<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>使用robot_pose_ekf实现传感器融合 | Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="Each source gives a pose estimate and a covariance. The sources operate at different rates and with different latencies. A source can appear and disappear over time, and the node will automatically de">
<meta property="og:type" content="article">
<meta property="og:title" content="使用robot_pose_ekf实现传感器融合">
<meta property="og:url" content="http://example.com/2020/03/25/%E6%BF%80%E5%85%89SLAM/%E5%8D%A1%E5%B0%94%E6%9B%BC%E6%BB%A4%E6%B3%A2/%E4%BD%BF%E7%94%A8robot_pose_ekf%E5%AE%9E%E7%8E%B0%E6%95%B0%E6%8D%AE%E8%9E%8D%E5%90%88/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="Each source gives a pose estimate and a covariance. The sources operate at different rates and with different latencies. A source can appear and disappear over time, and the node will automatically de">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://i.loli.net/2020/03/25/RbpSnG9Ce8lLhOw.png">
<meta property="og:image" content="https://i.loli.net/2020/03/25/nM2Hb7NF9JfedWQ.png">
<meta property="og:image" content="https://i.loli.net/2020/05/23/BAwtu9NfZ3sQW4I.png">
<meta property="article:published_time" content="2020-03-25T13:35:40.000Z">
<meta property="article:modified_time" content="2020-05-23T12:57:40.390Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.loli.net/2020/03/25/RbpSnG9Ce8lLhOw.png">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 5.4.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-激光SLAM/卡尔曼滤波/使用robot_pose_ekf实现数据融合" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/03/25/%E6%BF%80%E5%85%89SLAM/%E5%8D%A1%E5%B0%94%E6%9B%BC%E6%BB%A4%E6%B3%A2/%E4%BD%BF%E7%94%A8robot_pose_ekf%E5%AE%9E%E7%8E%B0%E6%95%B0%E6%8D%AE%E8%9E%8D%E5%90%88/" class="article-date">
  <time class="dt-published" datetime="2020-03-25T13:35:40.000Z" itemprop="datePublished">2020-03-25</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%BF%80%E5%85%89SLAM/">激光SLAM</a>►<a class="article-category-link" href="/categories/%E6%BF%80%E5%85%89SLAM/%E5%8D%A1%E5%B0%94%E6%9B%BC%E6%BB%A4%E6%B3%A2/">卡尔曼滤波</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      使用robot_pose_ekf实现传感器融合
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>Each source gives a pose estimate and a covariance. The sources operate at different rates and with different latencies. A source can appear and disappear over time, and the node will automatically detect and use the available sensors.To add your own sensor inputs,</p>
<p>给滤波器节点提供信息的所有传感器源都有自己的参考坐标系，并且随着时间推移都可能出现漂移现象。因此，每个传感器发出来的绝对位姿不能直接对比。 </p>
<p><code>robot_pose_ekf</code>使用每个传感器的相对位姿差异来更新扩展卡尔曼滤波器，用松耦合方式融合不同传感器信息实现位姿估计。</p>
<p>在位姿本身上发布协方差是没有用的，而是传感器源发布协方差如何随时间变化，即速度的协方差。使用对世界的观测（例如，测量到已知墙壁的距离）将减少机器人位姿的不确定性；但是这是定位而不是里程计。</p>
<h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><p>校正好IMU,因为融合后的效果就是要看imu的校准度</p>
<p>注释掉StatusPublisher.cpp中的<code>sendTransform(tf::StampedTransform(transform, current_time.fromSec(base_time_), &quot;odom&quot;, &quot;base_footprint&quot;));</code>  因为ekf包会为我们处理好这部分tf，所以不需要我们发布odom变换了</p>
<h2 id="修改-xiaoqiang-pose-ekf-launch"><a href="#修改-xiaoqiang-pose-ekf-launch" class="headerlink" title="修改 xiaoqiang_pose_ekf.launch"></a>修改 xiaoqiang_pose_ekf.launch</h2><p>以小强自带的launch文件为基础进行修改</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">launch</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">node</span> <span class="attr">pkg</span>=<span class="string">&quot;robot_pose_ekf&quot;</span> <span class="attr">type</span>=<span class="string">&quot;robot_pose_ekf&quot;</span> <span class="attr">name</span>=<span class="string">&quot;robot_pose_ekf&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">&quot;output_frame&quot;</span> <span class="attr">value</span>=<span class="string">&quot;odom_combined&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">&quot;base_footprint_frame&quot;</span> <span class="attr">value</span>=<span class="string">&quot;base_footprint&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">&quot;freq&quot;</span> <span class="attr">value</span>=<span class="string">&quot;30.0&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">&quot;sensor_timeout&quot;</span> <span class="attr">value</span>=<span class="string">&quot;1.0&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">&quot;odom_used&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">&quot;imu_used&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">&quot;vo_used&quot;</span> <span class="attr">value</span>=<span class="string">&quot;false&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">&quot;debug&quot;</span> <span class="attr">value</span>=<span class="string">&quot;false&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">&quot;self_diagnose&quot;</span> <span class="attr">value</span>=<span class="string">&quot;false&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">node</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">launch</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p>freq: the update and publishing frequency of the filter. Note that a higher frequency will give you more robot poses over time, but it will not increase the accuracy of each estimated robot pose.</p>
</li>
<li><p>sensor_timeout: when a sensor stops sending information to the filter, how long should the filter wait before moving on without that sensor.</p>
</li>
<li><p>odom_used, imu_used, vo_used: enable or disable inputs.</p>
</li>
</ul>
<p><code>robot_pose_ekf</code>默认监听topic: <code>imu_data</code>、<code>odom</code>和<code>vo</code>. 发布<code>robot_pose_ekf/odom_combined</code>，也是机器人位姿的估计值，带协方差矩阵的位姿。所以我们需要remap到实际的话题:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">remap</span> <span class="attr">from</span>=<span class="string">&quot;odom&quot;</span> <span class="attr">to</span>=<span class="string">&quot;/xqserial_server/Odom&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">remap</span> <span class="attr">from</span>=<span class="string">&quot;vo&quot;</span> <span class="attr">to</span>=<span class="string">&quot;/ORB_SLAM/Odom&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">remap</span> <span class="attr">from</span>=<span class="string">&quot;imu_data&quot;</span> <span class="attr">to</span>=<span class="string">&quot;xqserial_server/IMU&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<p>启动之后,发布一下tf树,看看各坐标系名称是否正确,而且<code>odom_combined</code>是不是<code>robot_pose_ekf</code>发布的，它提供的tf变换是： odom_combined –&gt; base_footprint</p>
<p>我们最终要实现的目标TF关系是： <code>map --&gt; odom_combined --&gt; base_footprint --&gt; base_link</code></p>
<p>启动launch: <code>roslaunch robot_pose_ekf xiaoqiang_pose_ekf.launch</code></p>
<p><img src="https://i.loli.net/2020/03/25/RbpSnG9Ce8lLhOw.png" alt="发布订阅关系1"><br><img src="https://i.loli.net/2020/03/25/nM2Hb7NF9JfedWQ.png" alt="发布订阅关系2"></p>
<p>为了查看ekf包是否正常工作，可以用下面代码：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rosservice call /robot_pose_efk/get_status</span><br></pre></td></tr></table></figure>

<h2 id="协方差问题"><a href="#协方差问题" class="headerlink" title="协方差问题"></a>协方差问题</h2><p>里程计消息的协方差平时可以没有,但是如果要用到卡尔曼滤波做融合,就必须有,否则会报错:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[ERROR] [1519539033.600801081]: Covariance specified <span class="keyword">for</span> measurement on topic wheelodom is zero</span><br></pre></td></tr></table></figure>
<p>这里的协方差矩阵就是&lt;&lt;概率机器人&gt;&gt;154页的<code>Vt*Mt*VtT</code>, 根据之前速度积分的模型,我们已知的是ωt,Δt,θ</p>
<p>只有a1~a4还未知,它们的说明在《概率机器人》103页,这里就涉及到粒子滤波和AMCL了,其实它们就是AMCL的四个参数,即里程计的四个噪声分量. 我们在使用AMCL定位前就要调节这四个参数, 有了这四个参数,就能算出里程计的协方差矩阵了.</p>
<p><code>robot_pose_ekf</code>不输出协方差信息，但要求输入协方差，协方差是<font size =3 color=blue>on velocity level</font></p>
<p>随着机器人的移动，其位姿的不确定性越来越大。随着时间的流逝，协方差将无限增长。<code>robot_pose_ekf</code>会在每个传感器更新数据前重置协方差， 所以发布的协方差是the increase in covariance over the past time interval. 这个时间间隔不是不变的，它取决于传感器的测量速度和什么时候完成．</p>
<p>在使用robot_pose_ekf时，常遇到接收到的odometry数据格式错误的问题。一个可能的原因为底盘或其他设备发布odometry数据的协方差矩阵默认为0矩阵。解决的方法由两种：一种为在底盘将信息封装发布前对协方差矩阵进行初始化；另一种方法为在robot_pose_ekf中添加判断，如果接收到的odometry信息的协方差矩阵没有进行初始化，则进行初始化。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// manually set covariance untile imu sends covariance</span></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">imu_covariance_</span>(<span class="number">1</span>,<span class="number">1</span>) == <span class="number">0.0</span>)&#123;</span><br><span class="line">  <span class="function">SymmetricMatrix <span class="title">measNoiseImu_Cov</span><span class="params">(<span class="number">3</span>)</span></span>;  measNoiseImu_Cov = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">measNoiseImu_Cov</span>(<span class="number">1</span>,<span class="number">1</span>) = <span class="built_in">pow</span>(<span class="number">0.00017</span>,<span class="number">2</span>);  <span class="comment">// = 0.01 degrees / sec</span></span><br><span class="line">  <span class="built_in">measNoiseImu_Cov</span>(<span class="number">2</span>,<span class="number">2</span>) = <span class="built_in">pow</span>(<span class="number">0.00017</span>,<span class="number">2</span>);  <span class="comment">// = 0.01 degrees / sec</span></span><br><span class="line">  <span class="built_in">measNoiseImu_Cov</span>(<span class="number">3</span>,<span class="number">3</span>) = <span class="built_in">pow</span>(<span class="number">0.00017</span>,<span class="number">2</span>);  <span class="comment">// = 0.01 degrees / sec</span></span><br><span class="line">  imu_covariance_ = measNoiseImu_Cov;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>轮式里程计严重依赖控制系统，比如编码器，电机，轮子，控制器，驱动器等等．</p>
<p>try adjusting the process noise vs. the measurement covariance for the state variables you’re fusing. Lower covariance in the measurement and higher process noise will mean that the filter trusts your sensors more. Otherwise, the filter will prefer to stick with its predictions</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/EAIBOT/article/details/51405152">turtlebot所用的里程计和IMU协方差是手动设置的</a></p>
<p>修改<code>robot_pose_ekf/src/odom_estimation_node.cpp</code>中的函数<code>OdomEstimationNode::odomCallback</code>如下:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">unsigned</span> <span class="keyword">int</span> i=<span class="number">0</span>; i&lt;<span class="number">6</span>; i++)</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">unsigned</span> <span class="keyword">int</span> j=<span class="number">0</span>; j&lt;<span class="number">6</span>; j++)</span><br><span class="line">    <span class="built_in">odom_covariance_</span>(i+<span class="number">1</span>, j+<span class="number">1</span>) = odom-&gt;pose.covariance[<span class="number">6</span>*i+j];</span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">odom_covariance_</span>(<span class="number">1</span>,<span class="number">1</span>) == <span class="number">0.0</span>)&#123;</span><br><span class="line">  <span class="function">SymmetricMatrix <span class="title">measNoiseOdom_Cov</span><span class="params">(<span class="number">6</span>)</span></span>;  measNoiseOdom_Cov = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">measNoiseOdom_Cov</span>(<span class="number">1</span>,<span class="number">1</span>) = <span class="built_in">pow</span>(<span class="number">0.01221</span>,<span class="number">2</span>);  <span class="comment">// = 0.01221 meters / sec</span></span><br><span class="line">  <span class="built_in">measNoiseOdom_Cov</span>(<span class="number">2</span>,<span class="number">2</span>) = <span class="built_in">pow</span>(<span class="number">0.01221</span>,<span class="number">2</span>);  <span class="comment">// = 0.01221 meters / sec</span></span><br><span class="line">  <span class="built_in">measNoiseOdom_Cov</span>(<span class="number">3</span>,<span class="number">3</span>) = <span class="built_in">pow</span>(<span class="number">0.01221</span>,<span class="number">2</span>);  <span class="comment">// = 0.01221 meters / sec</span></span><br><span class="line">  <span class="built_in">measNoiseOdom_Cov</span>(<span class="number">4</span>,<span class="number">4</span>) = <span class="built_in">pow</span>(<span class="number">0.007175</span>,<span class="number">2</span>);  <span class="comment">// = 0.41 degrees / sec</span></span><br><span class="line">  <span class="built_in">measNoiseOdom_Cov</span>(<span class="number">5</span>,<span class="number">5</span>) = <span class="built_in">pow</span>(<span class="number">0.007175</span>,<span class="number">2</span>);  <span class="comment">// = 0.41 degrees / sec</span></span><br><span class="line">  <span class="built_in">measNoiseOdom_Cov</span>(<span class="number">6</span>,<span class="number">6</span>) = <span class="built_in">pow</span>(<span class="number">0.007175</span>,<span class="number">2</span>);  <span class="comment">// = 0.41 degrees / sec</span></span><br><span class="line">  odom_covariance_ = measNoiseOdom_Cov;</span><br><span class="line">&#125;</span><br><span class="line">my_filter_.<span class="built_in">addMeasurement</span>(<span class="built_in">StampedTransform</span>(odom_meas_.<span class="built_in">inverse</span>(), odom_stamp_, base_footprint_frame_, <span class="string">&quot;wheelodom&quot;</span>), odom_covariance_);</span><br></pre></td></tr></table></figure>
<p>这是仿照源码中的函数<code>imuCallback</code>做的修改</p>
<p>如果协方差太大，那么说明机器人不太依靠里程计．协方差矩阵具体值可以考虑设置为精度的二次方。工程中确保odom的协方差矩阵对角线元素不均为0，则robot_pose_ekf即可工作。</p>
<h2 id="源码的坐标系错误"><a href="#源码的坐标系错误" class="headerlink" title="源码的坐标系错误"></a>源码的坐标系错误</h2><p>使用rviz观看滤波后的行走轨迹，结果报错：<br><img src="https://i.loli.net/2020/05/23/BAwtu9NfZ3sQW4I.png" alt="rviz里的ekf_dom_path报错.png"><br>它居然要求的是odom坐标系，但是查看tf树，坐标关系是正确的<code>odom_combined --&gt; base_footprint</code>，没有odom了。</p>
<p>使用echo查看/robot_pose_ekf/odom_combined话题，发现header里的frame_id: “odom”，看来是哪个地方发布错了。 从robot_pose_ekf源码里查找，发现<code>OdomEstimation::getEstimate(geometry_msgs::PoseWithCovarianceStamped&amp; estimate)</code>中，有这样一句<code>estimate.header.frame_id = &quot;odom&quot;;</code>，按说新的坐标系是<code>odom_combined</code>，不知为什么这里还是<code>odom</code>，只能认为是源码写错了。</p>
<h2 id="转换odom-combined的格式"><a href="#转换odom-combined的格式" class="headerlink" title="转换odom_combined的格式"></a>转换odom_combined的格式</h2><p>原来的<code>odom</code>话题的格式为<code>nav_msgs/Odometry</code>. robot_pose_ekf发布的默认话题<code>robot_pose_ekf/odom_combined</code>，消息格式为<code>geometry_msgs/PoseWithCovarianceStamped</code>, 需要进行消息格式转换：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="keyword">import</span> rospy</span><br><span class="line"><span class="keyword">from</span> geometry_msgs.msg <span class="keyword">import</span> PoseWithCovarianceStamped</span><br><span class="line"><span class="keyword">from</span> nav_msgs.msg <span class="keyword">import</span> Odometry</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OdomEKF</span>():</span></span><br><span class="line">   <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">       <span class="comment"># Give the node a name</span></span><br><span class="line">       rospy.init_node(<span class="string">&#x27;odom_ekf&#x27;</span>, anonymous=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">       <span class="comment"># Publisher of type nav_msgs/Odometry</span></span><br><span class="line">       self.ekf_pub = rospy.Publisher(<span class="string">&#x27;output&#x27;</span>, Odometry, queue_size=<span class="number">10</span>)</span><br><span class="line">       </span><br><span class="line">       <span class="comment"># Wait for the /odom_combined topic to become available</span></span><br><span class="line">       rospy.wait_for_message(<span class="string">&#x27;input&#x27;</span>, PoseWithCovarianceStamped)</span><br><span class="line">       </span><br><span class="line">       <span class="comment"># Subscribe to the /odom_combined topic</span></span><br><span class="line">       rospy.Subscriber(<span class="string">&#x27;input&#x27;</span>, PoseWithCovarianceStamped, self.pub_ekf_odom)</span><br><span class="line">       </span><br><span class="line">       rospy.loginfo(<span class="string">&quot;Publishing combined odometry on /odom_ekf&quot;</span>)</span><br><span class="line">       </span><br><span class="line">   <span class="function"><span class="keyword">def</span> <span class="title">pub_ekf_odom</span>(<span class="params">self, msg</span>):</span></span><br><span class="line">       odom = Odometry()</span><br><span class="line">       odom.header = msg.header</span><br><span class="line">       odom.header.frame_id = <span class="string">&#x27;/odom&#x27;</span></span><br><span class="line">       odom.child_frame_id = <span class="string">&#x27;base_footprint&#x27;</span></span><br><span class="line">       odom.pose = msg.pose</span><br><span class="line">       </span><br><span class="line">       self.ekf_pub.publish(odom)</span><br><span class="line">       </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">   <span class="keyword">try</span>:</span><br><span class="line">       OdomEKF()</span><br><span class="line">       rospy.spin()</span><br><span class="line">   <span class="keyword">except</span>:</span><br><span class="line">       <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>

<p>修改<code>xiaoqiang_move_base_blank_map.launch</code>中的static_transform_publisher和remap中的里程计话题名称. 打开<code>nav_test/config/xiaoqiang/local_costmap_params.yaml</code>, 将<code>global_frame</code>改为<code>odom_combined</code></p>
<p>参考:<a target="_blank" rel="noopener" href="https://answers.ros.org/question/11682/robot_pose_ekf-with-an-external-sensor/?answer=17402#post-id-17402">ROS answer的回答</a><br><a target="_blank" rel="noopener" href="http://xxty.fun/2019/08/12/ROS%E5%B0%8F%E8%BD%A6%EF%BC%9Arobot_pose_ekf%E8%9E%8D%E5%90%88%E9%87%8C%E7%A8%8B%E8%AE%A1%E4%BF%A1%E6%81%AF/">XiaoXiaoTao博客</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2020/03/25/%E6%BF%80%E5%85%89SLAM/%E5%8D%A1%E5%B0%94%E6%9B%BC%E6%BB%A4%E6%B3%A2/%E4%BD%BF%E7%94%A8robot_pose_ekf%E5%AE%9E%E7%8E%B0%E6%95%B0%E6%8D%AE%E8%9E%8D%E5%90%88/" data-id="ckr29d1c100gsn8lmeagm3jlv" data-title="使用robot_pose_ekf实现传感器融合" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2020/03/30/%E6%BF%80%E5%85%89SLAM/amcl%E5%92%8C%E7%B2%92%E5%AD%90%E6%BB%A4%E6%B3%A2/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90(%E5%9B%9B)%E8%BF%90%E5%8A%A8%E6%A8%A1%E5%9E%8B/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          源码分析(四)运动模型
        
      </div>
    </a>
  
  
    <a href="/2020/03/25/C++/C++%20%20%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1/%E6%8A%9B%E5%87%BA%E5%BC%82%E5%B8%B8/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">抛出异常</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/C/">C++</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/C/Boost/">Boost</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/C/C-%E5%9F%BA%E7%A1%80/">C++ 基础</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/C/C-%E6%A8%A1%E6%9D%BF%E4%B8%8ESTL/">C++ 模板与STL</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/C/C-%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1/">C++ 面向对象</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/C/%E5%A4%9A%E7%BA%BF%E7%A8%8B/">多线程</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux%E5%9F%BA%E7%A1%80/">Linux基础</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Matlab/">Matlab</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/PCL%E7%82%B9%E4%BA%91/">PCL点云</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/ROS/">ROS</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/ROS/ROS-Kinetic%E7%9F%A5%E8%AF%86/">ROS Kinetic知识</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/ROS/ROS%E6%9C%BA%E5%99%A8%E4%BA%BA/">ROS机器人</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/ROS/ROS%E7%A8%8B%E5%BA%8F%E5%92%8C%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">ROS程序和源码分析</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/ROS/rviz%E6%B7%B1%E5%85%A5%E7%A0%94%E7%A9%B6/">rviz深入研究</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/ROS/%E6%9C%BA%E5%99%A8%E4%BA%BA%E5%AF%BC%E8%88%AA/">机器人导航</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/SLAM%E5%B7%A5%E5%85%B7/">SLAM工具</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Valgrind%E5%92%8C%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/">Valgrind和内存管理</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Wireshark/">Wireshark</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/cmake-qmake/">cmake/qmake</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%85%B6%E4%BB%96/">其他</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%8D%97%E4%BA%AC%E5%AF%BC%E8%88%AA%E7%A8%8B%E5%BA%8F%E7%9A%84%E7%96%91%E9%9A%BE%E9%97%AE%E9%A2%98/">南京导航程序的疑难问题</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%B8%B8%E7%94%A8%E5%B7%A5%E5%85%B7/">常用工具</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%95%B0%E5%AD%A6%E5%9F%BA%E7%A1%80/">数学基础</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%BF%80%E5%85%89SLAM/">激光SLAM</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%BF%80%E5%85%89SLAM/Cartographer/">Cartographer</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%BF%80%E5%85%89SLAM/Cartographer/%E5%8E%9F%E7%90%86%E5%92%8C%E9%85%8D%E7%BD%AE/">原理和配置</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%BF%80%E5%85%89SLAM/Cartographer/%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/">源码解读</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%BF%80%E5%85%89SLAM/ICP/">ICP</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%BF%80%E5%85%89SLAM/amcl%E5%92%8C%E7%B2%92%E5%AD%90%E6%BB%A4%E6%B3%A2/">amcl和粒子滤波</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%BF%80%E5%85%89SLAM/gmapping/">gmapping</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%BF%80%E5%85%89SLAM/%E5%85%B6%E4%BB%96/">其他</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%BF%80%E5%85%89SLAM/%E5%8D%A1%E5%B0%94%E6%9B%BC%E6%BB%A4%E6%B3%A2/">卡尔曼滤波</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%BF%80%E5%85%89SLAM/%E5%8F%8D%E5%85%89%E6%9D%BF/">反光板</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%BF%80%E5%85%89SLAM/%E7%AE%97%E6%B3%95%E6%8E%A8%E5%AF%BC/">算法推导</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%BF%80%E5%85%89SLAM/%E9%9B%B7%E8%BE%BE/">雷达</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%AC%AC%E4%B8%89%E6%96%B9%E5%BA%93/">第三方库</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%84%9A%E6%9C%AC/">脚本</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%A7%86%E8%A7%89SLAM/">视觉SLAM</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%B7%AF%E5%BE%84%E8%A7%84%E5%88%92/">路径规划</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%B7%AF%E5%BE%84%E8%A7%84%E5%88%92/TEB%E7%AE%97%E6%B3%95/">TEB算法</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%B7%AF%E5%BE%84%E8%A7%84%E5%88%92/TEB%E7%AE%97%E6%B3%95/costmap-converter/">costmap converter</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%B7%AF%E5%BE%84%E8%A7%84%E5%88%92/move-base%E5%88%86%E6%9E%90/">move_base分析</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%B7%AF%E5%BE%84%E8%A7%84%E5%88%92/%E4%BB%A3%E4%BB%B7%E5%9C%B0%E5%9B%BE/">代价地图</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%B7%AF%E5%BE%84%E8%A7%84%E5%88%92/%E5%85%A8%E5%B1%80%E8%B7%AF%E5%BE%84%E7%AE%97%E6%B3%95/">全局路径算法</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%B7%AF%E5%BE%84%E8%A7%84%E5%88%92/%E5%85%B6%E4%BB%96/">其他</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%B7%AF%E5%BE%84%E8%A7%84%E5%88%92/%E5%9F%BA%E4%BA%8Erealsense%E6%89%AB%E6%8F%8F%E7%82%B9%E4%BA%91%E7%9A%84%E4%BD%8E%E7%9F%AE%E9%81%BF%E9%9A%9C/">基于realsense扫描点云的低矮避障</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%B7%AF%E5%BE%84%E8%A7%84%E5%88%92/%E5%A4%A7%E8%BD%AE%E5%BB%93%E6%9C%BA%E5%99%A8%E4%BA%BA%E7%9A%84%E5%AF%BC%E8%88%AA/">大轮廓机器人的导航</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%9D%A2%E8%AF%95%E7%AC%94%E8%AF%95/">面试笔试</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/web%E6%9C%8D%E5%8A%A1%E5%99%A8/" rel="tag">web服务器</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/" rel="tag">内存管理</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%91%84%E5%83%8F%E5%A4%B4/" rel="tag">摄像头</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BC%96%E8%AF%91%E8%B0%83%E8%AF%95/" rel="tag">编译调试</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%9D%A2%E8%AF%95%E7%AC%94%E8%AF%95/" rel="tag">面试笔试</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/web%E6%9C%8D%E5%8A%A1%E5%99%A8/" style="font-size: 10px;">web服务器</a> <a href="/tags/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/" style="font-size: 10px;">内存管理</a> <a href="/tags/%E6%91%84%E5%83%8F%E5%A4%B4/" style="font-size: 15px;">摄像头</a> <a href="/tags/%E7%BC%96%E8%AF%91%E8%B0%83%E8%AF%95/" style="font-size: 20px;">编译调试</a> <a href="/tags/%E9%9D%A2%E8%AF%95%E7%AC%94%E8%AF%95/" style="font-size: 10px;">面试笔试</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/07/">July 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/06/">June 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/05/">May 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/04/">April 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">March 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/02/">February 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">January 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">December 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">November 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">October 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">September 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">August 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">July 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">June 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">May 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">April 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">February 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">January 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">August 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">June 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">May 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">April 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">February 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">January 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">November 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">October 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">September 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">August 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">July 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">May 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">April 2018</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2021/07/13/%E6%BF%80%E5%85%89SLAM/%E7%AE%97%E6%B3%95%E6%8E%A8%E5%AF%BC/%E9%AB%98%E6%96%AF%E7%89%9B%E9%A1%BF%E6%B3%95/">17747</a>
          </li>
        
          <li>
            <a href="/2021/07/13/%E6%BF%80%E5%85%89SLAM/%E7%AE%97%E6%B3%95%E6%8E%A8%E5%AF%BC/%E7%89%9B%E9%A1%BF%E6%B3%95/">牛顿法</a>
          </li>
        
          <li>
            <a href="/2021/07/12/%E7%AC%94%E8%AF%95%E9%9D%A2%E8%AF%95/ROS/">ROS</a>
          </li>
        
          <li>
            <a href="/2021/07/12/%E7%AC%94%E8%AF%95%E9%9D%A2%E8%AF%95/%E7%AE%97%E6%B3%95/">算法</a>
          </li>
        
          <li>
            <a href="/2021/07/07/%E6%BF%80%E5%85%89SLAM/Cartographer/%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/AddAccumulatedRangeData%E5%87%BD%E6%95%B0(3)/">AddAccumulatedRangeData函数(3) 加入位姿估计器和插入子图</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2021 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>