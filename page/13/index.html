<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content=""><meta name="keywords" content=""><meta name="author" content="Charon Cheung"><meta name="copyright" content="Charon Cheung"><title>If you wish for peace, prepare for war | 沉默杀手</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.6.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.6.1"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  }
} </script><meta name="generator" content="Hexo 5.4.0"></head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="author-info"><div class="author-info__avatar text-center"><img src="https://s2.loli.net/2022/02/17/HQaCXUBn64zsMIL.png"></div><div class="author-info__name text-center">Charon Cheung</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">598</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">5</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">56</span></a></div></div></div><nav id="nav" style="background-image: url(https://s2.loli.net/2022/02/18/exLTfbM3uFOq5SV.png)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">沉默杀手</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span></div><div id="site-info"><div id="site-title">沉默杀手</div><div id="site-sub-title">If you wish for peace, prepare for war</div></div></nav><div id="content-outer"><div class="layout" id="content-inner"><div class="recent-post-item article-container"><a class="article-title" href="/2021/11/04/%E8%B7%AF%E5%BE%84%E8%A7%84%E5%88%92/%E4%BB%A3%E4%BB%B7%E5%9C%B0%E5%9B%BE/map_server%E5%8A%A0%E8%BD%BD%E4%B8%8D%E5%90%8C%E5%A4%A7%E5%B0%8F%E5%9C%B0%E5%9B%BE%E7%9A%84%E5%BD%B1%E5%93%8D/">map_server加载不同大小地图的影响</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-11-04</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E8%B7%AF%E5%BE%84%E8%A7%84%E5%88%92/">路径规划</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E8%B7%AF%E5%BE%84%E8%A7%84%E5%88%92/%E4%BB%A3%E4%BB%B7%E5%9C%B0%E5%9B%BE/">代价地图</a></span><div class="content"><h2 id="小地图"><a href="#小地图" class="headerlink" title="小地图"></a>小地图</h2><p>加载小地图，目标点出了地图范围时，导航会失败，<code>GlobalPlanner::makePlan</code>出现报警:</p>
<font color = orange size=4>The robot's start position is off the global costmap. Planning will always fail, are you sure the robot has been properly localized? </font>

<p>这很容易理解，除了地图就到不了了</p>
<h2 id="大地图"><a href="#大地图" class="headerlink" title="大地图"></a>大地图</h2><p>加载一个空的 20000x20000 的地图，转成pgm格式，高达380M。结果加载时会在<code>map_server::loadMapFromFile</code>里报错： <font color = red size = 4>  [ERROR] failed to open image file “/home/dxr/ws/src/follow/map/big_blank.pgm”: Out of memory
 </font></p>
<p>原理是map_server使用<code>SDL</code>加载地图文件，这就把问题下降到SDL了。ubuntu18所用SDL版本是1.2，原因在源码<code>SDL_surface.c</code>里对地图宽和高做了限制<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">SDL_Surface * <span class="title">SDL_CreateRGBSurface</span> <span class="params">(Uint32 flags,</span></span></span><br><span class="line"><span class="params"><span class="function">      <span class="keyword">int</span> width, <span class="keyword">int</span> height, <span class="keyword">int</span> depth,</span></span></span><br><span class="line"><span class="params"><span class="function">      Uint32 Rmask, Uint32 Gmask, Uint32 Bmask, Uint32 Amask)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">      ......</span><br><span class="line">  <span class="comment">/* Make sure the size requested doesn&#x27;t overflow our datatypes */</span></span><br><span class="line">  <span class="comment">/* Next time I write a library like SDL, I&#x27;ll use int for size. :) */</span></span><br><span class="line">  <span class="keyword">if</span> ( width &gt;= <span class="number">16384</span> || height &gt;= <span class="number">65536</span> ) &#123;</span><br><span class="line">    <span class="built_in">SDL_SetError</span>(<span class="string">&quot;Width or height is too large&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span>(<span class="literal">NULL</span>);</span><br><span class="line">  &#125;</span><br><span class="line">      ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>到这里其实不用再研究了，不用想怎么改善SDL了。有些公司的处理方法是每次只加载一部分地图，这也是3D稠密和稀疏重建常用的方法</p>
<p>其实就算这里通过了，到move_base创建代价地图时，new分配了太多内存，还有可能出错</p>
<h2 id="不加载地图"><a href="#不加载地图" class="headerlink" title="不加载地图"></a>不加载地图</h2><p>最令人想不到的是还可以不加载地图，使用里程计，但此时无法规划路径。把全局代价地图的参数改的跟局部代价地图一样，去掉静态层，但是增大<code>rolling_window</code>的大小，也就是说使用一大一小的局部代价地图，然后就可以规划路径了，相当于以前只用局部代价地图避障。这看上去冗余，而且浪费计算机性能。<br><img src="https://i.loli.net/2021/11/04/8sQTD96qcWpHtYv.png" alt=""><br>如果不用全局代价地图，启动不报错，还是无法规划路径。原因在于<code>move_base.cpp</code>里对全局和局部代价地图都使用了，除非将源码中的全局代价地图部分删除，不过影响太大了。<br><br></p>
<p>不加载地图时，可以正常导航，但是代价值会累计很多，需要设置自动清除<br><img src="https://i.loli.net/2021/11/11/79oanXtm6kZH215.png" alt="清除了大部分的代价值.png"><br><img src="https://i.loli.net/2021/11/11/4KMkY2oDh5Z6wWH.png" alt="代价值一直没有清除.png"></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2021/11/03/ROS/ROS%E6%9C%BA%E5%99%A8%E4%BA%BA/xsens%20IMU/">xsens IMU的使用</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-11-03</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/ROS/">ROS</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/ROS/ROS%E6%9C%BA%E5%99%A8%E4%BA%BA/">ROS机器人</a></span><div class="content"><p><code>roslaunch xsens_driver xsens_driver.launch</code></p>
<p>节点<code>xsens_driver</code>发布话题:</p>
<ul>
<li>/diagnostics [diagnostic_msgs/DiagnosticArray]</li>
<li>/imu/data [sensor_msgs/Imu]，  被节点<code>data_pretreat_node</code>订阅</li>
<li>/imu_data_str [std_msgs/String]</li>
<li>/time_reference [sensor_msgs/TimeReference]</li>
<li>/velocity [geometry_msgs/TwistStamped]</li>
</ul>
<p><code>xsens.bag</code>对应车先向前行驶，然后原地转约180°，然后再往回走。</p>
<p><img src="https://s2.loli.net/2021/12/08/lkSfcqKt7eDGWuA.png" alt="imu数据占用的带宽.png"></p>
<p>参考:<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_41469272/article/details/107512032">基于ros melodic 及 MTI-G-710测试</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/LSG_Down/article/details/81068114">Xsens MTi -1 姿态传感器恢复与MTI的通信的方法</a></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2021/10/31/ROS/ROS%20Kinetic%E7%9F%A5%E8%AF%86/python%E4%B8%AD%E4%BD%BF%E7%94%A8ROS%E7%9A%84%E6%B3%A8%E6%84%8F%E7%82%B9/">python中使用ROS的注意点</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-10-31</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/ROS/">ROS</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/ROS/ROS-Kinetic%E7%9F%A5%E8%AF%86/">ROS Kinetic知识</a></span><div class="content"><h2 id="python2-7和python3的冲突问题"><a href="#python2-7和python3的冲突问题" class="headerlink" title="python2.7和python3的冲突问题"></a>python2.7和python3的冲突问题</h2><p>之前在<a href="">ROS安装和编译等常见问题.md</a>提到了python3.8和python2.7冲突的问题，那次是不同文件可以分别用不同版本的python运行，但是如果同一个文件里用到了python的两个版本，那就不好解决了。</p>
<p>比如一个文件需要用到python3的函数，然后发现<code>import tf</code>报错，没法用tf了，因为<code>tf2_ros</code>是针对python2编译的，为了适应python3 (melodic)，进行如下步骤：<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update</span><br><span class="line">sudo apt install python3-catkin-pkg-modules python3-rospkg-modules python3-empy</span><br><span class="line">Prepare catkin workspace</span><br><span class="line"></span><br><span class="line">mkdir -p ~/catkin_ws/src; <span class="built_in">cd</span> ~/catkin_ws</span><br><span class="line">catkin_make</span><br><span class="line"><span class="built_in">source</span> devel/setup.bash</span><br><span class="line">wstool init</span><br><span class="line">wstool <span class="built_in">set</span> -y src/geometry2 --git https://github.com/ros/geometry2 -v 0.6.5</span><br><span class="line">wstool up</span><br><span class="line">rosdep install --from-paths src --ignore-src -y -r</span><br><span class="line">Finally compile <span class="keyword">for</span> Python 3</span><br><span class="line"></span><br><span class="line">catkin_make --cmake-args \</span><br><span class="line">            -DCMAKE_BUILD_TYPE=Release \</span><br><span class="line">            -DPYTHON_EXECUTABLE=/usr/bin/python3 \</span><br><span class="line">            -DPYTHON_INCLUDE_DIR=/usr/include/python3.6m \</span><br><span class="line">            -DPYTHON_LIBRARY=/usr/lib/x86_64-linux-gnu/libpython3.6m.so</span><br><span class="line"><span class="built_in">source</span> devel/setup.bash</span><br></pre></td></tr></table></figure></p>
<h2 id="让python支持中文注释"><a href="#让python支持中文注释" class="headerlink" title="让python支持中文注释"></a>让python支持中文注释</h2><p>在源文件的初始部分，而且必须放在第一行，添加<code>#coding=utf-8</code> 或者 <code>#coding=gbk</code> 或<code># -- coding: gb2312 --</code></p>
<p>参考：<br><a target="_blank" rel="noopener" href="https://answers.ros.org/question/326226/importerror-dynamic-module-does-not-define-module-export-function-pyinit__tf2/">ImportError: dynamic module does not define module export function (PyInit__tf2)</a></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2021/10/27/%E7%AE%97%E6%B3%95%E6%8E%A8%E5%AF%BC/%E5%8D%A1%E5%B0%94%E6%9B%BC%E6%BB%A4%E6%B3%A2%E7%9A%84%E6%8E%A8%E5%AF%BC%201/">卡尔曼滤波的推导(一)</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-10-27</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E7%AE%97%E6%B3%95%E6%8E%A8%E5%AF%BC/">算法推导</a></span><div class="content"><p>根据自己的情况，推导观测方程和雅克比矩阵</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2021/10/27/%E7%AE%97%E6%B3%95%E6%8E%A8%E5%AF%BC/%E5%8D%A1%E5%B0%94%E6%9B%BC%E6%BB%A4%E6%B3%A2%E7%9A%84%E6%8E%A8%E5%AF%BC%202/">卡尔曼滤波的推导(二)</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-10-27</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E7%AE%97%E6%B3%95%E6%8E%A8%E5%AF%BC/">算法推导</a></span><div class="content"></div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2021/10/26/%E6%BF%80%E5%85%89SLAM/%E9%9B%B7%E8%BE%BE/%E6%AF%AB%E7%B1%B3%E6%B3%A2%E9%9B%B7%E8%BE%BE/">毫米波雷达</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-10-26</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E6%BF%80%E5%85%89SLAM/">激光SLAM</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E6%BF%80%E5%85%89SLAM/%E9%9B%B7%E8%BE%BE/">雷达</a></span><div class="content"><p>毫米波雷达：介于微波和红外线之间，频率范围10GHz—200GHz，毫米波的频段高于无线电，低于可见光和红外线，这是一个非常适合车载领域的频段，波长为毫米级。测距原理是把无线电波（雷达波/电磁波）发射出去，根据接收回波与发送之间的时间差测得目标位置距离数据。一般的探测距离在0-200米之间。安装也可以完全隐蔽，不影响车辆整体外观。因此毫米波雷达技术更适用于汽车防撞领域。</p>
<p>激光雷达：介于红外线和可见光之间，频率大致为100000GHz，波长为纳米级</p>
<p>毫米波雷达的探测距离受到频段损耗的直接制约（想要探测的远，就必须使用高频段雷达），也无法感知行人，并且对周边所有障碍物无法进行精准的建模。这一点就大不如激光雷达。</p>
<p>激光雷达发射的电磁波是一条直线，主要以光粒子发射为主要方法，而毫米波雷达发射出去的电磁波是一个锥状的波束，这个波段的天线主要以电磁辐射为主。</p>
<p>从抗干扰能力上来讲，由于激光雷达通过发射光束进行探测，受环境影响较大，光束受遮挡后就不能正常使用，因此无法在雨雪雾霾天，沙尘暴等恶劣天气中开启，而毫米波的引导头穿透雾、烟、灰尘的能力强，因此可以在糟糕的天气中探测，在这一点上毫米波雷达更胜一筹。</p>
<p>激光雷达获取的数据量远超毫米波雷达，所以需要更高性能的处理器来处理数据，成本高了，售价自然就更贵了。</p>
<p>一般毫米波雷达的数据格式就是z=(a,r,s)，其中a表示物体相对于汽车的角度，r表示和汽车之间的距离，s表示径向速度。而一次扫描会有很多的物体，结果就会变成 (z1, z2, z3…)。</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2021/10/22/%E8%B7%AF%E5%BE%84%E8%A7%84%E5%88%92/%E5%85%A8%E5%B1%80%E8%B7%AF%E5%BE%84/%E5%85%A8%E5%B1%80%E8%B7%AF%E5%BE%84%E4%B8%8D%E6%AD%A3%E5%B8%B8%E7%9A%84%E8%A7%84%E5%88%92%E5%A4%B1%E8%B4%A5/">全局路径不正常的规划失败</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-10-22</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E8%B7%AF%E5%BE%84%E8%A7%84%E5%88%92/">路径规划</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E8%B7%AF%E5%BE%84%E8%A7%84%E5%88%92/%E5%85%A8%E5%B1%80%E8%B7%AF%E5%BE%84%E7%AE%97%E6%B3%95/">全局路径算法</a></span><div class="content"><p>精灵2所用全局路径的参数<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">planner_window_x: <span class="number">0.0</span></span><br><span class="line">planner_window_y: <span class="number">0.0</span></span><br><span class="line">default_tolerance: <span class="number">0.0</span></span><br><span class="line"></span><br><span class="line">publish_scale: <span class="number">100</span></span><br><span class="line">planner_costmap_publish_frequency: <span class="number">0.0</span></span><br></pre></td></tr></table></figure></p>
<p><img src="https://i.loli.net/2021/10/22/XZNH9QPWKsdBh76.png" alt="全局路径很奇怪.png"><br><img src="https://i.loli.net/2021/10/22/1Pb3XQe5Tnv8Mjk.png" alt="全局路径失败时的报错.png"><br><img src="https://i.loli.net/2021/10/25/YoQAJSDxRZdnrzw.png" alt="全局路径规划失败"></p>
<p>看代码<code>GlobalPlanner::makePlan</code>中的<code>if (found_legal)</code>部分，再看<code>GlobalPlanner::getPlanFromPotential</code>函数，继续定位到<code>path_maker_-&gt;getPath</code>。这里就需要看<code>path_maker</code>是什么东西，在文件中发现<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (use_grid_path)   <span class="comment">// 参数</span></span><br><span class="line">    <span class="comment">//栅格路径，从终点开始找上下或左右4个中最小的栅格直到起点</span></span><br><span class="line">    path_maker_ = <span class="keyword">new</span> <span class="built_in">GridPath</span>(p_calc_);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="comment">//梯度路径，从周围八个栅格中找到下降梯度最大的点</span></span><br><span class="line">path_maker_ = <span class="keyword">new</span> <span class="built_in">GradientPath</span>(p_calc_);</span><br></pre></td></tr></table></figure><br><code>use_grid_path</code>默认是false，所以一般用<code>GradientPath</code>，最终看<code>GradientPath::getPath</code>为什么返回false</p>
<p>将<code>if (fabs(nx - start_x) &lt; .5 &amp;&amp; fabs(ny - start_y) &lt; .5)</code> 中的0.5改为1</p>
<p>查来查去，终于发现其实就是全局代价地图里，本来就处于障碍的附近，所以规划如此奇怪。只是换到了室外环境，不习惯看全局代价地图了<br><img src="https://i.loli.net/2021/10/25/Cv9ncJuRMY4IoeU.png" alt=""></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2021/10/21/ROS/ROS%E7%A8%8B%E5%BA%8F%E5%92%8C%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/Synchronizer%E8%BF%9B%E8%A1%8C%E6%97%B6%E9%97%B4%E5%90%8C%E6%AD%A5/">message_filters::Synchronizer进行时间同步</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-10-21</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/ROS/">ROS</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/ROS/ROS%E7%A8%8B%E5%BA%8F%E5%92%8C%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">ROS程序和源码分析</a></span><div class="content"><p>多传感器数据融合的时候，由于各个传感器采集数据的频率的不同，例如odom 50Hz、Imu 100Hz、camera 25Hz，需要将传感器数据进行时间同步后才能进行融合。</p>
<p>分别订阅不同的需要融合的传感器的主题，通过<code>TimeSynchronizer</code>统一接收多个主题，只有在所有的topic都有相同的时间戳时，才会产生一个同步结果的回调函数，在回调函数里处理同步时间后的数据。</p>
<p>注意: 只有多个主题都有数据的时候才可以触发回调函数。如果其中一个主题的发布节点崩溃了，则整个回调函数永远无法触发回调。 <strong>频率一般趋于和最低的频率一样。</strong> 当多个主题频率一致的时候，回调函数的频率(融合后的频率)可能会小于订阅主题的频率。</p>
<p><code>message_filters::Synchronizer</code>省去了不同线程(回调函数)之间的同步问题，两线程的数据直接放到一个回调里处理。 但是它对传感器数据进行时间同步后，回调函数里的两个话题的时间戳会完全一样，纳秒级的相同。这是经过了ROS的调整，但有时候可能不是我们想要的。</p>
<p>对齐传感信息时间戳有两种方式, 一种是时间戳完全对齐 <strong>ExactTime Policy</strong>, 另一种是时间戳相近 <strong>ApproximateTime Policy</strong>, 前者更为严格, 但有时会没有结果而无法进行回调函数。所以一般还是用后者</p>
<p><a target="_blank" rel="noopener" href="http://wiki.ros.org/message_filters">message_filters</a><br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/long5683/p/13223458.html">message_filters::Synchronizer的使用</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_21830903/article/details/106532143">传感器数据之间的时间同步问题</a></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2021/10/21/%E5%9F%BA%E4%BA%8EUWB%E7%9A%84%E8%B7%9F%E9%9A%8F%E5%AF%BC%E8%88%AA/2.%20UWB%E7%9A%84%E5%AF%BC%E8%88%AA%E6%A1%86%E6%9E%B6/">(二) UWB的导航框架</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-10-21</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E5%9F%BA%E4%BA%8EUWB%E7%9A%84%E8%B7%9F%E9%9A%8F%E5%AF%BC%E8%88%AA/">基于UWB的跟随导航</a></span><div class="content"><p><strong>省略硬件和驱动的一系列配置</strong>，这个根据不同的UWB说明书进行即可，不是这里的重点。</p>
<p>所谓的目标跟随，就是人把UWB标签带在身上，UWB基站固定在机器人上，建立好<code>base_link</code>坐标系和UWB坐标系的tf关系。人向前移动，工控机通过串口不断读取UWB标签端相对基站的位姿，这样就得到<code>base_link</code>和UWB之间的位姿关系。 因此把这个位姿当做<code>move_base_simple/Goal</code>话题不断地发布出来，<strong>注意发布的频率会比较快</strong>，机器人还是使用<code>move_base</code>和代价地图去规划路径，这样就实现了跟随功能。</p>
<h2 id="导航框架设置"><a href="#导航框架设置" class="headerlink" title="导航框架设置"></a>导航框架设置</h2><p><img src="https://i.loli.net/2021/11/03/xZztbvjhYF4JXcV.png" alt="base_link和雷达坐标系.png"><br>一开始发现跟随功能的框架是这样设置的：map, odom, base_link 三个坐标系都重合，加载一个小地图。代价地图里没有静态层，当然有膨胀层和障碍层。没有里程计和LOAM之类的定位程序，跟随功能对定位的精度要求不高，但是避障还是要达到一定要求。</p>
<p>重新设置： 不加载pgm地图了，但全局和局部代价地图仍然要有。按<a href="https://charon-cheung.github.io/2021/11/04/%E8%B7%AF%E5%BE%84%E8%A7%84%E5%88%92/%E4%BB%A3%E4%BB%B7%E5%9C%B0%E5%9B%BE/map_server%E5%8A%A0%E8%BD%BD%E4%B8%8D%E5%90%8C%E5%A4%A7%E5%B0%8F%E5%9C%B0%E5%9B%BE%E7%9A%84%E5%BD%B1%E5%93%8D/#%E5%B0%8F%E5%9C%B0%E5%9B%BE">map_server加载不同大小地图的影响</a> 进行配置。  加入轮速里程计，线速度和角速度的来源是电机驱动器。 这样<code>odom</code>和<code>base_link</code>就不是重合的，不再需要<code>map</code>坐标系。代价地图中的全局坐标系为<code>odom</code>， 仍然不用LOAM。</p>
<p>跟随导航框架占用的CPU和网络带宽不大，不必过于考虑，可以加大性能的利用</p>
<h2 id="UWB数据的特点和处理"><a href="#UWB数据的特点和处理" class="headerlink" title="UWB数据的特点和处理"></a>UWB数据的特点和处理</h2><p>一定要先在UWB的配置程序上对UWB<strong>设置滤波</strong>，即从串口发送指定的十六进制数据。另外UWB充电时读不到数据</p>
<ol>
<li><p>静止时，UWB数据明显更稳定。隔着墙时，UWB数据非常不准确，不能使用，所以主要在室外使用。</p>
</li>
<li><p>移动时，UWB标签在近距离的数据波动比较大，尤其y会忽正忽负，导致朝向出错。在7m以上浮动小。可接收的距离最大30m。</p>
</li>
<li><p>x坐标偶尔会出现负值，这是不合理的，应过滤。有时相邻两个时间戳的数据差距过大，也应过滤。</p>
</li>
<li><p>UWB在某次启动程序后，一直<font color = red size = 4> load json error </font>，重启程序和UWB都无效，重启工控机后正常。 这种没办法避免。</p>
</li>
</ol>
<p>处理方法：</p>
<ul>
<li><p>UWB标签是在人身上的，如果直接取标签位置为<code>move_base/Goal</code>，那目标点在障碍物里，会直接规划失败，所以需要把目标点的坐标做一些处理。</p>
</li>
<li><p>对目标的朝向是使用<code>atan2(y,x)</code>计算，范围是 <script type="math/tex">[-\pi, \pi]</script>。实际应限制在<code>[-70°, 70°]</code></p>
</li>
<li><p>跟随是有一定距离的，在人离车比较近的时候，车会保持停止。正好可以避开UWB近距离数据波动大的缺点。</p>
</li>
<li><p>对x坐标负值情况return。 由于UWB有时读数据失败，因此不能再对相邻数据差距过大的情况进行滤波了。比如t时间的x坐标为x1, 然后没有读到数据，等再次读到数据x2时，二者相差很大，这时的x2应当保留，如果过滤，x2和以后的数据都不能保留了。 考虑再加入时间差的判断</p>
</li>
<li><p>对雷达的点云增加x方向的直通滤波(-6, 6)以及体素滤波(网格0.05)，降低带宽占用</p>
</li>
</ul>
<h2 id="待优化"><a href="#待优化" class="headerlink" title="待优化"></a>待优化</h2><ul>
<li><p>由于线速度和角速度来自<code>follow_server.py</code>，所以里程计的频率只能达到20Hz，能不能再增大。</p>
</li>
<li><p>无论目标走的快还是慢，机器人的速度不会改变。由于目标的坐标做过处理，当目标走的很慢时，机器人可能会停一会。 最好是机器人的速度随着目标的速度做改变。</p>
</li>
<li><p>机器人的最大速度要求3m/s，这就要求目标(话题 move_base_simple/goal)的发布频率要很快，但目前只能达到2Hz，再增大就报错</p>
</li>
<li><p>在降低 feasible_no_pose 和 min_obs_dist 情况下，大力神勉强能通过1.9米通道</p>
</li>
</ul>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2021/10/18/octomap%E5%92%8C%E5%85%AB%E5%8F%89%E6%A0%91/octomap_server/">octomap_server</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-10-18</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/octomap%E5%92%8C%E5%85%AB%E5%8F%89%E6%A0%91/">octomap和八叉树</a></span><div class="content"><p><code>octomap_server</code>除了将点云地图转化为基于Octree的OctoMap，还能将点云地图转化为二维地图。可以增量建3D的 OctoMaps，还提供了能保存地图的节点<code>octomap_saver</code>.  <code>octomap_server</code>节点很消耗内存，增量建图的过程中内存持续上升，因为当中不存在内存释放，没有静态储存八叉树图信息</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">node</span> <span class="attr">pkg</span>=<span class="string">&quot;octomap_server&quot;</span> <span class="attr">type</span>=<span class="string">&quot;octomap_server_node&quot;</span> <span class="attr">name</span>=<span class="string">&quot;octomap_server&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- resolution in meters per pixel --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">&quot;resolution&quot;</span> <span class="attr">value</span>=<span class="string">&quot;0.05&quot;</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- name of the fixed frame, needs to be &quot;/map&quot; for SLAM --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">&quot;frame_id&quot;</span> <span class="attr">type</span>=<span class="string">&quot;string&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$(arg frame_id)&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">&quot;sensor_model/max_range&quot;</span> <span class="attr">value</span>=<span class="string">&quot;150.0&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">&quot;latch&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 需要和 publish_pointcloud 的frame_id相同，否则会导致Octomap没有发布数据 --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- topic from where pointcloud2 messages are subscribed，改为自己的点云话题 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">remap</span> <span class="attr">from</span>=<span class="string">&quot;/cloud_in&quot;</span> <span class="attr">to</span>=<span class="string">&quot;$(arg cloud_topic)&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">remap</span> <span class="attr">from</span>=<span class="string">&quot;/projected_map&quot;</span> <span class="attr">to</span>=<span class="string">&quot;$(arg map_topic)&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">node</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>也就是将点云数据发布到一个指定的 topic 上，然后调用 Octomap 在ROS下的srv组件进行实时转换，并发布到另外一个 Octomap topic 上去，最后通过rviz 进行显示Octomap。注意octomap的输入话题（topic）和数据的坐标系(frame_id)两个参数的设置， 通常octomap 没有数据输出都是由于这两个参数设置错误导致的。</p>
<h2 id="Rviz配置"><a href="#Rviz配置" class="headerlink" title="Rviz配置"></a>Rviz配置</h2><p>安装<code>octomap-rviz-plugins</code>后，打开rviz,这时候点开Add选项，会多一个<code>octomap_rviz_plugins</code>模组。 其中的OccupancyGrid是显示三维概率地图，也就是octomap地图。OccupancyMap是显示二维占据栅格地图。<br><img src="https://i.loli.net/2021/10/18/xnEIHFoeLWtTY9a.png" alt=""><br>打开rviz，在里面添加OccupancyGrid，OccupancyMap，Map显示选项,显示话题选择<code>octomap_full</code>或者<code>octomap_binary</code></p>
<p>octomap topics are 3D occupancy maps, which would be used by some other 3D planning approach (e.g., move_it). They are not the same as /grid_map or /proj_map from rtabmap_ros.   For 3D trajectories (having to move in Z, e.g., quadcopter), then using OctoMap with OMPL/move_it can be another approach, though not sure if there is one most popular approach for the 3D case.</p>
<p>参考：<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/crp997576280/article/details/74605766">Octomap在ROS环境下实时显示，但点云来源是ORB稠密点云</a></p>
</div><hr></div><nav id="pagination"><div class="pagination"><a class="extend prev" rel="prev" href="/page/12/">&lt;&lt; Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/12/">12</a><span class="page-number current">13</span><a class="page-number" href="/page/14/">14</a><span class="space">&hellip;</span><a class="page-number" href="/page/60/">60</a><a class="extend next" rel="next" href="/page/14/">Next &gt;&gt;</a></div></nav></div></div><footer class="footer-bg" style="background-image: url(https://s2.loli.net/2022/02/18/exLTfbM3uFOq5SV.png)"><div class="layout" id="footer"><div class="copyright">&copy;2018 - 2022 By Charon Cheung</div><div class="framework-info"><span>Driven - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_site_uv"><i class="fa fa-user"></i><span id="busuanzi_value_site_uv"></span><span></span></span><span class="footer-separator">|</span><span id="busuanzi_container_site_pv"><i class="fa fa-eye"></i><span id="busuanzi_value_site_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.6.1"></script><script src="/js/fancybox.js?version=1.6.1"></script><script src="/js/sidebar.js?version=1.6.1"></script><script src="/js/copy.js?version=1.6.1"></script><script src="/js/fireworks.js?version=1.6.1"></script><script src="/js/transition.js?version=1.6.1"></script><script src="/js/scroll.js?version=1.6.1"></script><script src="/js/head.js?version=1.6.1"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
    processEscapes: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
  },
  CommonHTML: {
    linebreaks: { automatic: true, width: "90% container" }
  },
  "HTML-CSS": { 
    linebreaks: { automatic: true, width: "90% container" }
  },
  "SVG": { 
    linebreaks: { automatic: true, width: "90% container" }
  }
});
</script><script type="text/x-mathjax-config">MathJax.Hub.Queue(function() {
  var all = MathJax.Hub.getAllJax(), i;
  for (i=0; i < all.length; i += 1) {
    all[i].SourceElement().parentNode.className += ' has-jax';
  }
});
</script><script src="https://cdn.bootcss.com/mathjax/2.7.2/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script>if(/Android|webOS|iPhone|iPod|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
}</script></body></html>