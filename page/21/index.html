<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content=""><meta name="keywords" content=""><meta name="author" content="Charon Cheung"><meta name="copyright" content="Charon Cheung"><title>If you wish for peace, prepare for war | 沉默杀手</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.6.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.6.1"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  }
} </script><meta name="generator" content="Hexo 5.4.0"></head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="author-info"><div class="author-info__avatar text-center"><img src="https://s2.loli.net/2022/02/17/HQaCXUBn64zsMIL.png"></div><div class="author-info__name text-center">Charon Cheung</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">664</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">6</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">51</span></a></div></div></div><nav id="nav" style="background-image: url(https://s2.loli.net/2022/11/17/QOR8cePIS5NdDrK.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">沉默杀手</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span></div><div id="site-info"><div id="site-title">沉默杀手</div><div id="site-sub-title">If you wish for peace, prepare for war</div></div></nav><div id="content-outer"><div class="layout" id="content-inner"><div class="recent-post-item article-container"><a class="article-title" href="/2022/04/15/%E6%BF%80%E5%85%89SLAM/Cartographer/%E5%8E%9F%E7%90%86%E5%92%8C%E9%85%8D%E7%BD%AE/cartographer_grpc_server%E7%9A%84%E9%85%8D%E7%BD%AE/">cartographer_grpc_server的使用和配置</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-04-15</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E6%BF%80%E5%85%89SLAM/">激光SLAM</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E6%BF%80%E5%85%89SLAM/Cartographer/">Cartographer</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E6%BF%80%E5%85%89SLAM/Cartographer/%E5%8E%9F%E7%90%86%E5%92%8C%E9%85%8D%E7%BD%AE/">原理和配置</a></span><div class="content"><p>使用gRPC与云端结合：cartographer使用Protobuf数据传输协议，所以可以使用gRPC（也是谷歌的），可以通过云端运行cartographer算法，最典型的例子就是多机器人在一张已知地图上进行导航，在一个远程的强大centralized localization server运行 multi-trajectories Cartographer</p>
<p>方案：一台机器运行local optimization，另一台运行 global optimization</p>
<p>Cloud-based mapping ，using a gRPC streaming connection between local and global SLAM to propagate sensor data and local SLAM updates, which does not support ACKs and resending, hence this is not going to work over spotty WiFi.<br><img src="https://s2.loli.net/2022/04/15/luS9ofiMEh5c2mR.png" alt=""></p>
<p>先安装<code>protobuf</code>和<code>ceres</code></p>
<h2 id="安装-grpc"><a href="#安装-grpc" class="headerlink" title="安装 grpc"></a>安装 grpc</h2><p>一开始下载<code>grpc</code>后进行编译，结果报错：<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CMake Warning at cmake/abseil-cpp.cmake:30 (message):</span><br><span class="line">  gRPC_ABSL_PROVIDER is <span class="string">&quot;module&quot;</span> but ABSL_ROOT_DIR is wrong</span><br><span class="line">Call Stack (most recent call first):</span><br><span class="line">  CMakeLists.txt:188 (include)</span><br></pre></td></tr></table></figure><br>这说明第三方库没准备好，最好按如下步骤：</p>
<p>如果只想下载指定版本的，如以版本<code>1.27.3</code>为例，可改成如下语句：<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone -b v1<span class="number">.27</span><span class="number">.0</span> https:<span class="comment">//github.com/grpc/grpc.git</span></span><br></pre></td></tr></table></figure><br>上列操作成功完成后，gRPC 源码的第三方依赖目录 <code>third_party</code> 实际是空的，需通过下列步骤拉取依赖的第三方。切换到 grpc 目录，下载 grpc 第三方依赖到本地：<br><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git submodule update --init</span><br></pre></td></tr></table></figure><br>grpc依赖的第三方库有点多，如果不借助<code>git submodule</code>，手工一个个下载不太容易。其中的<code>bloaty</code>库很大。</p>
<p>注意，gRPC 要求 <code>CMake 3.5.1</code> 或以上版本的CMake，否则会报错 CMake 3.5.1 or higher is required </p>
<p>编译：<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cmake -DgRPC_SSL_PROVIDER=package ..</span><br><span class="line">make -j8</span><br><span class="line">sudo make install</span><br><span class="line"></span><br><span class="line">cmake  -DgRPC_INSTALL=ON -DgRPC_ZLIB_PROVIDER=package -DgRPC_CARES_PROVIDER=package -DgRPC_PROTOBUF_PROVIDER=package -DgRPC_SSL_PROVIDER=package -DgRPC_ABSL_PROVIDER=package ..</span><br><span class="line">make -j8</span><br><span class="line">sudo make install</span><br><span class="line"></span><br><span class="line">cmake  -DgRPC_INSTALL=ON -DBUILD_SHARED_LIBS=ON -DgRPC_ZLIB_PROVIDER=package -DgRPC_CARES_PROVIDER=package -DgRPC_PROTOBUF_PROVIDER=package -DgRPC_SSL_PROVIDER=package -DgRPC_ABSL_PROVIDER=package ..</span><br><span class="line">make -j8</span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure></p>
<h2 id="CMake配置"><a href="#CMake配置" class="headerlink" title="CMake配置"></a>CMake配置</h2><p>在包含<code>option(BUILD_GRPC &quot;build Cartographer gRPC support&quot; false)</code>的3个<code>CMakeLists</code>修改为true。 最好再添加 <code>set(BUILD_GRPC true)</code>，以及C++14的支持  <code>set(CMAKE_CXX_STANDARD 14)</code></p>
<h2 id="lua配置"><a href="#lua配置" class="headerlink" title="lua配置"></a>lua配置</h2><p><code>backpack_2d_server.lua</code>如下:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">include <span class="string">&quot;map_builder_server.lua&quot;</span></span><br><span class="line"></span><br><span class="line">MAP_BUILDER_SERVER.map_builder.use_trajectory_builder_2d = <span class="keyword">true</span></span><br><span class="line"><span class="keyword">return</span> MAP_BUILDER_SERVER</span><br></pre></td></tr></table></figure></p>
<p><code>map_builder_server.lua</code>如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">include <span class="string">&quot;map_builder.lua&quot;</span></span><br><span class="line"></span><br><span class="line">MAP_BUILDER_SERVER = &#123;</span><br><span class="line">  map_builder = MAP_BUILDER,</span><br><span class="line">  num_event_threads = <span class="number">4</span>,</span><br><span class="line">  num_grpc_threads = <span class="number">4</span>,</span><br><span class="line">  --- 我的修改</span><br><span class="line">  server_address = <span class="string">&quot;192.168.0.105:50051&quot;</span>,</span><br><span class="line">  uplink_server_address = <span class="string">&quot;&quot;</span>,</span><br><span class="line">  upload_batch_size = <span class="number">100</span>,</span><br><span class="line">  enable_ssl_encryption = <span class="keyword">false</span>,</span><br><span class="line">  enable_google_auth = <span class="keyword">false</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="运行数据集"><a href="#运行数据集" class="headerlink" title="运行数据集"></a>运行数据集</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">roslaunch cartographer_ros grpc_demo_backpack_2d.launch bag_filename:=/home/user/cartographer/dataset/cartographer_paper_deutsches_museum.bag</span><br></pre></td></tr></table></figure>
<p>这是在一台机上运行客户端和服务端<br><img src="https://s2.loli.net/2022/08/21/thAPe3QlsTKYyRc.png" alt=""><br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">launch</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">&quot;/use_sim_time&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">&quot;robot_description&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">textfile</span>=<span class="string">&quot;$(find cartographer_ros)/urdf/backpack_2d.urdf&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">node</span> <span class="attr">name</span>=<span class="string">&quot;robot_state_publisher&quot;</span> <span class="attr">pkg</span>=<span class="string">&quot;robot_state_publisher&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">type</span>=<span class="string">&quot;robot_state_publisher&quot;</span> /&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- 服务端 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">node</span> <span class="attr">name</span>=<span class="string">&quot;cartographer_grpc_server&quot;</span> <span class="attr">pkg</span>=<span class="string">&quot;cartographer_ros&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">type</span>=<span class="string">&quot;cartographer_grpc_server.sh&quot;</span> <span class="attr">args</span>=<span class="string">&quot;</span></span></span><br><span class="line"><span class="string"><span class="tag">          -configuration_directory $(find cartographer_ros)/configuration_files</span></span></span><br><span class="line"><span class="string"><span class="tag">          -configuration_basename backpack_2d_server.lua&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">node</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- 客户端 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">node</span> <span class="attr">name</span>=<span class="string">&quot;cartographer_grpc_node&quot;</span> <span class="attr">pkg</span>=<span class="string">&quot;cartographer_ros&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">type</span>=<span class="string">&quot;cartographer_grpc_node&quot;</span> <span class="attr">args</span>=<span class="string">&quot;</span></span></span><br><span class="line"><span class="string"><span class="tag">    -client_id CLIENT_ID</span></span></span><br><span class="line"><span class="string"><span class="tag">          -configuration_directory $(find cartographer_ros)/configuration_files</span></span></span><br><span class="line"><span class="string"><span class="tag">          -configuration_basename backpack_2d.lua&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">output</span>=<span class="string">&quot;screen&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">remap</span> <span class="attr">from</span>=<span class="string">&quot;echoes&quot;</span> <span class="attr">to</span>=<span class="string">&quot;horizontal_laser_2d&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">node</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">node</span> <span class="attr">name</span>=<span class="string">&quot;playbag&quot;</span> <span class="attr">pkg</span>=<span class="string">&quot;rosbag&quot;</span> <span class="attr">type</span>=<span class="string">&quot;play&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">args</span>=<span class="string">&quot;--clock $(arg bag_filename)&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">node</span> <span class="attr">name</span>=<span class="string">&quot;rviz&quot;</span> <span class="attr">pkg</span>=<span class="string">&quot;rviz&quot;</span> <span class="attr">type</span>=<span class="string">&quot;rviz&quot;</span> <span class="attr">required</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">args</span>=<span class="string">&quot;-d $(find cartographer_ros)/configuration_files/demo_2d.rviz&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">launch</span>&gt;</span></span><br></pre></td></tr></table></figure><br>就是<code>CLIENT_ID</code>，无需设置为数字。</p>
<h2 id="真实运行"><a href="#真实运行" class="headerlink" title="真实运行"></a>真实运行</h2><ul>
<li>把客户端上的<code>ROS_MASTER_URI</code>设置为服务端的IP</li>
<li>rviz放在服务端。</li>
<li>服务端的终端刷新日志，客户端不刷新</li>
<li>网络不能差，否则服务端刷新慢。</li>
<li>连接成功后，关服务端，客户端也会终止。连接成功后，关客户端，服务端停止刷新；再启动客户端，服务端继续更新。</li>
</ul>
<p>客户端<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">launch</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">node</span> <span class="attr">name</span>=<span class="string">&quot;cartographer_grpc_node&quot;</span> <span class="attr">pkg</span>=<span class="string">&quot;cartographer_ros&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">type</span>=<span class="string">&quot;cartographer_grpc_node&quot;</span> <span class="attr">args</span>=<span class="string">&quot;</span></span></span><br><span class="line"><span class="string"><span class="tag">      -client_id CLIENT_ID</span></span></span><br><span class="line"><span class="string"><span class="tag">      -server_address 192.168.1.213:50051</span></span></span><br><span class="line"><span class="string"><span class="tag">          -configuration_directory $(find cartographer_ros)/configuration_files</span></span></span><br><span class="line"><span class="string"><span class="tag">          -configuration_basename backpack_2d.lua&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">output</span>=<span class="string">&quot;screen&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">remap</span> <span class="attr">from</span>=<span class="string">&quot;/scan&quot;</span> <span class="attr">to</span>=<span class="string">&quot;/sick_tim551_scan&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">remap</span> <span class="attr">from</span>=<span class="string">&quot;/odom&quot;</span> <span class="attr">to</span>=<span class="string">&quot;/odometry/filtered&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">node</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">launch</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>服务端<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">launch</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">node</span> <span class="attr">name</span>=<span class="string">&quot;cartographer_grpc_server&quot;</span> <span class="attr">pkg</span>=<span class="string">&quot;cartographer_ros&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">type</span>=<span class="string">&quot;cartographer_grpc_server.sh&quot;</span> <span class="attr">args</span>=<span class="string">&quot;</span></span></span><br><span class="line"><span class="string"><span class="tag">          -configuration_directory $(find cartographer_ros)/configuration_files</span></span></span><br><span class="line"><span class="string"><span class="tag">          -configuration_basename backpack_2d_server.lua&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">node</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">node</span> <span class="attr">name</span>=<span class="string">&quot;rviz&quot;</span> <span class="attr">pkg</span>=<span class="string">&quot;rviz&quot;</span> <span class="attr">type</span>=<span class="string">&quot;rviz&quot;</span> <span class="attr">required</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">args</span>=<span class="string">&quot;-d $(find cartographer_ros)/configuration_files/demo_2d.rviz&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">launch</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<h2 id="纯定位"><a href="#纯定位" class="headerlink" title="纯定位"></a>纯定位</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">node</span> <span class="attr">name</span>=<span class="string">&quot;cartographer_grpc_node&quot;</span> <span class="attr">pkg</span>=<span class="string">&quot;cartographer_ros&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">type</span>=<span class="string">&quot;cartographer_grpc_node&quot;</span> <span class="attr">args</span>=<span class="string">&quot;</span></span></span><br><span class="line"><span class="string"><span class="tag">        -client_id CLIENT_ID</span></span></span><br><span class="line"><span class="string"><span class="tag">        -configuration_directory $(find cartographer_ros)/configuration_files</span></span></span><br><span class="line"><span class="string"><span class="tag">        -configuration_basename backpack_2d_localization.lua</span></span></span><br><span class="line"><span class="string"><span class="tag">        -load_state_filename $(arg load_state_filename)&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">output</span>=<span class="string">&quot;screen&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">remap</span> <span class="attr">from</span>=<span class="string">&quot;echoes&quot;</span> <span class="attr">to</span>=<span class="string">&quot;horizontal_laser_2d&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">node</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>参考：<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/windxf/article/details/108868236">运行cartographer的gRPC demo</a><br><a target="_blank" rel="noopener" href="http://txgcwm.github.io/blog/2014/03/26/ubuntuxia-an-zhuang-c-aresku/">Ubuntu下安装c-ares库</a></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2022/04/15/%E6%BF%80%E5%85%89SLAM/Cartographer/%E5%8E%9F%E7%90%86%E5%92%8C%E9%85%8D%E7%BD%AE/%E5%A6%82%E4%BD%95%E6%89%93%E5%8D%B0%E5%BD%93%E5%89%8D%E4%BD%BF%E7%94%A8%E7%9A%84lua%E5%8F%82%E6%95%B0/">如何打印当前使用的lua参数</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-04-15</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E6%BF%80%E5%85%89SLAM/">激光SLAM</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E6%BF%80%E5%85%89SLAM/Cartographer/">Cartographer</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E6%BF%80%E5%85%89SLAM/Cartographer/%E5%8E%9F%E7%90%86%E5%92%8C%E9%85%8D%E7%BD%AE/">原理和配置</a></span><div class="content"><p>这里就是使用<code>cartographer_print_configuration</code>，它输出了当前cartographer使用的所有lua参数，虽然不如rosparam强大，但也是一种方法，本质就是读取加载的lua文件。</p>
<p>代码比较简单，不用太过研究，直接写launch<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">launch</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">node</span> <span class="attr">name</span>=<span class="string">&quot;print_mit_config&quot;</span> <span class="attr">pkg</span>=<span class="string">&quot;cartographer_ros&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">type</span>=<span class="string">&quot;cartographer_print_configuration&quot;</span> <span class="attr">args</span>=<span class="string">&quot;</span></span></span><br><span class="line"><span class="string"><span class="tag">          -configuration_directories $(find cartographer_ros)/configuration_files</span></span></span><br><span class="line"><span class="string"><span class="tag">          -configuration_basename mit_stata_odom.lua</span></span></span><br><span class="line"><span class="string"><span class="tag">	  	  -subdictionary map_builder&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">output</span>=<span class="string">&quot;screen&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">node</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">launch</span>&gt;</span></span><br></pre></td></tr></table></figure><br>运行后会报错，找不到<code>cartographer_print_configuration</code>，这是因为可执行文件在bin路径: <code>/home/user/carto_ws/install_isolated/bin/cartographer_print_configuration</code>，roslaunch找的是<code>/home/user/carto_ws/install_isolated/lib/cartographer_ros</code>路径下的文件，复制到这里就好了。</p>
<p>运行launch就会输出所有lua参数，自己设置的参数也会覆盖默认的。 另外还有个<code>subdictionary</code>参数，输出的是子参数，这里用map_builder。但是只能输出第一级的子参数，如果自参数太底层就会报错，比如<code>submaps</code>做子参数就会运行错误。</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2022/04/13/%E6%BF%80%E5%85%89SLAM/LOAM%E7%B3%BB%E5%88%97/%E7%82%B9%E4%BA%91%E5%9C%B0%E5%9B%BE/">点云地图</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-04-13</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/LOAM%E7%B3%BB%E5%88%97/">LOAM系列</a></span><div class="content"><ul>
<li><p>去除噪点：激光雷达扫的点云有很多噪点，需要用PCL移除噪点。有的是孤立点，有的是激光打到边缘产生的衍射现象，衍射产生的点也要移除。</p>
</li>
<li><p>降采样：激光的数据量很大，需要用Voxel进行降采样</p>
</li>
<li><p>移除行人： 动态障碍，没必要采用</p>
</li>
<li><p>移除地面： 地面不是重要的参考，也要移除</p>
</li>
<li><p>点云变换和增量式注册： </p>
</li>
<li><p>mesh化： 点云地图建好后，把点云用边连起来，形成三维模型，再用Matlab进行处理</p>
</li>
</ul>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2022/04/13/%E6%BF%80%E5%85%89SLAM/Cartographer/%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/cartographer_occupancy_grid_node%E8%8E%B7%E5%8F%96%E5%9C%B0%E5%9B%BE/">cartographer_occupancy_grid_node获取地图</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-04-13</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E6%BF%80%E5%85%89SLAM/">激光SLAM</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E6%BF%80%E5%85%89SLAM/Cartographer/">Cartographer</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E6%BF%80%E5%85%89SLAM/Cartographer/%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/">源码解读</a></span><div class="content"><p>Rviz中的地图绘制使用了<code>cairo</code>库。注意gflag的参数<code>include_frozen_submaps</code> 和 <code>include_unfrozen_submaps</code>不能都为false，否则会报错</p>
<p>cartographer<em>rviz的绘制方式，就是`submap_node</em><code>控制一个子图的绘制，每个子图有一个子图原点，这个是</code>submap_query<code>中的</code>slice_pose<code>。而每个子图之间是有微弱旋转的，而控制旋转的中心也是这个</code>slice_pose<code>。而每个子图之间的旋转和平移可以通过</code>submap_list`的pose得到。</p>
<p><code>main</code>函数值得看的就一句<code>::cartographer_ros::Node node(FLAGS_resolution, FLAGS_publish_period_sec);</code>，构造函数如下<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">Node::<span class="built_in">Node</span>(<span class="keyword">const</span> <span class="keyword">double</span> resolution, <span class="keyword">const</span> <span class="keyword">double</span> publish_period_sec)</span><br><span class="line">: <span class="built_in">resolution_</span>(resolution),</span><br><span class="line">	<span class="comment">// submap_query 服务的客户端</span></span><br><span class="line">  <span class="built_in">client_</span>(node_handle_.serviceClient&lt;::cartographer_ros_msgs::SubmapQuery&gt;(</span><br><span class="line">      kSubmapQueryServiceName)),</span><br><span class="line">  <span class="comment">// submap_list话题的订阅者，回调函数 HandleSubmapList</span></span><br><span class="line">  <span class="built_in">submap_list_subscriber_</span>(node_handle_.<span class="built_in">subscribe</span>(</span><br><span class="line">      kSubmapListTopic, kLatestOnlyPublisherQueueSize,</span><br><span class="line">      boost::function&lt;<span class="built_in"><span class="keyword">void</span></span>(</span><br><span class="line">          <span class="keyword">const</span> cartographer_ros_msgs::SubmapList::ConstPtr&amp;)&gt;(</span><br><span class="line">          [<span class="keyword">this</span>](<span class="keyword">const</span> cartographer_ros_msgs::SubmapList::ConstPtr&amp; msg) &#123;</span><br><span class="line">            <span class="built_in">HandleSubmapList</span>(msg);</span><br><span class="line">          &#125;))),</span><br><span class="line">  <span class="comment">// 发布话题 map</span></span><br><span class="line">  <span class="built_in">occupancy_grid_publisher_</span>(</span><br><span class="line">      node_handle_.advertise&lt;::nav_msgs::OccupancyGrid&gt;(</span><br><span class="line">          kOccupancyGridTopic, kLatestOnlyPublisherQueueSize,</span><br><span class="line">          <span class="literal">true</span> <span class="comment">/* latched */</span>)),</span><br><span class="line">  <span class="comment">// timer执行DrawAndPublish函数</span></span><br><span class="line">  <span class="built_in">occupancy_grid_publisher_timer_</span>(</span><br><span class="line">      node_handle_.<span class="built_in">createWallTimer</span>(::ros::<span class="built_in">WallDuration</span>(publish_period_sec),</span><br><span class="line">                                   &amp;Node::DrawAndPublish, <span class="keyword">this</span>)) &#123;&#125;</span><br></pre></td></tr></table></figure><br><code>Node::DrawAndPublish</code>是画图和发布<code>map</code>，不是重点</p>
<p><br></p>
<p><code>HandleSubmapList</code>函数大部分都很简单，终点是下面这句：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">auto</span> fetched_textures =</span><br><span class="line">        ::cartographer_ros::<span class="built_in">FetchSubmapTextures</span>(id, &amp;client_);</span><br></pre></td></tr></table></figure><br>内部其实就是<code>submap_query</code>的客户端发起请求，服务端的注册在<code>Node</code>的构造函数里，回调是<code>Node::HandleSubmapQuery</code></p>
<p>代码调用顺序是： <code>Node::HandleSubmapQuery</code> —— <code>MapBuilderBridge::HandleSubmapQuery</code> —— <code>MapBuilder::SubmapToProto</code> —— <code>PoseGraph2D::GetSubmapData</code> 和 <code>Submap2D::ToResponseProto</code>  —— <code>ProbabilityGrid::DrawToSubmapTexture</code></p>
<p>重点：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这里比较简单，最终返回的是后端传来的 global坐标系下的位姿</span></span><br><span class="line"><span class="function">PoseGraphInterface::SubmapData <span class="title">PoseGraph2D::GetSubmapDataUnderLock</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">const</span> SubmapId&amp; submap_id)</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">auto</span> it = data_.submap_data.<span class="built_in">find</span>(submap_id);</span><br><span class="line">  <span class="keyword">if</span> (it == data_.submap_data.<span class="built_in">end</span>())</span><br><span class="line">      <span class="keyword">return</span> &#123;&#125;;</span><br><span class="line">  <span class="keyword">auto</span> submap = it-&gt;data.submap;</span><br><span class="line">  <span class="keyword">if</span> (data_.global_submap_poses_2d.<span class="built_in">Contains</span>(submap_id) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// We already have an optimized pose.</span></span><br><span class="line">    <span class="keyword">return</span> &#123;submap,</span><br><span class="line">            transform::<span class="built_in">Embed3D</span>(</span><br><span class="line">                data_.global_submap_poses_2d.<span class="built_in">at</span>(submap_id).global_pose) &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// We have to extrapolate.</span></span><br><span class="line">  <span class="keyword">return</span> &#123;submap, <span class="built_in">ComputeLocalToGlobalTransform</span>(data_.global_submap_poses_2d,</span><br><span class="line">                                                submap_id.trajectory_id) *</span><br><span class="line">                      submap-&gt;<span class="built_in">local_pose</span>() &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Submap2D::ToResponseProto</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">const</span> transform::Rigid3d&amp;,</span></span></span><br><span class="line"><span class="params"><span class="function">    proto::SubmapQuery::Response* <span class="keyword">const</span> response)</span> <span class="keyword">const</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!grid_)  	<span class="keyword">return</span>;</span><br><span class="line">  <span class="comment">// 这个 version 是子图插入了多少雷达数据，完成的子图是 2* num_range_data</span></span><br><span class="line">  response-&gt;<span class="built_in">set_submap_version</span>( <span class="built_in">num_range_data</span>()  );</span><br><span class="line">  proto::SubmapQuery::Response::SubmapTexture* <span class="keyword">const</span> texture =</span><br><span class="line">      response-&gt;<span class="built_in">add_textures</span>();</span><br><span class="line">  <span class="built_in">grid</span>()-&gt;<span class="built_in">DrawToSubmapTexture</span>(texture, <span class="built_in">local_pose</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>再看<code>DrawToSubmapTexture</code><br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">ProbabilityGrid::DrawToSubmapTexture</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    proto::SubmapQuery::Response::SubmapTexture* <span class="keyword">const</span> texture,</span></span></span><br><span class="line"><span class="params"><span class="function">    transform::Rigid3d local_pose)</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  Eigen::Array2i offset;</span><br><span class="line">  CellLimits cell_limits;</span><br><span class="line">  <span class="built_in">ComputeCroppedLimits</span>(&amp;offset, &amp;cell_limits);</span><br><span class="line"></span><br><span class="line">  std::string cells;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> Eigen::Array2i&amp; xy_index : <span class="built_in">XYIndexRangeIterator</span>(cell_limits))</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">IsKnown</span>(xy_index + offset)) &#123;</span><br><span class="line">      cells.<span class="built_in">push_back</span>(<span class="number">0</span> <span class="comment">/* unknown log odds value */</span>);</span><br><span class="line">      cells.<span class="built_in">push_back</span>(<span class="number">0</span> <span class="comment">/* alpha */</span>);</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// We would like to add &#x27;delta&#x27; but this is not possible using a value and</span></span><br><span class="line">    <span class="comment">// alpha. We use premultiplied alpha, so when &#x27;delta&#x27; is positive we can</span></span><br><span class="line">    <span class="comment">// add it by setting &#x27;alpha&#x27; to zero. If it is negative, we set &#x27;value&#x27; to</span></span><br><span class="line">    <span class="comment">// zero, and use &#x27;alpha&#x27; to subtract. This is only correct when the pixel</span></span><br><span class="line">    <span class="comment">// is currently white, so walls will look too gray. This should be hard to</span></span><br><span class="line">    <span class="comment">// detect visually for the user, though.</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// delta范围[-127, 127]</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> delta =</span><br><span class="line">        <span class="number">128</span> - <span class="built_in">ProbabilityToLogOddsInteger</span>(<span class="built_in">GetProbability</span>(xy_index + offset));</span><br><span class="line">    <span class="keyword">const</span> uint8 alpha = delta &gt; <span class="number">0</span> ? <span class="number">0</span> : -delta;</span><br><span class="line">    <span class="keyword">const</span> uint8 value = delta &gt; <span class="number">0</span> ? delta : <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 存数据有2个值，栅格值value和alpha透明度</span></span><br><span class="line">    cells.<span class="built_in">push_back</span>(value);</span><br><span class="line">    cells.<span class="built_in">push_back</span>((value || alpha) ? alpha : <span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 保存地图栅格数据时进行压缩</span></span><br><span class="line">  common::<span class="built_in">FastGzipString</span>(cells, texture-&gt;<span class="built_in">mutable_cells</span>());</span><br><span class="line">  <span class="comment">// 地图描述信息赋值，省略</span></span><br><span class="line">  	......</span><br><span class="line">  *texture-&gt;<span class="built_in">mutable_slice_pose</span>() = transform::<span class="built_in">ToProto</span>(</span><br><span class="line">      local_pose.<span class="built_in">inverse</span>() *</span><br><span class="line">      transform::Rigid3d::<span class="built_in">Translation</span>(Eigen::<span class="built_in">Vector3d</span>(max_x, max_y, <span class="number">0.</span>))  );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 解压后的栅格数据</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">SubmapTexture</span> &#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">Pixels</span> &#123;</span></span><br><span class="line">    std::vector&lt;<span class="keyword">char</span>&gt; intensity;   <span class="comment">// 栅格值</span></span><br><span class="line">    std::vector&lt;<span class="keyword">char</span>&gt; alpha;      <span class="comment">// 透明度</span></span><br><span class="line">  &#125;;</span><br><span class="line">  Pixels pixels;</span><br><span class="line">  <span class="keyword">int</span> width;</span><br><span class="line">  <span class="keyword">int</span> height;</span><br><span class="line">  <span class="keyword">double</span> resolution;</span><br><span class="line">  ::cartographer::transform::Rigid3d slice_pose;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 压缩后的栅格数据</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">SubmapTextures</span> &#123;</span></span><br><span class="line">  <span class="keyword">int</span> version;</span><br><span class="line">  std::vector&lt;SubmapTexture&gt; textures;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2022/04/03/%E6%BF%80%E5%85%89SLAM/Cartographer/%E5%8E%9F%E7%90%86%E5%92%8C%E9%85%8D%E7%BD%AE/MIT%E5%92%8C%E8%BD%AF%E4%BB%B6%E6%89%80%E7%9A%84%E6%95%B0%E6%8D%AE%E9%9B%86/">MIT和软件所的数据集</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-04-03</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E6%BF%80%E5%85%89SLAM/">激光SLAM</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E6%BF%80%E5%85%89SLAM/Cartographer/">Cartographer</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E6%BF%80%E5%85%89SLAM/Cartographer/%E5%8E%9F%E7%90%86%E5%92%8C%E9%85%8D%E7%BD%AE/">原理和配置</a></span><div class="content"><p>根据我的经验，先启动cartographer后，等待出现下面的日志，然后再播放bag。如果这个日志没出现，播放bag通常不会成功开始建图<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[/cartographer_node   node.cc:<span class="number">886</span>] Expected topic <span class="string">&quot;scan&quot;</span> (trajectory <span class="number">0</span>) (resolved topic <span class="string">&quot;/base_scan&quot;</span>) but no publisher is currently active.</span><br><span class="line">[/cartographer_node   node.cc:<span class="number">895</span>] Currently available topics are: /constraint_list,/submap_list,/scan_matched_points2,/rosout,/tf,/rosout_agg,/map,/trajectory_node_list,/landmark_poses_list,</span><br></pre></td></tr></table></figure></p>
<p><strong>MIT数据集老出问题，德意志博物馆数据集却从不出问题</strong>， <font size="4" color="blue"> 最好数据集里不要有tf信息  </font><br><img src="https://s2.loli.net/2022/11/17/yG1RzQxHUSkYjcV.png" alt="博物馆的tf"><br><img src="https://s2.loli.net/2022/11/17/BnvgP4eVhTL9JG6.png" alt="MIT数据集的 tf"></p>
<p>博物馆的地图大小 3066平方米</p>
<h2 id="MIT的数据集运行"><a href="#MIT的数据集运行" class="headerlink" title="MIT的数据集运行"></a>MIT的数据集运行</h2><p>这个数据集使用雷达北洋UTM-30LX，也就是LOAM论文所用的雷达，有一个问题是它的机器人是会坐电梯在楼层之间跑的，因此需要选择一个只在一个平面上跑的数据集<code>2011-03-28-08-38-59.bag</code></p>
<p>从TF变换树可以看到，这里的里程计信息是采用经过EKF滤波之后的里程计坐标系<code>/robot_pose_ekf/odom_combined</code>，而不是直接的<code>base_odometry/odom</code>。<strong>第2个问题</strong>来了：cartographer需要的里程计消息是<code>nav_msgs/Odometry</code>，但是<code>/robot_pose_ekf/odom_combined</code>的类型是<code>geometry_msgs/PoseWithCovarianceStamped</code>，在播放rosbag时会报错，无法建图。于是想用原来的里程计<code>/base_odometry/odom</code>，结果发现缺少<code>child_frame_id</code>，一般为<code>base_link</code>。无法给bag消息加坐标系，只能写一个程序<code>mit_to_odom</code>做转换</p>
<p>我们要使用数据集的IMU和odom，否则建图不能进行，日志如下<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[/cartographer_node] [local_trajectory_builder_2d.cc:<span class="number">136</span>] time_first_point: <span class="number">634369235390529797</span></span><br><span class="line">[/cartographer_node] [local_trajectory_builder_2d.cc:<span class="number">137</span>] GetLastPoseTime: <span class="number">634369235390647384</span></span><br><span class="line">[/cartographer_node] [local_trajectory_builder_2d.cc:<span class="number">138</span>] Extrapolator is still initializing</span><br><span class="line">[/cartographer_node] [pose_graph_2d.cc:<span class="number">148</span>] <span class="function">Inserted <span class="title">submap</span> <span class="params">(<span class="number">0</span>, <span class="number">0</span>)</span>.</span></span><br></pre></td></tr></table></figure><br>阻塞在<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (time_first_point &lt; extrapolator_-&gt;<span class="built_in">GetLastPoseTime</span>() )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">LOG</span>(INFO) &lt;&lt; <span class="string">&quot;Extrapolator is still initializing.&quot;</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>launch如下，不能加<code>&lt;param name=&quot;/use_sim_time&quot; value=&quot;true&quot; /&gt;</code>，否则cartographer一直阻塞。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">launch</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">node</span> <span class="attr">name</span>=<span class="string">&quot;cartographer_node&quot;</span> <span class="attr">pkg</span>=<span class="string">&quot;cartographer_ros&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">type</span>=<span class="string">&quot;cartographer_node&quot;</span> <span class="attr">args</span>=<span class="string">&quot;</span></span></span><br><span class="line"><span class="string"><span class="tag">          -configuration_directory $(find cartographer_ros)/configuration_files</span></span></span><br><span class="line"><span class="string"><span class="tag">          -configuration_basename mit_stata_odom.lua&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">output</span>=<span class="string">&quot;screen&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">remap</span> <span class="attr">from</span>=<span class="string">&quot;scan&quot;</span> <span class="attr">to</span>=<span class="string">&quot;base_scan&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">remap</span> <span class="attr">from</span>=<span class="string">&quot;imu&quot;</span> <span class="attr">to</span>=<span class="string">&quot;torso_lift_imu/data&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">node</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">node</span> <span class="attr">name</span>=<span class="string">&quot;cartographer_occupancy_grid_node&quot;</span> <span class="attr">pkg</span>=<span class="string">&quot;cartographer_ros&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">type</span>=<span class="string">&quot;cartographer_occupancy_grid_node&quot;</span> <span class="attr">args</span>=<span class="string">&quot;-resolution 0.05&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">launch</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<h3 id="TF-REPEATED-DATA-问题"><a href="#TF-REPEATED-DATA-问题" class="headerlink" title="TF_REPEATED_DATA 问题"></a>TF_REPEATED_DATA 问题</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Warning: TF_REPEATED_DATA ignoring data with redundant timestamp <span class="keyword">for</span> frame odom at time <span class="number">1301326803.532597</span> according to authority unknown_publisher</span><br><span class="line">         at line <span class="number">278</span> in /tmp/binarydeb/ros-noetic-tf2-<span class="number">0.7</span><span class="number">.5</span>/src/buffer_core.cpp</span><br></pre></td></tr></table></figure>
<p>这个问题困扰了我好长时间，后来发现是数据集发布了坐标转换<code>odom_combined</code> —— <code>base_footprint</code>，而cartographer也容易发布这个变换，此时仍然可以建图，但这个报警无穷无尽，没法看其他日志了。</p>
<p>如此解决：首先在播放bag的终端，先运行<code>rosparam set use_sim_time true</code>，lua设置如下<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">map_frame = <span class="string">&quot;map&quot;</span>,</span><br><span class="line">tracking_frame = <span class="string">&quot;imu_link&quot;</span>,</span><br><span class="line">published_frame = <span class="string">&quot;odom_combined&quot;</span>,</span><br><span class="line">odom_frame = <span class="string">&quot;odom_combined&quot;</span>,</span><br><span class="line"></span><br><span class="line">provide_odom_frame = <span class="literal">false</span>,  </span><br><span class="line">use_odometry = <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">TRAJECTORY_BUILDER_2D.use_imu_data = <span class="literal">true</span></span><br></pre></td></tr></table></figure></p>
<p>但是Rviz终端也出现了报警，按说把Rviz里的<code>Submaps</code>的Tracking Frame改为lua 文件中的 <code>tracking_frame</code> 即可，但是我改了后无效，把<code>base_footprint</code>和<code>base_link</code>都试了一遍也没有解决<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[ WARN] Could not compute submap fading: Could not find a connection between <span class="string">&#x27;map&#x27;</span> and <span class="string">&#x27;base_link&#x27;</span> because they are not part of the same tree.Tf has two or more unconnected trees</span><br></pre></td></tr></table></figure></p>
<font size="4" color="blue">  这样导致无法获得`base_link`在`map`中的坐标 </font> 


<h3 id="map-和-base-link的关系问题"><a href="#map-和-base-link的关系问题" class="headerlink" title="map 和 base_link的关系问题"></a><code>map</code> 和 <code>base_link</code>的关系问题</h3><p>数据集中已经包含了<code>odom_combined</code>和<code>base_link</code>之间的tf关系，运行carto之后会获得<code>odom_combined</code>和<code>map</code>之间的关系，但是无法获得<code>map</code>和<code>base_link</code>之间的tf，运行<code>rosrun tf tf_echo map base_link</code>报警如下<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Exception thrown:Lookup would require extrapolation <span class="number">367325588.</span>004024029s into the past.  Requested time <span class="number">1301326755.953867912</span> but the earliest data is at time <span class="number">1668652343.957891941</span>, when looking up transform from frame [base_link] to frame [map]</span><br></pre></td></tr></table></figure><br><code>1668652343</code>是当前时间的，<code>1301326755</code>是数据集中的时间。<font size="4" color="orange"> 目前未解决  </font></p>
<h2 id="软件所的数据集运行"><a href="#软件所的数据集运行" class="headerlink" title="软件所的数据集运行"></a>软件所的数据集运行</h2><p><img src="https://s2.loli.net/2022/11/17/SageUnGRjQ3fNDF.png" alt=""><br>不需要在任何地方设置<code>use_sim_time</code>，如果出现时间戳问题，关掉一切节点，重新开始roscore。launch里不能加<code>&lt;param name=&quot;/use_sim_time&quot; value=&quot;true&quot; /&gt;</code>，否则cartographer一直阻塞。</p>
<p>问题:</p>
<ol>
<li><p><code>scan</code>话题里的坐标系是<code>laser</code>，这是驱动程序决定的。但是<code>tf</code>里的坐标系变成了<code>laser_mount_link</code>，到了<code>tf_bridge_.LookupToTracking</code>那里卡住了，即使手动改了源码也不行。</p>
</li>
<li><p>坐标系名称带了<code>/</code>，这个其实在cartographer里会被解决，但是习惯上不要加上。</p>
</li>
<li><p>也无法获得<code>map</code>到<code>base_link</code>的转换。</p>
</li>
<li><p><code>tfecho map odom</code>会发现位姿跳变极大，<font size="4" color="orange">  还没搞清楚， </font>不是是否和时间戳有关<br><img src="https://s2.loli.net/2022/12/21/bXUdoimK3OVIZTw.png" alt=""></p>
</li>
</ol>
<p>参考：<br><a target="_blank" rel="noopener" href="http://wiki.ros.org/tf/Errors%20explained">TF_OLD_DATA 问题</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_55937915/article/details/126875442">TF_OLD_DATA的另一种原因</a></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2022/04/02/%E8%B7%AF%E5%BE%84%E8%A7%84%E5%88%92/move_base%20%E5%88%86%E6%9E%90/move_base%E7%9A%84%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%92%8C%E5%AE%A2%E6%88%B7%E7%AB%AF/">move_base的服务端和客户端</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-04-02</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E8%B7%AF%E5%BE%84%E8%A7%84%E5%88%92/">路径规划</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E8%B7%AF%E5%BE%84%E8%A7%84%E5%88%92/move-base%E5%88%86%E6%9E%90/">move_base分析</a></span><div class="content"><p><code>find_package</code>中添加<code>actionlib</code> 和 <code>actionlib_msgs</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">add_action_files</span>(</span><br><span class="line">   DIRECTORY action</span><br><span class="line">   FILES</span><br><span class="line">   DoDishes.action</span><br><span class="line"> )</span><br></pre></td></tr></table></figure>
<p><code>package.xml</code>添加<code>actionlib</code>的编译和执行依赖，如下:<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;build_depend&gt;actionlib&lt;/build_depend&gt;</span><br><span class="line">&lt;build_depend&gt;actionlib_msgs&lt;/build_depend&gt;</span><br><span class="line">&lt;run_depend&gt;actionlib&lt;/run_depend&gt;</span><br><span class="line">&lt;run_depend&gt;actionlib_msgs&lt;/run_depend&gt;</span><br></pre></td></tr></table></figure></p>
<h2 id="服务端"><a href="#服务端" class="headerlink" title="服务端"></a>服务端</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// action定义在 scheduler/action/Scheduler.action</span></span><br><span class="line"><span class="keyword">typedef</span> actionlib::SimpleActionServer&lt;scheduler::SchedulerAction&gt; Server;</span><br><span class="line">actionlib::SimpleActionServer&lt;scheduler::SchedulerAction&gt;  as_;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注册抢占回调函数</span></span><br><span class="line">as_.<span class="built_in">registerPreemptCallback</span>(boost::<span class="built_in">bind</span>(&amp;Explore::preemptCB, <span class="keyword">this</span>))</span><br><span class="line">as_.<span class="built_in">registerGoalCallback</span>(boost::<span class="built_in">bind</span>(&amp;Explore::goalCB, <span class="keyword">this</span>));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Explore::preemptCB</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">ROS_INFO</span>(<span class="string">&quot;%s: Preempted&quot;</span>, action_name_.<span class="built_in">c_str</span>());</span><br><span class="line">  explore_ = <span class="literal">false</span>;</span><br><span class="line">  explore_state_ = STOP;</span><br><span class="line">  ac_.<span class="built_in">cancelAllGoals</span>();</span><br><span class="line">  <span class="keyword">if</span>(as_.<span class="built_in">isActive</span>())</span><br><span class="line">	as_.<span class="built_in">setPreempted</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Explore::goalCB</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  explore_state_ = FULL_ROTATE;</span><br><span class="line">  as_.<span class="built_in">acceptNewGoal</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>SimpleActionServer</code>有构造函数可以注册<code>ExecuteCallback</code>回调函数，但没有其他两个回调，原型：<br><code>SimpleActionServer (ros::NodeHandle n, std::string name, ExecuteCallback execute_callback, bool auto_start)</code></p>
<p><code>move_base</code>的构造函数中是这样使用的：<br><code>as_ = new MoveBaseActionServer(ros::NodeHandle(), &quot;move_base&quot;, boost::bind(&amp;MoveBase::executeCb, this, _1), false);</code></p>
<p>服务端<code>as_</code>最后需要<code>start()</code>来启动，再加<code>ros::spin()</code>阻塞。 <code>MoveBase</code>构造函数的最后只有前者，<code>ros::spin()</code>其实是在<code>move_base_node.cpp</code>里</p>
<h2 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h2><p>这里只看带回调函数的函数原型：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> actionlib::SimpleActionClient&lt; ActionSpec &gt;::<span class="built_in">sendGoal</span>(<span class="keyword">const</span> Goal&amp; goal,</span><br><span class="line">    SimpleDoneCallback       done_cb = <span class="built_in">SimpleDoneCallback</span>(),</span><br><span class="line">    SimpleActiveCallback     active_cb = <span class="built_in">SimpleActiveCallback</span>(),</span><br><span class="line">    SimpleFeedbackCallback   feedback_cb = <span class="built_in">SimpleFeedbackCallback</span>() </span><br><span class="line">)</span><br></pre></td></tr></table></figure><br>向<code>ActionServer</code>发送goal, 并注册回调函数。 如果调用本函数时已经有个goal处于active，状态机就会忽略goal并且开始向新的goal导航，不用发取消的请求。</p>
<ul>
<li>done_cb:        Callback that gets called on transitions to <code>Done</code>，用于监听服务器任务执行完后的相应消息以及客户端的相应处理</li>
<li>active_cb:      Callback that gets called on transitions to <code>Active</code>，服务器任务被激活时的消息提示以及客户端的相应处理</li>
<li>feedback_cb:    Callback that gets called whenever <code>feedback</code> for this goal is received，接收服务器的反馈消息以及客户端的相应处理<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> actionlib::SimpleActionClient&lt;move_base_msgs::MoveBaseAction&gt; MoveBaseClient;</span><br><span class="line">MoveBaseClient   ac_;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 示例</span></span><br><span class="line">ac_.<span class="built_in">sendGoal</span>(goal,</span><br><span class="line">    boost::<span class="built_in">bind</span>(&amp;DoDishesActionClient::DoneCb, <span class="keyword">this</span>, _1, _2),</span><br><span class="line">    boost::<span class="built_in">bind</span>(&amp;DoDishesActionClient::ActiveCb, <span class="keyword">this</span>),</span><br><span class="line">    boost::<span class="built_in">bind</span>(&amp;DoDishesActionClient::FeedbackCb, <span class="keyword">this</span>, _1));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">DoneCb</span><span class="params">(<span class="keyword">const</span> actionlib::SimpleClientGoalState&amp; state,</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="keyword">const</span> first_actionlib_sample::DoDishesResultConstPtr&amp; result)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="built_in">ROS_INFO</span>(<span class="string">&quot;Finished in state [%s]&quot;</span>, state.<span class="built_in">toString</span>().<span class="built_in">c_str</span>());</span><br><span class="line">        <span class="built_in">ROS_INFO</span>(<span class="string">&quot;Toal dish cleaned: %i&quot;</span>, result-&gt;toal_dishes_cleaned);</span><br><span class="line">        ros::<span class="built_in">shutdown</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 当目标激活的时候，会调用一次</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ActiveCb</span><span class="params">()</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">ROS_INFO</span>(<span class="string">&quot;Goal just went active&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 接收服务器的反馈信息</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FeedbackCb</span><span class="params">(<span class="keyword">const</span> first_actionlib_sample::DoDishesFeedbackConstPtr&amp; feedback)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">ROS_INFO</span>(<span class="string">&quot;Got Feedback Complete Rate: %f&quot;</span>, feedback-&gt;percent_complete);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="Goal的状态"><a href="#Goal的状态" class="headerlink" title="Goal的状态"></a>Goal的状态</h2><p><code>GoalStatus</code><br><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">PENDING = <span class="number">0</span></span><br><span class="line">ACTIVE = <span class="number">1</span></span><br><span class="line">PREEMPTED = <span class="number">2</span></span><br><span class="line">SUCCEEDED = <span class="number">3</span></span><br><span class="line">ABORTED = <span class="number">4</span></span><br><span class="line">REJECTED = <span class="number">5</span></span><br><span class="line">PREEMPTING = <span class="number">6</span></span><br><span class="line">RECALLING = <span class="number">7</span></span><br><span class="line">RECALLED = <span class="number">8</span></span><br><span class="line">LOST = <span class="number">9</span></span><br></pre></td></tr></table></figure></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cout&lt;&lt; ac_.<span class="built_in">getState</span>().<span class="built_in">toString</span>() &lt;&lt;endl;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取goal的状态信息</span></span><br><span class="line"><span class="comment">// PENDING, ACTIVE, RECALLED, REJECTED, PREEMPTED, ABORTED, SUCCEEDED, LOST(isn&#x27;t tracking a goal)</span></span><br><span class="line"><span class="function">SimpleClientGoalState   <span class="title">getState</span> <span class="params">()</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"><span class="comment">// 输出上面的几个状态，大写字母，对调试很有用</span></span></span><br><span class="line"><span class="function">std::string <span class="title">toString</span><span class="params">()</span> <span class="keyword">const</span></span></span><br></pre></td></tr></table></figure>
<p>如果当前已经在某个状态，再次设置为这个状态就会报警：比如<code>ABORTED</code>状态  <font size="3" color="orange"> To transition to an aborted state, the goal must be in a preempting or active state, it is currently in state: 4  </font></p>
<p>参考：<a target="_blank" rel="noopener" href="https://www.guyuehome.com/14050">ROS Action动作通讯编程</a></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2022/03/31/%E8%B7%AF%E5%BE%84%E8%A7%84%E5%88%92/%E8%BF%9E%E7%BB%AD%E5%8F%91%E5%AF%BC%E8%88%AA%E7%9B%AE%E6%A0%87%E6%97%B6%E7%9A%84%E5%AF%BC%E8%88%AA%E4%B8%AD%E6%96%AD/">连续发导航目标时的导航中断</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-03-31</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E8%B7%AF%E5%BE%84%E8%A7%84%E5%88%92/">路径规划</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E8%B7%AF%E5%BE%84%E8%A7%84%E5%88%92/%E5%85%B6%E4%BB%96/">其他</a></span><div class="content"><p>车收到导航命令没有动，查日志如下<br><img src="https://s2.loli.net/2022/03/31/3pLtO8HI7GMDTbV.png" alt="move_base接收的目标四元数invalid.png"></p>
<p>在一个客户端程序里，在<code>sendGoal</code>之前调用了两次<code>cancelAllGoals</code>，结果得到下面的日志，某次goal的消息全是0<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">[ INFO] [<span class="number">1648276976.479444090</span>]: move_base client send goal: type: <span class="number">1</span></span><br><span class="line">target_pose: </span><br><span class="line">  header: </span><br><span class="line">    seq: <span class="number">11</span></span><br><span class="line">    stamp: <span class="number">1648276976.479361050</span></span><br><span class="line">    frame_id: map</span><br><span class="line">  pose: </span><br><span class="line">    position: </span><br><span class="line">      x: <span class="number">-3.9901</span></span><br><span class="line">      y: <span class="number">0.427604</span></span><br><span class="line">      z: <span class="number">0</span></span><br><span class="line">    orientation: </span><br><span class="line">      x: <span class="number">0</span></span><br><span class="line">      y: <span class="number">0</span></span><br><span class="line">      z: <span class="number">0</span></span><br><span class="line">      w: <span class="number">1</span></span><br><span class="line"></span><br><span class="line">[ INFO] [<span class="number">1648276976.492017723</span>]: move base task just went active</span><br><span class="line">[ WARN] [<span class="number">1648276979.458537608</span>]: <span class="number">32</span> receive cmd: position: </span><br><span class="line">  x: <span class="number">-4.01633</span></span><br><span class="line">  y: <span class="number">0.440816</span></span><br><span class="line">  z: <span class="number">0</span></span><br><span class="line">orientation: </span><br><span class="line">  x: <span class="number">0</span></span><br><span class="line">  y: <span class="number">0</span></span><br><span class="line">  z: <span class="number">0</span></span><br><span class="line">  w: <span class="number">1</span></span><br><span class="line"></span><br><span class="line">[ INFO] [<span class="number">1648276979.494004129</span>]: actionlib result state: PREEMPTED</span><br><span class="line">[ INFO] [<span class="number">1648276979.494157917</span>]: actionlib result: result: <span class="number">0</span></span><br><span class="line">result_pose: </span><br><span class="line">  header: </span><br><span class="line">    seq: <span class="number">0</span></span><br><span class="line">    stamp: <span class="number">0.000000000</span></span><br><span class="line">    frame_id: </span><br><span class="line">  pose: </span><br><span class="line">    position: </span><br><span class="line">      x: <span class="number">0</span></span><br><span class="line">      y: <span class="number">0</span></span><br><span class="line">      z: <span class="number">0</span></span><br><span class="line">    orientation: </span><br><span class="line">      x: <span class="number">0</span></span><br><span class="line">      y: <span class="number">0</span></span><br><span class="line">      z: <span class="number">0</span></span><br><span class="line">      w: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">[ INFO] [<span class="number">1648276979.494228945</span>]: actionDoneCb state PREEMPTED</span><br><span class="line">[ INFO] [<span class="number">1648276979.494308493</span>]: move_base client send goal: type: <span class="number">1</span></span><br><span class="line">target_pose: </span><br><span class="line">  header: </span><br><span class="line">    seq: <span class="number">12</span></span><br><span class="line">    stamp: <span class="number">1648276979.494253319</span></span><br><span class="line">    frame_id: map</span><br><span class="line">  pose: </span><br><span class="line">    position: </span><br><span class="line">      x: <span class="number">0</span></span><br><span class="line">      y: <span class="number">0</span></span><br><span class="line">      z: <span class="number">0</span></span><br><span class="line">    orientation: </span><br><span class="line">      x: <span class="number">0</span></span><br><span class="line">      y: <span class="number">0</span></span><br><span class="line">      z: <span class="number">0</span></span><br><span class="line">      w: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">[ERROR] [<span class="number">1648276979.504876032</span>]: BUG: Got a transition to CommState [PENDING] when our in SimpleGoalState [DONE]</span><br><span class="line">[ERROR] [<span class="number">1648276979.504963821</span>]: BUG: Got a transition to CommState [RECALLING] when our in SimpleGoalState [DONE]</span><br><span class="line">[ERROR] [<span class="number">1648276979.514087412</span>]: BUG: Got a transition to CommState [PREEMPTING] when in SimpleGoalState [DONE]</span><br><span class="line">[ERROR] [<span class="number">1648276979.515084871</span>]: BUG: Got a second transition to DONE</span><br></pre></td></tr></table></figure><br>结果导致move_base漏接了一个目标，最后取消两个<code>cancelAllGoals</code>就好了</p>
<ul>
<li><p><code>cancelAllGoals()</code>[inline]: Cancel all goals currently running on the action server. This preempts all goals running on the action server at the point that this message is serviced by the ActionServer.</p>
</li>
<li><p><code>cancelGoal()</code>[inline]: Cancel the goal that we are currently pursuing</p>
</li>
</ul>
<p><code>cancellAllGoals()</code>和<code>cancellGoal()</code>经常放在<code>SIGINT</code>信号的回调函数里，用于停止所有actions</p>
<p>参考： <a target="_blank" rel="noopener" href="https://github.com/thecodeside/elektron_ballcollector">elektron_ballcollector</a></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2022/03/22/C++/%E6%99%BA%E8%83%BD%E6%8C%87%E9%92%88/%E6%99%BA%E8%83%BD%E6%8C%87%E9%92%88(%E4%B8%89)%20weak_ptr/">智能指针(三) weak_ptr</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-03-22</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/C/">C++</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/C/%E6%99%BA%E8%83%BD%E6%8C%87%E9%92%88/">智能指针</a></span><div class="content"><p><code>weak_ptr</code>本身也是一个模板类，但是不能直接用它来定义一个智能指针的对象，只能配合<code>shared_ptr</code>来使用，可以将<code>shared_ptr的对象赋值给weak_ptr</code>，并且这样并不会改变引用计数的值。查看weak_ptr的代码时发现，它主要有<code>lock</code>、<code>swap</code>、<code>reset</code>、<code>expired</code>、<code>operator=</code>、<code>use_count</code>几个函数，与shared_ptr相比多了l<code>ock</code>、<code>expired</code>函数，但是却少了<code>get</code>函数，甚至连<code>operator*</code>  和 <code>operator-&gt;</code>都没有</p>
<h2 id="weak-ptr解决循环引用"><a href="#weak-ptr解决循环引用" class="headerlink" title="weak_ptr解决循环引用"></a>weak_ptr解决循环引用</h2><p><code>weak_ptr</code>必须跟<code>shared_ptr</code>配合使用, 它用于解决<code>shared_ptr</code>的死锁问题，如果两个<code>shared_ptr</code>一直互相引用，那么它们的引用计数永远不是0，资源永远不释放，这样实际造成了内存泄露。<code>weak_ptr</code>并不拥有其指向的对象，让<code>weak_ptr</code>指向<code>shared_ptr</code>所指向对象，对象的引用计数并不会增加</p>
<p>循环引用的情况：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Son</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Father</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    ~<span class="built_in">Father</span>() &#123;cout&lt;&lt;<span class="string">&quot; father 析构&quot;</span>&lt;&lt;endl; &#125;</span><br><span class="line">    shared_ptr&lt;Son&gt; son_;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Son</span> &#123;</span></span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">    ~<span class="built_in">Son</span>() &#123;cout&lt;&lt;<span class="string">&quot; son 析构&quot;</span>&lt;&lt;endl; &#125;</span><br><span class="line">    shared_ptr&lt;Father&gt; father_;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">auto</span> father = make_shared&lt;Father&gt;();</span><br><span class="line"><span class="keyword">auto</span> son = make_shared&lt;Son&gt;();</span><br><span class="line">father-&gt;son_ = son;</span><br><span class="line">son-&gt;father_ = father;</span><br></pre></td></tr></table></figure><br>结果一个析构函数也没运行，说明对象资源没有释放。使用<code>weak_ptr</code>解决很简单，让Son的成员变量father改为<code>weak_ptr</code>类型，运行后发现两个析构都有了。</p>
<p>main函数退出前，Son对象的引用计数是2，而Father的引用计数是1。<br>son指针销毁，Son对象的引用计数变成1。<br>father指针销毁，Father对象的引用计数变成0，导致Father对象析构，Father对象的析构会导致它包含的son_指针被销毁，这时Son对象的引用计数变成0，所以Son对象也会被析构。</p>
<p>参考:<a target="_blank" rel="noopener" href="https://blog.csdn.net/Jacketinsysu/article/details/53341370">shared_ptr循环引用的例子及解决方法示例</a></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2022/03/22/C++/C++%20%20%E5%9F%BA%E7%A1%80/c++11%20%E6%96%B0%E7%89%B9%E6%80%A7%20%201/">c++11 新特性</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-03-22</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/C/">C++</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/C/C-%E5%9F%BA%E7%A1%80/">C++ 基础</a></span><div class="content"><h2 id="auto-和-for循环"><a href="#auto-和-for循环" class="headerlink" title="auto 和 for循环"></a>auto 和 for循环</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">std::vector&lt;<span class="keyword">int</span>&gt; vec &#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>&#125;;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">auto</span> n :vec)</span><br><span class="line">    std::cout &lt;&lt; n;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">int</span> arr[<span class="number">10</span>] = &#123; <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>&#125;;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">auto</span> n : arr)</span><br><span class="line">    std::cout &lt;&lt; n;</span><br></pre></td></tr></table></figure>
<p>C++11的for使用方法简单了很多，但是上述对容器的遍历是只读的，也就是说遍历的值是不可修改的。</p>
<p>如果要修改遍历的值，需要将遍历的变量声明为引用类型：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">std::vector&lt;<span class="keyword">int</span>&gt; vec &#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>&#125;;</span><br><span class="line">cout &lt;&lt; <span class="string">&quot;修改前&quot;</span> &lt;&lt; endl;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">auto</span>&amp; n :vec)</span><br><span class="line">    std::cout &lt;&lt; n++;</span><br><span class="line">cout &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">cout &lt;&lt; <span class="string">&quot;修改后&quot;</span> &lt;&lt; endl;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">auto</span> j : vec)</span><br><span class="line">    std::cout &lt;&lt; j;</span><br></pre></td></tr></table></figure><br>结果：<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">修改前</span><br><span class="line">12345</span><br><span class="line">修改后</span><br><span class="line">23456</span><br></pre></td></tr></table></figure></p>
<h2 id="lambda表达式"><a href="#lambda表达式" class="headerlink" title="lambda表达式"></a>lambda表达式</h2><p>C++11提供了对匿名函数的支持，称为Lambda表达式. Lambda表达式具体形式如下:<br><code>[capture](parameters)-&gt;return-type&#123;body&#125;</code></p>
<p>如果没有参数，空的圆括号()可以省略。 返回值也可以省略，如果函数体只由一条return语句组成或返回类型为void的话。形如:<br><code>[capture](parameters)&#123;body&#125;</code></p>
<p>几个Lambda函数的例子:  　　　　<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[](<span class="keyword">int</span> x, <span class="keyword">int</span> y) &#123; <span class="keyword">return</span> x + y; &#125; <span class="comment">// 隐式返回类型</span></span><br><span class="line">[](<span class="keyword">int</span>&amp; x) &#123; ++x; &#125;   <span class="comment">// 没有return语句 -&gt; lambda 函数的返回类型是&#x27;void&#x27;</span></span><br><span class="line">[]() &#123; ++global_x; &#125;  <span class="comment">// 没有参数, 仅访问某个全局变量</span></span><br><span class="line">[]&#123; ++global_x; &#125;     <span class="comment">// 与上一个相同,省略了()</span></span><br></pre></td></tr></table></figure><br>先掌握这些简单的情况</p>
<h2 id="判断inf-nan"><a href="#判断inf-nan" class="headerlink" title="判断inf, nan"></a>判断inf, nan</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">isinf</span><span class="params">( <span class="keyword">float</span> arg )</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">isfinite</span><span class="params">( <span class="keyword">float</span> arg )</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">isnan</span><span class="params">( <span class="keyword">float</span> arg )</span></span>;</span><br></pre></td></tr></table></figure>
<h2 id="constexpr"><a href="#constexpr" class="headerlink" title="constexpr"></a>constexpr</h2><p>C++11新标准规定，允许将变量声明为<code>constexpr</code>类型以便由编译器验证变量的值是否是一个常量表达式。如果不是，编译器报错。同时，声明为constexpr的变量一定是常量，而且必须用常量表达式初始化。  constexpr可以修饰函数参数、函数返回值、变量、类的构造函数、函数模板等，是一种比const更加严格的约束，它修饰的表达式除了具有“运行时常量性”，也具有“编译时常量性”，即constexpr修饰的表达式的值在编译期间可知。<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">constexpr</span> <span class="keyword">int</span> mf = <span class="number">20</span>;              <span class="comment">//正确，20是常量表达式</span></span><br><span class="line"><span class="keyword">constexpr</span> <span class="keyword">int</span> limit = mf + <span class="number">1</span>;       <span class="comment">//正确，mf + 1是常量表达式</span></span><br><span class="line"><span class="keyword">constexpr</span> <span class="keyword">int</span> sz = <span class="built_in">size</span>();         <span class="comment">//未知，若size()函数是一个constexpr函数时即正确，反之错误。</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> i = <span class="number">10</span>;</span><br><span class="line"><span class="keyword">constexpr</span> <span class="keyword">int</span> t = i;                <span class="comment">//错误，i不是常量</span></span><br></pre></td></tr></table></figure></p>
<p>参考：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/ljwgis/p/13095739.html">constexpr</a></p>
<h2 id="大括号初始化"><a href="#大括号初始化" class="headerlink" title="大括号初始化"></a>大括号初始化</h2><p>在C++11中，自动变量和全局变量的初始化方式增加了几种:<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> a = &#123;<span class="number">3</span>+<span class="number">4</span>&#125;;</span><br><span class="line"><span class="keyword">int</span> a&#123;<span class="number">6</span>+<span class="number">8</span>&#125;;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">a</span><span class="params">(<span class="number">6</span>+<span class="number">8</span>)</span></span>;</span><br></pre></td></tr></table></figure><br>主要是大括号的用法，另外大括号内可以不包含任何内容，此时变量初始化为0<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> roc = &#123;&#125;;</span><br><span class="line"><span class="keyword">int</span> roc&#123;&#125;;</span><br></pre></td></tr></table></figure></p>
<p>STL也可以用大括号的方式初始化，比如 vector<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vector&lt;<span class="keyword">int</span>&gt; c&#123; <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span> &#125;;</span><br></pre></td></tr></table></figure><br>这显然不能从构造函数角度理解了，源于<code>&lt;initializer_list&gt;</code>头文件中<code>initialize_list</code>类模板的支持。只要<code>#include&lt;initializer_list&gt;</code>并声明一个以<code>initialize_List&lt;T&gt;</code>模板类为参数的构造函数，也可以使得自定义类使用列表初始化。</p>
<p>在C++11中，除了初始化列表（在构造函数中初始化）外，允许使用等=或花括号{}进行就地的非静态成员变量初始化，例如：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">example</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">int</span> a = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">double</span> b&#123; <span class="number">1.2</span> &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><br>如果在一个类中，既使用了就地初始化来初始化非静态成员变量，又在构造函数中使用了初始化列表，执行顺序是: 先执行就地初始化，然后执行初始化列表。</p>
<h2 id="匿名命名空间"><a href="#匿名命名空间" class="headerlink" title="匿名命名空间"></a>匿名命名空间</h2><h2 id="std-tie"><a href="#std-tie" class="headerlink" title="std::tie"></a>std::tie</h2><h2 id="限域枚举"><a href="#限域枚举" class="headerlink" title="限域枚举"></a>限域枚举</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="keyword">class</span> <span class="title">SensorType</span> &#123;</span></span><br><span class="line">      RANGE = <span class="number">0</span>,</span><br><span class="line">      IMU,</span><br><span class="line">      ODOMETRY,</span><br><span class="line">      FIXED_FRAME_POSE,</span><br><span class="line">      LANDMARK,</span><br><span class="line">      LOCAL_SLAM_RESULT</span><br><span class="line">    &#125;;</span><br></pre></td></tr></table></figure>
<h2 id="using"><a href="#using" class="headerlink" title="using"></a>using</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MapBuilderInterface</span> &#123;</span></span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line"><span class="keyword">using</span> LocalSlamResultCallback =</span><br><span class="line">  TrajectoryBuilderInterface::LocalSlamResultCallback;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> SensorId = TrajectoryBuilderInterface::SensorId;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> Callback =</span><br><span class="line">      std::function&lt;<span class="built_in"><span class="keyword">void</span></span>(<span class="keyword">const</span> std::string&amp;, std::unique_ptr&lt;Data&gt;)&gt;;</span><br></pre></td></tr></table></figure>
<h2 id="std-weak-ptr"><a href="#std-weak-ptr" class="headerlink" title="std::weak_ptr"></a>std::weak_ptr</h2><p>std::weak<em>ptr<Task> Schedule(std::unique_ptr<Task> task)<br>      LOCKS_EXCLUDED(mutex</em>) override;</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2022/03/21/%E6%BF%80%E5%85%89SLAM/Cartographer/%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/cartographer%E6%96%B0%E7%89%88%E6%9C%AC%E7%9A%84%E5%8F%98%E5%8C%96/">cartographer新版本的变化</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-03-21</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E6%BF%80%E5%85%89SLAM/">激光SLAM</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E6%BF%80%E5%85%89SLAM/Cartographer/">Cartographer</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E6%BF%80%E5%85%89SLAM/Cartographer/%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/">源码解读</a></span><div class="content"><h2 id="publish-tracked-pose-和-use-pose-extrapolator"><a href="#publish-tracked-pose-和-use-pose-extrapolator" class="headerlink" title="publish_tracked_pose 和 use_pose_extrapolator"></a>publish_tracked_pose 和 use_pose_extrapolator</h2><p>新版本增加的参数<code>publish_tracked_pose</code>，默认false<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">NodeOptions</span> &#123;</span></span><br><span class="line">  ::cartographer::mapping::proto::MapBuilderOptions map_builder_options;</span><br><span class="line">  std::string map_frame;</span><br><span class="line">  <span class="keyword">double</span> lookup_transform_timeout_sec;</span><br><span class="line">  <span class="keyword">double</span> submap_publish_period_sec;</span><br><span class="line">  <span class="keyword">double</span> pose_publish_period_sec;</span><br><span class="line">  <span class="keyword">double</span> trajectory_publish_period_sec;</span><br><span class="line">  <span class="keyword">bool</span> publish_to_tf = <span class="literal">true</span>;</span><br><span class="line">  <span class="keyword">bool</span> publish_tracked_pose = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">bool</span> use_pose_extrapolator = <span class="literal">true</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>在<code>Node</code>构造函数中的部分<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (node_options_.publish_tracked_pose) &#123;</span><br><span class="line">    tracked_pose_publisher_ =</span><br><span class="line">        node_handle_.advertise&lt;::geometry_msgs::PoseStamped&gt;(</span><br><span class="line">            kTrackedPoseTopic, kLatestOnlyPublisherQueueSize);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><br>发布消息的部分在<code>Node::PublishLocalTrajectoryData</code>的最后。</p>
<p>这里用到了<strong>新版本</strong>的另一个新内容： 参数<code>use_pose_extrapolator</code></p>
<p>Node里的位姿估计器，作用是融合里程计和IMU，推测出一个位姿。 如果<code>use_pose_extrapolator</code>参数为true，发布出的这个位姿不准，因为是先验的位姿，没有经过雷达校准，除非IMU和里程计特别准。因此这个参数一般都是false</p>
<p>如果参数<code>publish_tracked_pose</code>为false，<code>use_pose_extrapolator</code>其实就无效了</p>
<h2 id="Node-MaybeWarnAboutTopicMismatch"><a href="#Node-MaybeWarnAboutTopicMismatch" class="headerlink" title="Node::MaybeWarnAboutTopicMismatch"></a>Node::MaybeWarnAboutTopicMismatch</h2><p>新版本中的<code>Node::AddTrajectory</code>添加<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wall_timers_.<span class="built_in">push_back</span>(node_handle_.<span class="built_in">createWallTimer</span>(</span><br><span class="line">      ::ros::<span class="built_in">WallDuration</span>(kTopicMismatchCheckDelaySec),</span><br><span class="line">      &amp;Node::MaybeWarnAboutTopicMismatch, <span class="keyword">this</span>, <span class="comment">/*oneshot=*/</span><span class="literal">true</span>)  );</span><br></pre></td></tr></table></figure><br>创建一个3s执行一次的定时器，由于<code>oneshot=true</code>，所以只执行一次。检查设置的topic名字在ROS中是否存在，不存在则报错</p>
<h2 id="pose-graph-odometry-motion-filter"><a href="#pose-graph-odometry-motion-filter" class="headerlink" title="pose_graph_odometry_motion_filter"></a>pose_graph_odometry_motion_filter</h2><p><code>CreateGlobalTrajectoryBuilder2D</code>的参数增加 <code>pose_graph_odometry_motion_filter</code>里程计的滤波器，但没有初始化</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">absl::optional&lt;MotionFilter&gt; pose_graph_odometry_motion_filter;</span><br><span class="line"><span class="keyword">if</span> (trajectory_options.<span class="built_in">has_pose_graph_odometry_motion_filter</span>())</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">LOG</span>(INFO) &lt;&lt; <span class="string">&quot;Using a motion filter for adding odometry to the pose graph.&quot;</span>;</span><br><span class="line">    pose_graph_odometry_motion_filter.<span class="built_in">emplace</span>(</span><br><span class="line">        <span class="built_in">MotionFilter</span>(trajectory_options.<span class="built_in">pose_graph_odometry_motion_filter</span>()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="GetTrajectoryStates-改名为-GetLocalTrajectoryData"><a href="#GetTrajectoryStates-改名为-GetLocalTrajectoryData" class="headerlink" title="GetTrajectoryStates 改名为 GetLocalTrajectoryData"></a><code>GetTrajectoryStates</code> 改名为 <code>GetLocalTrajectoryData</code></h2><p>原因在于后端里也有<code>GetTrajectoryStates</code>，容易混淆</p>
<p><code>Node</code>构造函数 —— <code>Node::PublishLocalTrajectoryData</code> —— <code>map_builder_bridge_.GetLocalTrajectoryData()</code></p>
<p>最后用到的<code>local_slam_data_</code>在<code>MapBuilderBridge::OnLocalSlamResult</code>中赋值</p>
</div><hr></div><nav id="pagination"><div class="pagination"><a class="extend prev" rel="prev" href="/page/20/">&lt;&lt; Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/20/">20</a><span class="page-number current">21</span><a class="page-number" href="/page/22/">22</a><span class="space">&hellip;</span><a class="page-number" href="/page/67/">67</a><a class="extend next" rel="next" href="/page/22/">Next &gt;&gt;</a></div></nav></div></div><footer class="footer-bg" style="background-image: url(https://s2.loli.net/2022/11/17/QOR8cePIS5NdDrK.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2018 - 2024 By Charon Cheung</div><div class="framework-info"><span>Driven - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_site_uv"><i class="fa fa-user"></i><span id="busuanzi_value_site_uv"></span><span></span></span><span class="footer-separator">|</span><span id="busuanzi_container_site_pv"><i class="fa fa-eye"></i><span id="busuanzi_value_site_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.6.1"></script><script src="/js/fancybox.js?version=1.6.1"></script><script src="/js/sidebar.js?version=1.6.1"></script><script src="/js/copy.js?version=1.6.1"></script><script src="/js/fireworks.js?version=1.6.1"></script><script src="/js/transition.js?version=1.6.1"></script><script src="/js/scroll.js?version=1.6.1"></script><script src="/js/head.js?version=1.6.1"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
    processEscapes: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
  },
  CommonHTML: {
    linebreaks: { automatic: true, width: "90% container" }
  },
  "HTML-CSS": { 
    linebreaks: { automatic: true, width: "90% container" }
  },
  "SVG": { 
    linebreaks: { automatic: true, width: "90% container" }
  }
});
</script><script type="text/x-mathjax-config">MathJax.Hub.Queue(function() {
  var all = MathJax.Hub.getAllJax(), i;
  for (i=0; i < all.length; i += 1) {
    all[i].SourceElement().parentNode.className += ' has-jax';
  }
});
</script><script src="https://cdn.bootcss.com/mathjax/2.7.2/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script>if(/Android|webOS|iPhone|iPod|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
}</script></body></html>