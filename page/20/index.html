<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content=""><meta name="keywords" content=""><meta name="author" content="Charon Cheung"><meta name="copyright" content="Charon Cheung"><title>If you wish for peace, prepare for war | 沉默杀手</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.6.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.6.1"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  }
} </script><meta name="generator" content="Hexo 5.4.0"></head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="author-info"><div class="author-info__avatar text-center"><img src="https://s2.loli.net/2022/02/17/HQaCXUBn64zsMIL.png"></div><div class="author-info__name text-center">Charon Cheung</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">660</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">6</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">51</span></a></div></div></div><nav id="nav" style="background-image: url(https://s2.loli.net/2022/11/17/QOR8cePIS5NdDrK.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">沉默杀手</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span></div><div id="site-info"><div id="site-title">沉默杀手</div><div id="site-sub-title">If you wish for peace, prepare for war</div></div></nav><div id="content-outer"><div class="layout" id="content-inner"><div class="recent-post-item article-container"><a class="article-title" href="/2022/05/07/%E6%BF%80%E5%85%89SLAM/Cartographer/%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/%E8%BD%A8%E8%BF%B9%E7%9A%84%E5%8F%AF%E8%A7%86%E5%8C%96/">轨迹的可视化</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-05-07</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E6%BF%80%E5%85%89SLAM/">激光SLAM</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E6%BF%80%E5%85%89SLAM/Cartographer/">Cartographer</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E6%BF%80%E5%85%89SLAM/Cartographer/%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/">源码解读</a></span><div class="content"><p><code>Node::PublishSubmapList</code>: 这里的子图只有节点id和子图的节点数，没有地图数据</p>
<h2 id="scan-matched-points2-话题"><a href="#scan-matched-points2-话题" class="headerlink" title="scan_matched_points2 话题"></a><code>scan_matched_points2</code> 话题</h2><h2 id="trajectory-node-list话题"><a href="#trajectory-node-list话题" class="headerlink" title="trajectory_node_list话题"></a><code>trajectory_node_list</code>话题</h2></div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2022/05/07/%E6%BF%80%E5%85%89SLAM/Cartographer/%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/%E7%BB%93%E6%9D%9F%E8%BD%A8%E8%BF%B9%20FinishTrajectoryUnderLock/">结束轨迹</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-05-07</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E6%BF%80%E5%85%89SLAM/">激光SLAM</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E6%BF%80%E5%85%89SLAM/Cartographer/">Cartographer</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E6%BF%80%E5%85%89SLAM/Cartographer/%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/">源码解读</a></span><div class="content"><p><code>node_main.cc</code>中的<code>Run</code>函数最后：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">::ros::<span class="built_in">spin</span>();</span><br><span class="line"><span class="comment">// 终止所有轨迹</span></span><br><span class="line">node.<span class="built_in">FinishAllTrajectories</span>();</span><br><span class="line">node.<span class="built_in">RunFinalOptimization</span>();</span><br></pre></td></tr></table></figure></p>
<p>主要看<code>FinishAllTrajectories</code><br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Node::FinishAllTrajectories</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  carto::<span class="function">common::MutexLocker <span class="title">lock</span><span class="params">(&amp;mutex_)</span></span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">auto</span>&amp; entry : is_active_trajectory_) &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> trajectory_id = entry.first;</span><br><span class="line">    <span class="comment">// 已经lock了，所以叫做 FinishTrajectoryUnderLock</span></span><br><span class="line">    <span class="keyword">if</span> (entry.second) &#123;</span><br><span class="line">      <span class="built_in">CHECK_EQ</span>(<span class="built_in">FinishTrajectoryUnderLock</span>(trajectory_id).code,</span><br><span class="line">               cartographer_ros_msgs::StatusCode::OK);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><code>offline_node.cc</code> 中还调用了一个<code>Node::FinishTrajectory</code>(是这个函数唯一被调用的地方)，还有就是<code>finish_trajectory</code>服务的回调函数，以上3个函数实际都调用<code>FinishTrajectoryUnderLock</code></p>
<p><br></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">cartographer_ros_msgs::StatusResponse <span class="title">Node::FinishTrajectoryUnderLock</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">const</span> <span class="keyword">int</span> trajectory_id)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  cartographer_ros_msgs::StatusResponse status_response;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// First, check if we can actually finish the trajectory</span></span><br><span class="line">  <span class="comment">// trajectory_id 是否属于正在结束的轨迹集合，如果是 FROZEN 则返回</span></span><br><span class="line">  <span class="keyword">if</span> (map_builder_bridge_.<span class="built_in">GetFrozenTrajectoryIds</span>().<span class="built_in">count</span>(trajectory_id))</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">const</span> std::string error =</span><br><span class="line">        <span class="string">&quot;Trajectory &quot;</span> + std::<span class="built_in">to_string</span>(trajectory_id) + <span class="string">&quot; is frozen.&quot;</span>;</span><br><span class="line">    <span class="built_in">LOG</span>(ERROR) &lt;&lt; error;</span><br><span class="line">    status_response.code = cartographer_ros_msgs::StatusCode::INVALID_ARGUMENT;</span><br><span class="line">    status_response.message = error;</span><br><span class="line">    <span class="keyword">return</span> status_response;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// trajectory_id 是否是 ACTIVE状态</span></span><br><span class="line">  <span class="keyword">if</span> (is_active_trajectory_.<span class="built_in">count</span>(trajectory_id) == <span class="number">0</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">const</span> std::string error =</span><br><span class="line">        <span class="string">&quot;Trajectory &quot;</span> + std::<span class="built_in">to_string</span>(trajectory_id) + <span class="string">&quot; is not created yet.&quot;</span>;</span><br><span class="line">    <span class="built_in">LOG</span>(ERROR) &lt;&lt; error;</span><br><span class="line">    status_response.code = cartographer_ros_msgs::StatusCode::NOT_FOUND;</span><br><span class="line">    status_response.message = error;</span><br><span class="line">    <span class="keyword">return</span> status_response;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// trajectory_id 是否已经 finish</span></span><br><span class="line">  <span class="keyword">if</span> (!is_active_trajectory_[trajectory_id])</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">const</span> std::string error = <span class="string">&quot;Trajectory &quot;</span> + std::<span class="built_in">to_string</span>(trajectory_id) +</span><br><span class="line">                              <span class="string">&quot; has already been finished.&quot;</span>;</span><br><span class="line">    <span class="built_in">LOG</span>(ERROR) &lt;&lt; error;</span><br><span class="line">    status_response.code =</span><br><span class="line">        cartographer_ros_msgs::StatusCode::RESOURCE_EXHAUSTED;</span><br><span class="line">    status_response.message = error;</span><br><span class="line">    <span class="keyword">return</span> status_response;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// Shutdown the subscribers of this trajectory.</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">auto</span>&amp; entry : subscribers_[trajectory_id])</span><br><span class="line">  &#123;</span><br><span class="line">    entry.subscriber.<span class="built_in">shutdown</span>();</span><br><span class="line">    subscribed_topics_.<span class="built_in">erase</span>(entry.topic);</span><br><span class="line">    <span class="built_in">LOG</span>(INFO) &lt;&lt; <span class="string">&quot;Shutdown the subscriber of [&quot;</span> &lt;&lt; entry.topic &lt;&lt; <span class="string">&quot;]&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">CHECK_EQ</span>(subscribers_.<span class="built_in">erase</span>(trajectory_id), <span class="number">1</span>);</span><br><span class="line">  <span class="built_in">CHECK</span>(is_active_trajectory_.<span class="built_in">at</span>(trajectory_id));</span><br><span class="line">  <span class="comment">// 主要是这里</span></span><br><span class="line">  map_builder_bridge_.<span class="built_in">FinishTrajectory</span>(trajectory_id);</span><br><span class="line"></span><br><span class="line">  is_active_trajectory_[trajectory_id] = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">const</span> std::string message =</span><br><span class="line">      <span class="string">&quot;Finished trajectory &quot;</span> + std::<span class="built_in">to_string</span>(trajectory_id) + <span class="string">&quot;.&quot;</span>;</span><br><span class="line">  status_response.code = cartographer_ros_msgs::StatusCode::OK;</span><br><span class="line">  status_response.message = message;</span><br><span class="line">  <span class="keyword">return</span> status_response;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>StatusResponse</code>不正常的<code>code</code>是<code>INVALID_ARGUMENT</code>,  <code>NOT_FOUND</code>,  <code>RESOURCE_EXHAUSTED</code>, 只有<code>OK</code>是正常的</p>
<p>其中的关键函数就是：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MapBuilderBridge::FinishTrajectory</span><span class="params">(<span class="keyword">const</span> <span class="keyword">int</span> trajectory_id)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">LOG</span>(INFO) &lt;&lt; <span class="string">&quot;Finishing trajectory with ID &#x27;&quot;</span> &lt;&lt; trajectory_id &lt;&lt; <span class="string">&quot;&#x27;...&quot;</span>;</span><br><span class="line">  <span class="comment">// Make sure there is a trajectory with &#x27;trajectory_id&#x27;.</span></span><br><span class="line">  <span class="built_in">CHECK_EQ</span>(sensor_bridges_.<span class="built_in">count</span>(trajectory_id), <span class="number">1</span>);</span><br><span class="line">  map_builder_-&gt;<span class="built_in">FinishTrajectory</span>(trajectory_id);</span><br><span class="line">  sensor_bridges_.<span class="built_in">erase</span>(trajectory_id);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 再看这个函数</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MapBuilder::FinishTrajectory</span><span class="params">(<span class="keyword">const</span> <span class="keyword">int</span> trajectory_id)</span> </span>&#123;</span><br><span class="line">  sensor_collator_-&gt;<span class="built_in">FinishTrajectory</span>(trajectory_id);</span><br><span class="line">  pose_graph_-&gt;<span class="built_in">FinishTrajectory</span>(trajectory_id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><code>sensor_collator_</code>就是<code>Collator::FinishTrajectory</code> 或者 <code>TrajectoryCollator::FinishTrajectory</code>，不用关注。</p>
<p>重要的是后端的同名函数：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">PoseGraph2D::FinishTrajectory</span><span class="params">(<span class="keyword">const</span> <span class="keyword">int</span> trajectory_id)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">AddWorkItem</span>([<span class="keyword">this</span>, trajectory_id]() <span class="built_in">LOCKS_EXCLUDED</span>(mutex_)</span><br><span class="line">  &#123;</span><br><span class="line">    absl::MutexLock  <span class="built_in">locker</span>(&amp;mutex_);</span><br><span class="line">    <span class="built_in">CHECK</span>(!<span class="built_in">IsTrajectoryFinished</span>(trajectory_id));   <span class="comment">// 不能是已结束</span></span><br><span class="line">    data_.trajectories_state[trajectory_id].state = TrajectoryState::FINISHED;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; submap : data_.submap_data.<span class="built_in">trajectory</span>(trajectory_id)) &#123;</span><br><span class="line">      data_.submap_data.<span class="built_in">at</span>(submap.id).state = SubmapState::kFinished;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> WorkItem::Result::kRunOptimization;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>这里又是全局优化的标志<code>kRunOptimization</code>，然后又去<code>PoseGraph2D::HandleWorkQueue</code>，也是一次优化过程了</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2022/05/07/%E6%BF%80%E5%85%89SLAM/Cartographer/%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/map_builder_server.cc/">map_builder_server.cc</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-05-07</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E6%BF%80%E5%85%89SLAM/">激光SLAM</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E6%BF%80%E5%85%89SLAM/Cartographer/">Cartographer</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E6%BF%80%E5%85%89SLAM/Cartographer/%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/">源码解读</a></span><div class="content"><p><code>map_builder_server.cc</code>中注册了一大堆回调函数，例如：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">server_builder.RegisterHandler&lt;handlers::GetLocalToGlobalTransformHandler&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">// get_local_to_global_transform_handler.cc 文件</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">GetLocalToGlobalTransformHandler::OnRequest</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">const</span> proto::GetLocalToGlobalTransformRequest&amp; request)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">auto</span> response = absl::make_unique&lt;proto::GetLocalToGlobalTransformResponse&gt;();</span><br><span class="line">  <span class="keyword">auto</span> local_to_global =</span><br><span class="line">      GetContext&lt;MapBuilderContextInterface&gt;()</span><br><span class="line">          -&gt;<span class="built_in">map_builder</span>()</span><br><span class="line">          .<span class="built_in">pose_graph</span>()</span><br><span class="line">          -&gt;<span class="built_in">GetLocalToGlobalTransform</span>(request.<span class="built_in">trajectory_id</span>());</span><br><span class="line">  *response-&gt;<span class="built_in">mutable_local_to_global</span>() = transform::<span class="built_in">ToProto</span>(local_to_global);</span><br><span class="line">  <span class="built_in">Send</span>(std::<span class="built_in">move</span>(response));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>GetLocalToGlobalTransform</code>可用于获取local坐标系的原点<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">transform::Rigid3d <span class="title">PoseGraph2D::GetLocalToGlobalTransform</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">const</span> <span class="keyword">int</span> trajectory_id)</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="function">absl::MutexLock <span class="title">locker</span><span class="params">(&amp;mutex_)</span></span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">ComputeLocalToGlobalTransform</span>(data_.global_submap_poses_2d,</span><br><span class="line">                                       trajectory_id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>同样的还有 <code>PoseGraph2D::GetAllSubmapPoses</code>,  <code>PoseGraph2D::GetTrajectoryStates</code>,  <code>PoseGraph2D::GetTrajectoryNodePoses</code>,  <code>PoseGraph2D::GetLandmarkPoses()</code>,  <code>PoseGraph2D::constraints()</code>等等</p>
<p><code>cartographer\cartographer\cloud\internal\handlers</code>目录有一堆文件，每个文件只定义了一个对应的回调函数，这个回调函数只在<code>map_builder_server.cc</code>中调用，最终是运行<code>cartographer_grpc_server</code></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2022/04/30/%E6%BF%80%E5%85%89SLAM/Cartographer/%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/metrics%E6%9C%BA%E5%88%B6/">metrics机制</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-04-30</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E6%BF%80%E5%85%89SLAM/">激光SLAM</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E6%BF%80%E5%85%89SLAM/Cartographer/">Cartographer</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E6%BF%80%E5%85%89SLAM/Cartographer/%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/">源码解读</a></span><div class="content"><p>若要启用metrics机制，必须在launch文件里添加参数<code>-collect_metrics true</code>，这个本质也是gflag</p>
<p>源码的顺序如下<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// node.cc中</span></span><br><span class="line"><span class="keyword">if</span> (collect_metrics)</span><br><span class="line">&#123;</span><br><span class="line">  metrics_registry_ = absl::make_unique&lt;metrics::FamilyFactory&gt;();</span><br><span class="line">  carto::metrics::<span class="built_in">RegisterAllMetrics</span>(metrics_registry_.<span class="built_in">get</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// register.cc 中定义</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">RegisterAllMetrics</span><span class="params">(FamilyFactory* registry)</span> </span>&#123;</span><br><span class="line">  mapping::constraints::ConstraintBuilder2D::<span class="built_in">RegisterMetrics</span>(registry);</span><br><span class="line">  mapping::<span class="built_in">GlobalTrajectoryBuilderRegisterMetrics</span>(registry);</span><br><span class="line">  mapping::LocalTrajectoryBuilder2D::<span class="built_in">RegisterMetrics</span>(registry);</span><br><span class="line">  mapping::PoseGraph2D::<span class="built_in">RegisterMetrics</span>(registry);</span><br><span class="line">  sensor::TrajectoryCollator::<span class="built_in">RegisterMetrics</span>(registry);</span><br><span class="line">  <span class="comment">// 不需要可以注释掉</span></span><br><span class="line">  mapping::constraints::ConstraintBuilder3D::<span class="built_in">RegisterMetrics</span>(registry);</span><br><span class="line">  mapping::LocalTrajectoryBuilder3D::<span class="built_in">RegisterMetrics</span>(registry);</span><br><span class="line">  mapping::PoseGraph3D::<span class="built_in">RegisterMetrics</span>(registry);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>以上所有<code>RegisterMetrics</code>在<code>local_trajectory_builder_2d.cc</code>,  <code>pose_graph_2d.cc</code>,  <code>constraint_builder_2d.cc</code>(排除3D情况)定义了所有metrics参数</p>
<p><br></p>
<p>以<code>kLocalSlamCpuRealTimeRatio</code>为例进行说明， 在<code>local_trajectory_builder_2d.cc</code>开始部分的声明：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">auto</span>* kLocalSlamCpuRealTimeRatio = metrics::Gauge::<span class="built_in">Null</span>();`</span><br></pre></td></tr></table></figure></p>
<p>然后在<code>LocalTrajectoryBuilder2D::RegisterMetrics</code>中<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">auto</span>* cpu_real_time_ratio = family_factory-&gt;<span class="built_in">NewGaugeFamily</span>(</span><br><span class="line">      <span class="string">&quot;mapping_2d_local_trajectory_builder_cpu_real_time_ratio&quot;</span>,</span><br><span class="line">      <span class="string">&quot;sensor duration / cpu duration.&quot;</span>);</span><br><span class="line"></span><br><span class="line">kLocalSlamCpuRealTimeRatio = cpu_real_time_ratio-&gt;<span class="built_in">Add</span>(&#123;&#125;);</span><br></pre></td></tr></table></figure></p>
<p>最后是赋值部分<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (last_thread_cpu_time_seconds_.<span class="built_in">has_value</span>()) &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">double</span> thread_cpu_duration_seconds =</span><br><span class="line">        thread_cpu_time_seconds - last_thread_cpu_time_seconds_.<span class="built_in">value</span>();</span><br><span class="line">    <span class="keyword">if</span> (sensor_duration.<span class="built_in">has_value</span>()) &#123;</span><br><span class="line">      kLocalSlamCpuRealTimeRatio-&gt;<span class="built_in">Set</span>(</span><br><span class="line">          common::<span class="built_in">ToSeconds</span>(sensor_duration.<span class="built_in">value</span>()) / thread_cpu_duration_seconds );</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<p>如果想查看metrics，只能<code>rosservice call /read_metrics &quot;&#123;&#125;&quot;</code>，一次调用的结果部分：<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">name: <span class="string">&quot;mapping_constraints_constraint_builder_2d_constraints&quot;</span></span><br><span class="line">description: <span class="string">&quot;Constraints computed&quot;</span></span><br><span class="line">metrics: </span><br><span class="line">    <span class="built_in">type</span>: 0</span><br><span class="line">    labels: </span><br><span class="line">      - </span><br><span class="line">        key: <span class="string">&quot;matcher&quot;</span></span><br><span class="line">        value: <span class="string">&quot;searched&quot;</span></span><br><span class="line">      - </span><br><span class="line">        key: <span class="string">&quot;search_region&quot;</span></span><br><span class="line">        value: <span class="string">&quot;global&quot;</span></span><br><span class="line">    value: 4206.0</span><br><span class="line">    counts_by_bucket: []</span><br><span class="line">  - </span><br><span class="line">    <span class="built_in">type</span>: 0</span><br><span class="line">    labels: </span><br><span class="line">      - </span><br><span class="line">        key: <span class="string">&quot;matcher&quot;</span></span><br><span class="line">        value: <span class="string">&quot;found&quot;</span></span><br><span class="line">      - </span><br><span class="line">        key: <span class="string">&quot;search_region&quot;</span></span><br><span class="line">        value: <span class="string">&quot;global&quot;</span></span><br><span class="line">    value: 0.0</span><br><span class="line">    counts_by_bucket: []</span><br><span class="line"></span><br><span class="line">- </span><br><span class="line">  name: <span class="string">&quot;mapping_2d_pose_graph_constraints&quot;</span></span><br><span class="line">  description: <span class="string">&quot;Current number of constraints in the pose graph&quot;</span></span><br><span class="line">  metrics: </span><br><span class="line">    - </span><br><span class="line">      <span class="built_in">type</span>: 1</span><br><span class="line">      labels: </span><br><span class="line">        - </span><br><span class="line">          key: <span class="string">&quot;tag&quot;</span></span><br><span class="line">          value: <span class="string">&quot;inter_submap&quot;</span></span><br><span class="line">        - </span><br><span class="line">          key: <span class="string">&quot;trajectory&quot;</span></span><br><span class="line">          value: <span class="string">&quot;different&quot;</span></span><br><span class="line">      value: 0.0</span><br><span class="line">      counts_by_bucket: []</span><br><span class="line"></span><br><span class="line">name: <span class="string">&quot;mapping_constraints_constraint_builder_2d_num_submap_scan_matchers&quot;</span></span><br><span class="line">description: <span class="string">&quot;Current number of constructed submap scan matchers&quot;</span></span><br><span class="line">metrics: </span><br><span class="line">- </span><br><span class="line">    <span class="built_in">type</span>: 1</span><br><span class="line">    labels: []</span><br><span class="line">    value: 18.0</span><br><span class="line">    counts_by_bucket: []</span><br><span class="line">- </span><br><span class="line">name: <span class="string">&quot;mapping_2d_pose_graph_constraints&quot;</span></span><br><span class="line">description: <span class="string">&quot;Current number of constraints in the pose graph&quot;</span></span><br><span class="line">metrics: </span><br><span class="line">  - </span><br><span class="line">    <span class="built_in">type</span>: 1</span><br><span class="line">    labels: </span><br><span class="line">      - </span><br><span class="line">        key: <span class="string">&quot;tag&quot;</span></span><br><span class="line">        value: <span class="string">&quot;inter_submap&quot;</span></span><br><span class="line">      - </span><br><span class="line">        key: <span class="string">&quot;trajectory&quot;</span></span><br><span class="line">        value: <span class="string">&quot;different&quot;</span></span><br><span class="line">    value: 27.0</span><br><span class="line">    counts_by_bucket: []</span><br><span class="line">  - </span><br><span class="line">    <span class="built_in">type</span>: 1</span><br><span class="line">    labels: </span><br><span class="line">      - </span><br><span class="line">        key: <span class="string">&quot;tag&quot;</span></span><br><span class="line">        value: <span class="string">&quot;inter_submap&quot;</span></span><br><span class="line">      - </span><br><span class="line">        key: <span class="string">&quot;trajectory&quot;</span></span><br><span class="line">        value: <span class="string">&quot;same&quot;</span></span><br><span class="line">    value: 10.0</span><br><span class="line">    counts_by_bucket: []</span><br><span class="line">- </span><br><span class="line">name: <span class="string">&quot;mapping_constraints_constraint_builder_2d_scores&quot;</span></span><br><span class="line">description: <span class="string">&quot;Constraint scores built&quot;</span></span><br><span class="line">metrics: </span><br><span class="line">  - </span><br><span class="line">    <span class="built_in">type</span>: 2</span><br><span class="line">    labels: </span><br><span class="line">      - </span><br><span class="line">        key: <span class="string">&quot;search_region&quot;</span></span><br><span class="line">        value: <span class="string">&quot;local&quot;</span></span><br></pre></td></tr></table></figure><br>获知不同轨迹之间的查找次数和找到的约束数目，源码在<code>ConstraintBuilder2D::ComputeConstraint</code>中的<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kGlobalConstraintsFoundMetric-&gt;<span class="built_in">Increment</span>();</span><br><span class="line">kGlobalConstraintScoresMetric-&gt;<span class="built_in">Observe</span>(score);</span><br></pre></td></tr></table></figure></p>
<font size="4" color="blue"> 模仿源码，可以根据自己的需要添加 metrics  </font>

<p>如果不需要3D的metrics，可以到<code>ConstraintBuilder3D::RegisterMetrics</code>,  <code>LocalTrajectoryBuilder3D::RegisterMetrics</code>,  <code>PoseGraph3D::RegisterMetrics</code>中return</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2022/04/21/SLAM%E5%B7%A5%E5%85%B7/ceres%202%20%E8%87%AA%E5%8A%A8%E6%B1%82%E5%AF%BC/">Ceres(二) 自动求导</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-04-21</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/SLAM%E5%B7%A5%E5%85%B7/">SLAM工具</a></span><div class="content"><p>头文件只有一个<code>&quot;ceres/ceres.h&quot;</code></p>
<p>调试几个经典例子的过程<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;ceres/ceres.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> ceres::AutoDiffCostFunction;</span><br><span class="line"><span class="keyword">using</span> ceres::CostFunction;</span><br><span class="line"><span class="keyword">using</span> ceres::Problem;</span><br><span class="line"><span class="keyword">using</span> ceres::Solver;</span><br><span class="line"><span class="keyword">using</span> ceres::Solve;</span><br></pre></td></tr></table></figure><br><br></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span>  <span class="title">Functor</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt; <span class="function"><span class="keyword">bool</span> <span class="title">operator</span><span class="params">()</span><span class="params">(<span class="keyword">const</span> T* <span class="keyword">const</span> x, T* residual)</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		residual[<span class="number">0</span>] = <span class="number">10.0</span> - x[<span class="number">0</span>];</span><br><span class="line">		residual[<span class="number">1</span>] = <span class="number">3.0</span> - x[<span class="number">1</span>];</span><br><span class="line">		<span class="comment">// 直接让第2维度为0，优化后的x[1]还是初值2</span></span><br><span class="line">		<span class="comment">// residual[1] = T(0.0);</span></span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>这里的变量为二维的<script type="math/tex">(x_0, x_1)</script>，目标函数为<code>10.0-x</code>和<code>3.0-x</code></p>
<p>如果这里不写10.0而是10，就会报错。 Ceres中没有int，只接受double</p>
<p>对于<code>residual[1] = T(0.0);</code>的情况，如果不加<code>T</code>，编译就会报错<font size="4" color="orange"> error: no match for ‘operator=’ (operand types are ‘ceres::Jet<double, 2>’ and ‘double’)  </font>. Jet类型是ceres内置类型，我们要把double转成Jet类型，也就是<code>T(0.0)</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span>  <span class="title">TestLocalParam</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt; <span class="keyword">bool</span> <span class="title">operator</span><span class="params">()</span><span class="params">(<span class="keyword">const</span> T* x, <span class="keyword">const</span> T* delta, T* x_plus_delta)</span> <span class="keyword">const</span></span>&#123;</span><br><span class="line">		x_plus_delta[<span class="number">0</span>] = x[<span class="number">0</span>] + <span class="number">0.4</span> * delta[<span class="number">0</span>];</span><br><span class="line">		x_plus_delta[<span class="number">1</span>] = x[<span class="number">1</span>] + <span class="number">0.4</span> * delta[<span class="number">1</span>];</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><code>CostFunctor</code>的<code>operator</code>就是计算残差，不带平方项，平方是ceres自动添加，相当于最小二乘的函数 f</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// double x = 0.5;</span></span><br><span class="line"><span class="keyword">double</span> x[] = &#123;<span class="number">0.5</span>, <span class="number">2.0</span>&#125;;</span><br><span class="line"></span><br><span class="line">Problem problem;</span><br><span class="line"></span><br><span class="line">problem.<span class="built_in">AddParameterBlock</span>(x, <span class="number">2</span>, </span><br><span class="line">  (<span class="keyword">new</span> ceres::AutoDiffLocalParameterization</span><br><span class="line">  	<span class="comment">// 真正的维度是2， 参与优化的维度是1</span></span><br><span class="line">  	&lt;TestLocalParam, <span class="number">2</span>, <span class="number">1</span>&gt; ())</span><br><span class="line">	);</span><br><span class="line"><span class="comment">// AddParameterBlock 修改之后，无论下面的AutoDiffCostFunction参数是多少，只优化第1维度</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 残差的维度，参数的维度</span></span><br><span class="line"><span class="comment">// 如果此时是 2,1. 报错</span></span><br><span class="line">CostFunction* cost_func = <span class="keyword">new</span> AutoDiffCostFunction&lt;Functor, <span class="number">2</span>, <span class="number">2</span>&gt;(<span class="keyword">new</span> Functor);</span><br><span class="line"><span class="comment">// 参数：CostFunction，可选的LossFunction，将CostFunction连接到一组参数块</span></span><br><span class="line">problem.<span class="built_in">AddResidualBlock</span>(cost_func, <span class="literal">nullptr</span>, x);</span><br></pre></td></tr></table></figure>
<p>创建最小二乘问题，可以使用<code>Problem::AddResidualBlock()</code>和<code>Problem::AddParameterBlock()</code>。 可以使用<code>Problem::AddParameterBlock()</code>显式添加参数块，这将导致额外的正确性检查; 然而，如果参数块不存在，<code>Problem::AddResidualBlock()</code>会隐式添加参数块。</p>
<p><code>AddParameterBlock()</code>显式地向Problem添加了一个参数块。它还允许用户将LocalParameterization对象与参数块关联起来。</p>
<p><code>AddResidualBlock</code>默认会先调用<code>AddParameterBlock</code>，一般不用后者。</p>
<p>损失函数<code>LossFunction</code>，给异常值做限定，如果是nullptr，该项的代价就是残差的平方范数</p>
<p>代价函数携带关于它所期望的参数块大小的信息。函数检查这些参数是否与parameter_blocks中列出的参数块的大小匹配。如果检测到不匹配，程序将中止。</p>
<h2 id="Solver"><a href="#Solver" class="headerlink" title="Solver"></a>Solver</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">  Solver::Options  option;</span><br><span class="line">  option.minimizer_progress_to_stdout = <span class="literal">true</span>;</span><br><span class="line">  option.linear_solver_type = ceres::SPARSE_NORMAL_CHOLESKY;</span><br><span class="line"></span><br><span class="line">  Solver::Summary summary;</span><br><span class="line">  <span class="built_in">Solve</span>(option, &amp;problem, &amp;summary);</span><br><span class="line">  </span><br><span class="line">  std::cout &lt;&lt; summary.<span class="built_in">BriefReport</span>() &lt;&lt; std::endl&lt;&lt;std::endl;</span><br><span class="line">  <span class="comment">// std::cout &lt;&lt; summary.FullReport() &lt;&lt; std::endl&lt;&lt;std::endl;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// std::cout &lt;&lt; &quot;initial x: &quot; &lt;&lt; initial_x &lt;&lt;&quot;   x: &quot;&lt;&lt; x &lt;&lt; std::endl;</span></span><br><span class="line">  std::cout &lt;&lt;<span class="string">&quot;x[0]: &quot;</span>&lt;&lt; x[<span class="number">0</span>] &lt;&lt;<span class="string">&quot;   x[1]: &quot;</span>&lt;&lt; x[<span class="number">1</span>]&lt;&lt; std::endl;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>优先选用自动微分算法，某些情况可能需要用到解析微分算法，尽量避免数值微分算法。</p>
<h2 id="曲线拟合"><a href="#曲线拟合" class="headerlink" title="曲线拟合"></a>曲线拟合</h2><p>使用十四讲第六章的曲线拟合的例子，已知 N 个数据 <script type="math/tex">(x_i, y_i)</script>，它们符合曲线 <script type="math/tex">e^{(ax^2 + bx + c)}</script>，通过曲线拟合求 a, b, c</p>
<p>跟上面的例子不同，这次目标函数为 <script type="math/tex">e(x) = y-e^{(ax^2 + bx + c)}</script>，<font size="4" color="blue">  残差维度为3(未知a,b,c) </font></p>
<p>CMake配置如下<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">find_package(OpenCV REQUIRED)</span><br><span class="line">INCLUDE_DIRECTORIES($&#123;OpenCV_DIRS&#125;)</span><br><span class="line"></span><br><span class="line">target_link_libraries(node_2</span><br><span class="line">   $&#123;catkin_LIBRARIES&#125;</span><br><span class="line">   $&#123;CERES_LIBRARIES&#125;</span><br><span class="line">   $&#123;OpenCV_LIBS&#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure></p>
<p>先生成带有高斯噪声的数据<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;opencv2/opencv.hpp&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 真实值</span></span><br><span class="line"><span class="keyword">double</span> a =<span class="number">1.0</span>, b=<span class="number">2.0</span>, c=<span class="number">1.0</span>;</span><br><span class="line"><span class="comment">// abc的初值</span></span><br><span class="line"><span class="keyword">double</span> abc[<span class="number">3</span>]  = &#123;<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 生成带有噪声的模拟数据</span></span><br><span class="line">vector&lt;<span class="keyword">double</span>&gt; x_data, y_data;</span><br><span class="line"><span class="keyword">int</span> N = <span class="number">240</span>;  <span class="comment">// 数据数量</span></span><br><span class="line"><span class="keyword">double</span> w_sigma = <span class="number">1.0</span>;  <span class="comment">// 高斯标准差</span></span><br><span class="line">cv::RNG  rng;</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">unsigned</span> <span class="keyword">int</span> i =<span class="number">0</span>; i&lt;N; i++)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">double</span> x = i/<span class="number">100.0</span>;</span><br><span class="line">    x_data.<span class="built_in">push_back</span>(x);</span><br><span class="line">    y_data.<span class="built_in">push_back</span>(<span class="built_in">exp</span>(a*x*x + b*x + c) + rng.<span class="built_in">gaussian</span>(w_sigma)  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>高斯噪声的产生： <code>cv::RNG  rng;  rng.gaussian(w_sigma)</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Functor</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="built_in">Functor</span>(<span class="keyword">double</span> x, <span class="keyword">double</span> y):</span><br><span class="line">    <span class="built_in">m_x</span>(x), <span class="built_in">m_y</span>(y) &#123;    &#125;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">if</span> 0</span></span><br><span class="line">    <span class="comment">// 开始我是这么写的，没弄清残差的维度</span></span><br><span class="line">    <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt; <span class="keyword">bool</span> <span class="title">operator</span><span class="params">()</span><span class="params">( <span class="keyword">const</span> T* <span class="keyword">const</span> a, </span></span></span><br><span class="line"><span class="params"><span class="function">                                          <span class="keyword">const</span> T* <span class="keyword">const</span> b, </span></span></span><br><span class="line"><span class="params"><span class="function">                                          <span class="keyword">const</span> T* <span class="keyword">const</span> c, </span></span></span><br><span class="line"><span class="params"><span class="function">                                          T* residual)</span>  <span class="keyword">const</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        residual[<span class="number">0</span>] = m_y - <span class="built_in">exp</span>(a[<span class="number">0</span>] * m_x * m_x + b[<span class="number">0</span>] * m_x + c[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 因为要传入数据(x,y)， 所以要定义两个成员变量</span></span><br><span class="line">    <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt; <span class="keyword">bool</span> <span class="title">operator</span><span class="params">()</span><span class="params">( <span class="keyword">const</span> T* <span class="keyword">const</span> abc, T* residual)</span>  <span class="keyword">const</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        residual[<span class="number">0</span>] = m_y - <span class="built_in">exp</span>(abc[<span class="number">0</span>] * m_x * m_x + abc[<span class="number">1</span>] * m_x + abc[<span class="number">2</span>]);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">double</span> m_x, m_y;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>因为自变量x是一维的，而不是向量，所以残差只计算一维 <code>residual[0]</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Problem problem;</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">unsigned</span> <span class="keyword">int</span> i=<span class="number">0</span>; i&lt;N; i++)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// 残差维度， 所估计变量的维度</span></span><br><span class="line">  CostFunction* cost_func = <span class="keyword">new</span> AutoDiffCostFunction&lt;Functor,<span class="number">1</span>,<span class="number">3</span>&gt;(<span class="keyword">new</span> <span class="built_in">Functor</span>(x_data[i], y_data[i]) );</span><br><span class="line">  problem.<span class="built_in">AddResidualBlock</span>(cost_func, <span class="literal">nullptr</span>, abc);</span><br><span class="line">&#125;</span><br><span class="line">Solver::Options option;</span><br><span class="line">option.minimizer_progress_to_stdout = <span class="literal">true</span>;</span><br><span class="line">option.linear_solver_type = ceres::SPARSE_NORMAL_CHOLESKY;</span><br><span class="line"></span><br><span class="line">Solver::Summary summary;</span><br><span class="line"><span class="built_in">Solve</span>(option, &amp;problem, &amp;summary);</span><br><span class="line"></span><br><span class="line">cout &lt;&lt; summary.<span class="built_in">BriefReport</span>() &lt;&lt; endl &lt;&lt;endl;</span><br><span class="line">cout &lt;&lt; <span class="string">&quot;a: &quot;</span>&lt;&lt; abc[<span class="number">0</span>] &lt;&lt;<span class="string">&quot;  b: &quot;</span>&lt;&lt; abc[<span class="number">1</span>]&lt;&lt; <span class="string">&quot;  c: &quot;</span>&lt;&lt; abc[<span class="number">2</span>] &lt;&lt;endl;</span><br></pre></td></tr></table></figure>
<p>参考：<br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/vivian187/p/15331181.html">Curve Fitting(曲线拟合)</a><br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/vivian187/p/15394000.html">Problem类</a><br><a target="_blank" rel="noopener" href="https://www.zybuluo.com/iStarLee/note/1639516#88-evaluate%E7%9B%B8%E5%85%B3">资料</a></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2022/04/18/%E6%BF%80%E5%85%89SLAM/Hector/">Hector</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-04-18</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E6%BF%80%E5%85%89SLAM/">激光SLAM</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E6%BF%80%E5%85%89SLAM/%E5%85%B6%E4%BB%96/">其他</a></span><div class="content"><p>hector相当于cartographer的前端，没有闭环检测，利用高斯牛顿方法来解决scan-matching的问题。它要求激光雷达的扫描频率比较高，建图时机器人速度需要很慢，但在机器人快速转弯时容易发生错误，原因在于优化算法容易陷入局部最小值。使用了多分辨率地图，也可以没有里程计。</p>
<p>论文的新颖点在于scanMatch使用<strong>高斯牛顿法</strong>以及<strong>多分辨率地图</strong>，后来被cartographer借鉴。</p>
<p><img src="https://s2.loli.net/2022/04/18/BJeNV18bKDCqHEn.png" alt="对向量求导.png"></p>
<h2 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h2><ol>
<li>hector的计算太慢了，只进行扫描匹配的操作就要花费大概0.1秒钟，这就导致即使雷达频率再高，hector也处理不过来</li>
<li>hector的地图不能自动更改大小，地图的大小在初始化之后始终是固定的</li>
<li>适用于非光滑线性逼近的地图梯度∇M(Si(ε))，这意味着不能保证局部二次收敛到最小，但该算法在实践中精度较高。</li>
</ol>
<p>参考：<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/tiancailx/article/details/113522899">李想对hector的分析</a><br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/dlutjwh/p/10962026.html">论文阅读：hector_slam</a></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2022/04/15/%E6%BF%80%E5%85%89SLAM/Cartographer/%E5%8E%9F%E7%90%86%E5%92%8C%E9%85%8D%E7%BD%AE/cartographer_grpc_server%E7%9A%84%E9%85%8D%E7%BD%AE/">cartographer_grpc_server的使用和配置</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-04-15</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E6%BF%80%E5%85%89SLAM/">激光SLAM</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E6%BF%80%E5%85%89SLAM/Cartographer/">Cartographer</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E6%BF%80%E5%85%89SLAM/Cartographer/%E5%8E%9F%E7%90%86%E5%92%8C%E9%85%8D%E7%BD%AE/">原理和配置</a></span><div class="content"><p>使用gRPC与云端结合：cartographer使用Protobuf数据传输协议，所以可以使用gRPC（也是谷歌的），可以通过云端运行cartographer算法，最典型的例子就是多机器人在一张已知地图上进行导航，在一个远程的强大centralized localization server运行 multi-trajectories Cartographer</p>
<p>方案：一台机器运行local optimization，另一台运行 global optimization</p>
<p>Cloud-based mapping ，using a gRPC streaming connection between local and global SLAM to propagate sensor data and local SLAM updates, which does not support ACKs and resending, hence this is not going to work over spotty WiFi.<br><img src="https://s2.loli.net/2022/04/15/luS9ofiMEh5c2mR.png" alt=""></p>
<p>先安装<code>protobuf</code>和<code>ceres</code></p>
<h2 id="安装-grpc"><a href="#安装-grpc" class="headerlink" title="安装 grpc"></a>安装 grpc</h2><p>一开始下载<code>grpc</code>后进行编译，结果报错：<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CMake Warning at cmake/abseil-cpp.cmake:30 (message):</span><br><span class="line">  gRPC_ABSL_PROVIDER is <span class="string">&quot;module&quot;</span> but ABSL_ROOT_DIR is wrong</span><br><span class="line">Call Stack (most recent call first):</span><br><span class="line">  CMakeLists.txt:188 (include)</span><br></pre></td></tr></table></figure><br>这说明第三方库没准备好，最好按如下步骤：</p>
<p>如果只想下载指定版本的，如以版本<code>1.27.3</code>为例，可改成如下语句：<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone -b v1<span class="number">.27</span><span class="number">.0</span> https:<span class="comment">//github.com/grpc/grpc.git</span></span><br></pre></td></tr></table></figure><br>上列操作成功完成后，gRPC 源码的第三方依赖目录 <code>third_party</code> 实际是空的，需通过下列步骤拉取依赖的第三方。切换到 grpc 目录，下载 grpc 第三方依赖到本地：<br><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git submodule update --init</span><br></pre></td></tr></table></figure><br>grpc依赖的第三方库有点多，如果不借助<code>git submodule</code>，手工一个个下载不太容易。其中的<code>bloaty</code>库很大。</p>
<p>注意，gRPC 要求 <code>CMake 3.5.1</code> 或以上版本的CMake，否则会报错 CMake 3.5.1 or higher is required </p>
<p>编译：<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cmake -DgRPC_SSL_PROVIDER=package ..</span><br><span class="line">make -j8</span><br><span class="line">sudo make install</span><br><span class="line"></span><br><span class="line">cmake  -DgRPC_INSTALL=ON -DgRPC_ZLIB_PROVIDER=package -DgRPC_CARES_PROVIDER=package -DgRPC_PROTOBUF_PROVIDER=package -DgRPC_SSL_PROVIDER=package -DgRPC_ABSL_PROVIDER=package ..</span><br><span class="line">make -j8</span><br><span class="line">sudo make install</span><br><span class="line"></span><br><span class="line">cmake  -DgRPC_INSTALL=ON -DBUILD_SHARED_LIBS=ON -DgRPC_ZLIB_PROVIDER=package -DgRPC_CARES_PROVIDER=package -DgRPC_PROTOBUF_PROVIDER=package -DgRPC_SSL_PROVIDER=package -DgRPC_ABSL_PROVIDER=package ..</span><br><span class="line">make -j8</span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure></p>
<h2 id="CMake配置"><a href="#CMake配置" class="headerlink" title="CMake配置"></a>CMake配置</h2><p>在包含<code>option(BUILD_GRPC &quot;build Cartographer gRPC support&quot; false)</code>的3个<code>CMakeLists</code>修改为true。 最好再添加 <code>set(BUILD_GRPC true)</code>，以及C++14的支持  <code>set(CMAKE_CXX_STANDARD 14)</code></p>
<h2 id="lua配置"><a href="#lua配置" class="headerlink" title="lua配置"></a>lua配置</h2><p><code>backpack_2d_server.lua</code>如下:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">include <span class="string">&quot;map_builder_server.lua&quot;</span></span><br><span class="line"></span><br><span class="line">MAP_BUILDER_SERVER.map_builder.use_trajectory_builder_2d = <span class="keyword">true</span></span><br><span class="line"><span class="keyword">return</span> MAP_BUILDER_SERVER</span><br></pre></td></tr></table></figure></p>
<p><code>map_builder_server.lua</code>如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">include <span class="string">&quot;map_builder.lua&quot;</span></span><br><span class="line"></span><br><span class="line">MAP_BUILDER_SERVER = &#123;</span><br><span class="line">  map_builder = MAP_BUILDER,</span><br><span class="line">  num_event_threads = <span class="number">4</span>,</span><br><span class="line">  num_grpc_threads = <span class="number">4</span>,</span><br><span class="line">  --- 我的修改</span><br><span class="line">  server_address = <span class="string">&quot;192.168.0.105:50051&quot;</span>,</span><br><span class="line">  uplink_server_address = <span class="string">&quot;&quot;</span>,</span><br><span class="line">  upload_batch_size = <span class="number">100</span>,</span><br><span class="line">  enable_ssl_encryption = <span class="keyword">false</span>,</span><br><span class="line">  enable_google_auth = <span class="keyword">false</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="运行数据集"><a href="#运行数据集" class="headerlink" title="运行数据集"></a>运行数据集</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">roslaunch cartographer_ros grpc_demo_backpack_2d.launch bag_filename:=/home/user/cartographer/dataset/cartographer_paper_deutsches_museum.bag</span><br></pre></td></tr></table></figure>
<p>这是在一台机上运行客户端和服务端<br><img src="https://s2.loli.net/2022/08/21/thAPe3QlsTKYyRc.png" alt=""><br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">launch</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">&quot;/use_sim_time&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">&quot;robot_description&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">textfile</span>=<span class="string">&quot;$(find cartographer_ros)/urdf/backpack_2d.urdf&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">node</span> <span class="attr">name</span>=<span class="string">&quot;robot_state_publisher&quot;</span> <span class="attr">pkg</span>=<span class="string">&quot;robot_state_publisher&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">type</span>=<span class="string">&quot;robot_state_publisher&quot;</span> /&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- 服务端 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">node</span> <span class="attr">name</span>=<span class="string">&quot;cartographer_grpc_server&quot;</span> <span class="attr">pkg</span>=<span class="string">&quot;cartographer_ros&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">type</span>=<span class="string">&quot;cartographer_grpc_server.sh&quot;</span> <span class="attr">args</span>=<span class="string">&quot;</span></span></span><br><span class="line"><span class="string"><span class="tag">          -configuration_directory $(find cartographer_ros)/configuration_files</span></span></span><br><span class="line"><span class="string"><span class="tag">          -configuration_basename backpack_2d_server.lua&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">node</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- 客户端 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">node</span> <span class="attr">name</span>=<span class="string">&quot;cartographer_grpc_node&quot;</span> <span class="attr">pkg</span>=<span class="string">&quot;cartographer_ros&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">type</span>=<span class="string">&quot;cartographer_grpc_node&quot;</span> <span class="attr">args</span>=<span class="string">&quot;</span></span></span><br><span class="line"><span class="string"><span class="tag">    -client_id CLIENT_ID</span></span></span><br><span class="line"><span class="string"><span class="tag">          -configuration_directory $(find cartographer_ros)/configuration_files</span></span></span><br><span class="line"><span class="string"><span class="tag">          -configuration_basename backpack_2d.lua&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">output</span>=<span class="string">&quot;screen&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">remap</span> <span class="attr">from</span>=<span class="string">&quot;echoes&quot;</span> <span class="attr">to</span>=<span class="string">&quot;horizontal_laser_2d&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">node</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">node</span> <span class="attr">name</span>=<span class="string">&quot;playbag&quot;</span> <span class="attr">pkg</span>=<span class="string">&quot;rosbag&quot;</span> <span class="attr">type</span>=<span class="string">&quot;play&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">args</span>=<span class="string">&quot;--clock $(arg bag_filename)&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">node</span> <span class="attr">name</span>=<span class="string">&quot;rviz&quot;</span> <span class="attr">pkg</span>=<span class="string">&quot;rviz&quot;</span> <span class="attr">type</span>=<span class="string">&quot;rviz&quot;</span> <span class="attr">required</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">args</span>=<span class="string">&quot;-d $(find cartographer_ros)/configuration_files/demo_2d.rviz&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">launch</span>&gt;</span></span><br></pre></td></tr></table></figure><br>就是<code>CLIENT_ID</code>，无需设置为数字。</p>
<h2 id="真实运行"><a href="#真实运行" class="headerlink" title="真实运行"></a>真实运行</h2><ul>
<li>把客户端上的<code>ROS_MASTER_URI</code>设置为服务端的IP</li>
<li>rviz放在服务端。</li>
<li>服务端的终端刷新日志，客户端不刷新</li>
<li>网络不能差，否则服务端刷新慢。</li>
<li>连接成功后，关服务端，客户端也会终止。连接成功后，关客户端，服务端停止刷新；再启动客户端，服务端继续更新。</li>
</ul>
<p>客户端<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">launch</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">node</span> <span class="attr">name</span>=<span class="string">&quot;cartographer_grpc_node&quot;</span> <span class="attr">pkg</span>=<span class="string">&quot;cartographer_ros&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">type</span>=<span class="string">&quot;cartographer_grpc_node&quot;</span> <span class="attr">args</span>=<span class="string">&quot;</span></span></span><br><span class="line"><span class="string"><span class="tag">      -client_id CLIENT_ID</span></span></span><br><span class="line"><span class="string"><span class="tag">      -server_address 192.168.1.213:50051</span></span></span><br><span class="line"><span class="string"><span class="tag">          -configuration_directory $(find cartographer_ros)/configuration_files</span></span></span><br><span class="line"><span class="string"><span class="tag">          -configuration_basename backpack_2d.lua&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">output</span>=<span class="string">&quot;screen&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">remap</span> <span class="attr">from</span>=<span class="string">&quot;/scan&quot;</span> <span class="attr">to</span>=<span class="string">&quot;/sick_tim551_scan&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">remap</span> <span class="attr">from</span>=<span class="string">&quot;/odom&quot;</span> <span class="attr">to</span>=<span class="string">&quot;/odometry/filtered&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">node</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">launch</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>服务端<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">launch</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">node</span> <span class="attr">name</span>=<span class="string">&quot;cartographer_grpc_server&quot;</span> <span class="attr">pkg</span>=<span class="string">&quot;cartographer_ros&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">type</span>=<span class="string">&quot;cartographer_grpc_server.sh&quot;</span> <span class="attr">args</span>=<span class="string">&quot;</span></span></span><br><span class="line"><span class="string"><span class="tag">          -configuration_directory $(find cartographer_ros)/configuration_files</span></span></span><br><span class="line"><span class="string"><span class="tag">          -configuration_basename backpack_2d_server.lua&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">node</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">node</span> <span class="attr">name</span>=<span class="string">&quot;rviz&quot;</span> <span class="attr">pkg</span>=<span class="string">&quot;rviz&quot;</span> <span class="attr">type</span>=<span class="string">&quot;rviz&quot;</span> <span class="attr">required</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">args</span>=<span class="string">&quot;-d $(find cartographer_ros)/configuration_files/demo_2d.rviz&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">launch</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<h2 id="纯定位"><a href="#纯定位" class="headerlink" title="纯定位"></a>纯定位</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">node</span> <span class="attr">name</span>=<span class="string">&quot;cartographer_grpc_node&quot;</span> <span class="attr">pkg</span>=<span class="string">&quot;cartographer_ros&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">type</span>=<span class="string">&quot;cartographer_grpc_node&quot;</span> <span class="attr">args</span>=<span class="string">&quot;</span></span></span><br><span class="line"><span class="string"><span class="tag">        -client_id CLIENT_ID</span></span></span><br><span class="line"><span class="string"><span class="tag">        -configuration_directory $(find cartographer_ros)/configuration_files</span></span></span><br><span class="line"><span class="string"><span class="tag">        -configuration_basename backpack_2d_localization.lua</span></span></span><br><span class="line"><span class="string"><span class="tag">        -load_state_filename $(arg load_state_filename)&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">output</span>=<span class="string">&quot;screen&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">remap</span> <span class="attr">from</span>=<span class="string">&quot;echoes&quot;</span> <span class="attr">to</span>=<span class="string">&quot;horizontal_laser_2d&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">node</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>参考：<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/windxf/article/details/108868236">运行cartographer的gRPC demo</a><br><a target="_blank" rel="noopener" href="http://txgcwm.github.io/blog/2014/03/26/ubuntuxia-an-zhuang-c-aresku/">Ubuntu下安装c-ares库</a></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2022/04/15/%E6%BF%80%E5%85%89SLAM/Cartographer/%E5%8E%9F%E7%90%86%E5%92%8C%E9%85%8D%E7%BD%AE/%E5%A6%82%E4%BD%95%E6%89%93%E5%8D%B0%E5%BD%93%E5%89%8D%E4%BD%BF%E7%94%A8%E7%9A%84lua%E5%8F%82%E6%95%B0/">如何打印当前使用的lua参数</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-04-15</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E6%BF%80%E5%85%89SLAM/">激光SLAM</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E6%BF%80%E5%85%89SLAM/Cartographer/">Cartographer</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E6%BF%80%E5%85%89SLAM/Cartographer/%E5%8E%9F%E7%90%86%E5%92%8C%E9%85%8D%E7%BD%AE/">原理和配置</a></span><div class="content"><p>这里就是使用<code>cartographer_print_configuration</code>，它输出了当前cartographer使用的所有lua参数，虽然不如rosparam强大，但也是一种方法，本质就是读取加载的lua文件。</p>
<p>代码比较简单，不用太过研究，直接写launch<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">launch</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">node</span> <span class="attr">name</span>=<span class="string">&quot;print_mit_config&quot;</span> <span class="attr">pkg</span>=<span class="string">&quot;cartographer_ros&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">type</span>=<span class="string">&quot;cartographer_print_configuration&quot;</span> <span class="attr">args</span>=<span class="string">&quot;</span></span></span><br><span class="line"><span class="string"><span class="tag">          -configuration_directories $(find cartographer_ros)/configuration_files</span></span></span><br><span class="line"><span class="string"><span class="tag">          -configuration_basename mit_stata_odom.lua</span></span></span><br><span class="line"><span class="string"><span class="tag">	  	  -subdictionary map_builder&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">output</span>=<span class="string">&quot;screen&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">node</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">launch</span>&gt;</span></span><br></pre></td></tr></table></figure><br>运行后会报错，找不到<code>cartographer_print_configuration</code>，这是因为可执行文件在bin路径: <code>/home/user/carto_ws/install_isolated/bin/cartographer_print_configuration</code>，roslaunch找的是<code>/home/user/carto_ws/install_isolated/lib/cartographer_ros</code>路径下的文件，复制到这里就好了。</p>
<p>运行launch就会输出所有lua参数，自己设置的参数也会覆盖默认的。 另外还有个<code>subdictionary</code>参数，输出的是子参数，这里用map_builder。但是只能输出第一级的子参数，如果自参数太底层就会报错，比如<code>submaps</code>做子参数就会运行错误。</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2022/04/13/%E6%BF%80%E5%85%89SLAM/LOAM%E7%B3%BB%E5%88%97/%E7%82%B9%E4%BA%91%E5%9C%B0%E5%9B%BE/">点云地图</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-04-13</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/LOAM%E7%B3%BB%E5%88%97/">LOAM系列</a></span><div class="content"><ul>
<li><p>去除噪点：激光雷达扫的点云有很多噪点，需要用PCL移除噪点。有的是孤立点，有的是激光打到边缘产生的衍射现象，衍射产生的点也要移除。</p>
</li>
<li><p>降采样：激光的数据量很大，需要用Voxel进行降采样</p>
</li>
<li><p>移除行人： 动态障碍，没必要采用</p>
</li>
<li><p>移除地面： 地面不是重要的参考，也要移除</p>
</li>
<li><p>点云变换和增量式注册： </p>
</li>
<li><p>mesh化： 点云地图建好后，把点云用边连起来，形成三维模型，再用Matlab进行处理</p>
</li>
</ul>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2022/04/13/%E6%BF%80%E5%85%89SLAM/Cartographer/%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/cartographer_occupancy_grid_node%E8%8E%B7%E5%8F%96%E5%9C%B0%E5%9B%BE/">cartographer_occupancy_grid_node获取地图</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-04-13</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E6%BF%80%E5%85%89SLAM/">激光SLAM</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E6%BF%80%E5%85%89SLAM/Cartographer/">Cartographer</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E6%BF%80%E5%85%89SLAM/Cartographer/%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/">源码解读</a></span><div class="content"><p>Rviz中的地图绘制使用了<code>cairo</code>库。注意gflag的参数<code>include_frozen_submaps</code> 和 <code>include_unfrozen_submaps</code>不能都为false，否则会报错</p>
<p>cartographer<em>rviz的绘制方式，就是`submap_node</em><code>控制一个子图的绘制，每个子图有一个子图原点，这个是</code>submap_query<code>中的</code>slice_pose<code>。而每个子图之间是有微弱旋转的，而控制旋转的中心也是这个</code>slice_pose<code>。而每个子图之间的旋转和平移可以通过</code>submap_list`的pose得到。</p>
<p><code>main</code>函数值得看的就一句<code>::cartographer_ros::Node node(FLAGS_resolution, FLAGS_publish_period_sec);</code>，构造函数如下<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">Node::<span class="built_in">Node</span>(<span class="keyword">const</span> <span class="keyword">double</span> resolution, <span class="keyword">const</span> <span class="keyword">double</span> publish_period_sec)</span><br><span class="line">: <span class="built_in">resolution_</span>(resolution),</span><br><span class="line">	<span class="comment">// submap_query 服务的客户端</span></span><br><span class="line">  <span class="built_in">client_</span>(node_handle_.serviceClient&lt;::cartographer_ros_msgs::SubmapQuery&gt;(</span><br><span class="line">      kSubmapQueryServiceName)),</span><br><span class="line">  <span class="comment">// submap_list话题的订阅者，回调函数 HandleSubmapList</span></span><br><span class="line">  <span class="built_in">submap_list_subscriber_</span>(node_handle_.<span class="built_in">subscribe</span>(</span><br><span class="line">      kSubmapListTopic, kLatestOnlyPublisherQueueSize,</span><br><span class="line">      boost::function&lt;<span class="built_in"><span class="keyword">void</span></span>(</span><br><span class="line">          <span class="keyword">const</span> cartographer_ros_msgs::SubmapList::ConstPtr&amp;)&gt;(</span><br><span class="line">          [<span class="keyword">this</span>](<span class="keyword">const</span> cartographer_ros_msgs::SubmapList::ConstPtr&amp; msg) &#123;</span><br><span class="line">            <span class="built_in">HandleSubmapList</span>(msg);</span><br><span class="line">          &#125;))),</span><br><span class="line">  <span class="comment">// 发布话题 map</span></span><br><span class="line">  <span class="built_in">occupancy_grid_publisher_</span>(</span><br><span class="line">      node_handle_.advertise&lt;::nav_msgs::OccupancyGrid&gt;(</span><br><span class="line">          kOccupancyGridTopic, kLatestOnlyPublisherQueueSize,</span><br><span class="line">          <span class="literal">true</span> <span class="comment">/* latched */</span>)),</span><br><span class="line">  <span class="comment">// timer执行DrawAndPublish函数</span></span><br><span class="line">  <span class="built_in">occupancy_grid_publisher_timer_</span>(</span><br><span class="line">      node_handle_.<span class="built_in">createWallTimer</span>(::ros::<span class="built_in">WallDuration</span>(publish_period_sec),</span><br><span class="line">                                   &amp;Node::DrawAndPublish, <span class="keyword">this</span>)) &#123;&#125;</span><br></pre></td></tr></table></figure><br><code>Node::DrawAndPublish</code>是画图和发布<code>map</code>，不是重点</p>
<p><br></p>
<p><code>HandleSubmapList</code>函数大部分都很简单，终点是下面这句：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">auto</span> fetched_textures =</span><br><span class="line">        ::cartographer_ros::<span class="built_in">FetchSubmapTextures</span>(id, &amp;client_);</span><br></pre></td></tr></table></figure><br>内部其实就是<code>submap_query</code>的客户端发起请求，服务端的注册在<code>Node</code>的构造函数里，回调是<code>Node::HandleSubmapQuery</code></p>
<p>代码调用顺序是： <code>Node::HandleSubmapQuery</code> —— <code>MapBuilderBridge::HandleSubmapQuery</code> —— <code>MapBuilder::SubmapToProto</code> —— <code>PoseGraph2D::GetSubmapData</code> 和 <code>Submap2D::ToResponseProto</code>  —— <code>ProbabilityGrid::DrawToSubmapTexture</code></p>
<p>重点：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这里比较简单，最终返回的是后端传来的 global坐标系下的位姿</span></span><br><span class="line"><span class="function">PoseGraphInterface::SubmapData <span class="title">PoseGraph2D::GetSubmapDataUnderLock</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">const</span> SubmapId&amp; submap_id)</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">auto</span> it = data_.submap_data.<span class="built_in">find</span>(submap_id);</span><br><span class="line">  <span class="keyword">if</span> (it == data_.submap_data.<span class="built_in">end</span>())</span><br><span class="line">      <span class="keyword">return</span> &#123;&#125;;</span><br><span class="line">  <span class="keyword">auto</span> submap = it-&gt;data.submap;</span><br><span class="line">  <span class="keyword">if</span> (data_.global_submap_poses_2d.<span class="built_in">Contains</span>(submap_id) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// We already have an optimized pose.</span></span><br><span class="line">    <span class="keyword">return</span> &#123;submap,</span><br><span class="line">            transform::<span class="built_in">Embed3D</span>(</span><br><span class="line">                data_.global_submap_poses_2d.<span class="built_in">at</span>(submap_id).global_pose) &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// We have to extrapolate.</span></span><br><span class="line">  <span class="keyword">return</span> &#123;submap, <span class="built_in">ComputeLocalToGlobalTransform</span>(data_.global_submap_poses_2d,</span><br><span class="line">                                                submap_id.trajectory_id) *</span><br><span class="line">                      submap-&gt;<span class="built_in">local_pose</span>() &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Submap2D::ToResponseProto</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">const</span> transform::Rigid3d&amp;,</span></span></span><br><span class="line"><span class="params"><span class="function">    proto::SubmapQuery::Response* <span class="keyword">const</span> response)</span> <span class="keyword">const</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!grid_)  	<span class="keyword">return</span>;</span><br><span class="line">  <span class="comment">// 这个 version 是子图插入了多少雷达数据，完成的子图是 2* num_range_data</span></span><br><span class="line">  response-&gt;<span class="built_in">set_submap_version</span>( <span class="built_in">num_range_data</span>()  );</span><br><span class="line">  proto::SubmapQuery::Response::SubmapTexture* <span class="keyword">const</span> texture =</span><br><span class="line">      response-&gt;<span class="built_in">add_textures</span>();</span><br><span class="line">  <span class="built_in">grid</span>()-&gt;<span class="built_in">DrawToSubmapTexture</span>(texture, <span class="built_in">local_pose</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>再看<code>DrawToSubmapTexture</code><br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">ProbabilityGrid::DrawToSubmapTexture</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    proto::SubmapQuery::Response::SubmapTexture* <span class="keyword">const</span> texture,</span></span></span><br><span class="line"><span class="params"><span class="function">    transform::Rigid3d local_pose)</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  Eigen::Array2i offset;</span><br><span class="line">  CellLimits cell_limits;</span><br><span class="line">  <span class="built_in">ComputeCroppedLimits</span>(&amp;offset, &amp;cell_limits);</span><br><span class="line"></span><br><span class="line">  std::string cells;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> Eigen::Array2i&amp; xy_index : <span class="built_in">XYIndexRangeIterator</span>(cell_limits))</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">IsKnown</span>(xy_index + offset)) &#123;</span><br><span class="line">      cells.<span class="built_in">push_back</span>(<span class="number">0</span> <span class="comment">/* unknown log odds value */</span>);</span><br><span class="line">      cells.<span class="built_in">push_back</span>(<span class="number">0</span> <span class="comment">/* alpha */</span>);</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// We would like to add &#x27;delta&#x27; but this is not possible using a value and</span></span><br><span class="line">    <span class="comment">// alpha. We use premultiplied alpha, so when &#x27;delta&#x27; is positive we can</span></span><br><span class="line">    <span class="comment">// add it by setting &#x27;alpha&#x27; to zero. If it is negative, we set &#x27;value&#x27; to</span></span><br><span class="line">    <span class="comment">// zero, and use &#x27;alpha&#x27; to subtract. This is only correct when the pixel</span></span><br><span class="line">    <span class="comment">// is currently white, so walls will look too gray. This should be hard to</span></span><br><span class="line">    <span class="comment">// detect visually for the user, though.</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// delta范围[-127, 127]</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> delta =</span><br><span class="line">        <span class="number">128</span> - <span class="built_in">ProbabilityToLogOddsInteger</span>(<span class="built_in">GetProbability</span>(xy_index + offset));</span><br><span class="line">    <span class="keyword">const</span> uint8 alpha = delta &gt; <span class="number">0</span> ? <span class="number">0</span> : -delta;</span><br><span class="line">    <span class="keyword">const</span> uint8 value = delta &gt; <span class="number">0</span> ? delta : <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 存数据有2个值，栅格值value和alpha透明度</span></span><br><span class="line">    cells.<span class="built_in">push_back</span>(value);</span><br><span class="line">    cells.<span class="built_in">push_back</span>((value || alpha) ? alpha : <span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 保存地图栅格数据时进行压缩</span></span><br><span class="line">  common::<span class="built_in">FastGzipString</span>(cells, texture-&gt;<span class="built_in">mutable_cells</span>());</span><br><span class="line">  <span class="comment">// 地图描述信息赋值，省略</span></span><br><span class="line">  	......</span><br><span class="line">  *texture-&gt;<span class="built_in">mutable_slice_pose</span>() = transform::<span class="built_in">ToProto</span>(</span><br><span class="line">      local_pose.<span class="built_in">inverse</span>() *</span><br><span class="line">      transform::Rigid3d::<span class="built_in">Translation</span>(Eigen::<span class="built_in">Vector3d</span>(max_x, max_y, <span class="number">0.</span>))  );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 解压后的栅格数据</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">SubmapTexture</span> &#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">Pixels</span> &#123;</span></span><br><span class="line">    std::vector&lt;<span class="keyword">char</span>&gt; intensity;   <span class="comment">// 栅格值</span></span><br><span class="line">    std::vector&lt;<span class="keyword">char</span>&gt; alpha;      <span class="comment">// 透明度</span></span><br><span class="line">  &#125;;</span><br><span class="line">  Pixels pixels;</span><br><span class="line">  <span class="keyword">int</span> width;</span><br><span class="line">  <span class="keyword">int</span> height;</span><br><span class="line">  <span class="keyword">double</span> resolution;</span><br><span class="line">  ::cartographer::transform::Rigid3d slice_pose;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 压缩后的栅格数据</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">SubmapTextures</span> &#123;</span></span><br><span class="line">  <span class="keyword">int</span> version;</span><br><span class="line">  std::vector&lt;SubmapTexture&gt; textures;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
</div><hr></div><nav id="pagination"><div class="pagination"><a class="extend prev" rel="prev" href="/page/19/">&lt;&lt; Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/19/">19</a><span class="page-number current">20</span><a class="page-number" href="/page/21/">21</a><span class="space">&hellip;</span><a class="page-number" href="/page/66/">66</a><a class="extend next" rel="next" href="/page/21/">Next &gt;&gt;</a></div></nav></div></div><footer class="footer-bg" style="background-image: url(https://s2.loli.net/2022/11/17/QOR8cePIS5NdDrK.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2018 - 2024 By Charon Cheung</div><div class="framework-info"><span>Driven - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_site_uv"><i class="fa fa-user"></i><span id="busuanzi_value_site_uv"></span><span></span></span><span class="footer-separator">|</span><span id="busuanzi_container_site_pv"><i class="fa fa-eye"></i><span id="busuanzi_value_site_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.6.1"></script><script src="/js/fancybox.js?version=1.6.1"></script><script src="/js/sidebar.js?version=1.6.1"></script><script src="/js/copy.js?version=1.6.1"></script><script src="/js/fireworks.js?version=1.6.1"></script><script src="/js/transition.js?version=1.6.1"></script><script src="/js/scroll.js?version=1.6.1"></script><script src="/js/head.js?version=1.6.1"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
    processEscapes: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
  },
  CommonHTML: {
    linebreaks: { automatic: true, width: "90% container" }
  },
  "HTML-CSS": { 
    linebreaks: { automatic: true, width: "90% container" }
  },
  "SVG": { 
    linebreaks: { automatic: true, width: "90% container" }
  }
});
</script><script type="text/x-mathjax-config">MathJax.Hub.Queue(function() {
  var all = MathJax.Hub.getAllJax(), i;
  for (i=0; i < all.length; i += 1) {
    all[i].SourceElement().parentNode.className += ' has-jax';
  }
});
</script><script src="https://cdn.bootcss.com/mathjax/2.7.2/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script>if(/Android|webOS|iPhone|iPod|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
}</script></body></html>