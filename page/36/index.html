<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content=""><meta name="keywords" content=""><meta name="author" content="Charon Cheung"><meta name="copyright" content="Charon Cheung"><title>If you wish for peace, prepare for war | 沉默杀手</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.6.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.6.1"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  }
} </script><meta name="generator" content="Hexo 5.4.0"></head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="author-info"><div class="author-info__avatar text-center"><img src="https://s2.loli.net/2022/02/17/HQaCXUBn64zsMIL.png"></div><div class="author-info__name text-center">Charon Cheung</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">595</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">5</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">54</span></a></div></div></div><nav id="nav" style="background-image: url(https://s2.loli.net/2022/11/17/QOR8cePIS5NdDrK.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">沉默杀手</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span></div><div id="site-info"><div id="site-title">沉默杀手</div><div id="site-sub-title">If you wish for peace, prepare for war</div></div></nav><div id="content-outer"><div class="layout" id="content-inner"><div class="recent-post-item article-container"><a class="article-title" href="/2020/07/02/%E6%BF%80%E5%85%89SLAM/Cartographer/%E5%8E%9F%E7%90%86%E5%92%8C%E9%85%8D%E7%BD%AE/%E7%BA%AF%E5%AE%9A%E4%BD%8D%E6%A8%A1%E5%BC%8F%20(%E4%B8%80)/">纯定位模式 (一)</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-07-02</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E6%BF%80%E5%85%89SLAM/">激光SLAM</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E6%BF%80%E5%85%89SLAM/Cartographer/">Cartographer</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E6%BF%80%E5%85%89SLAM/Cartographer/%E5%8E%9F%E7%90%86%E5%92%8C%E9%85%8D%E7%BD%AE/">原理和配置</a></span><div class="content"><p>纯定位时载入的地图在submap中的trajectory为0，启动定位后，系统默认从起点开始建立子图进行匹配，该子图在submap中的trajectory为 1。</p>
<p>一条trajectory可以理解为一次建图过程。如果只让机器人跑一圈，那么trajectory数就是1. 但是，建好图后又需要在图中走，这时候可以增加一条trajectory，把<code>pure_localization</code>设为true，那么机器人再重新跑的过程中就会跟已经建好的图进行匹配，估计机器人在地图中的路径。所以，一次运行就代表了一条trajectory。</p>
<p><strong>cartographer定位时，它的地图是变化的</strong></p>
<p>纯定位和建图不同，local和global SLAM之间的延迟要尽量低. 其次global SLAM通常会在作为地图的frozen trajectory和当前trajectory之间，找到大量的相互约束(inter constraints)。</p>
<p>纯定位模式默认只保存 3 个子图，只有这些子图内的节点参与优化。所以地图大小并不会影响后端优化的速度。而建图结束的时候全图优化应该是所有节点参与。</p>
<p>我们需要显著减小<code>POSE_GRAPH.optimize_every_n_nodes</code>以接收频繁的结果， global SLAM通常会太慢，所以再显著减小<code>global_sampling_ratio</code>和<code>constraint_builder.sampling_ratio</code>以补偿大量的约束。</p>
<p><code>submaps.resolution</code>应当和运行的<code>.pbstream</code>中的子图resolution一致</p>
<p>建图时，cartographer使用 <strong>fast correlative scan matcher</strong>找到回环，search window默认为<code>7m×7m×30°</code>. 但纯定位模式中，search window变得非常大，所以纯定位消耗CPU更大</p>
<p><code>constraint_builder_2d.cc</code>中的<code>ComputeConstraint()</code>函数，在纯定位模式下，会频繁地调用<code>MaybeAddGlobalConstraint()</code>，这个函数会搜索整个子图，造成的开销特别大。建议将<code>global_sampling_ratio</code>调小，这样就可以从一定程度上减少开销。</p>
<h2 id="数据集的纯定位测试"><a href="#数据集的纯定位测试" class="headerlink" title="数据集的纯定位测试"></a>数据集的纯定位测试</h2><p>程序运行时只在局部建图（保留固定数量的子图），随着机器人的运动和观测，<font color = blue size=4> 新的子图会添加进来，旧的子图会被删除，就是只保留局部的地图数据。我的理解是保留局部数据越多，与原有地图进行回环检测就增多，这样计算量增加的同时也增加了误匹配的概率，使得整个系统不稳定</font> ，所以这里只进行定位，不用于建图</p>
<p>需要用到数据集<code>b2-2016-04-05-14-44-52.bag</code>和<code>b2-2016-04-27-12-31-41.bag</code>，前者用于建图，后者用于定位</p>
<p>先运行建图：<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">roslaunch cartographer_ros offline_backpack_2d.launch bag_filenames:=<span class="variable">$&#123;HOME&#125;</span>/path/b2-2016-04-05-14-44-52.bag</span><br></pre></td></tr></table></figure><br>等一会，完成后会生成pbstream文件，如果运行建图，实际地图是这样的<br><img src="https://i.loli.net/2020/07/14/yIZn7sUrBzYEfNi.png" alt="建图.png"></p>
<p>这里是先用第一个数据集建图，建完图后用第二个数据集进行定位测试。<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">roslaunch cartographer_ros demo_backpack_2d_localization.launch load_state_filename:=<span class="variable">$&#123;BAG&#125;</span>/b2-2016-04-05-14-44-52.bag.pbstream bag_filename:=<span class="variable">$&#123;BAG&#125;</span>/b2-2016-04-27-12-31-41.bag</span><br></pre></td></tr></table></figure><br>后面两个参数一个是上一步建好的地图，pbstream格式，另一个是数据集。你会看到机器人很快实现了定位</p>
<h2 id="在机器人的旧版本纯定位"><a href="#在机器人的旧版本纯定位" class="headerlink" title="在机器人的旧版本纯定位"></a>在机器人的旧版本纯定位</h2><p>用于定位时的<code>home_no_odom_localization.launch</code><br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">launch</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">node</span> <span class="attr">name</span>=<span class="string">&quot;cartographer_node&quot;</span> <span class="attr">pkg</span>=<span class="string">&quot;cartographer_ros&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">type</span>=<span class="string">&quot;cartographer_node&quot;</span> <span class="attr">args</span>=<span class="string">&quot;</span></span></span><br><span class="line"><span class="string"><span class="tag">          -configuration_directory $(find cartographer_ros)/configuration_files</span></span></span><br><span class="line"><span class="string"><span class="tag">          -configuration_basename home_no_odom_localization.lua</span></span></span><br><span class="line"><span class="string"><span class="tag">          -load_state_filename /home/xiaoqiang/Documents/ros/maps/home.pbstream&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">output</span>=<span class="string">&quot;screen&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">node</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">node</span> <span class="attr">name</span>=<span class="string">&quot;cartographer_occupancy_grid_node&quot;</span> <span class="attr">pkg</span>=<span class="string">&quot;cartographer_ros&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">type</span>=<span class="string">&quot;cartographer_occupancy_grid_node&quot;</span> <span class="attr">args</span>=<span class="string">&quot;-resolution 0.05&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">launch</span>&gt;</span></span><br></pre></td></tr></table></figure><br>使用<code>cartographer</code>建图和定位时，launch文件的不同之处在于<code>cartographer_node</code>节点的参数<code>-configuration_basename</code>和<code>-load_state_filename</code>，前者就是lua文件的不同，后者只在定位时才有，毕竟没有地图就不能定位</p>
<p>建图使用<code>no_odom_and_imu.lua</code>，定位使用<code>home_no_odom_localization.lua</code>:<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">include <span class="string">&quot;home.lua&quot;</span></span><br><span class="line"></span><br><span class="line">TRAJECTORY_BUILDER.pure_localization = <span class="literal">true</span></span><br><span class="line">--- 每10个有效帧一个子图，子图构建完成要闭环检测一次，这个数越小，闭环检测越频繁，当然CPU增大</span><br><span class="line">POSE_GRAPH.optimize_every_n_nodes = 5</span><br><span class="line">POSE_GRAPH.constraint_builder.sampling_ratio = 0.1</span><br><span class="line">POSE_GRAPH.global_sampling_ratio = 0.002</span><br></pre></td></tr></table></figure><br>启动<code>roslaunch cartographer_ros home_localization.launch</code>后应该就可以了，必须有<code>map</code>坐标系，否则就是没成功。<br><img src="https://i.loli.net/2020/07/20/NhcVQr8JIfUvTX7.png" alt="定位结果.png"></p>
<p><code>optimize_every_n_nodes</code>会影响定位时的CPU占用，设置为<code>5</code>时对应50%，但只有定位时的一秒左右，所以无所谓。</p>
<p>添加轨迹实际调用的源码是<code>node.cc</code>中的<code>Node::HandleStartTrajectory</code>——<code>AddTrajectory</code></p>
<h3 id="新版本的配置"><a href="#新版本的配置" class="headerlink" title="新版本的配置"></a>新版本的配置</h3><p><img src="https://i.loli.net/2020/07/14/6DYXKcHwfTetgMq.png" alt="pure_localization_trimmer.png"><br>这是因为我的 cartographer版本旧，不支持<code>pure_localization_trimmer</code>，最好还是更新到最新。在18年7月增加了<code>pure_localization_trimmer</code>，删掉了<code>pure_localization</code>，如果是新一点的版本，做对应修改。commit历史在<a target="_blank" rel="noopener" href="https://github.com/cartographer-project/cartographer/commit/0981620d8fd4d3489ff1b503183b128909f1c86d">这里</a></p>
<p>相应的源码在 <code>MapBuilder::AddTrajectoryBuilder</code>——<code>MaybeAddPureLocalizationTrimmer</code>：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (trajectory_options.<span class="built_in">pure_localization</span>()) </span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">LOG</span>(WARNING) &lt;&lt; <span class="string">&quot;&#x27;TrajectoryBuilderOptions::pure_localization&#x27; field is deprecated&quot;</span></span><br><span class="line">         <span class="string">&quot;Use &#x27;TrajectoryBuilderOptions::pure_localization_trimmer&#x27; instead.&quot;</span>;</span><br><span class="line">  pose_graph-&gt;<span class="built_in">AddTrimmer</span>(absl::make_unique&lt;PureLocalizationTrimmer&gt;(</span><br><span class="line">      trajectory_id, <span class="number">3</span> <span class="comment">/* max_submaps_to_keep */</span>)  );</span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (trajectory_options.<span class="built_in">has_pure_localization_trimmer</span>()) </span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// 添加一个PureLocalizationTrimmer类型修饰器</span></span><br><span class="line">  pose_graph-&gt;<span class="built_in">AddTrimmer</span>(absl::make_unique&lt;PureLocalizationTrimmer&gt;(</span><br><span class="line">      trajectory_id,</span><br><span class="line">      trajectory_options.<span class="built_in">pure_localization_trimmer</span>().<span class="built_in">max_submaps_to_keep</span>() ) );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>新版本的配置:<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">TRAJECTORY_BUILDER.pure_localization_trimmer = &#123;</span><br><span class="line">  --- 最大保存子图数，存定位模式通过子图进行定位，但只需要当前和上一个子图即可</span><br><span class="line">  max_submaps_to_keep = 3,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>如果使用了机器人的odom，但无法定位成功或定位误差太大，可能的原因是odom不够精确，尝试关闭odom，并由cartographer代为提供odom。既然定位误差大，可能在建图时的原始submap之间误差较大，图优化后map的边缘较为模糊</p>
<p>重定位注释掉<code>Node::GrawAndPublish</code>函数的后三行，否则会继续建图。但是建图的时候还得加回来。<br>由于Cartographer定位是当前帧和子图进行匹配，所以对于机器人周围被新物体遮挡的情况完全没有影响。</p>
<p>唯一影响就是没法重定位了，因为地图上没有这些新物体。但是就算长时间被遮挡，存在累积定位误差，只要机器人离开了遮挡区域，回到了之前的环境，就可以重定位回来。</p>
<h2 id="获得机器人在map坐标系中的坐标"><a href="#获得机器人在map坐标系中的坐标" class="headerlink" title="获得机器人在map坐标系中的坐标"></a>获得机器人在map坐标系中的坐标</h2><p>cartographer是使用tf转换来发布位姿的，如果想发布类似<code>amcl_pose</code>那样的话题，只能修改源码或自己写个程序。</p>
<p>修改源码的方法可以参考<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_42861143/article/details/104021487">这里</a></p>
<p>我还是自己写了个程序，其实就是<a href="https://charon-cheung.github.io/2020/07/11/ROS/ROS%20Kinetic%E7%9F%A5%E8%AF%86/tf%E6%8A%A5%E8%AD%A6%EF%BC%9ALookup%20would%20require%20extrapolation%20into%20the%20past/">tf报警：Lookup would require extrapolation into the past</a>中的程序改了坐标系和话题名称，以获得<code>base_footprint</code>在<code>map</code>中的坐标系</p>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>某次运行得到这样结果：<br><img src="https://i.loli.net/2020/07/17/PETDZKNuLYjh2zl.png" alt=""><br>追查到<code>node.cc</code>里的<code>Node::FinishTrajectoryUnderLock</code>函数，检查了一下是否可以关掉，指定id是否存在，是否已经被Finished了等情况后，如果一切正常，则停止订阅Topic、清除id及其他与该trajectory相关的量。最后调用<code>map_builder_bridge_</code>中的FinishTrajectory函数。发现code对应<code>cartographer_ros_msgs::StatusCode::INVALID_ARGUMENT</code></p>
<p>参考：<br><a target="_blank" rel="noopener" href="https://google-cartographer-ros.readthedocs.io/en/latest/tuning.html#pure-localization-in-a-given-map">官方参考</a><br><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/33110529">更优雅的设定初始位姿</a></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/06/30/%E8%A7%86%E8%A7%89SLAM/realsense%20D435i%E5%85%B3%E9%97%ADIR%E7%BB%93%E6%9E%84%E5%85%89/">Realsense D435i关闭IR结构光</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-06-30</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E8%A7%86%E8%A7%89SLAM/">视觉SLAM</a></span><div class="content"><p>由于要做Realsense D435i的双目结构光相机标定，其中用到了ROS来录制数据包，但是结构光会影响标定，所以得先关闭IR结构光发射器。</p>
<h2 id="一次性关闭IR光"><a href="#一次性关闭IR光" class="headerlink" title="一次性关闭IR光"></a>一次性关闭IR光</h2><p>其实就是动态参数调整<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">roslaunch realsense2_camera rs_camera.launch </span><br><span class="line">rosrun rqt_reconfigure rqt_reconfigure </span><br></pre></td></tr></table></figure><br><a target="_blank" rel="noopener" href="https://i.loli.net/2020/06/30/nxGBZTqfiQR31hj.png">rqt_reconfigure</a><br><code>emitter_enabled</code>有三项: Laser(1),  Laser Auto(2), Off(0)。 选Off即可</p>
<p>通过肉眼看相机发射器已经不再发射IR光了，打开rqt，找到<code>/camera/infra1/image_rect_raw</code>和<code>/camera/infra2/image_rect_raw</code>，发现确实没有白斑了。</p>
<h2 id="永久关闭"><a href="#永久关闭" class="headerlink" title="永久关闭"></a>永久关闭</h2><p>其实就是通过<code>realsense-viewer</code>，这个是驱动层面的操作，更加底层<br><img src="https://i.loli.net/2020/06/30/CGYw92XUWgnKb7c.png" alt="配置栏.png"></p>
<p>参考：<a target="_blank" rel="noopener" href="https://blog.csdn.net/Hanghang_/article/details/103612300">Realsense D435i 关闭IR光</a></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/06/30/ROS/ROS%20Kinetic%E7%9F%A5%E8%AF%86/ROS%E7%9A%84topic_tools%E5%8C%85/">ROS的topic_tools包</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-06-30</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/ROS/">ROS</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/ROS/ROS-Kinetic%E7%9F%A5%E8%AF%86/">ROS Kinetic知识</a></span><div class="content"><h2 id="throttle"><a href="#throttle" class="headerlink" title="throttle"></a>throttle</h2><p>转播 (relay)话题, 限制最大发布频率或者带宽。使用格式: <code>rosrun topic_tools throttle messages &lt;intopic&gt; &lt;msgs_per_sec&gt; [outtopic]</code></p>
<p>messages是当前使用的是throttle的messages模式,限制发布频率. intopic是指你想要改变频率的那个topic, msgs_per_sec是指你想要它发布的频率，而outtopic是指改变发布频率后的topic的名称，可以省略，<strong>如果省略则自动在原来topic的名字上后缀throttle</strong></p>
<p>另外还有bytes模式, 用以限制带宽: <code>rosrun topic_tools throttle bytes &lt;intopic&gt; &lt;bytes_per_sec&gt; &lt;window&gt; [outtopic]</code></p>
<p>例如，让雷达的带宽占用降至1KBps，则命令为：<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rosrun topic_tools throttle bytes base_scan 1024 1.0</span><br></pre></td></tr></table></figure></p>
<p>改变topic发布频率并不是说原来的topic就没了，或者直接在原来的topic上更改，<font size="4" color="blue"> 而是把其更改后的topic发布出来，原来的topic仍然存在 </font></p>
<p>有三个参数，需要注意的是<code>~lazy</code>，如果它等于True的话，只有当你订阅到throttle发出来的消息，它才会工作，这显然是<code>ros::publish</code>函数的lazy模式了</p>
<p>最大的问题是<font color=orange size= 4> 频率控制的精度低,我要求4Hz,实际却在3.6Hz左右</font>，所以实际要设置的大一些</p>
<h2 id="transform"><a href="#transform" class="headerlink" title="transform"></a>transform</h2><p>订阅一个topic或topic field，并在应用给定的Python表达式后将传入的数据发布到另一个topic。它可以处理任何消息类型，主要用于简单的消息转换，例如计算向量或四元数的范数，<font size="4" color="blue"> 甚至将四元数转换为欧拉角。  </font></p>
<p><code>transform &lt;input&gt; &lt;output_topic&gt; &lt;output_type&gt; [&lt;expression&gt;] [--import &lt;module&gt; [&lt;module&gt; ...]]</code></p>
<ul>
<li>input：要订阅的传入topic（或topic field）</li>
<li>output_topic:要发布的输出topic</li>
<li>expression:转换输入消息的Python表达式，在变量m中给出。默认表达式是m，它将输入（可以是topic field）转发到output_topic</li>
<li>import :要在表达式中导入和使用的Python模块的列表。默认导入numpy模块</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 计算IMU给出的方向四元数的范数</span></span><br><span class="line">rosrun topic_tools transform /imu/orientation /norm std_msgs/Float64 <span class="string">&#x27;numpy.linalg.norm([m.x, m.y, m.z, m.w])&#x27;</span></span><br><span class="line"><span class="comment"># 将方向四元数转换为Euler角度</span></span><br><span class="line">rosrun topic_tools transform /imu/orientation /euler geometry_msgs/Vector3 <span class="string">&#x27;tf.transformations.euler_from_quaternion([m.x, m.y, m.z, m.w])&#x27;</span> --import tf</span><br></pre></td></tr></table></figure>
<p><br></p>
<ul>
<li><p>mux: multiplex between multiple topics</p>
</li>
<li><p>relay: republish data on one topic to another.</p>
</li>
<li><p>relay_field: allow to republish data in a different message type</p>
</li>
<li><p>drop: relay a topic, dropping X out of every Y message.</p>
</li>
</ul>
<h2 id="mux"><a href="#mux" class="headerlink" title="mux"></a>mux</h2><p><a target="_blank" rel="noopener" href="http://wiki.ros.org/topic_tools/mux">topic_tools-mux</a><br>可以用于多地图实时切换，参考<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/cbae90b33528">MUX的使用</a></p>
<p>参考:<a target="_blank" rel="noopener" href="http://wiki.ros.org/topic_tools/throttle">throttle Wiki</a></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/06/30/%E8%A7%86%E8%A7%89SLAM/%E6%A0%87%E5%AE%9AD435i%E7%9A%84%E7%9B%B8%E6%9C%BA(%E4%BA%8C)/">标定D435i(二) 相机</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-06-30</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E8%A7%86%E8%A7%89SLAM/">视觉SLAM</a></span><div class="content"><p>Kalibr可以解决以下的标定问题:</p>
<ul>
<li>多相机标定: 一个相机系统的内外参标定，这几个相机没有全局性重叠的视角</li>
<li>视觉惯性标定(camera-IMU): IMU关于相机系统的时空间标定</li>
<li>Rolling Shutter Camera calibration: full intrinsic calibration (projection, distortion and shutter parameters) of rolling shutter cameras</li>
</ul>
<p>可以下载Kalibr源码编译生成可执行文件，也可以下载其CDE精简版包。这中间有个坑就是CDE精简包是没有办法标定彩色图片的，而D435输出的是彩色图。所以还是按编译源码的方式</p>
<p>使用Kalibr标定相机的内参和多个相机相对位置关系即外参</p>
<h2 id="安装Kalibr"><a href="#安装Kalibr" class="headerlink" title="安装Kalibr"></a>安装Kalibr</h2><ol>
<li><p>安装依赖项</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install python-pyx python-setuptools python-rosinstall ipython libeigen3-dev libboost-all-dev doxygen ros-kinetic-vision-opencv ros-kinetic-image-transport-plugins ros-kinetic-cmake-modules python-software-properties software-properties-common libpoco-dev python-matplotlib python-scipy python-git python-pip ipython libtbb-dev libblas-dev liblapack-dev python-catkin-tools libv4l-dev</span><br></pre></td></tr></table></figure>
</li>
<li><p>源码放入工作空间进行编译，会花很长时间，所以编译命令要这样:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 视情况取j8</span></span><br><span class="line">catkin_make -DCMAKE_BUILD_TYPE=Release -j4</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>编译kalibr可能会出现<font color=orange size=4> fatal error: numpy/arrayobject.h: No such file or directory </font>，解决方法： <code>sudo apt-get install --reinstall python-numpy</code></p>
<p>可能出现catkin_make时，下载suitesparse过久甚至失败的问题。解决方法： 修改<code>～/catkin_ws/src/kalibr/suitesparse</code>中的CMakeLists.txt为<a target="_blank" rel="noopener" href="https://raw.githubusercontent.com/charon-cheung/xiaoqiang_robot/master/Calibration/Kalibr_CMakeLists.md">新CMakeLists.txt</a>, 然后重新catkin_make</p>
<h2 id="标定板"><a href="#标定板" class="headerlink" title="标定板"></a>标定板</h2><p><a target="_blank" rel="noopener" href="https://github.com/ethz-asl/kalibr/wiki/downloads">下载标定板</a></p>
<p>我下载的是<code>Aprilgrid 6x6 0.5x0.5m</code>(unscaled)， 打印在A3纸上</p>
<p>原版的参数是:6X6 tags，6乘6个格子，一个大格子size=5.5cm，一个小格子spacing=1.65cm</p>
<p>A3纸上的缩放:6X6 tags，一个大格子size=3.5cm，一个小格子spacing=1cm。记得打印出来用尺子量一下，以免出现差错。<br><img src="https://i.loli.net/2020/06/30/U68mzoAjeQEPvug.png" alt="标定板参数示意图"></p>
<p>下载官网提供的yaml格式文件，需要按照设定的尺寸进行修改<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">target_type: <span class="string">&#x27;aprilgrid&#x27;</span> <span class="comment">#gridtype</span></span><br><span class="line">tagCols: 6               <span class="comment">#number of apriltags</span></span><br><span class="line">tagRows: 6               <span class="comment">#number of apriltags</span></span><br><span class="line">tagSize: 0.035           <span class="comment">#size of apriltag, edge to edge [m]</span></span><br><span class="line">tagSpacing: 0.3          <span class="comment">#ratio of space between tags to tagSize</span></span><br></pre></td></tr></table></figure></p>
<p>找一个适合的能拍到棋盘格的距离,启动相机: <code>roslaunch realsense2_camera rs_camera.launch</code></p>
<p>d453i是有红外发射器的，可以发射很多红外小斑点，如果打开你会在rviz看到很多光斑，可能不利于标定，所以标定时关闭这个发射器的。</p>
<h2 id="降低图像话题的频率，录制图像数据包"><a href="#降低图像话题的频率，录制图像数据包" class="headerlink" title="降低图像话题的频率，录制图像数据包"></a>降低图像话题的频率，录制图像数据包</h2><p>kalibr在处理标定数据的时候要求图像的频率不可过高，一般为4hz(后面计算过程报错，改为20)。使用如下指令来限制图像频率:<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rosrun topic_tools throttle messages /camera/color/image_raw 4 /color</span><br><span class="line">rosrun topic_tools throttle messages /camera/infra2/image_rect_raw 4 /infra_left</span><br><span class="line">rosrun topic_tools throttle messages /camera/infra1/image_rect_raw 4 /infra_right</span><br></pre></td></tr></table></figure><br>用topic_tools throttle限制频率后,一定要查看限制后的topic输出频率：<code>rostopic hz /topic</code>，你会发现实际的频率与设定的频率并不一致，比如：<code>rosrun topic_tools throttle messages /topic_1  25  /topic_2</code>，如果topic_1是40hz，/topic_2可能不是25hz，而是20hz，而且每次的实际频率可能不同，具体原因不明。</p>
<p>注意这里是采用了新的话题<code>/color</code>去发布,所以下面录制要写<code>/color</code>话题</p>
<p>将标定目标AprilGrid置于相机前方合理距离范围内，准备录制两分钟:<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rosbag record -O multicameras_calibration /infra_left /infra_right /color</span><br></pre></td></tr></table></figure><br>开始缓慢移动标定板，让所有摄像头看到标定板不要太远，不然无法检测到标定目标的特征，这个过程中看不到图案的识别结果，这是kalibr的原因。在标定算法中需要检测是否有足够数量图片检测到标定特征，否则直接无法标定。移动标定物时候不要过快导致运动模糊，我们只需要获取不同位置和角度的图像，确保图像清晰和特征完整即可。另外要尽可能多角度和多位置（上下左右等）甚至到摄像头捕捉图像的边缘，这样移动目标1min左右即可。</p>
<p>移动的方式可以参考<a target="_blank" rel="noopener" href="https://vision.in.tum.de/data/datasets/visual-inertial-dataset">TUM CALIBRATION SEQUENCES的标定方式</a>，点play即可播放</p>
<h2 id="kalibr算法计算各个摄像头的内参和外参"><a href="#kalibr算法计算各个摄像头的内参和外参" class="headerlink" title="kalibr算法计算各个摄像头的内参和外参"></a>kalibr算法计算各个摄像头的内参和外参</h2><p><code>april_6x6_A3.yaml</code>: 标定物的参数，具体是标定目标的尺寸之类，因为我是缩小打印在A3上，所以要对参数进行修改；pinhole-equi – 选择的相机模型，kalibr提供了很多相机模型，可以自己选择; —bag-from-to 可以选择时间段，毕竟录制的时候不能保证整体都录制的很好。<strong>标定会花很长时间，最后会输出一个pdf和txt文件，有内外参数据。</strong></p>
<p>只标定主相机:<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kalibr_calibrate_cameras --target ../yaml/april_6x6_A4.yaml --bag ./bag/0_multicameras_calibration.bag --model pinhole-equi  --topic  /color  --show-extraction --approx-sync 0.04</span><br></pre></td></tr></table></figure></p>
<p>最后还是标定的多相机：<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kalibr_calibrate_cameras --target april_6x6_A3.yaml --bag multicameras_calibration.bag --models pinhole-equi pinhole-equi pinhole-equi --topics /infra_left /infra_right /color  --show-extraction --approx-sync 0.04 --bag-from-to 10 100</span><br></pre></td></tr></table></figure></p>
<ul>
<li><code>pinhole-radtan</code>指的是针孔相机模型和畸变模型，每个相机都要指定。还有<code>Pinhole + FOV</code>等等</li>
<li><code>--bag-from-to 10 100</code>指的是录制的第26秒到100秒这段时间</li>
<li><code>--show-extraction</code>, 在标定过程中可视化角点检测情况是否良好</li>
<li><code>--approx-sync 0.04</code></li>
</ul>
<p>结果报错： <font color = orange size=4> ImportError: No module named igraph </font><br>解决方法： <code>sudo apt-get install python2.7-igraph</code></p>
<p>需要在有界面的情况下标定，因为会弹出几个窗口，所以不能通过SSH进行，类似这样：<br><img src="https://i.loli.net/2020/07/01/FnbTkojVMxBCSlP.png" alt=""></p>
<p>可以使用calibration validator进行标定的验证，原理是对重投影误差进行量化分析，同样需要有界面：<br><code>kalibr_camera_validator --cam camchain-multicameras_calibration.yaml --target april_6x6_A3.yaml</code><br><img src="https://i.loli.net/2020/07/02/yZHWnB25hlm4cCO.png" alt="验证结果.png"></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/06/29/%E8%A7%86%E8%A7%89SLAM/%E6%A0%87%E5%AE%9AD435i%E7%9A%84IMU(%E4%B8%80)/">标定D435i(一) IMU</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-06-29</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E8%A7%86%E8%A7%89SLAM/">视觉SLAM</a></span><div class="content"><p>realsense d435i包含两个红外相机、红外发射器、RGB相机和IMU四个模块，显然四个传感器的空间位置是不同的，我们在处理图像和IMU数据时需要将这些数据都放在统一的坐标系上去。比如我们用d435i运行vins，处理的图像和IMU数据都需要放在同一个坐标系下，因此需要标定IMU相对RGB相机的空间位置（包括旋转和位移）。</p>
<p>另外，相机固有参数比如焦距、畸变参数等以及IMU的零偏和scale系数等都需要提前知道。前者称为外参，后者称为内参，在运行程序前我们需要标定它们，不论程序是否有自标定功能，毕竟好的初始标定值对于自标定来说也是有利的。</p>
<p>标定顺序：<strong>IMU标定 —&gt; 相机标定 —&gt; IMU+相机联合标定</strong>. 这么设定顺序是因为最后一步的IMU和相机的联合标定需要 IMU和相机的内参</p>
<h2 id="Allan方差"><a href="#Allan方差" class="headerlink" title="Allan方差"></a>Allan方差</h2><p>在IMU采集数据时，会产生两种误差：确定性误差和随机性误差，为获得精确的数据，需要对上述两种误差进行标定,加速度计和陀螺仪随机误差的标定通常使用Allan方差法，它是20世纪60年代由美国国家标准局的David Allan提出的基于时域的分析方法。</p>
<p>A ROS package tool to analyze the IMU performance. C++ version of Allan Variance Tool. The figures are drawn by Matlab, in scripts.</p>
<p>Actually, just analyze the Allan Variance for the IMU data. Collect the data while the IMU is Stationary, with a two hours duration.<br>code_utils标定IMU的噪音密度和随机游走系数。</p>
<h2 id="安装库和依赖项"><a href="#安装库和依赖项" class="headerlink" title="安装库和依赖项"></a>安装库和依赖项</h2><p>安装依赖项，不装之后的编译会报错： <code>sudo apt-get -y install libdw-dev</code>，结果可能提示<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">The following packages have unmet dependencies:</span><br><span class="line"> libdw-dev : Depends: libelf-dev but it is not going to be installed</span><br><span class="line">             Depends: libdw1 (= 0.165-3ubuntu1) but it is not going to be installed</span><br><span class="line">E: Unable to correct problems, you have held broken packages.</span><br></pre></td></tr></table></figure><br>这是因为一个依赖项已经安装了不同版本：<code>Depends: libelf1 (= 0.165-3ubuntu1) but 0.165-3ubuntu1.2 is to be installed</code>。 解决方法: <code>sudo aptitude install libdw-dev</code>，对给出的方案，选择第二个，降级 libelf1[0.165-3ubuntu1.1 (now) -&gt; 0.158-0ubuntu]</p>
<h2 id="编译code-utils和imu-utils"><a href="#编译code-utils和imu-utils" class="headerlink" title="编译code_utils和imu_utils"></a>编译code_utils和imu_utils</h2><p>全局安装ceres库，因为<code>code_imu</code>依赖ceres。不要同时把imu_utils和code_utils一起放到src下进行编译。因为imu_utils 依赖 code_utils，原作者的CMakeLists写的不好，所以先编译code_utils再编译后者。 </p>
<p>在<code>code_utils</code>下面找到<code>sumpixel_test.cpp</code>，修改<code>#include &quot;backward.hpp&quot;</code>为<code>#include&quot;code_utils/backward.hpp&quot;</code>，再依次编译两个包</p>
<h2 id="发布D435i的IMU数据"><a href="#发布D435i的IMU数据" class="headerlink" title="发布D435i的IMU数据"></a>发布D435i的IMU数据</h2><p>可以直接在rs_camera.launch基础上针对IMU校准做修改。目的是将acc、gyro数据对齐使用同一个topic发布。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 更改前原版本arg name=&quot;unite_imu_method&quot;          default=&quot;&quot;/--&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">arg</span> <span class="attr">name</span>=<span class="string">&quot;unite_imu_method&quot;</span>          <span class="attr">default</span>=<span class="string">&quot;linear_interpolation&quot;</span>/&gt;</span></span><br><span class="line"><span class="comment">&lt;!--或着将参数改为copy--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">arg</span> <span class="attr">name</span>=<span class="string">&quot;unite_imu_method&quot;</span>          <span class="attr">default</span>=<span class="string">&quot;copy&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure><br>启动: <code>roslaunch realsense2_camera rs_imu_calibration.launch</code>，然后录制imu数据包<code>rosbag record -O imu_calibration /camera/imu</code>，让IMU静止不动两个小时，录制IMU的bag.</p>
<h2 id="标定"><a href="#标定" class="headerlink" title="标定"></a>标定</h2><p>根据<code>imu_utils</code>文件夹里面的<code>A3.launch</code>改写D435i标定启动文件：<code>d435i_imu_calib.launch</code>注意，记得修改max_time_min对应的参数，默认是120，也就是两个小时，如果ros包里的imu数据长度没有两个小时，等bag播放完了，还是停留在<code>wait for imu data</code>这里，不会生成标定文件。我录了1小时59分多一点，所以还得改成119</p>
<p><code>d435i_imu_calibration.launch</code>如下:<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">launch</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">node</span> <span class="attr">pkg</span>=<span class="string">&quot;imu_utils&quot;</span> <span class="attr">type</span>=<span class="string">&quot;imu_an&quot;</span> <span class="attr">name</span>=<span class="string">&quot;imu_an&quot;</span> <span class="attr">output</span>=<span class="string">&quot;screen&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--TOPIC名称和上面一致--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">&quot;imu_topic&quot;</span> <span class="attr">type</span>=<span class="string">&quot;string&quot;</span> <span class="attr">value</span>= <span class="string">&quot;/camera/imu&quot;</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--imu_name 无所谓--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">&quot;imu_name&quot;</span> <span class="attr">type</span>=<span class="string">&quot;string&quot;</span> <span class="attr">value</span>= <span class="string">&quot;D435i&quot;</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--标定结果存放路径--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">&quot;data_save_path&quot;</span> <span class="attr">type</span>=<span class="string">&quot;string&quot;</span> <span class="attr">value</span>= <span class="string">&quot;$(find imu_utils)/data/&quot;</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--数据录制时间-min--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">&quot;max_time_min&quot;</span> <span class="attr">type</span>=<span class="string">&quot;int&quot;</span> <span class="attr">value</span>= <span class="string">&quot;120&quot;</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--采样频率，即是IMU频率，采样频率可以使用rostopic hz /camera/imu查看，设置为200，也就是rosbag play播放频率--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">&quot;max_cluster&quot;</span> <span class="attr">type</span>=<span class="string">&quot;int&quot;</span> <span class="attr">value</span>= <span class="string">&quot;200&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">node</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">launch</span>&gt;</span></span><br></pre></td></tr></table></figure><br>先启动标定程序: <code>roslaunch imu_utils d435i_imu_calib.launch</code>，再播放bag: <code>rosbag play -r 200 imu_calibration.bag</code></p>
<h2 id="标定结果"><a href="#标定结果" class="headerlink" title="标定结果"></a>标定结果</h2><p>标定结果是<code>D435i_imu_param.yaml</code>:<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">%YAML:1.0</span><br><span class="line">---</span><br><span class="line"><span class="built_in">type</span>: IMU</span><br><span class="line">name: D435i</span><br><span class="line">Gyr:</span><br><span class="line">   unit: <span class="string">&quot; rad/s&quot;</span></span><br><span class="line">   avg-axis:</span><br><span class="line">      gyr_n: 3.6673681012835031e-03</span><br><span class="line">      gyr_w: 7.0017785520472972e-05</span><br><span class="line">   x-axis:</span><br><span class="line">      gyr_n: 3.6001489799186333e-03</span><br><span class="line">      gyr_w: 6.2846247607788020e-05</span><br><span class="line">   y-axis:</span><br><span class="line">      gyr_n: 4.7157261366663813e-03</span><br><span class="line">      gyr_w: 7.5207268006344615e-05</span><br><span class="line">   z-axis:</span><br><span class="line">      gyr_n: 2.6862291872654953e-03</span><br><span class="line">      gyr_w: 7.1999840947286307e-05</span><br><span class="line">Acc:</span><br><span class="line">   unit: <span class="string">&quot; m/s^2&quot;</span></span><br><span class="line">   avg-axis:</span><br><span class="line">      acc_n: 2.7436489578044256e-02</span><br><span class="line">      acc_w: 1.0915021608117670e-03</span><br><span class="line">   x-axis:</span><br><span class="line">      acc_n: 1.8271976632141730e-02</span><br><span class="line">      acc_w: 5.5394830052109354e-04</span><br><span class="line">   y-axis:</span><br><span class="line">      acc_n: 2.8924134998445018e-02</span><br><span class="line">      acc_w: 1.5674764920646303e-03</span><br><span class="line">   z-axis:</span><br><span class="line">      acc_n: 3.5113357103546017e-02</span><br><span class="line">      acc_w: 1.1530816898495772e-03</span><br></pre></td></tr></table></figure><br>我们一会只用到<strong>Gyr</strong>中的<code>avg-axis</code>的<code>gyr_n</code>和<code>gyr_w</code>, <strong>Acc</strong>中的<code>avg-axis</code>的<code>acc_n</code>和<code>acc_w</code><br><br></p>
<p>终端输出结果:<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line">gyr x  numData 781205</span><br><span class="line">gyr x  start_t 1.59343e+09</span><br><span class="line">gyr x  end_t 1.59344e+09</span><br><span class="line">gyr x dt </span><br><span class="line">-------------7140.59 s</span><br><span class="line">-------------119.01 min</span><br><span class="line">-------------1.9835 h</span><br><span class="line">gyr x  freq 109.403</span><br><span class="line">gyr x  period 0.00914049</span><br><span class="line">gyr y  numData 781205</span><br><span class="line">gyr y  start_t 1.59343e+09</span><br><span class="line">gyr y  end_t 1.59344e+09</span><br><span class="line">gyr y dt </span><br><span class="line">-------------7140.59 s</span><br><span class="line">-------------119.01 min</span><br><span class="line">-------------1.9835 h</span><br><span class="line">gyr y  freq 109.403</span><br><span class="line">gyr y  period 0.00914049</span><br><span class="line">gyr z  numData 781205</span><br><span class="line">gyr z  start_t 1.59343e+09</span><br><span class="line">gyr z  end_t 1.59344e+09</span><br><span class="line">gyr z dt </span><br><span class="line">-------------7140.59 s</span><br><span class="line">-------------119.01 min</span><br><span class="line">-------------1.9835 h</span><br><span class="line">gyr z  freq 109.403</span><br><span class="line">gyr z  period 0.00914049</span><br><span class="line">Gyro X </span><br><span class="line">C   -6.83161    94.2973   -19.0588      2.983 -0.0404918</span><br><span class="line"> Bias Instability 2.37767e-05 rad/s</span><br><span class="line"> Bias Instability 6.28462e-05 rad/s, at 63.1334 s</span><br><span class="line"> White Noise 12.9453 rad/s</span><br><span class="line"> White Noise 0.00360015 rad/s</span><br><span class="line">  bias -0.363298 degree/s</span><br><span class="line">-------------------</span><br><span class="line">Gyro y </span><br><span class="line">C   -8.74367    117.584   -15.9277    2.47408 -0.0373467</span><br><span class="line"> Bias Instability 6.41864e-05 rad/s</span><br><span class="line"> Bias Instability 7.52073e-05 rad/s, at 104.256 s</span><br><span class="line"> White Noise 16.8998 rad/s</span><br><span class="line"> White Noise 0.00471573 rad/s</span><br><span class="line">  bias -0.544767 degree/s</span><br><span class="line">-------------------</span><br><span class="line">Gyro z </span><br><span class="line">C   -4.51808    68.1919   -9.33284    1.95333 -0.0262641</span><br><span class="line"> Bias Instability 8.50869e-05 rad/s</span><br><span class="line"> Bias Instability 7.19998e-05 rad/s, at 63.1334 s</span><br><span class="line"> White Noise 9.43212 rad/s</span><br><span class="line"> White Noise 0.00268623 rad/s</span><br><span class="line">  bias -0.0762471 degree/s</span><br><span class="line">-------------------</span><br><span class="line">==============================================</span><br><span class="line">==============================================</span><br><span class="line">acc x  numData 781205</span><br><span class="line">acc x  start_t 1.59343e+09</span><br><span class="line">acc x  end_t 1.59344e+09</span><br><span class="line">acc x dt </span><br><span class="line">-------------7140.59 s</span><br><span class="line">-------------119.01 min</span><br><span class="line">-------------1.9835 h</span><br><span class="line">acc x  freq 109.403</span><br><span class="line">acc x  period 0.00914049</span><br><span class="line">acc y  numData 781205</span><br><span class="line">acc y  start_t 1.59343e+09</span><br><span class="line">acc y  end_t 1.59344e+09</span><br><span class="line">acc y dt </span><br><span class="line">-------------7140.59 s</span><br><span class="line">-------------119.01 min</span><br><span class="line">-------------1.9835 h</span><br><span class="line">acc y  freq 109.403</span><br><span class="line">acc y  period 0.00914049</span><br><span class="line">acc z  numData 781205</span><br><span class="line">acc z  start_t 1.59343e+09</span><br><span class="line">acc z  end_t 1.59344e+09</span><br><span class="line">acc z dt </span><br><span class="line">-------------7140.59 s</span><br><span class="line">-------------119.01 min</span><br><span class="line">-------------1.9835 h</span><br><span class="line">acc z  freq 109.403</span><br><span class="line">acc z  period 0.00914049</span><br><span class="line">acc X </span><br><span class="line">C  3.36177e-05   0.00175435 -0.000159698  7.23303e-05 -7.16006e-07</span><br><span class="line"> Bias Instability 0.000553948 m/s^2</span><br><span class="line"> White Noise 0.018272 m/s^2</span><br><span class="line">-------------------</span><br><span class="line">acc y </span><br><span class="line">C  9.36955e-05   0.00234733   0.00012197  0.000243676 -2.66252e-06</span><br><span class="line"> Bias Instability 0.00156748 m/s^2</span><br><span class="line"> White Noise 0.0289241 m/s^2</span><br><span class="line">-------------------</span><br><span class="line">acc z </span><br><span class="line">C  5.07832e-05   0.00331104 -0.000381222  0.000199602 -2.43776e-06</span><br><span class="line"> Bias Instability 0.00115308 m/s^2</span><br><span class="line"> White Noise 0.0351134 m/s^2</span><br></pre></td></tr></table></figure><br>经过这些标定会生成一个yaml文件和很多txt文件，主要是yaml文件，给出了加速度计和陀螺仪三轴的<code>noise_density</code>和<code>random_walk</code>，同时计算出了平均值，后面IMU+摄像头联合标定的时候需要这些均值。</p>
<h3 id="标定外参的准备"><a href="#标定外参的准备" class="headerlink" title="标定外参的准备"></a>标定外参的准备</h3><p>将Acc和Gyr的第一组平均数据拷贝到kalibr对应的<code>imu.yaml</code>文件中<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">rostopic: /camera/imu</span><br><span class="line">update_rate: 200.0  <span class="comment">#Hz</span></span><br><span class="line"> </span><br><span class="line">accelerometer_noise_density: 2.89e-01 <span class="comment">#continous</span></span><br><span class="line">accelerometer_random_walk: 4.55e-04 </span><br><span class="line">gyroscope_noise_density: 3.02e-03 <span class="comment">#continous</span></span><br><span class="line">gyroscope_random_walk: 2.29e-05</span><br></pre></td></tr></table></figure><br>分别是加速度计和陀螺仪的高斯白噪声和随机游走的平均值，是IMU噪声模型中的两种噪声。</p>
<h2 id="查看默认imu与相机参数"><a href="#查看默认imu与相机参数" class="headerlink" title="　查看默认imu与相机参数"></a>　查看默认imu与相机参数</h2><p>D435i相关的imu_info话题如下:<br><img src="https://i.loli.net/2020/06/30/nQftEcampMWxThw.png" alt="imu_info列表"></p>
<p><img src="https://i.loli.net/2020/06/30/vUu4FljdA5tJRwQ.png" alt="/camera/gyro/imu_info和/camera/accel/imu_info没有结果"></p>
<p><code>realsense_camera/IMUInfo</code> with the header.frame_id set to either <code>imu_accel</code> or <code>imu_gyro</code> to distinguish between <code>accel</code> and <code>gyro</code> info. 消息成员如下:<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">string frame_id</span><br><span class="line">float64[12] data</span><br><span class="line">float64[3] noise_variances</span><br><span class="line">float64[3] bias_variances</span><br></pre></td></tr></table></figure></p>
<p><code>rostopic echo -n1 /camera/color/camera_info</code>得到结果:<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">  frame_id: <span class="string">&quot;camera_color_optical_frame&quot;</span></span><br><span class="line">height: 480</span><br><span class="line">width: 640</span><br><span class="line">distortion_model: <span class="string">&quot;plumb_bob&quot;</span></span><br><span class="line">D: [0.0, 0.0, 0.0, 0.0, 0.0]</span><br><span class="line">K: [611.3538208007812, 0.0, 327.437744140625, 0.0, 610.015869140625, 239.99667358398438, 0.0, 0.0, 1.0]</span><br><span class="line">R: [1.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 1.0]</span><br><span class="line">P: [611.3538208007812, 0.0, 327.437744140625, 0.0, 0.0, 610.015869140625, 239.99667358398438, 0.0, 0.0, 0.0, 1.0, 0.0]</span><br><span class="line">binning_x: 0</span><br><span class="line">binning_y: 0</span><br><span class="line">roi: </span><br><span class="line">  x_offset: 0</span><br><span class="line">  y_offset: 0</span><br><span class="line">  height: 0</span><br><span class="line">  width: 0</span><br><span class="line">  do_rectify: False</span><br></pre></td></tr></table></figure></p>
<p>对于<code>/camera/depth/imu_info</code>，结果是:<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">frame_id: <span class="string">&quot;camera_depth_optical_frame&quot;</span></span><br><span class="line">height: 480</span><br><span class="line">width: 640</span><br><span class="line">distortion_model: <span class="string">&quot;plumb_bob&quot;</span></span><br><span class="line">D: [0.0, 0.0, 0.0, 0.0, 0.0]</span><br><span class="line">K: [380.23321533203125, 0.0, 316.4999084472656, 0.0, 380.23321533203125, 237.40985107421875, 0.0, 0.0, 1.0]</span><br><span class="line">R: [1.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 1.0]</span><br><span class="line">P: [380.23321533203125, 0.0, 316.4999084472656, 0.0, 0.0, 380.23321533203125, 237.40985107421875, 0.0, 0.0, 0.0, 1.0, 0.0]</span><br><span class="line">binning_x: 0</span><br><span class="line">binning_y: 0</span><br><span class="line">roi: </span><br><span class="line">  x_offset: 0</span><br><span class="line">  y_offset: 0</span><br><span class="line">  height: 0</span><br><span class="line">  width: 0</span><br><span class="line">  do_rectify: False</span><br></pre></td></tr></table></figure></p>
<p>话题<code>/camera/infra2/camera_info</code>和<code>/camera/infra2/camera_info</code>的结果完全一样:<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">frame_id: <span class="string">&quot;camera_infra1_optical_frame&quot;</span></span><br><span class="line">height: 480</span><br><span class="line">width: 640</span><br><span class="line">distortion_model: <span class="string">&quot;plumb_bob&quot;</span></span><br><span class="line">D: [0.0, 0.0, 0.0, 0.0, 0.0]</span><br><span class="line">K: [380.23321533203125, 0.0, 316.4999084472656, 0.0, 380.23321533203125, 237.40985107421875, 0.0, 0.0, 1.0]</span><br><span class="line">R: [1.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 1.0]</span><br><span class="line">P: [380.23321533203125, 0.0, 316.4999084472656, 0.0, 0.0, 380.23321533203125, 237.40985107421875, 0.0, 0.0, 0.0, 1.0, 0.0]</span><br><span class="line">binning_x: 0</span><br><span class="line">binning_y: 0</span><br><span class="line">roi: </span><br><span class="line">  x_offset: 0</span><br><span class="line">  y_offset: 0</span><br><span class="line">  height: 0</span><br><span class="line">  width: 0</span><br><span class="line">  do_rectify: False</span><br></pre></td></tr></table></figure><br>可以看出，实际上出厂没有标定IMU</p>
<h2 id="绘制Allan曲线"><a href="#绘制Allan曲线" class="headerlink" title="绘制Allan曲线"></a>绘制Allan曲线</h2><p><code>imu_utils/scripts</code>中是Matlab写的.m文件，按照<code>draw_allan.m</code>创建文件<code>draw_allan_acc.m</code>和<code>draw_allan_gyr.m</code></p>
<p>由于Ubuntu下安装Matlab比较麻烦，因此将数据和.m文件都拷贝到Windows系统下绘制，注意文件路径和m文件中要对应，<strong>尤其matlab中的当前路径指的是左侧栏的路径，而不是m文件所在的路径</strong></p>
<p><img src="https://i.loli.net/2020/06/30/4z9OaMhDF8gnsBH.jpg" alt="allan_gyr.jpg"><br><img src="https://i.loli.net/2020/06/30/CDxL3nBrWPtYu21.jpg" alt="allan_acc.jpg"></p>
<p>参考:<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/fb_941219/article/details/104709049">RealSense D435i Calibration</a><br><a target="_blank" rel="noopener" href="https://github.com/gaowenliang/imu_utils">官方Github</a><br><a target="_blank" rel="noopener" href="https://www.geek-share.com/detail/2798533390.html">VIO标定IMU随机误差——Allan方差法</a></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/06/29/%E8%A7%86%E8%A7%89SLAM/%E6%A0%87%E5%AE%9AD435i%E7%9A%84%E5%A4%96%E5%8F%82%E6%95%B0(%E4%B8%89)/">标定D435i(三) 外参数</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-06-29</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E8%A7%86%E8%A7%89SLAM/">视觉SLAM</a></span><div class="content"><ul>
<li>标定板pattern尽量选择apriltag，尽量不要用纸质的</li>
<li>选择合适的相机模型</li>
<li>标定手法看看TUM的</li>
</ul>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/06/28/%E8%A7%86%E8%A7%89SLAM/realsense%20D435i%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE/">realsense D435i安装配置</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-06-28</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E8%A7%86%E8%A7%89SLAM/">视觉SLAM</a></span><div class="content"><p><img src="https://s2.loli.net/2022/06/19/kFT4eULdGvqsDNO.png" alt=""><br>realsense D435i终于到手了，打开发现其实很小巧，先做一些配置看看。默认要使用USB3，如果RealSense使用USB2, Output Resolution自动降到<code>480*270 30fbs</code>，而非产品所宣称的1280 x 720 active stereo depth resolution和90fps，且只有Stereo Moudle在工作，无Image Sensor的RGB Moudle菜单项，无法进行3D建模。</p>
<p>D435i采用了即用型USB供电形式，不仅提供深度传感器模组，还配备了一个IMU单元（惯性测量单元，采用的博世BMI055）。凭借内置的IMU单元，结合视觉数据可实现6DoF追踪功能。其中，IMU将各种线性加速度计和陀螺仪数据结合，可检测X，Y，Z三轴的旋转和平移，以及俯仰、横摇等动作。D435i的2000万像素RGB摄像头和3D传感器可以30帧/秒的速度提供分辨率高达1280 × 720，或者以90帧/秒的速度提供848 × 480的较低分辨率。该摄像头具有全局快门，可以处理快速移动物体，室内室外皆可操作。深度距离在<code>0.1 m~10 m</code>之间，视场角度为85 × 58度</p>
<p>可以获得RGB图、左右红外摄像图、深度图、IMU数据，并且将深度图数据和RGB图进行对齐。左右红外相机进行测量深度，中间红外点阵投射器相当于补光灯，不打开也能测深度，只是效果不好；最右边的rgb相机用于采集彩色图片，最终可以将彩色视频流与深度流进行对齐.</p>
<p>两个驱动讲究搭配，否则安装编译都不报错，运行时会报错 <font size="4" color="red"> realsense  hwmon command 0x7d failed  </font> 我使用的是<code>realsense-ros-2.2.23</code>和<code>librealsense-2.43.0</code></p>
<h2 id="安装librealsense"><a href="#安装librealsense" class="headerlink" title="安装librealsense"></a>安装librealsense</h2><p>先装realsense的驱动，步骤参考网上的，其实不必完全相同，我的步骤如下：</p>
<ol>
<li>下载<a target="_blank" rel="noopener" href="https://github.com/IntelRealSense/librealsense">驱动</a>，然后解压到根目录</li>
<li>执行如下命令：<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> ~/librealsense</span><br><span class="line">sudo apt-get install libssl-dev libusb-1.0-0-dev pkg-config libgtk-3-dev libglfw3-dev</span><br><span class="line"><span class="comment"># 许可脚本</span></span><br><span class="line">sudo cp config/99-realsense-libusb.rules /etc/udev/rules.d/</span><br><span class="line">sudo udevadm control --reload-rules &amp;&amp; udevadm trigger</span><br></pre></td></tr></table></figure></li>
<li>开始编译<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> ~/librealsense</span><br><span class="line">mkdir build &amp;&amp; <span class="built_in">cd</span> build</span><br><span class="line">cmake ../ -DBUILD_EXAMPLES=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line">sudo make uninstall &amp;&amp; make clean &amp;&amp; make  -j7 &amp;&amp; sudo make install</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>运行<code>realsense-viewer</code>验证，看到如下画面<br><img src="https://i.loli.net/2020/06/28/TIEr7MGmfpWXisD.png" alt="RGB Depth Infrared"><br>配置可以修改为常见的黑白深度图以及分辨率等等<br><img src="https://i.loli.net/2020/06/28/3uPdGyh7TlFnS5w.png" alt="配置栏"></p>
<h2 id="ROS驱动"><a href="#ROS驱动" class="headerlink" title="ROS驱动"></a>ROS驱动</h2><p>从<a target="_blank" rel="noopener" href="https://github.com/IntelRealSense/realsense-ros">这里</a>下载，然后放到某工作空间，编译即可：<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">catkin_make -DCATKIN_ENABLE_TESTING=False -DCMAKE_BUILD_TYPE=Release</span><br><span class="line">catkin_make install</span><br></pre></td></tr></table></figure><br>现在运行<code>roslaunch realsense2_camera rs_camera.launch</code>，打开rqt就能看到realsense的三种图像<br>实际运行了<code>/camera/realsense2_camera</code>和<code>camera/realsense2_camera_manager</code>两个节点，涉及的话题有很多，以后慢慢分析。</p>
<p>tf关系如图：<br><img src="https://i.loli.net/2020/07/01/5DTI18Hnzdr7qJy.png" alt="frames.png"><br><br></p>
<p>在rqt中打开深度图时出现了报错，又是图像编码问题<br><img src="https://i.loli.net/2020/06/28/PV9LDck5atvEzMZ.png" alt="launch文件中报错.png"><br><img src="https://i.loli.net/2020/06/28/PYMuOQ7R6zDgvel.png" alt="rqt终端报错.png"><br>在rqt里查看<code>/camera/depth/image_rect_raw/theora</code>，同样没有深度图，但rqt不报警</p>
<p>在rqt查看RGB和红外的图像，只要选择theora，rqt终端都会报警:<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[ WARN][/rqt_gui_cpp_node_25764] [TheoraSubscriber::internalCallback] line_170  [theora] Packet was not a Theora header</span><br></pre></td></tr></table></figure><br><br></p>
<p>使用对齐的深度话题信息发布RGBD点云<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">roslaunch realsense2_camera rs_rgbd.launch</span><br></pre></td></tr></table></figure><br>这一步还没有成功,在rviz里没看到结果</p>
<h2 id="内参"><a href="#内参" class="headerlink" title="内参"></a>内参</h2><p><code>realsense</code>启动时可以发现信息 <code>[color stream is enabled - width: 640, height: 480, fps: 15, Format: RGB8]</code></p>
<p>realsense相机出厂的时候一般都标定好了，直接读取他们的内参即可。终端输入： <code>rs-sensor-control</code>，根据提示选择，出现所有视频流的列表时，根据上面的信息选择，最终显示内参:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Principal Point         : <span class="number">327.438</span>, <span class="number">239.997</span></span><br><span class="line">Focal Length            : <span class="number">611.354</span>, <span class="number">610.016</span></span><br><span class="line">Distortion Model        : Inverse Brown Conrady</span><br><span class="line">Distortion Coefficients : [<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>]</span><br></pre></td></tr></table></figure></p>
<p>参考：<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/sinat_23853639/article/details/88044019">realsense D435 驱动安装并嵌入ROS中使用</a></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/06/16/ROS/ROS%E6%9C%BA%E5%99%A8%E4%BA%BA/%E5%B0%8F%E5%BC%BA%E6%9C%BA%E5%99%A8%E4%BA%BA%E7%9A%84%E8%AF%B4%E6%98%8E/">小强机器人的补充说明</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-06-16</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/ROS/">ROS</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/ROS/ROS%E6%9C%BA%E5%99%A8%E4%BA%BA/">ROS机器人</a></span><div class="content"><h2 id="修改记录"><a href="#修改记录" class="headerlink" title="修改记录"></a>修改记录</h2><p>2020.12.24  <code>xqserial_no_odom.launch</code>:  将base_link和base_footprint之间的变换的注释去掉</p>
<h2 id="编译问题"><a href="#编译问题" class="headerlink" title="编译问题"></a>编译问题</h2><p>将<code>/home/xiaoqiang/Documents/ros/src/ORB_SLAM2</code>中的CMakeLists大部分内容都注释掉了，目前还用不到它．</p>
<p>注释<code>xqserial_server/CMakeLists.txt</code>的57行，否则出现下面情况：<br><img src="https://i.loli.net/2020/05/21/NBcWdKsP286OAV5.png" alt=""></p>
<p><code>nav_test</code>不需要特别编译，它全是py文件，没有cpp。但是需要从网上下载<code>rbx1</code>工程，这是一本教程里用到的，只把其中的<code>rbx1_nav</code>放到当前工作空间里，编译通过。<strong>nav_squared.py</strong>需要它</p>
<p>将<code>startup.launch</code>注释掉一部分，比如摄像头节点等等。</p>
<p><code>robot_pose_ekf</code>包很奇怪，它应当是在<code>/home/xiaoqiang/Documents/ros/src/navigation</code>，但是修改相应源码，执行launch没有效果。最后发现实际使用的是<code>R50_Release</code>中的<code>robot_pose_ekf</code>。删掉后者就报错找不到了，可见xiaoqiang中的那个没有生效，不像个package，但是rospd又能找到，很奇怪。</p>
<h2 id="运动部分"><a href="#运动部分" class="headerlink" title="运动部分"></a>运动部分</h2><p>小强有时不移动，可能是IMU在重启，因为此时的IMU数据除了四元数的w为1，其他全是0</p>
<p><code>/xqserial_server/Twist</code>疑似无用，只有<code>/motor_driver</code>在一直发布它</p>
<p><code>xqserial_server/Pose2D</code>的消息是(x,y,theta)，是相对里程计坐标系原点的位姿</p>
<p>里程计模型也是速度积分的二轮差速，使用编码器读数获得极小时间内的位移，以左右轮的编码器增量的均值计算。</p>
<p><code>control.py</code>就是从键盘获取方向键，发布速度命令到<code>cmd_vel</code>话题，订阅了<code>/xqserial_server/Odom</code>话题，但是实际没用到。</p>
<p><code>xqserial_server</code>命名空间包括<code>StatusPublisher</code>和<code>DiffDriverController</code>两个类</p>
<p><code>xiaoqiang_log</code>话题对应的<code>LogRecored.msg</code>如下，只有缺少串口设备时才发布，record是json形式<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">string collection_name</span><br><span class="line">time stamp</span><br><span class="line">string record</span><br></pre></td></tr></table></figure></p>
<p><code>xiaoqiang_tts/text</code>话题对应语音提示信息，也是在缺少串口设备时才发布</p>
<p>里程计的更新频率为100Hz,里程计也是切线模型假设，使用编码器推算轨迹</p>
<h2 id="startup-launch"><a href="#startup-launch" class="headerlink" title="startup.launch"></a>startup.launch</h2><p>开机启动的launch文件是<code>startup</code>包中的startup.launch<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">launch</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">node</span> <span class="attr">pkg</span>=<span class="string">&quot;xqserial_server&quot;</span> <span class="attr">type</span>=<span class="string">&quot;xqserial_server&quot;</span> <span class="attr">name</span>=<span class="string">&quot;motor_driver&quot;</span> <span class="attr">respawn</span>=<span class="string">&quot;true&quot;</span> <span class="attr">respawn_delay</span>=<span class="string">&quot;10&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">&quot;debug_flag&quot;</span> <span class="attr">value</span>=<span class="string">&quot;false&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">&quot;wheel_separation&quot;</span> <span class="attr">value</span>=<span class="string">&quot;0.360&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">&quot;wheel_radius&quot;</span> <span class="attr">value</span>=<span class="string">&quot;0.0625&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">&quot;port&quot;</span> <span class="attr">value</span>=<span class="string">&quot;/dev/ttyUSB001&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">&quot;r_min&quot;</span> <span class="attr">value</span>=<span class="string">&quot;1.0&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">node</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">node</span> <span class="attr">pkg</span>=<span class="string">&quot;tf&quot;</span> <span class="attr">type</span>=<span class="string">&quot;static_transform_publisher&quot;</span> <span class="attr">name</span>=<span class="string">&quot;baselink_broadcaster&quot;</span> <span class="attr">args</span>=<span class="string">&quot;0 0 0.15 0 0 0 1 base_footprint base_link 50&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">node</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">node</span> <span class="attr">pkg</span>=<span class="string">&quot;tf&quot;</span> <span class="attr">type</span>=<span class="string">&quot;static_transform_publisher&quot;</span> <span class="attr">name</span>=<span class="string">&quot;imulink_broadcaster&quot;</span> <span class="attr">args</span>=<span class="string">&quot;-0.1 -0.03 0 0 0 0 1 base_link imu 50&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">launch</span>&gt;</span></span><br></pre></td></tr></table></figure><br>主要是xqserial_server，然后是静态发布tf变换： <code>base_footprint --&gt; base_link --&gt; imu</code></p>
<h2 id="urdf"><a href="#urdf" class="headerlink" title="urdf"></a>urdf</h2><h3 id="rviz显示问题"><a href="#rviz显示问题" class="headerlink" title="rviz显示问题"></a>rviz显示问题</h3><p>尝试在远程机上同时启动<code>xiaoqiang_udrf.launch</code>和rviz，先尝试加载<code>urdf.rviz</code>，这种情况下的tf变换都是正常的<br><img src="https://i.loli.net/2020/04/21/p9o8NVRW62OEbcz.png" alt="加载urdf并显示小强机器人.png"></p>
<p>但是常用方式是远程机启动launch，本地机启动rviz，rviz里做好配置后，发现终端会报错：找不到所需要的所有STL文件，这几个文件在<code>/home/xiaoqiang/Documents/ros/src/xiaoqiang_udrf/meshes</code>。这是因为rviz在本机找这些文件，</p>
<p>launch文件里加载了<code>xiaoqiang_udrf.URDF</code>，这个文件又加载STL文件，语句是这样的：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mesh</span>  <span class="attr">filename</span>=<span class="string">&quot;package://xiaoqiang_udrf/meshes/base_link.STL&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure><br>也就是说本地机需要一个名为xiaoqiang_udrf的package，自己新建一个。</p>
<p>这时再打开rviz就不会报错了，但还是有问题，整个模型透明发白，这是因为rivz中的全局坐标系“fixed frame”设置的不合适，将map改成base_link后即可正常显示。</p>
<p>结果机器人并不能动，rviz里仍显示几个wheel和odom没有tf变换，但是<code>rosrun tf tf_echo</code>有正常结果，结果发现就是显示的问题，<font color = blue size= 3>重启rviz就好了 </font></p>
<h3 id="坐标系冲突"><a href="#坐标系冲突" class="headerlink" title="坐标系冲突"></a>坐标系冲突</h3><p>现在urdf中的坐标系叫做<code>lidar_urdf</code>，<code>static_transform_publisher</code>定义的是base_link和laser的关系，在<code>a2.launch</code>里。<br><img src="https://i.loli.net/2020/07/05/LICsGrwtDm3nPVK.png" alt="urdf中的base_link和laser的关系.png"><br><img src="https://i.loli.net/2020/07/05/ErV4Hq3xAPyk7TO.png" alt="static_transform_publisher中base_link和laser的关系.png"><br>可以看到二者的坐标关系有所不同，如果把<code>lidar_urdf</code>也改成<code>laser</code>，那么在rviz可以看到<code>laser</code>坐标系会不断旋转跳动，这是存在两个tf变换造成的。由于urdf只是个显示功能，所以还是用两个坐标系。<code>base_link</code>和<code>laser</code>之间的关系可能不精确，这就需要标定了</p>
<h2 id="tf变换"><a href="#tf变换" class="headerlink" title="tf变换"></a>tf变换</h2><p><img src="https://i.loli.net/2020/04/20/Izq7PYWlSMBJTkn.png" alt="开机启动下的tf关系图.png"></p>
<p><img src="https://i.loli.net/2020/04/23/6Jdp2VgYIlPzZwr.png" alt="odom和base_foot坐标系低于地图"></p>
<p><img src="https://i.loli.net/2020/04/21/fTDlwPs7YIFEuzA.png" alt="雷达扫描的轨迹和地图边缘有一定差距"></p>
<p><img src="https://i.loli.net/2020/04/23/TM8Vud6EoFshwKb.png" alt="LaserScan未正常显示，但tf正常"></p>
<p>无地图状态下，以odom为固定坐标系，移动机器人时，base_link会相对移动。但是用rviz里的<code>Odometry</code>可以表达base_link在odom坐标系下的运动</p>
<h2 id="使用伽利略客户端"><a href="#使用伽利略客户端" class="headerlink" title="使用伽利略客户端"></a>使用伽利略客户端</h2><p>使用最新版本，一开始总连接不成功，最后发现是公用网络的防火墙造成的，但是不知为什么，防火墙已经将它添加例外了，无法修改，只好把防火墙关了<br><img src="https://i.loli.net/2020/05/18/n5EueWIBL3TtQPO.png" alt="防火墙.png"><br><img src="https://i.loli.net/2020/05/18/xlGK29yToFkRejq.png" alt="关闭串口.png"></p>
<h2 id="建图"><a href="#建图" class="headerlink" title="建图"></a>建图</h2><p>gmapping建图： <code>roslaunch gmapping a2.launch</code>，对应<code>rplidar_a2_test.rviz</code></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/06/12/SLAM%E5%B7%A5%E5%85%B7/OctoMap%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE/">OctoMap安装配置</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-06-12</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/SLAM%E5%B7%A5%E5%85%B7/">SLAM工具</a></span><div class="content"><p>ROS环境下的安装：<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 也可用与非ROS环境</span></span><br><span class="line">sudo apt-get install ros-kinetic-octomap</span><br><span class="line"><span class="comment"># octomap的查看工具</span></span><br><span class="line">sudo apt-get install ros-kinetic-octovis</span><br><span class="line">````</span><br><span class="line">`octomap_ros`和`octomap_msgs`提供了消息文件，封装和转换方法。`octomap_server`提供建图和服务</span><br><span class="line"></span><br><span class="line"><span class="comment">## 编译</span></span><br><span class="line"></span><br><span class="line">在`package.xml`中添加：</span><br><span class="line">```sh</span><br><span class="line">&lt;build_depend&gt;octomap&lt;/build_depend&gt;</span><br><span class="line">&lt;run_depend&gt;octomap&lt;/run_depend&gt;</span><br></pre></td></tr></table></figure></p>
<p>因为库提供了CMake的config文件，所以直接这样用：<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">find_package(octomap REQUIRED)</span><br><span class="line">include_directories(<span class="variable">$&#123;OCTOMAP_INCLUDE_DIRS&#125;</span>)</span><br><span class="line">target_link_libraries(<span class="variable">$&#123;OCTOMAP_LIBRARIES&#125;</span>)</span><br></pre></td></tr></table></figure></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/06/11/PCL%E7%82%B9%E4%BA%91/%E7%82%B9%E4%BA%91%E6%BB%A4%E6%B3%A2/">点云滤波</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-06-11</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/PCL%E7%82%B9%E4%BA%91/">PCL点云</a></span><div class="content"><p>地图分很多种：稀疏的，稠密的，还有半稀疏的。稀疏的地图放大了看就是一个个离散的空间点，不过我们可以把它变成连续的稠密的网格，这个过程也叫点云的网格化。点云网格化需要对点云进行一系列处理</p>
<p>一般下面这几种情况需要进行点云滤波处理：</p>
<ol>
<li><p>点云数据密度不规则需要平滑</p>
</li>
<li><p>因为遮挡等问题造成离群点需要去除</p>
</li>
<li><p>大量数据需要降采样</p>
</li>
<li><p>噪声数据需要去除</p>
</li>
</ol>
<h2 id="滤波程序"><a href="#滤波程序" class="headerlink" title="滤波程序"></a>滤波程序</h2><p><code>package.xml</code>中要添加：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">build_depend</span>&gt;</span>libpcl-all-dev<span class="tag">&lt;/<span class="name">build_depend</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">exec_depend</span>&gt;</span>libpcl-all<span class="tag">&lt;/<span class="name">exec_depend</span>&gt;</span></span><br></pre></td></tr></table></figure><br>CMake按照第一篇里进行配置</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ros/ros.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sensor_msgs/PointCloud2.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pcl_conversions/pcl_conversions.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pcl/point_cloud.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pcl/point_types.h&gt;</span></span></span><br><span class="line"><span class="comment">//滤波的头文件</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pcl/filters/voxel_grid.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">ros::Publisher pub;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">cloud_cb</span> <span class="params">(<span class="keyword">const</span> sensor_msgs::PointCloud2ConstPtr&amp; cloud_msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// 声明存储原始数据与滤波后的数据的点云的格式</span></span><br><span class="line">  pcl::PCLPointCloud2* cloud = <span class="keyword">new</span> pcl::PCLPointCloud2; <span class="comment">//原始的点云的数据格式</span></span><br><span class="line">  <span class="function">pcl::PCLPointCloud2ConstPtr <span class="title">cloudPtr</span><span class="params">(cloud)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ROS消息转化为PCL中的点云数据格式</span></span><br><span class="line">  pcl_conversions::<span class="built_in">toPCL</span>(*cloud_msg, *cloud);</span><br><span class="line"></span><br><span class="line">  pcl::PCLPointCloud2 cloud_filtered;   <span class="comment">//存储滤波后的数据格式</span></span><br><span class="line">  <span class="comment">// 进行一个滤波处理</span></span><br><span class="line">  pcl::VoxelGrid&lt;pcl::PCLPointCloud2&gt; sor; <span class="comment">//创建滤波对象</span></span><br><span class="line">  sor.<span class="built_in">setInputCloud</span> (cloudPtr);  <span class="comment">//设置输入的滤波，将需要过滤的点云给滤波对象</span></span><br><span class="line">  sor.<span class="built_in">setLeafSize</span> (<span class="number">0.1</span>, <span class="number">0.1</span>, <span class="number">0.1</span>);  <span class="comment">//设置滤波时创建的体素大小为1cm立方体</span></span><br><span class="line">  sor.<span class="built_in">filter</span> (cloud_filtered);<span class="comment">//执行滤波处理，存储输出cloud_filtered</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 再将滤波后的点云的数据格式转换为ROS下的数据格式发布</span></span><br><span class="line">  sensor_msgs::PointCloud2 output;</span><br><span class="line">  pcl_conversions::<span class="built_in">moveFromPCL</span>(cloud_filtered, output);<span class="comment">//第一个参数是输入，后面的是输出</span></span><br><span class="line">  pub.<span class="built_in">publish</span> (output);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>** argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  ros::<span class="built_in">init</span> (argc, argv, <span class="string">&quot;filter_cloud&quot;</span>);<span class="comment">//声明节点的名称</span></span><br><span class="line">  ros::NodeHandle nh;</span><br><span class="line"></span><br><span class="line">  ros::Subscriber sub = nh.subscribe&lt;sensor_msgs::PointCloud2&gt; (<span class="string">&quot;/camera/depth/points&quot;</span>, <span class="number">1</span>, cloud_cb);</span><br><span class="line">  pub = nh.advertise&lt;sensor_msgs::PointCloud2&gt; (<span class="string">&quot;filtered_cloud&quot;</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  ros::<span class="built_in">spin</span> ();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="点云合并"><a href="#点云合并" class="headerlink" title="点云合并"></a>点云合并</h2><p>把相邻的点合并成一个点，一方面可以减少图像的数据量，另一方面可以增加点云的稳定度。个人感觉贴近滤波<br><img src="https://s2.loli.net/2022/06/18/G4FfmBLVex6g5hR.png" alt="点云合并"></p>
<h2 id="直通滤波"><a href="#直通滤波" class="headerlink" title="直通滤波"></a>直通滤波</h2><p>多线雷达点云大部分的点都集中的中间区域，距离越远点云越稀疏，信息量也越小，应该筛选掉一些较远的点。这就用到了直通滤波，它是最为简单、粗暴的一种滤波方式，就是直接对点云的X、Y、Z轴的点云坐标约束来进行滤波。<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pcl/io/pcd_io.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pcl/point_types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pcl/filters/passthrough.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>** argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    </span><br><span class="line">  pcl::PointCloud&lt;pcl::PointXYZ&gt;::<span class="function">Ptr <span class="title">cloud</span><span class="params">(<span class="keyword">new</span> pcl::PointCloud&lt;pcl::PointXYZ&gt;)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Fill in the cloud data</span></span><br><span class="line">  pcl::PCDReader reader;</span><br><span class="line">  reader.<span class="built_in">read</span>(<span class="string">&quot;16line.pcd&quot;</span>, *cloud);</span><br><span class="line"></span><br><span class="line">  std::cerr &lt;&lt; <span class="string">&quot;Cloud before filtering: &quot;</span> &lt;&lt; cloud-&gt;points.<span class="built_in">size</span>() &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">  pcl::PointCloud&lt;pcl::PointXYZ&gt;::<span class="function">Ptr <span class="title">cloud_filtered2</span><span class="params">(<span class="keyword">new</span> pcl::PointCloud&lt;pcl::PointXYZ&gt;)</span></span>;</span><br><span class="line">  pcl::PointCloud&lt;pcl::PointXYZ&gt;::<span class="function">Ptr <span class="title">cloud_filtered3</span><span class="params">(<span class="keyword">new</span> pcl::PointCloud&lt;pcl::PointXYZ&gt;)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Create the filtering object 直通滤波</span></span><br><span class="line">  pcl::PassThrough&lt;pcl::PointXYZ&gt; pass;</span><br><span class="line">  pass.<span class="built_in">setInputCloud</span>(cloud);</span><br><span class="line">  pass.<span class="built_in">setFilterFieldName</span>(<span class="string">&quot;x&quot;</span>);   <span class="comment">// 设置操作的坐标轴</span></span><br><span class="line">  pass.<span class="built_in">setFilterLimits</span>(<span class="number">-5.0</span>, <span class="number">5.0</span>);</span><br><span class="line">  pass.<span class="built_in">filter</span>(*cloud_filtered2);</span><br><span class="line">  <span class="comment">// filter range Y-axis</span></span><br><span class="line">  <span class="comment">// 注意多次滤波需要再次输入点云和调用filter函数</span></span><br><span class="line">  pass.<span class="built_in">setInputCloud</span>(cloud_filtered2);</span><br><span class="line">  pass.<span class="built_in">setFilterFieldName</span>(<span class="string">&quot;y&quot;</span>);</span><br><span class="line">  pass.<span class="built_in">setFilterLimits</span>(<span class="number">-5.0</span>, <span class="number">5.0</span>);</span><br><span class="line">  pass.<span class="built_in">filter</span>(*cloud_filtered3);</span><br><span class="line"></span><br><span class="line">  std::cerr &lt;&lt; <span class="string">&quot;Cloud after filtering: &quot;</span> &lt;&lt; cloud_filtered3-&gt;points.<span class="built_in">size</span>() &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 读取pcd点云数据进行操作，最后保存为pcd文件</span></span><br><span class="line">  pcl::PCDWriter writer;</span><br><span class="line">  writer.<span class="built_in">write</span>(<span class="string">&quot;16line_filtered.pcd&quot;</span>, *cloud_filtered3, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><code>pass.setFilterLimitsNegative(true);</code>: 是否保存滤波的限制范围内的点云，默认为false，保存限制范围点云，true时候是相反。</p>
<h2 id="条件滤波法"><a href="#条件滤波法" class="headerlink" title="条件滤波法"></a>条件滤波法</h2><p>在某些情况下，我们也会需要去除给定区域内部的点，比如激光雷达扫描近处的点(可能就是装载雷达的车)，这些点通常对建图和感知不会有作用。</p>
<p>设定滤波条件进行滤波，点在范围内保留，不在范围内丢弃。</p>
<p><code>getFilterLimitsNegative</code> 可以对选定范围取反，将其设为 <code>true</code> 时可以进行给定只保留给定范围内的点的功能。</p>
<h2 id="体素滤波"><a href="#体素滤波" class="headerlink" title="体素滤波"></a>体素滤波</h2><p>实现降采样，既减少点云的数量，并同时保持点云的形状特征。创建一个三维体素，用体素内所有点的重心近似表示体素中的其他点，这样体素内所有点就用一个重心点最终表示。</p>
<h2 id="半径滤波"><a href="#半径滤波" class="headerlink" title="半径滤波"></a>半径滤波</h2><p>对整个输入迭代一次，对于每个点进行半径R的邻域搜索(球体)，如果邻域点的个数低于某一阈值，则该点将被视为噪声点并被移除。<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">pcl::PointCloud&lt;pcl::PointXYZ&gt;::<span class="function">Ptr <span class="title">cloud</span><span class="params">(<span class="keyword">new</span> pcl::PointCloud&lt;pcl::PointXYZ&gt;)</span></span>;      <span class="comment">//待滤波点云</span></span><br><span class="line"><span class="keyword">if</span> (pcl::io::<span class="built_in">loadPCDFile</span>(<span class="string">&quot;test.pcd&quot;</span>, *cloud) &lt; <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">PCL_ERROR</span>(<span class="string">&quot;\a点云文件不存在！\n&quot;</span>);</span><br><span class="line">  <span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">pcl::PointCloud&lt;pcl::PointXYZ&gt;::<span class="function">Ptr <span class="title">cloud_filtered</span><span class="params">(<span class="keyword">new</span> pcl::PointCloud&lt;pcl::PointXYZ&gt;)</span></span>; <span class="comment">//滤波后点云</span></span><br><span class="line">pcl::RadiusOutlierRemoval&lt;pcl::PointXYZ&gt; ror; <span class="comment">//创建滤波器对象</span></span><br><span class="line">ror.<span class="built_in">setInputCloud</span>(cloud);           <span class="comment">//设置待滤波点云</span></span><br><span class="line">ror.<span class="built_in">setRadiusSearch</span>(<span class="number">0.02</span>);            <span class="comment">//设置查询点的半径邻域范围</span></span><br><span class="line">ror.<span class="built_in">setMinNeighborsInRadius</span>(<span class="number">5</span>);         <span class="comment">//设置判断是否为离群点的阈值，即半径内至少包括的点数</span></span><br><span class="line"><span class="comment">//ror.setNegative(true);            //默认false，保存内点；true，保存滤掉的外点</span></span><br><span class="line">ror.<span class="built_in">filter</span>(*cloud_filtered);          <span class="comment">//执行滤波，保存滤波结果于cloud_filtered</span></span><br></pre></td></tr></table></figure></p>
<p>实现：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">radiusremoval</span><span class="params">(pcl::PointCloud&lt;pcl::PointXYZ&gt;::Ptr&amp; cloud, pcl::PointCloud&lt;pcl::PointXYZ&gt;::Ptr&amp; cloud_filtered, <span class="keyword">double</span> radius, <span class="keyword">int</span> min_pts)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  pcl::KdTreeFLANN&lt;pcl::PointXYZ&gt; tree;</span><br><span class="line">  tree.<span class="built_in">setInputCloud</span>(cloud);</span><br><span class="line">  vector&lt;<span class="keyword">float</span>&gt; avg;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; cloud-&gt;points.<span class="built_in">size</span>(); ++i)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="function">vector&lt;<span class="keyword">int</span>&gt; <span class="title">id</span><span class="params">(min_pts)</span></span>;</span><br><span class="line">    <span class="function">vector&lt;<span class="keyword">float</span>&gt; <span class="title">dist</span><span class="params">(min_pts)</span></span>;</span><br><span class="line">    tree.<span class="built_in">nearestKSearch</span>(cloud-&gt;points[i], min_pts, id, dist);</span><br><span class="line">    <span class="comment">// 是否是平方</span></span><br><span class="line">    <span class="keyword">if</span> (dist[dist.<span class="built_in">size</span>() - <span class="number">1</span>] &lt; radius)</span><br><span class="line">    &#123;</span><br><span class="line">      cloud_filtered-&gt;<span class="built_in">push_back</span>(cloud-&gt;points[i]);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>构建一个 KD 树，对每个点进行范围搜索（最近邻搜索 <code>nearestKSearch</code>），最后判断邻近点数（最大距离）是否满足要求即可。</p>
<h2 id="统计滤波"><a href="#统计滤波" class="headerlink" title="统计滤波"></a>统计滤波</h2><p><img src="https://s2.loli.net/2022/02/15/BVKY8ZXcAtL64FC.png" alt=""><br>看过源码后得知， 计算均值 <script type="math/tex">\mu</script> 时除以的是点云的点数，不是邻域的点数。 对滤波结果有影响的是标准差阈值系数<code>k</code>和邻域的点数。 <font size="4" color="blue"> 使用的也是 nearestKSearch   </font></p>
<p>缺点：对较远的激光线也筛除掉了。首先对激光雷达点云数据中的每个点而言，由于每个激光线束本身扫描频率是一致的， 显然越远的扫描线点会越稀疏，因此其平均距离会越远（即便其本身可能不一定是噪点）。因此更合理的方法可能是对每个点周围小范围内（同一条线内）的点进行高斯拟合，然后判断该点是否满足该高斯分布，但是如果需要得到比较准确的高斯分布参数，点数需要达到一定数量，否则和上述基于点云密度进行去噪差别不大。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pcl/io/pcd_io.h&gt;</span>  <span class="comment">//文件输入输出</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pcl/point_types.h&gt;</span>  <span class="comment">//点类型相关定义</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pcl/visualization/cloud_viewer.h&gt;</span>  <span class="comment">//点云可视化相关定义</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pcl/filters/statistical_outlier_removal.h&gt;</span>  <span class="comment">//滤波相关</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pcl/common/common.h&gt;</span>  </span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 1.读取点云</span></span><br><span class="line">pcl::PointCloud&lt;pcl::PointXYZ&gt;::<span class="function">Ptr <span class="title">cloud</span><span class="params">(<span class="keyword">new</span> pcl::PointCloud&lt;pcl::PointXYZ&gt;)</span></span>;</span><br><span class="line">pcl::PCDReader r;</span><br><span class="line">r.read&lt;pcl::PointXYZ&gt;(<span class="string">&quot;table_scene_lms400.pcd&quot;</span>, *cloud);</span><br><span class="line">cout &lt;&lt; <span class="string">&quot;there are &quot;</span> &lt;&lt; cloud-&gt;points.<span class="built_in">size</span>() &lt;&lt; <span class="string">&quot; points before filtering.&quot;</span> &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2.统计滤波</span></span><br><span class="line">pcl::PointCloud&lt;pcl::PointXYZ&gt;::<span class="function">Ptr <span class="title">cloud_filter</span><span class="params">(<span class="keyword">new</span> pcl::PointCloud&lt;pcl::PointXYZ&gt;)</span></span>;</span><br><span class="line">pcl::StatisticalOutlierRemoval&lt;pcl::PointXYZ&gt; sor;</span><br><span class="line">sor.<span class="built_in">setInputCloud</span>(cloud);</span><br><span class="line">sor.<span class="built_in">setMeanK</span>(<span class="number">50</span>);             <span class="comment">// K近邻搜索点个数</span></span><br><span class="line">sor.<span class="built_in">setStddevMulThresh</span>(<span class="number">1.0</span>); <span class="comment">// 标准差倍数</span></span><br><span class="line">sor.<span class="built_in">setNegative</span>(<span class="literal">false</span>);     <span class="comment">// 保留未滤波点（内点）</span></span><br><span class="line">sor.<span class="built_in">filter</span>(*cloud_filter);  <span class="comment">// 保存滤波结果到cloud_filter</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.滤波结果保存</span></span><br><span class="line">pcl::PCDWriter w;</span><br><span class="line">w.writeASCII&lt;pcl::PointXYZ&gt;(<span class="string">&quot;table_scene_lms400_filter.pcd&quot;</span>, *cloud_filter);</span><br><span class="line">cout &lt;&lt; <span class="string">&quot;there are &quot;</span> &lt;&lt; cloud_filter-&gt;points.<span class="built_in">size</span>() &lt;&lt; <span class="string">&quot; points after filtering.&quot;</span> &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br></pre></td></tr></table></figure>
<p>参考：<a target="_blank" rel="noopener" href="https://anyaojun.github.io/2018/12/13/PCL%E7%B3%BB%E5%88%976%E2%80%94%E2%80%94%E7%BB%9F%E8%AE%A1%E6%BB%A4%E6%B3%A2/">统计滤波的源码</a></p>
</div><hr></div><nav id="pagination"><div class="pagination"><a class="extend prev" rel="prev" href="/page/35/">&lt;&lt; Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/35/">35</a><span class="page-number current">36</span><a class="page-number" href="/page/37/">37</a><span class="space">&hellip;</span><a class="page-number" href="/page/60/">60</a><a class="extend next" rel="next" href="/page/37/">Next &gt;&gt;</a></div></nav></div></div><footer class="footer-bg" style="background-image: url(https://s2.loli.net/2022/11/17/QOR8cePIS5NdDrK.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2018 - 2022 By Charon Cheung</div><div class="framework-info"><span>Driven - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_site_uv"><i class="fa fa-user"></i><span id="busuanzi_value_site_uv"></span><span></span></span><span class="footer-separator">|</span><span id="busuanzi_container_site_pv"><i class="fa fa-eye"></i><span id="busuanzi_value_site_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.6.1"></script><script src="/js/fancybox.js?version=1.6.1"></script><script src="/js/sidebar.js?version=1.6.1"></script><script src="/js/copy.js?version=1.6.1"></script><script src="/js/fireworks.js?version=1.6.1"></script><script src="/js/transition.js?version=1.6.1"></script><script src="/js/scroll.js?version=1.6.1"></script><script src="/js/head.js?version=1.6.1"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
    processEscapes: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
  },
  CommonHTML: {
    linebreaks: { automatic: true, width: "90% container" }
  },
  "HTML-CSS": { 
    linebreaks: { automatic: true, width: "90% container" }
  },
  "SVG": { 
    linebreaks: { automatic: true, width: "90% container" }
  }
});
</script><script type="text/x-mathjax-config">MathJax.Hub.Queue(function() {
  var all = MathJax.Hub.getAllJax(), i;
  for (i=0; i < all.length; i += 1) {
    all[i].SourceElement().parentNode.className += ' has-jax';
  }
});
</script><script src="https://cdn.bootcss.com/mathjax/2.7.2/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script>if(/Android|webOS|iPhone|iPod|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
}</script></body></html>