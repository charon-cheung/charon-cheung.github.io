<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content=""><meta name="keywords" content=""><meta name="author" content="Charon Cheung"><meta name="copyright" content="Charon Cheung"><title>If you wish for peace, prepare for war | 沉默杀手</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.6.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.6.1"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  }
} </script><meta name="generator" content="Hexo 5.4.0"></head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="author-info"><div class="author-info__avatar text-center"><img src="https://s2.loli.net/2022/02/17/HQaCXUBn64zsMIL.png"></div><div class="author-info__name text-center">Charon Cheung</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">649</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">6</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">52</span></a></div></div></div><nav id="nav" style="background-image: url(https://s2.loli.net/2022/11/17/QOR8cePIS5NdDrK.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">沉默杀手</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span></div><div id="site-info"><div id="site-title">沉默杀手</div><div id="site-sub-title">If you wish for peace, prepare for war</div></div></nav><div id="content-outer"><div class="layout" id="content-inner"><div class="recent-post-item article-container"><a class="article-title" href="/2020/07/06/%E6%BF%80%E5%85%89SLAM/Cartographer/%E5%8E%9F%E7%90%86%E5%92%8C%E9%85%8D%E7%BD%AE/(%E4%B8%89)%20%E5%9F%BA%E6%9C%AC%E5%8F%82%E6%95%B0%E9%85%8D%E7%BD%AE/">(三) 基本参数配置</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-07-06</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E6%BF%80%E5%85%89SLAM/">激光SLAM</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E6%BF%80%E5%85%89SLAM/Cartographer/">Cartographer</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E6%BF%80%E5%85%89SLAM/Cartographer/%E5%8E%9F%E7%90%86%E5%92%8C%E9%85%8D%E7%BD%AE/">原理和配置</a></span><div class="content"><p>launch 和 lua 配置文件都是在<code>install_isolated/share/cartographer_ros/launch/</code> 和 <code>install_isolated/share/cartographer_ros/configuration_files/</code> 下，所以如果只修改了cartographer_ros软件包中的launch 和 lua 文件之后是需要重新编译的，编译之后才能将修改的文件安装到install_isolated文件中。</p>
<p>从cartographer启动时输出的信息可知，我们自己的lua加载的其他lua有：<code>map_builder.lua</code>, <code>pose_graph.lua</code>, <code>trajectory_builder.lua</code>, <code>trajectory_builder_2d.lua</code>.  它们的路径都在<code>/usr/local/share/cartographer/configuration_files</code>。如果我们需要改这些基本lua的参数，可以在自己lua里覆盖地修改，直接改原文件不太好，它们的关系如下：<br><img src="https://i.loli.net/2020/07/07/cWHdEYj4VXK7ymL.png" alt=""></p>
<p><code>map_builder.lua</code>和<code>trajectory_build.lua</code>起着总领的作用，前者包括的<code>pose_graph.lua</code>为后端优化的具体参数配置； 后者是前端的参数配置，分为2d和3d两个文件。</p>
<p><code>lua_parameter_dictionary.cc</code>是用于lua参数的，如果这里有报错，基本是lua参数的语法问题<br><img src="https://s2.loli.net/2022/04/02/xUzv8fDsco95ieP.png" alt=""></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[/cartographer_node] [ScopedRosLogSink::send] line_63  F0402 <span class="number">21</span>:<span class="number">57</span>:<span class="number">53.000000</span> <span class="number">20519</span> lua_parameter_dictionary.cc:<span class="number">399</span>] Check failed: HasKey(key) Key <span class="string">&#x27;use_nav_sat&#x27;</span> not in dictionary:</span><br></pre></td></tr></table></figure>
<p>在lua文件里必须设置<code>use_nav_sat</code>参数，同样报错的参数都要添加</p>
<h2 id="自定义lua的参数"><a href="#自定义lua的参数" class="headerlink" title="自定义lua的参数"></a>自定义lua的参数</h2><p>我用的是<code>home.lua</code>， 先看options的内容，这是通用的参数。options块中定义的值定义了cartographer前端应当如何与机器人进行交互。  定义在options段后的值用于调试cartographer的内部信息</p>
<p>开头的<code>map_builder = MAP_BUILDER</code>和<code>trajectory_builder = TRAJECTORY_BUILDER</code>万年不变:<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">map_builder = MAP_BUILDER,</span><br><span class="line">trajectory_builder = TRAJECTORY_BUILDER,</span><br><span class="line">map_frame = <span class="string">&quot;map&quot;</span>,</span><br><span class="line">tracking_frame = <span class="string">&quot;imu&quot;</span>,</span><br><span class="line">published_frame = <span class="string">&quot;odom&quot;</span>,</span><br><span class="line">odom_frame = <span class="string">&quot;odom&quot;</span>,</span><br><span class="line">provide_odom_frame = <span class="literal">false</span>,</span><br><span class="line">publish_frame_projected_to_2d = <span class="literal">false</span>,</span><br><span class="line">publish_tracked_pose = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">use_odometry = <span class="literal">true</span>,</span><br><span class="line">use_nav_sat = <span class="literal">false</span>,</span><br><span class="line">use_landmarks = <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">num_laser_scans = 1,</span><br><span class="line">num_multi_echo_laser_scans = 0,</span><br><span class="line">num_subdivisions_per_laser_scan = 1,</span><br><span class="line">num_point_clouds = 0,</span><br><span class="line"></span><br><span class="line">lookup_transform_timeout_sec = 0.2,</span><br><span class="line">submap_publish_period_sec = 0.3,</span><br><span class="line">pose_publish_period_sec = 5e-3,  --频率可能比较高</span><br><span class="line">trajectory_publish_period_sec = 30e-3,</span><br><span class="line"></span><br><span class="line">rangefinder_sampling_ratio = 1.,</span><br><span class="line">odometry_sampling_ratio = 1.,</span><br><span class="line">fixed_frame_pose_sampling_ratio = 1.,</span><br><span class="line">imu_sampling_ratio = 1.,</span><br><span class="line">landmarks_sampling_ratio = 1.,</span><br><span class="line"></span><br><span class="line"><span class="comment"># 补充</span></span><br><span class="line">collate_fixed_frame = <span class="literal">true</span>  是否将数据放入阻塞队列</span><br><span class="line">collate_landmarks = <span class="literal">false</span>  -- 一般都是<span class="literal">false</span></span><br></pre></td></tr></table></figure></p>
<h3 id="坐标系组"><a href="#坐标系组" class="headerlink" title="坐标系组"></a>坐标系组</h3><ul>
<li><p>map_frame: 用于发布submaps的ROS坐标系，也是位姿的父坐标系，通常是map</p>
</li>
<li><p>tracking_frame: 通常，如果使用IMU，就是<code>imu_link</code>; 如果不用IMU，可以用<code>laser</code>。博物馆的lua写的base_link</p>
</li>
</ul>
<p>有时遇到这样的报错：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Check failed: sensor_to_tracking-&gt;translation().norm() &lt; <span class="number">1e-5</span> The IMU frame must be colocated with the tracking frame. Transforming linear acceleration into the tracking frame will otherwise be imprecise</span><br></pre></td></tr></table></figure><br>这是因为在使用IMU的情况下，<code>tracking frame</code>不是imu的link</p>
<ul>
<li><p>published_frame: 位姿子坐标系的ROS坐标系，例如”odom”坐标系，如果一个odom坐标系由系统的不同部分提供，在这种情况下，map_frame中的<code>odom</code>姿势将被发布。 否则，将其设置为<code>base_link</code>可能是合适的</p>
</li>
<li><p>provide_odom_frame: true 适用于机器人本身没有odom坐标系的情况，如果启用，将发布局部、非闭环、持续的位姿，也就是odom_frame在map_frame中的坐标</p>
</li>
<li>odom_frame: 在provide_odom_frame为true才启用，坐标系在published_frame和map_frame之间用于发布局部SLAM结果，通常是”odom”</li>
<li>use_odometry: 如果启用，会订阅关于odom话题(或者叫其他名字)的<code>nav_msgs/Odometry</code>消息。应当提供里程信息，这些信息包含在SLAM里</li>
<li>use_nav_sat: 是否使用gps数据。如果启用，将订阅<code>sensor_msgs/NavSatFix</code>的话题，比如fix. 应当提供导航数据，将用于全局SLAM</li>
<li><p>use_landmarks: 如果启用，订阅<code>cartographer_ros_msgs/LandmarkList</code>的话题，比如landmarks. 应当提供Landmarks信息，这些信息包含在SLAM里</p>
</li>
<li><p><code>use_pose_extrapolator</code>: 默认false. 发布tf时是使用 pose_extrapolator推断的位姿还是前端计算出来的位姿</p>
</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">stamped_transform.header.stamp =</span><br><span class="line">    node_options_.use_pose_extrapolator</span><br><span class="line">        ? <span class="built_in">ToRos</span>(now)</span><br><span class="line">        : <span class="built_in">ToRos</span>(trajectory_data.local_slam_data-&gt;time);</span><br></pre></td></tr></table></figure>
<p>旧版本没有这个参数，直接使用了<code>now</code>。这个参数认为位姿估计器很精确，但前提是雷达频率高，时间间隔短。最好是使用前端的时间戳</p>
<ul>
<li>publish_frame_projected_to_2d: 默认false. 发布TF变换时，是否将tracking在Local坐标系中的坐标投影到2D平面上，这只是个显示功能，不影响SLAM。</li>
<li>publish_tracked_pose: 是否发布话题<code>tracked_pose</code>，也就是tracking坐标系在map坐标系的位姿，朝向与imu_link的x轴重合</li>
</ul>
<h3 id="num组"><a href="#num组" class="headerlink" title="num组"></a>num组</h3><p><code>Cartographer</code>可以订阅的主题有三种，我们一般用<code>scan</code>，还可以用<code>echoes</code>或<code>points2</code>，这三个是互斥的。分别对应lua中的<code>num_laser_scans</code>, <code>num_multi_echo_laser_scans</code>,<code>num_point_clouds</code>.  <font size="4" color="blue"> 这三个参数必须都是 &gt;= 0 且三者之和 &gt;=1 </font>  代码在<code>ComputeRepeatedTopicNames</code></p>
<p>lua中将<code>num_laser_scans</code>设置为1，则<code>scan</code>将用作SLAM的输入，如果<code>num_laser_scans</code>大于1，则多个编号的扫描主题（即scan_1，scan_2，scan_3，……直到并包括num_laser_scans）将用作SLAM的输入.</p>
<p>当<code>num_point_clouds</code>为1时，默认订阅<code>points2</code>话题的数据</p>
<p>同理，如果将<code>num_multi_echo_laser_scans</code>设置为１，则<code>echoes</code>做输入，但仅使用第一个回声，如果大于1，则多个编号的回声主题（即echoes_1，echoes_2，echoes_3，……直到并包括num_multi_echo_laser_scans）将用作SLAM的输入。<code>echoes</code>的消息类型为<code>sensor_msgs/MultiEchoLaserScan</code>，不同之处在于<code>sensor_msgs/LaserEcho[] ranges</code>和<code>sensor_msgs/LaserEcho[] intensities</code></p>
<font color = blue size=4> 首先需要雷达支持多echo，即每个脉冲发出以后，会有多个echo返回。我们知道一般雷达要避免扫描玻璃，因为laser会穿透过去，但多echo雷达不仅可以获得玻璃返回的echo，也能获得玻璃后面的墙返回的echo，这样我们就获得不同深度的信息，对建图定位的帮助更大。</font>

<p><code>points２</code>也是这样，消息类型<code>sensor_msgs/PointCloud2</code>，<code>num_point_clouds</code>适用于多线雷达，对于单线，设置为0</p>
<ul>
<li>num_subdivisions_per_laser_scan: 将雷达一帧的数据拆分成几次发出来，必须&gt;=1，默认10。在<code>SensorBridge::HandleLaserScan</code>中调用, 对点云points细分。比如雷达scan有200束激光，本参数为10，那么转换成点云后，对点云取很多小段处理：(0,20)、(20,40)……(190,200)。 对于普通雷达来说，此处为1即可</li>
</ul>
<h3 id="period-组"><a href="#period-组" class="headerlink" title="period 组"></a>period 组</h3><p>都在<code>Node</code>的构造函数里，是ROS定时器的发布间隔</p>
<ul>
<li>lookup_transform_timeout_sec: 使用tf2查找<code>tracking_frame</code>和雷达坐标系变换的超时秒数，在函数<code>TfBridge::LookupToTracking</code></li>
<li>submap_publish_period_sec: 发布话题<code>submap_list</code>的间隔</li>
<li>pose<em>publish_period_sec:  对应`publish_local_trajectory_data_timer</em><code>和</code>Node::PublishLocalTrajectoryData`. 例如5e-3，对应tf发布频率为200Hz</li>
<li>trajectory_publish_period_sec: 发布轨迹节点和Landmark的时间间隔，对应<code>PublishTrajectoryNodeList</code>和<code>PublishLandmarkPosesList</code></li>
</ul>
<h3 id="ratio-组"><a href="#ratio-组" class="headerlink" title="ratio 组"></a>ratio 组</h3><p>5种观测的权重比</p>
<ul>
<li><p>rangefinder_sampling_ratio: Fixed ratio sampling for range finders messages.</p>
</li>
<li><p>odometry_sampling_ratio: Fixed ratio sampling for odometry messages. 如odom的数据非常不准，可以设置为0.3，以减小odom对整体优化的影响</p>
</li>
<li><p>fixed_frame_sampling_ratio: Fixed ratio sampling for fixed frame messages.</p>
</li>
<li><p>imu_sampling_ratio: Fixed ratio sampling for IMU messages.</p>
</li>
<li><p>landmarks_sampling_ratio: Fixed ratio sampling for landmarks messages.</p>
</li>
</ul>
<p>options结束后，一般有一句：<code>MAP_BUILDER.use_trajectory_builder_2d = true</code>，这是因为<code>map_builder.lua</code>中的这个参数设置为false了，我们在这里可以重新赋值，选择使用2D还是3D</p>
<h3 id="不使用机器人的IMU和Odom"><a href="#不使用机器人的IMU和Odom" class="headerlink" title="不使用机器人的IMU和Odom"></a>不使用机器人的IMU和Odom</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">map_frame = <span class="string">&quot;map&quot;</span>,</span><br><span class="line">tracking_frame = <span class="string">&quot;base_footprint&quot;</span>,</span><br><span class="line">published_frame = <span class="string">&quot;base_footprint&quot;</span>,	</span><br><span class="line">odom_frame = <span class="string">&quot;odom&quot;</span>,</span><br><span class="line">provide_odom_frame = <span class="literal">true</span>,</span><br><span class="line">publish_frame_projected_to_2d = <span class="literal">false</span>,</span><br><span class="line">use_odometry = <span class="literal">false</span>,</span><br><span class="line">TRAJECTORY_BUILDER_2D.use_imu_data = <span class="literal">false</span>  --默认<span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p>进行2d slam时，carto的默认配置是使用imu的，所以如果没有imu就要<code>TRAJECTORY_BUILDER_2D.use_imu_data = false</code>，否则会一直等待imu的数据而进行不下去。而3D slam 必须使用imu，所以不必修改这个参数。</p>
<ul>
<li>为什么3D必须有IMU，而2D可以不用？</li>
</ul>
<p>在2D中，Cartographer支持运行相关的扫描匹配器，用于局部SLAM中寻找循环关闭的约束条件。它的计算代价很大，但通常会使odometry或IMU数据的加入变得不必要。2D也有假设平坦世界的好处，也就是说，上升是隐式定义的。<br>在三维中，IMU主要用于测量重力。重力在测量中是一个很有用的量，因为它不漂移，而且是一个非常强的信号，而且通常包含了大部分所要测量的加速度。</p>
<p><code>Node::LaunchSubscribers</code>函数中有一段：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (node_options_.map_builder_options.<span class="built_in">use_trajectory_builder_3d</span>() ||</span><br><span class="line">      (node_options_.map_builder_options.<span class="built_in">use_trajectory_builder_2d</span>() &amp;&amp;</span><br><span class="line">       options.trajectory_builder_options.<span class="built_in">trajectory_builder_2d_options</span>()</span><br><span class="line">           .<span class="built_in">use_imu_data</span>() )  )</span><br></pre></td></tr></table></figure><br>显然源码里已经做了规定</p>
<ul>
<li>屏蔽机器人的里程计</li>
</ul>
<p>如果我们不想使用轮式里程计， cartographer的lua无法屏蔽里程计，只能自己修改机器人的程序，不让它发布odom话题和<code>odom---&gt;base_footprint</code>的tf变换。如果不修改，使用时会发现tf变换一会儿由 cartographer发布，一会儿由机器人程序发布，<strong>千万不能由两个节点发布同一个tf变换，</strong>从rviz看上去，RobotModel和LaserScan摇晃地很厉害。</p>
<p>这里有一个技巧， <font color = blue size=4> 观察一个tf变换是否由两个节点发布，用rosrun tf view_frame是看不出来的，应该用rosrun rqt_tf_tree rqt_tf_tree，然后用刷新按钮观察。</font></p>
<font color = blue size=4> 如果不用IMU，Odom + Lidar在局部存在纠偏失败的可能。 但是在里程计与imu不准的情况下，使用imu和odom反而建图效果会更差</font>

<h3 id="使用机器人的odom和imu，lua做如下设置"><a href="#使用机器人的odom和imu，lua做如下设置" class="headerlink" title="使用机器人的odom和imu，lua做如下设置:"></a>使用机器人的odom和imu，lua做如下设置:</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">map_frame = <span class="string">&quot;map&quot;</span>,</span><br><span class="line">tracking_frame = <span class="string">&quot;imu&quot;</span>,</span><br><span class="line">published_frame = <span class="string">&quot;odom&quot;</span>,</span><br><span class="line">odom_frame = <span class="string">&quot;odom&quot;</span>,</span><br><span class="line">provide_odom_frame = <span class="literal">false</span>,</span><br><span class="line">publish_frame_projected_to_2d = <span class="literal">false</span>,</span><br><span class="line">use_odometry = <span class="literal">true</span>,</span><br></pre></td></tr></table></figure>
<p>一开始，我增加了参数<code>TRAJECTORY_BUILDER_2D.num_accumulated_range_data = 10</code>，结果出现了scan一直在转的情况，使用<code>tf_echo</code>  map和laser坐标系的关系，发现y位移一直在增大，但x z基本不变。去掉这个参数后，不再一直转了，但是过了几分钟还是有所偏，地图还出现了重影，这说明是机器人的里程计误差问题，需要校准，这个参数应该是放大了这种现象。</p>
<p>如果不想每过一段时间就校准，那么<code>odom</code>到<code>base_link</code>的tf就用cartographer的，因为它有重定位，累计误差比较小，而且可以得到修正</p>
<p>对是否使用odom的两套程序如下：<br><img src="https://i.loli.net/2020/07/15/xQBXdeTDlG9Mgmt.png" alt="不用odom的程序组合.png"></p>
<p><img src="https://i.loli.net/2020/07/15/4LaCfrFoxwA8291.png" alt="使用机器人odom的程序组合.png"><br>查看节点<code>cartographer_node</code>是否订阅了IMU和Odom，检查是否用到了它们</p>
<h3 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h3><ul>
<li><p>使用IMU后，有时启动时会报警：<br><img src="https://i.loli.net/2020/07/05/Oe6mSACf71RvilY.png" alt="启动cartographer报错 1.png"><br><img src="https://i.loli.net/2020/07/05/jctZgfXP2Gqhusm.png" alt="启动cartographer报错 2.png"><br>出问题的代码在<code>cartographer::mapping::ImuTracker::AddImuLinearAccelerationObservation()</code>。启动一下imu程序，如果<code>rostopic echo /xqserial_server/IMU/linear_acceleration</code>就会发现，imu线加速度开始为0，过了一秒左右才有数据，这应该是节点通信的问题。所以cartographer读取到的线加速度全是0，在程序里就会报错。此时再重启就没事了</p>
</li>
<li><p>建图时地图围绕原点转圈，画出来的是一团黑，可能是用到的IMU的加速度有问题，需要校准IMU。还有可能是ceres的平移和旋转的权重没有进行重新配置。</p>
</li>
<li><p>如果出现下面的输出，一般是<code>scan</code>话题没有订阅到:</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[ WARN][/cartographer_node] [ScopedRosLogSink::send] line_55  W0711 <span class="number">20</span>:05:<span class="number">58.000000</span> <span class="number">12245</span> ordered_multi_queue.cc:<span class="number">155</span>] Queue waiting <span class="keyword">for</span> data: (<span class="number">0</span>, scan)</span><br></pre></td></tr></table></figure>
<p>正确的是这样：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[ INFO][/cartographer_node] [ScopedRosLogSink::send] line_51  I0711 <span class="number">20</span>:<span class="number">14</span>:<span class="number">56.000000</span> <span class="number">25541</span> ordered_multi_queue.cc:<span class="number">172</span>] All sensor data <span class="keyword">for</span> trajectory <span class="number">0</span> <span class="keyword">is</span> available starting at <span class="string">&#x27;637300664959145564&#x27;</span>.</span><br></pre></td></tr></table></figure>
</li>
<li><p>常常启动后出现这个报警：<br><img src="https://i.loli.net/2020/07/11/Z52LHSFxUqphT6Y.png" alt="tf报警.png"><br>这其实是tf坐标系的问题，cartographer源码里lookupTransform写的不好，不管也可以，详细分析可见</p>
</li>
</ul>
<p><a href="https://charon-cheung.github.io/2020/07/11/ROS/ROS%20Kinetic%E7%9F%A5%E8%AF%86/tf%E6%8A%A5%E8%AD%A6%EF%BC%9ALookup%20would%20require%20extrapolation%20into%20the%20past/">tf报警：Lookup would require extrapolation into the past</a></p>
<ul>
<li>机器人在地图中的位置不稳定，有轻微摆动，tf_echo如下：</li>
</ul>
<p><img src="https://i.loli.net/2020/07/28/U3WKdLxVi8497RP.png" alt="base_footprint在map中的坐标.png"><br>yaw有跳变， 判断是里程计累计误差</p>
<ul>
<li><font color = blue size=4> cartographer对雷达频率要求比较高，20Hz以上比较好，当频率达到30hz时，做纯旋转运动时不会产生地图的偏移。因为只有频率越高，2帧间的时间越短，误差才能越小。</font>
</li>
<li><p>如果雷达比较差，地图边界会比较粗糙，用robosense雷达明显效果好</p>
</li>
</ul>
<h2 id="map-builder-lua-和-trajectory-builder-lua"><a href="#map-builder-lua-和-trajectory-builder-lua" class="headerlink" title="map_builder.lua 和 trajectory_builder.lua"></a>map_builder.lua 和 trajectory_builder.lua</h2><p>内容只有几行:<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">include <span class="string">&quot;pose_graph.lua&quot;</span></span><br><span class="line"></span><br><span class="line">MAP_BUILDER = &#123;</span><br><span class="line">  use_trajectory_builder_2d = <span class="literal">false</span>,</span><br><span class="line">  use_trajectory_builder_3d = <span class="literal">false</span>,</span><br><span class="line">  num_background_threads = 4,</span><br><span class="line">  pose_graph = POSE_GRAPH,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>map_builder.lua内容太简单了，配置是使用<code>trajectory_build_2d</code>还是<code>trajectory_build_3d</code>，以及后端使用的线程数。 <code>use_trajectory_builder_2d</code>在上面讲过改为true，其他一般不动，如果CPU性能好，可以增大<code>num_background_threads</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">include <span class="string">&quot;trajectory_builder_2d.lua&quot;</span></span><br><span class="line">include <span class="string">&quot;trajectory_builder_3d.lua&quot;</span></span><br><span class="line"></span><br><span class="line">TRAJECTORY_BUILDER = &#123;</span><br><span class="line">  trajectory_builder_2d = TRAJECTORY_BUILDER_2D,</span><br><span class="line">  trajectory_builder_3d = TRAJECTORY_BUILDER_3D,</span><br><span class="line">  pure_localization = <span class="literal">false</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>trajectory_builder.lua</code>更简单，只有一个<code>pure_localization</code>区分是否使用carto用于机器人纯定位</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/07/02/%E6%BF%80%E5%85%89SLAM/Cartographer/%E5%8E%9F%E7%90%86%E5%92%8C%E9%85%8D%E7%BD%AE/%E7%BA%AF%E5%AE%9A%E4%BD%8D%E6%A8%A1%E5%BC%8F%20(%E4%B8%80)/">纯定位模式 (一)</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-07-02</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E6%BF%80%E5%85%89SLAM/">激光SLAM</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E6%BF%80%E5%85%89SLAM/Cartographer/">Cartographer</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E6%BF%80%E5%85%89SLAM/Cartographer/%E5%8E%9F%E7%90%86%E5%92%8C%E9%85%8D%E7%BD%AE/">原理和配置</a></span><div class="content"><p>纯定位时载入的地图在submap中的trajectory为0，启动定位后，系统默认从起点开始建立子图进行匹配，该子图在submap中的trajectory为 1。</p>
<p>一条trajectory可以理解为一次建图过程。如果只让机器人跑一圈，那么trajectory数就是1. 但是，建好图后又需要在图中走，这时候可以增加一条trajectory，把<code>pure_localization</code>设为true，那么机器人再重新跑的过程中就会跟已经建好的图进行匹配，估计机器人在地图中的路径。所以，一次运行就代表了一条trajectory。</p>
<p><strong>cartographer定位时，它的地图是变化的</strong></p>
<p>纯定位和建图不同，local和global SLAM之间的延迟要尽量低. 其次global SLAM通常会在作为地图的frozen trajectory和当前trajectory之间，找到大量的相互约束(inter constraints)。</p>
<p>纯定位模式默认只保存 3 个子图，只有这些子图内的节点参与优化。所以地图大小并不会影响后端优化的速度。而建图结束的时候全图优化应该是所有节点参与。</p>
<p>我们需要显著减小<code>POSE_GRAPH.optimize_every_n_nodes</code>以接收频繁的结果， global SLAM通常会太慢，所以再显著减小<code>global_sampling_ratio</code>和<code>constraint_builder.sampling_ratio</code>以补偿大量的约束。</p>
<p><code>submaps.resolution</code>应当和运行的<code>.pbstream</code>中的子图resolution一致</p>
<p>建图时，cartographer使用 <strong>fast correlative scan matcher</strong>找到回环，search window默认为<code>7m×7m×30°</code>. 但纯定位模式中，search window变得非常大，所以纯定位消耗CPU更大</p>
<p><code>constraint_builder_2d.cc</code>中的<code>ComputeConstraint()</code>函数，在纯定位模式下，会频繁地调用<code>MaybeAddGlobalConstraint()</code>，这个函数会搜索整个子图，造成的开销特别大。建议将<code>global_sampling_ratio</code>调小，这样就可以从一定程度上减少开销。</p>
<h2 id="数据集的纯定位测试"><a href="#数据集的纯定位测试" class="headerlink" title="数据集的纯定位测试"></a>数据集的纯定位测试</h2><p>程序运行时只在局部建图（保留固定数量的子图），随着机器人的运动和观测，<font color = blue size=4> 新的子图会添加进来，旧的子图会被删除，就是只保留局部的地图数据。我的理解是保留局部数据越多，与原有地图进行回环检测就增多，这样计算量增加的同时也增加了误匹配的概率，使得整个系统不稳定</font> ，所以这里只进行定位，不用于建图</p>
<p>需要用到数据集<code>b2-2016-04-05-14-44-52.bag</code>和<code>b2-2016-04-27-12-31-41.bag</code>，前者用于建图，后者用于定位</p>
<p>先运行建图：<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">roslaunch cartographer_ros offline_backpack_2d.launch bag_filenames:=<span class="variable">$&#123;HOME&#125;</span>/path/b2-2016-04-05-14-44-52.bag</span><br></pre></td></tr></table></figure><br>等一会，完成后会生成pbstream文件，如果运行建图，实际地图是这样的<br><img src="https://i.loli.net/2020/07/14/yIZn7sUrBzYEfNi.png" alt="建图.png"></p>
<p>这里是先用第一个数据集建图，建完图后用第二个数据集进行定位测试。<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">roslaunch cartographer_ros demo_backpack_2d_localization.launch load_state_filename:=<span class="variable">$&#123;BAG&#125;</span>/b2-2016-04-05-14-44-52.bag.pbstream bag_filename:=<span class="variable">$&#123;BAG&#125;</span>/b2-2016-04-27-12-31-41.bag</span><br></pre></td></tr></table></figure><br>后面两个参数一个是上一步建好的地图，pbstream格式，另一个是数据集。你会看到机器人很快实现了定位</p>
<h2 id="在机器人的旧版本纯定位"><a href="#在机器人的旧版本纯定位" class="headerlink" title="在机器人的旧版本纯定位"></a>在机器人的旧版本纯定位</h2><p>用于定位时的<code>home_no_odom_localization.launch</code><br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">launch</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">node</span> <span class="attr">name</span>=<span class="string">&quot;cartographer_node&quot;</span> <span class="attr">pkg</span>=<span class="string">&quot;cartographer_ros&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">type</span>=<span class="string">&quot;cartographer_node&quot;</span> <span class="attr">args</span>=<span class="string">&quot;</span></span></span><br><span class="line"><span class="string"><span class="tag">          -configuration_directory $(find cartographer_ros)/configuration_files</span></span></span><br><span class="line"><span class="string"><span class="tag">          -configuration_basename home_no_odom_localization.lua</span></span></span><br><span class="line"><span class="string"><span class="tag">          -load_state_filename /home/xiaoqiang/Documents/ros/maps/home.pbstream&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">output</span>=<span class="string">&quot;screen&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">node</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">node</span> <span class="attr">name</span>=<span class="string">&quot;cartographer_occupancy_grid_node&quot;</span> <span class="attr">pkg</span>=<span class="string">&quot;cartographer_ros&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">type</span>=<span class="string">&quot;cartographer_occupancy_grid_node&quot;</span> <span class="attr">args</span>=<span class="string">&quot;-resolution 0.05&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">launch</span>&gt;</span></span><br></pre></td></tr></table></figure><br>使用<code>cartographer</code>建图和定位时，launch文件的不同之处在于<code>cartographer_node</code>节点的参数<code>-configuration_basename</code>和<code>-load_state_filename</code>，前者就是lua文件的不同，后者只在定位时才有，毕竟没有地图就不能定位</p>
<p>建图使用<code>no_odom_and_imu.lua</code>，定位使用<code>home_no_odom_localization.lua</code>:<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">include <span class="string">&quot;home.lua&quot;</span></span><br><span class="line"></span><br><span class="line">TRAJECTORY_BUILDER.pure_localization = <span class="literal">true</span></span><br><span class="line">--- 每10个有效帧一个子图，子图构建完成要闭环检测一次，这个数越小，闭环检测越频繁，当然CPU增大</span><br><span class="line">POSE_GRAPH.optimize_every_n_nodes = 5</span><br><span class="line">POSE_GRAPH.constraint_builder.sampling_ratio = 0.1</span><br><span class="line">POSE_GRAPH.global_sampling_ratio = 0.002</span><br></pre></td></tr></table></figure><br>启动<code>roslaunch cartographer_ros home_localization.launch</code>后应该就可以了，必须有<code>map</code>坐标系，否则就是没成功。<br><img src="https://i.loli.net/2020/07/20/NhcVQr8JIfUvTX7.png" alt="定位结果.png"></p>
<p><code>optimize_every_n_nodes</code>会影响定位时的CPU占用，设置为<code>5</code>时对应50%，但只有定位时的一秒左右，所以无所谓。</p>
<p>添加轨迹实际调用的源码是<code>node.cc</code>中的<code>Node::HandleStartTrajectory</code>——<code>AddTrajectory</code></p>
<h3 id="新版本的配置"><a href="#新版本的配置" class="headerlink" title="新版本的配置"></a>新版本的配置</h3><p><img src="https://i.loli.net/2020/07/14/6DYXKcHwfTetgMq.png" alt="pure_localization_trimmer.png"><br>这是因为我的 cartographer版本旧，不支持<code>pure_localization_trimmer</code>，最好还是更新到最新。在18年7月增加了<code>pure_localization_trimmer</code>，删掉了<code>pure_localization</code>，如果是新一点的版本，做对应修改。commit历史在<a target="_blank" rel="noopener" href="https://github.com/cartographer-project/cartographer/commit/0981620d8fd4d3489ff1b503183b128909f1c86d">这里</a></p>
<p>相应的源码在 <code>MapBuilder::AddTrajectoryBuilder</code>——<code>MaybeAddPureLocalizationTrimmer</code>：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (trajectory_options.<span class="built_in">pure_localization</span>()) </span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">LOG</span>(WARNING) &lt;&lt; <span class="string">&quot;&#x27;TrajectoryBuilderOptions::pure_localization&#x27; field is deprecated&quot;</span></span><br><span class="line">         <span class="string">&quot;Use &#x27;TrajectoryBuilderOptions::pure_localization_trimmer&#x27; instead.&quot;</span>;</span><br><span class="line">  pose_graph-&gt;<span class="built_in">AddTrimmer</span>(absl::make_unique&lt;PureLocalizationTrimmer&gt;(</span><br><span class="line">      trajectory_id, <span class="number">3</span> <span class="comment">/* max_submaps_to_keep */</span>)  );</span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (trajectory_options.<span class="built_in">has_pure_localization_trimmer</span>()) </span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// 添加一个PureLocalizationTrimmer类型修饰器</span></span><br><span class="line">  pose_graph-&gt;<span class="built_in">AddTrimmer</span>(absl::make_unique&lt;PureLocalizationTrimmer&gt;(</span><br><span class="line">      trajectory_id,</span><br><span class="line">      trajectory_options.<span class="built_in">pure_localization_trimmer</span>().<span class="built_in">max_submaps_to_keep</span>() ) );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>新版本的配置:<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">TRAJECTORY_BUILDER.pure_localization_trimmer = &#123;</span><br><span class="line">  --- 最大保存子图数，存定位模式通过子图进行定位，但只需要当前和上一个子图即可</span><br><span class="line">  max_submaps_to_keep = 3,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>如果使用了机器人的odom，但无法定位成功或定位误差太大，可能的原因是odom不够精确，尝试关闭odom，并由cartographer代为提供odom。既然定位误差大，可能在建图时的原始submap之间误差较大，图优化后map的边缘较为模糊</p>
<p>重定位注释掉<code>Node::GrawAndPublish</code>函数的后三行，否则会继续建图。但是建图的时候还得加回来。<br>由于Cartographer定位是当前帧和子图进行匹配，所以对于机器人周围被新物体遮挡的情况完全没有影响。</p>
<p>唯一影响就是没法重定位了，因为地图上没有这些新物体。但是就算长时间被遮挡，存在累积定位误差，只要机器人离开了遮挡区域，回到了之前的环境，就可以重定位回来。</p>
<h2 id="获得机器人在map坐标系中的坐标"><a href="#获得机器人在map坐标系中的坐标" class="headerlink" title="获得机器人在map坐标系中的坐标"></a>获得机器人在map坐标系中的坐标</h2><p>cartographer是使用tf转换来发布位姿的，如果想发布类似<code>amcl_pose</code>那样的话题，只能修改源码或自己写个程序。</p>
<p>修改源码的方法可以参考<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_42861143/article/details/104021487">这里</a></p>
<p>我还是自己写了个程序，其实就是<a href="https://charon-cheung.github.io/2020/07/11/ROS/ROS%20Kinetic%E7%9F%A5%E8%AF%86/tf%E6%8A%A5%E8%AD%A6%EF%BC%9ALookup%20would%20require%20extrapolation%20into%20the%20past/">tf报警：Lookup would require extrapolation into the past</a>中的程序改了坐标系和话题名称，以获得<code>base_footprint</code>在<code>map</code>中的坐标系</p>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>某次运行得到这样结果：<br><img src="https://i.loli.net/2020/07/17/PETDZKNuLYjh2zl.png" alt=""><br>追查到<code>node.cc</code>里的<code>Node::FinishTrajectoryUnderLock</code>函数，检查了一下是否可以关掉，指定id是否存在，是否已经被Finished了等情况后，如果一切正常，则停止订阅Topic、清除id及其他与该trajectory相关的量。最后调用<code>map_builder_bridge_</code>中的FinishTrajectory函数。发现code对应<code>cartographer_ros_msgs::StatusCode::INVALID_ARGUMENT</code></p>
<p>参考：<br><a target="_blank" rel="noopener" href="https://google-cartographer-ros.readthedocs.io/en/latest/tuning.html#pure-localization-in-a-given-map">官方参考</a><br><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/33110529">更优雅的设定初始位姿</a></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/06/30/%E7%9B%B8%E6%9C%BA/realsense%20D435i%E5%85%B3%E9%97%ADIR%E7%BB%93%E6%9E%84%E5%85%89/">Realsense D435i关闭IR结构光</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-06-30</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E7%9B%B8%E6%9C%BA/">相机</a></span><div class="content"><p>由于要做Realsense D435i的双目结构光相机标定，其中用到了ROS来录制数据包，但是结构光会影响标定，所以得先关闭IR结构光发射器。</p>
<h2 id="一次性关闭IR光"><a href="#一次性关闭IR光" class="headerlink" title="一次性关闭IR光"></a>一次性关闭IR光</h2><p>其实就是动态参数调整<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">roslaunch realsense2_camera rs_camera.launch </span><br><span class="line">rosrun rqt_reconfigure rqt_reconfigure </span><br></pre></td></tr></table></figure><br><a target="_blank" rel="noopener" href="https://i.loli.net/2020/06/30/nxGBZTqfiQR31hj.png">rqt_reconfigure</a><br><code>emitter_enabled</code>有三项: Laser(1),  Laser Auto(2), Off(0)。 选Off即可</p>
<p>通过肉眼看相机发射器已经不再发射IR光了，打开rqt，找到<code>/camera/infra1/image_rect_raw</code>和<code>/camera/infra2/image_rect_raw</code>，发现确实没有白斑了。</p>
<h2 id="永久关闭"><a href="#永久关闭" class="headerlink" title="永久关闭"></a>永久关闭</h2><p>其实就是通过<code>realsense-viewer</code>，这个是驱动层面的操作，更加底层<br><img src="https://i.loli.net/2020/06/30/CGYw92XUWgnKb7c.png" alt="配置栏.png"></p>
<p>参考：<a target="_blank" rel="noopener" href="https://blog.csdn.net/Hanghang_/article/details/103612300">Realsense D435i 关闭IR光</a></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/06/30/ROS/ROS%20Kinetic%E7%9F%A5%E8%AF%86/ROS%E7%9A%84topic_tools%E5%8C%85/">ROS的topic_tools包</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-06-30</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/ROS/">ROS</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/ROS/ROS-Kinetic%E7%9F%A5%E8%AF%86/">ROS Kinetic知识</a></span><div class="content"><h2 id="throttle"><a href="#throttle" class="headerlink" title="throttle"></a>throttle</h2><p>转播 (relay)话题, 限制最大发布频率或者带宽。使用格式: <code>rosrun topic_tools throttle messages &lt;intopic&gt; &lt;msgs_per_sec&gt; [outtopic]</code></p>
<p>messages是当前使用的是throttle的messages模式,限制发布频率. intopic是指你想要改变频率的那个topic, msgs_per_sec是指你想要它发布的频率，而outtopic是指改变发布频率后的topic的名称，可以省略，<strong>如果省略则自动在原来topic的名字上后缀throttle</strong></p>
<p>另外还有bytes模式, 用以限制带宽: <code>rosrun topic_tools throttle bytes &lt;intopic&gt; &lt;bytes_per_sec&gt; &lt;window&gt; [outtopic]</code></p>
<p>例如，让雷达的带宽占用降至1KBps，则命令为：<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rosrun topic_tools throttle bytes base_scan 1024 1.0</span><br></pre></td></tr></table></figure></p>
<p>改变topic发布频率并不是说原来的topic就没了，或者直接在原来的topic上更改，<font size="4" color="blue"> 而是把其更改后的topic发布出来，原来的topic仍然存在 </font></p>
<p>有三个参数，需要注意的是<code>~lazy</code>，如果它等于True的话，只有当你订阅到throttle发出来的消息，它才会工作，这显然是<code>ros::publish</code>函数的lazy模式了</p>
<p>最大的问题是<font color=orange size= 4> 频率控制的精度低,我要求4Hz,实际却在3.6Hz左右</font>，所以实际要设置的大一些</p>
<h2 id="transform"><a href="#transform" class="headerlink" title="transform"></a>transform</h2><p>订阅一个topic或topic field，并在应用给定的Python表达式后将传入的数据发布到另一个topic。它可以处理任何消息类型，主要用于简单的消息转换，例如计算向量或四元数的范数，<font size="4" color="blue"> 甚至将四元数转换为欧拉角。  </font></p>
<p><code>transform &lt;input&gt; &lt;output_topic&gt; &lt;output_type&gt; [&lt;expression&gt;] [--import &lt;module&gt; [&lt;module&gt; ...]]</code></p>
<ul>
<li>input：要订阅的传入topic（或topic field）</li>
<li>output_topic:要发布的输出topic</li>
<li>expression:转换输入消息的Python表达式，在变量m中给出。默认表达式是m，它将输入（可以是topic field）转发到output_topic</li>
<li>import :要在表达式中导入和使用的Python模块的列表。默认导入numpy模块</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 计算IMU给出的方向四元数的范数</span></span><br><span class="line">rosrun topic_tools transform /imu/orientation /norm std_msgs/Float64 <span class="string">&#x27;numpy.linalg.norm([m.x, m.y, m.z, m.w])&#x27;</span></span><br><span class="line"><span class="comment"># 将方向四元数转换为Euler角度</span></span><br><span class="line">rosrun topic_tools transform /imu/orientation /euler geometry_msgs/Vector3 <span class="string">&#x27;tf.transformations.euler_from_quaternion([m.x, m.y, m.z, m.w])&#x27;</span> --import tf</span><br></pre></td></tr></table></figure>
<p><br></p>
<ul>
<li><p>mux: multiplex between multiple topics</p>
</li>
<li><p>relay: republish data on one topic to another.</p>
</li>
<li><p>relay_field: allow to republish data in a different message type</p>
</li>
<li><p>drop: relay a topic, dropping X out of every Y message.</p>
</li>
</ul>
<h2 id="mux"><a href="#mux" class="headerlink" title="mux"></a>mux</h2><p><a target="_blank" rel="noopener" href="http://wiki.ros.org/topic_tools/mux">topic_tools-mux</a><br>可以用于多地图实时切换，参考<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/cbae90b33528">MUX的使用</a></p>
<p>参考:<a target="_blank" rel="noopener" href="http://wiki.ros.org/topic_tools/throttle">throttle Wiki</a></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/06/30/%E7%9B%B8%E6%9C%BA/%E6%A0%87%E5%AE%9AD435i%E7%9A%84%E7%9B%B8%E6%9C%BA(%E4%BA%8C)/">标定D435i(二) 相机</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-06-30</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E7%9B%B8%E6%9C%BA/">相机</a></span><div class="content"><p>Kalibr可以解决以下的标定问题:</p>
<ul>
<li>多相机标定: 一个相机系统的内外参标定，这几个相机没有全局性重叠的视角</li>
<li>视觉惯性标定(camera-IMU): IMU关于相机系统的时空间标定</li>
<li>Rolling Shutter Camera calibration: full intrinsic calibration (projection, distortion and shutter parameters) of rolling shutter cameras</li>
</ul>
<p>可以下载Kalibr源码编译生成可执行文件，也可以下载其CDE精简版包。这中间有个坑就是CDE精简包是没有办法标定彩色图片的，而D435输出的是彩色图。所以还是按编译源码的方式</p>
<p>使用Kalibr标定相机的内参和多个相机相对位置关系即外参</p>
<h2 id="安装Kalibr"><a href="#安装Kalibr" class="headerlink" title="安装Kalibr"></a>安装Kalibr</h2><ol>
<li><p>安装依赖项</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install python-pyx python-setuptools python-rosinstall ipython libeigen3-dev libboost-all-dev doxygen ros-kinetic-vision-opencv ros-kinetic-image-transport-plugins ros-kinetic-cmake-modules python-software-properties software-properties-common libpoco-dev python-matplotlib python-scipy python-git python-pip ipython libtbb-dev libblas-dev liblapack-dev python-catkin-tools libv4l-dev</span><br></pre></td></tr></table></figure>
</li>
<li><p>源码放入工作空间进行编译，会花很长时间，所以编译命令要这样:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 视情况取j8</span></span><br><span class="line">catkin_make -DCMAKE_BUILD_TYPE=Release -j4</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>编译kalibr可能会出现<font color=orange size=4> fatal error: numpy/arrayobject.h: No such file or directory </font>，解决方法： <code>sudo apt-get install --reinstall python-numpy</code></p>
<p>可能出现catkin_make时，下载suitesparse过久甚至失败的问题。解决方法： 修改<code>～/catkin_ws/src/kalibr/suitesparse</code>中的CMakeLists.txt为<a target="_blank" rel="noopener" href="https://raw.githubusercontent.com/charon-cheung/xiaoqiang_robot/master/Calibration/Kalibr_CMakeLists.md">新CMakeLists.txt</a>, 然后重新catkin_make</p>
<h2 id="标定板"><a href="#标定板" class="headerlink" title="标定板"></a>标定板</h2><p><a target="_blank" rel="noopener" href="https://github.com/ethz-asl/kalibr/wiki/downloads">下载标定板</a></p>
<p>我下载的是<code>Aprilgrid 6x6 0.5x0.5m</code>(unscaled)， 打印在A3纸上</p>
<p>原版的参数是:6X6 tags，6乘6个格子，一个大格子size=5.5cm，一个小格子spacing=1.65cm</p>
<p>A3纸上的缩放:6X6 tags，一个大格子size=3.5cm，一个小格子spacing=1cm。记得打印出来用尺子量一下，以免出现差错。<br><img src="https://i.loli.net/2020/06/30/U68mzoAjeQEPvug.png" alt="标定板参数示意图"></p>
<p>下载官网提供的yaml格式文件，需要按照设定的尺寸进行修改<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">target_type: <span class="string">&#x27;aprilgrid&#x27;</span> <span class="comment">#gridtype</span></span><br><span class="line">tagCols: 6               <span class="comment">#number of apriltags</span></span><br><span class="line">tagRows: 6               <span class="comment">#number of apriltags</span></span><br><span class="line">tagSize: 0.035           <span class="comment">#size of apriltag, edge to edge [m]</span></span><br><span class="line">tagSpacing: 0.3          <span class="comment">#ratio of space between tags to tagSize</span></span><br></pre></td></tr></table></figure></p>
<p>找一个适合的能拍到棋盘格的距离,启动相机: <code>roslaunch realsense2_camera rs_camera.launch</code></p>
<p>d453i是有红外发射器的，可以发射很多红外小斑点，如果打开你会在rviz看到很多光斑，可能不利于标定，所以标定时关闭这个发射器的。</p>
<h2 id="降低图像话题的频率，录制图像数据包"><a href="#降低图像话题的频率，录制图像数据包" class="headerlink" title="降低图像话题的频率，录制图像数据包"></a>降低图像话题的频率，录制图像数据包</h2><p>kalibr在处理标定数据的时候要求图像的频率不可过高，一般为4hz(后面计算过程报错，改为20)。使用如下指令来限制图像频率:<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rosrun topic_tools throttle messages /camera/color/image_raw 4 /color</span><br><span class="line">rosrun topic_tools throttle messages /camera/infra2/image_rect_raw 4 /infra_left</span><br><span class="line">rosrun topic_tools throttle messages /camera/infra1/image_rect_raw 4 /infra_right</span><br></pre></td></tr></table></figure><br>用topic_tools throttle限制频率后,一定要查看限制后的topic输出频率：<code>rostopic hz /topic</code>，你会发现实际的频率与设定的频率并不一致，比如：<code>rosrun topic_tools throttle messages /topic_1  25  /topic_2</code>，如果topic_1是40hz，/topic_2可能不是25hz，而是20hz，而且每次的实际频率可能不同，具体原因不明。</p>
<p>注意这里是采用了新的话题<code>/color</code>去发布,所以下面录制要写<code>/color</code>话题</p>
<p>将标定目标AprilGrid置于相机前方合理距离范围内，准备录制两分钟:<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rosbag record -O multicameras_calibration /infra_left /infra_right /color</span><br></pre></td></tr></table></figure><br>开始缓慢移动标定板，让所有摄像头看到标定板不要太远，不然无法检测到标定目标的特征，这个过程中看不到图案的识别结果，这是kalibr的原因。在标定算法中需要检测是否有足够数量图片检测到标定特征，否则直接无法标定。移动标定物时候不要过快导致运动模糊，我们只需要获取不同位置和角度的图像，确保图像清晰和特征完整即可。另外要尽可能多角度和多位置（上下左右等）甚至到摄像头捕捉图像的边缘，这样移动目标1min左右即可。</p>
<p>移动的方式可以参考<a target="_blank" rel="noopener" href="https://vision.in.tum.de/data/datasets/visual-inertial-dataset">TUM CALIBRATION SEQUENCES的标定方式</a>，点play即可播放</p>
<h2 id="kalibr算法计算各个摄像头的内参和外参"><a href="#kalibr算法计算各个摄像头的内参和外参" class="headerlink" title="kalibr算法计算各个摄像头的内参和外参"></a>kalibr算法计算各个摄像头的内参和外参</h2><p><code>april_6x6_A3.yaml</code>: 标定物的参数，具体是标定目标的尺寸之类，因为我是缩小打印在A3上，所以要对参数进行修改；pinhole-equi – 选择的相机模型，kalibr提供了很多相机模型，可以自己选择; —bag-from-to 可以选择时间段，毕竟录制的时候不能保证整体都录制的很好。<strong>标定会花很长时间，最后会输出一个pdf和txt文件，有内外参数据。</strong></p>
<p>只标定主相机:<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kalibr_calibrate_cameras --target ../yaml/april_6x6_A4.yaml --bag ./bag/0_multicameras_calibration.bag --model pinhole-equi  --topic  /color  --show-extraction --approx-sync 0.04</span><br></pre></td></tr></table></figure></p>
<p>最后还是标定的多相机：<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kalibr_calibrate_cameras --target april_6x6_A3.yaml --bag multicameras_calibration.bag --models pinhole-equi pinhole-equi pinhole-equi --topics /infra_left /infra_right /color  --show-extraction --approx-sync 0.04 --bag-from-to 10 100</span><br></pre></td></tr></table></figure></p>
<ul>
<li><code>pinhole-radtan</code>指的是针孔相机模型和畸变模型，每个相机都要指定。还有<code>Pinhole + FOV</code>等等</li>
<li><code>--bag-from-to 10 100</code>指的是录制的第26秒到100秒这段时间</li>
<li><code>--show-extraction</code>, 在标定过程中可视化角点检测情况是否良好</li>
<li><code>--approx-sync 0.04</code></li>
</ul>
<p>结果报错： <font color = orange size=4> ImportError: No module named igraph </font><br>解决方法： <code>sudo apt-get install python2.7-igraph</code></p>
<p>需要在有界面的情况下标定，因为会弹出几个窗口，所以不能通过SSH进行，类似这样：<br><img src="https://i.loli.net/2020/07/01/FnbTkojVMxBCSlP.png" alt=""></p>
<p>可以使用calibration validator进行标定的验证，原理是对重投影误差进行量化分析，同样需要有界面：<br><code>kalibr_camera_validator --cam camchain-multicameras_calibration.yaml --target april_6x6_A3.yaml</code><br><img src="https://i.loli.net/2020/07/02/yZHWnB25hlm4cCO.png" alt="验证结果.png"></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/06/29/%E7%9B%B8%E6%9C%BA/%E6%A0%87%E5%AE%9AD435i%E7%9A%84IMU(%E4%B8%80)/">标定D435i(一) IMU</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-06-29</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E7%9B%B8%E6%9C%BA/">相机</a></span><div class="content"><p>realsense d435i包含两个红外相机、红外发射器、RGB相机和IMU四个模块，显然四个传感器的空间位置是不同的，我们在处理图像和IMU数据时需要将这些数据都放在统一的坐标系上去。比如我们用d435i运行vins，处理的图像和IMU数据都需要放在同一个坐标系下，因此需要标定IMU相对RGB相机的空间位置（包括旋转和位移）。</p>
<p>另外，相机固有参数比如焦距、畸变参数等以及IMU的零偏和scale系数等都需要提前知道。前者称为外参，后者称为内参，在运行程序前我们需要标定它们，不论程序是否有自标定功能，毕竟好的初始标定值对于自标定来说也是有利的。</p>
<p>标定顺序：<strong>IMU标定 —&gt; 相机标定 —&gt; IMU+相机联合标定</strong>. 这么设定顺序是因为最后一步的IMU和相机的联合标定需要 IMU和相机的内参</p>
<h2 id="Allan方差"><a href="#Allan方差" class="headerlink" title="Allan方差"></a>Allan方差</h2><p>在IMU采集数据时，会产生两种误差：确定性误差和随机性误差，为获得精确的数据，需要对上述两种误差进行标定,加速度计和陀螺仪随机误差的标定通常使用Allan方差法，它是20世纪60年代由美国国家标准局的David Allan提出的基于时域的分析方法。</p>
<p>A ROS package tool to analyze the IMU performance. C++ version of Allan Variance Tool. The figures are drawn by Matlab, in scripts.</p>
<p>Actually, just analyze the Allan Variance for the IMU data. Collect the data while the IMU is Stationary, with a two hours duration.<br>code_utils标定IMU的噪音密度和随机游走系数。</p>
<h2 id="安装库和依赖项"><a href="#安装库和依赖项" class="headerlink" title="安装库和依赖项"></a>安装库和依赖项</h2><p>安装依赖项，不装之后的编译会报错： <code>sudo apt-get -y install libdw-dev</code>，结果可能提示<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">The following packages have unmet dependencies:</span><br><span class="line"> libdw-dev : Depends: libelf-dev but it is not going to be installed</span><br><span class="line">             Depends: libdw1 (= 0.165-3ubuntu1) but it is not going to be installed</span><br><span class="line">E: Unable to correct problems, you have held broken packages.</span><br></pre></td></tr></table></figure><br>这是因为一个依赖项已经安装了不同版本：<code>Depends: libelf1 (= 0.165-3ubuntu1) but 0.165-3ubuntu1.2 is to be installed</code>。 解决方法: <code>sudo aptitude install libdw-dev</code>，对给出的方案，选择第二个，降级 libelf1[0.165-3ubuntu1.1 (now) -&gt; 0.158-0ubuntu]</p>
<h2 id="编译code-utils和imu-utils"><a href="#编译code-utils和imu-utils" class="headerlink" title="编译code_utils和imu_utils"></a>编译code_utils和imu_utils</h2><p>全局安装ceres库，因为<code>code_imu</code>依赖ceres。不要同时把imu_utils和code_utils一起放到src下进行编译。因为imu_utils 依赖 code_utils，原作者的CMakeLists写的不好，所以先编译code_utils再编译后者。 </p>
<p>在<code>code_utils</code>下面找到<code>sumpixel_test.cpp</code>，修改<code>#include &quot;backward.hpp&quot;</code>为<code>#include&quot;code_utils/backward.hpp&quot;</code>，再依次编译两个包</p>
<h2 id="发布D435i的IMU数据"><a href="#发布D435i的IMU数据" class="headerlink" title="发布D435i的IMU数据"></a>发布D435i的IMU数据</h2><p>可以直接在rs_camera.launch基础上针对IMU校准做修改。目的是将acc、gyro数据对齐使用同一个topic发布。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 更改前原版本arg name=&quot;unite_imu_method&quot;          default=&quot;&quot;/--&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">arg</span> <span class="attr">name</span>=<span class="string">&quot;unite_imu_method&quot;</span>          <span class="attr">default</span>=<span class="string">&quot;linear_interpolation&quot;</span>/&gt;</span></span><br><span class="line"><span class="comment">&lt;!--或着将参数改为copy--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">arg</span> <span class="attr">name</span>=<span class="string">&quot;unite_imu_method&quot;</span>          <span class="attr">default</span>=<span class="string">&quot;copy&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure><br>启动: <code>roslaunch realsense2_camera rs_imu_calibration.launch</code>，然后录制imu数据包<code>rosbag record -O imu_calibration /camera/imu</code>，让IMU静止不动两个小时，录制IMU的bag.</p>
<h2 id="标定"><a href="#标定" class="headerlink" title="标定"></a>标定</h2><p>根据<code>imu_utils</code>文件夹里面的<code>A3.launch</code>改写D435i标定启动文件：<code>d435i_imu_calib.launch</code>注意，记得修改max_time_min对应的参数，默认是120，也就是两个小时，如果ros包里的imu数据长度没有两个小时，等bag播放完了，还是停留在<code>wait for imu data</code>这里，不会生成标定文件。我录了1小时59分多一点，所以还得改成119</p>
<p><code>d435i_imu_calibration.launch</code>如下:<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">launch</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">node</span> <span class="attr">pkg</span>=<span class="string">&quot;imu_utils&quot;</span> <span class="attr">type</span>=<span class="string">&quot;imu_an&quot;</span> <span class="attr">name</span>=<span class="string">&quot;imu_an&quot;</span> <span class="attr">output</span>=<span class="string">&quot;screen&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--TOPIC名称和上面一致--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">&quot;imu_topic&quot;</span> <span class="attr">type</span>=<span class="string">&quot;string&quot;</span> <span class="attr">value</span>= <span class="string">&quot;/camera/imu&quot;</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--imu_name 无所谓--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">&quot;imu_name&quot;</span> <span class="attr">type</span>=<span class="string">&quot;string&quot;</span> <span class="attr">value</span>= <span class="string">&quot;D435i&quot;</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--标定结果存放路径--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">&quot;data_save_path&quot;</span> <span class="attr">type</span>=<span class="string">&quot;string&quot;</span> <span class="attr">value</span>= <span class="string">&quot;$(find imu_utils)/data/&quot;</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--数据录制时间-min--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">&quot;max_time_min&quot;</span> <span class="attr">type</span>=<span class="string">&quot;int&quot;</span> <span class="attr">value</span>= <span class="string">&quot;120&quot;</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--采样频率，即是IMU频率，采样频率可以使用rostopic hz /camera/imu查看，设置为200，也就是rosbag play播放频率--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">&quot;max_cluster&quot;</span> <span class="attr">type</span>=<span class="string">&quot;int&quot;</span> <span class="attr">value</span>= <span class="string">&quot;200&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">node</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">launch</span>&gt;</span></span><br></pre></td></tr></table></figure><br>先启动标定程序: <code>roslaunch imu_utils d435i_imu_calib.launch</code>，再播放bag: <code>rosbag play -r 200 imu_calibration.bag</code></p>
<h2 id="标定结果"><a href="#标定结果" class="headerlink" title="标定结果"></a>标定结果</h2><p>标定结果是<code>D435i_imu_param.yaml</code>:<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">%YAML:1.0</span><br><span class="line">---</span><br><span class="line"><span class="built_in">type</span>: IMU</span><br><span class="line">name: D435i</span><br><span class="line">Gyr:</span><br><span class="line">   unit: <span class="string">&quot; rad/s&quot;</span></span><br><span class="line">   avg-axis:</span><br><span class="line">      gyr_n: 3.6673681012835031e-03</span><br><span class="line">      gyr_w: 7.0017785520472972e-05</span><br><span class="line">   x-axis:</span><br><span class="line">      gyr_n: 3.6001489799186333e-03</span><br><span class="line">      gyr_w: 6.2846247607788020e-05</span><br><span class="line">   y-axis:</span><br><span class="line">      gyr_n: 4.7157261366663813e-03</span><br><span class="line">      gyr_w: 7.5207268006344615e-05</span><br><span class="line">   z-axis:</span><br><span class="line">      gyr_n: 2.6862291872654953e-03</span><br><span class="line">      gyr_w: 7.1999840947286307e-05</span><br><span class="line">Acc:</span><br><span class="line">   unit: <span class="string">&quot; m/s^2&quot;</span></span><br><span class="line">   avg-axis:</span><br><span class="line">      acc_n: 2.7436489578044256e-02</span><br><span class="line">      acc_w: 1.0915021608117670e-03</span><br><span class="line">   x-axis:</span><br><span class="line">      acc_n: 1.8271976632141730e-02</span><br><span class="line">      acc_w: 5.5394830052109354e-04</span><br><span class="line">   y-axis:</span><br><span class="line">      acc_n: 2.8924134998445018e-02</span><br><span class="line">      acc_w: 1.5674764920646303e-03</span><br><span class="line">   z-axis:</span><br><span class="line">      acc_n: 3.5113357103546017e-02</span><br><span class="line">      acc_w: 1.1530816898495772e-03</span><br></pre></td></tr></table></figure><br>我们一会只用到<strong>Gyr</strong>中的<code>avg-axis</code>的<code>gyr_n</code>和<code>gyr_w</code>, <strong>Acc</strong>中的<code>avg-axis</code>的<code>acc_n</code>和<code>acc_w</code><br><br></p>
<p>终端输出结果:<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line">gyr x  numData 781205</span><br><span class="line">gyr x  start_t 1.59343e+09</span><br><span class="line">gyr x  end_t 1.59344e+09</span><br><span class="line">gyr x dt </span><br><span class="line">-------------7140.59 s</span><br><span class="line">-------------119.01 min</span><br><span class="line">-------------1.9835 h</span><br><span class="line">gyr x  freq 109.403</span><br><span class="line">gyr x  period 0.00914049</span><br><span class="line">gyr y  numData 781205</span><br><span class="line">gyr y  start_t 1.59343e+09</span><br><span class="line">gyr y  end_t 1.59344e+09</span><br><span class="line">gyr y dt </span><br><span class="line">-------------7140.59 s</span><br><span class="line">-------------119.01 min</span><br><span class="line">-------------1.9835 h</span><br><span class="line">gyr y  freq 109.403</span><br><span class="line">gyr y  period 0.00914049</span><br><span class="line">gyr z  numData 781205</span><br><span class="line">gyr z  start_t 1.59343e+09</span><br><span class="line">gyr z  end_t 1.59344e+09</span><br><span class="line">gyr z dt </span><br><span class="line">-------------7140.59 s</span><br><span class="line">-------------119.01 min</span><br><span class="line">-------------1.9835 h</span><br><span class="line">gyr z  freq 109.403</span><br><span class="line">gyr z  period 0.00914049</span><br><span class="line">Gyro X </span><br><span class="line">C   -6.83161    94.2973   -19.0588      2.983 -0.0404918</span><br><span class="line"> Bias Instability 2.37767e-05 rad/s</span><br><span class="line"> Bias Instability 6.28462e-05 rad/s, at 63.1334 s</span><br><span class="line"> White Noise 12.9453 rad/s</span><br><span class="line"> White Noise 0.00360015 rad/s</span><br><span class="line">  bias -0.363298 degree/s</span><br><span class="line">-------------------</span><br><span class="line">Gyro y </span><br><span class="line">C   -8.74367    117.584   -15.9277    2.47408 -0.0373467</span><br><span class="line"> Bias Instability 6.41864e-05 rad/s</span><br><span class="line"> Bias Instability 7.52073e-05 rad/s, at 104.256 s</span><br><span class="line"> White Noise 16.8998 rad/s</span><br><span class="line"> White Noise 0.00471573 rad/s</span><br><span class="line">  bias -0.544767 degree/s</span><br><span class="line">-------------------</span><br><span class="line">Gyro z </span><br><span class="line">C   -4.51808    68.1919   -9.33284    1.95333 -0.0262641</span><br><span class="line"> Bias Instability 8.50869e-05 rad/s</span><br><span class="line"> Bias Instability 7.19998e-05 rad/s, at 63.1334 s</span><br><span class="line"> White Noise 9.43212 rad/s</span><br><span class="line"> White Noise 0.00268623 rad/s</span><br><span class="line">  bias -0.0762471 degree/s</span><br><span class="line">-------------------</span><br><span class="line">==============================================</span><br><span class="line">==============================================</span><br><span class="line">acc x  numData 781205</span><br><span class="line">acc x  start_t 1.59343e+09</span><br><span class="line">acc x  end_t 1.59344e+09</span><br><span class="line">acc x dt </span><br><span class="line">-------------7140.59 s</span><br><span class="line">-------------119.01 min</span><br><span class="line">-------------1.9835 h</span><br><span class="line">acc x  freq 109.403</span><br><span class="line">acc x  period 0.00914049</span><br><span class="line">acc y  numData 781205</span><br><span class="line">acc y  start_t 1.59343e+09</span><br><span class="line">acc y  end_t 1.59344e+09</span><br><span class="line">acc y dt </span><br><span class="line">-------------7140.59 s</span><br><span class="line">-------------119.01 min</span><br><span class="line">-------------1.9835 h</span><br><span class="line">acc y  freq 109.403</span><br><span class="line">acc y  period 0.00914049</span><br><span class="line">acc z  numData 781205</span><br><span class="line">acc z  start_t 1.59343e+09</span><br><span class="line">acc z  end_t 1.59344e+09</span><br><span class="line">acc z dt </span><br><span class="line">-------------7140.59 s</span><br><span class="line">-------------119.01 min</span><br><span class="line">-------------1.9835 h</span><br><span class="line">acc z  freq 109.403</span><br><span class="line">acc z  period 0.00914049</span><br><span class="line">acc X </span><br><span class="line">C  3.36177e-05   0.00175435 -0.000159698  7.23303e-05 -7.16006e-07</span><br><span class="line"> Bias Instability 0.000553948 m/s^2</span><br><span class="line"> White Noise 0.018272 m/s^2</span><br><span class="line">-------------------</span><br><span class="line">acc y </span><br><span class="line">C  9.36955e-05   0.00234733   0.00012197  0.000243676 -2.66252e-06</span><br><span class="line"> Bias Instability 0.00156748 m/s^2</span><br><span class="line"> White Noise 0.0289241 m/s^2</span><br><span class="line">-------------------</span><br><span class="line">acc z </span><br><span class="line">C  5.07832e-05   0.00331104 -0.000381222  0.000199602 -2.43776e-06</span><br><span class="line"> Bias Instability 0.00115308 m/s^2</span><br><span class="line"> White Noise 0.0351134 m/s^2</span><br></pre></td></tr></table></figure><br>经过这些标定会生成一个yaml文件和很多txt文件，主要是yaml文件，给出了加速度计和陀螺仪三轴的<code>noise_density</code>和<code>random_walk</code>，同时计算出了平均值，后面IMU+摄像头联合标定的时候需要这些均值。</p>
<h3 id="标定外参的准备"><a href="#标定外参的准备" class="headerlink" title="标定外参的准备"></a>标定外参的准备</h3><p>将Acc和Gyr的第一组平均数据拷贝到kalibr对应的<code>imu.yaml</code>文件中<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">rostopic: /camera/imu</span><br><span class="line">update_rate: 200.0  <span class="comment">#Hz</span></span><br><span class="line"> </span><br><span class="line">accelerometer_noise_density: 2.89e-01 <span class="comment">#continous</span></span><br><span class="line">accelerometer_random_walk: 4.55e-04 </span><br><span class="line">gyroscope_noise_density: 3.02e-03 <span class="comment">#continous</span></span><br><span class="line">gyroscope_random_walk: 2.29e-05</span><br></pre></td></tr></table></figure><br>分别是加速度计和陀螺仪的高斯白噪声和随机游走的平均值，是IMU噪声模型中的两种噪声。</p>
<h2 id="查看默认imu与相机参数"><a href="#查看默认imu与相机参数" class="headerlink" title="　查看默认imu与相机参数"></a>　查看默认imu与相机参数</h2><p>D435i相关的imu_info话题如下:<br><img src="https://i.loli.net/2020/06/30/nQftEcampMWxThw.png" alt="imu_info列表"></p>
<p><img src="https://i.loli.net/2020/06/30/vUu4FljdA5tJRwQ.png" alt="/camera/gyro/imu_info和/camera/accel/imu_info没有结果"></p>
<p><code>realsense_camera/IMUInfo</code> with the header.frame_id set to either <code>imu_accel</code> or <code>imu_gyro</code> to distinguish between <code>accel</code> and <code>gyro</code> info. 消息成员如下:<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">string frame_id</span><br><span class="line">float64[12] data</span><br><span class="line">float64[3] noise_variances</span><br><span class="line">float64[3] bias_variances</span><br></pre></td></tr></table></figure></p>
<p><code>rostopic echo -n1 /camera/color/camera_info</code>得到结果:<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">  frame_id: <span class="string">&quot;camera_color_optical_frame&quot;</span></span><br><span class="line">height: 480</span><br><span class="line">width: 640</span><br><span class="line">distortion_model: <span class="string">&quot;plumb_bob&quot;</span></span><br><span class="line">D: [0.0, 0.0, 0.0, 0.0, 0.0]</span><br><span class="line">K: [611.3538208007812, 0.0, 327.437744140625, 0.0, 610.015869140625, 239.99667358398438, 0.0, 0.0, 1.0]</span><br><span class="line">R: [1.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 1.0]</span><br><span class="line">P: [611.3538208007812, 0.0, 327.437744140625, 0.0, 0.0, 610.015869140625, 239.99667358398438, 0.0, 0.0, 0.0, 1.0, 0.0]</span><br><span class="line">binning_x: 0</span><br><span class="line">binning_y: 0</span><br><span class="line">roi: </span><br><span class="line">  x_offset: 0</span><br><span class="line">  y_offset: 0</span><br><span class="line">  height: 0</span><br><span class="line">  width: 0</span><br><span class="line">  do_rectify: False</span><br></pre></td></tr></table></figure></p>
<p>对于<code>/camera/depth/imu_info</code>，结果是:<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">frame_id: <span class="string">&quot;camera_depth_optical_frame&quot;</span></span><br><span class="line">height: 480</span><br><span class="line">width: 640</span><br><span class="line">distortion_model: <span class="string">&quot;plumb_bob&quot;</span></span><br><span class="line">D: [0.0, 0.0, 0.0, 0.0, 0.0]</span><br><span class="line">K: [380.23321533203125, 0.0, 316.4999084472656, 0.0, 380.23321533203125, 237.40985107421875, 0.0, 0.0, 1.0]</span><br><span class="line">R: [1.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 1.0]</span><br><span class="line">P: [380.23321533203125, 0.0, 316.4999084472656, 0.0, 0.0, 380.23321533203125, 237.40985107421875, 0.0, 0.0, 0.0, 1.0, 0.0]</span><br><span class="line">binning_x: 0</span><br><span class="line">binning_y: 0</span><br><span class="line">roi: </span><br><span class="line">  x_offset: 0</span><br><span class="line">  y_offset: 0</span><br><span class="line">  height: 0</span><br><span class="line">  width: 0</span><br><span class="line">  do_rectify: False</span><br></pre></td></tr></table></figure></p>
<p>话题<code>/camera/infra2/camera_info</code>和<code>/camera/infra2/camera_info</code>的结果完全一样:<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">frame_id: <span class="string">&quot;camera_infra1_optical_frame&quot;</span></span><br><span class="line">height: 480</span><br><span class="line">width: 640</span><br><span class="line">distortion_model: <span class="string">&quot;plumb_bob&quot;</span></span><br><span class="line">D: [0.0, 0.0, 0.0, 0.0, 0.0]</span><br><span class="line">K: [380.23321533203125, 0.0, 316.4999084472656, 0.0, 380.23321533203125, 237.40985107421875, 0.0, 0.0, 1.0]</span><br><span class="line">R: [1.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 1.0]</span><br><span class="line">P: [380.23321533203125, 0.0, 316.4999084472656, 0.0, 0.0, 380.23321533203125, 237.40985107421875, 0.0, 0.0, 0.0, 1.0, 0.0]</span><br><span class="line">binning_x: 0</span><br><span class="line">binning_y: 0</span><br><span class="line">roi: </span><br><span class="line">  x_offset: 0</span><br><span class="line">  y_offset: 0</span><br><span class="line">  height: 0</span><br><span class="line">  width: 0</span><br><span class="line">  do_rectify: False</span><br></pre></td></tr></table></figure><br>可以看出，实际上出厂没有标定IMU</p>
<h2 id="绘制Allan曲线"><a href="#绘制Allan曲线" class="headerlink" title="绘制Allan曲线"></a>绘制Allan曲线</h2><p><code>imu_utils/scripts</code>中是Matlab写的.m文件，按照<code>draw_allan.m</code>创建文件<code>draw_allan_acc.m</code>和<code>draw_allan_gyr.m</code></p>
<p>由于Ubuntu下安装Matlab比较麻烦，因此将数据和.m文件都拷贝到Windows系统下绘制，注意文件路径和m文件中要对应，<strong>尤其matlab中的当前路径指的是左侧栏的路径，而不是m文件所在的路径</strong></p>
<p><img src="https://i.loli.net/2020/06/30/4z9OaMhDF8gnsBH.jpg" alt="allan_gyr.jpg"><br><img src="https://i.loli.net/2020/06/30/CDxL3nBrWPtYu21.jpg" alt="allan_acc.jpg"></p>
<p>参考:<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/fb_941219/article/details/104709049">RealSense D435i Calibration</a><br><a target="_blank" rel="noopener" href="https://github.com/gaowenliang/imu_utils">官方Github</a><br><a target="_blank" rel="noopener" href="https://www.geek-share.com/detail/2798533390.html">VIO标定IMU随机误差——Allan方差法</a></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/06/29/%E7%9B%B8%E6%9C%BA/%E6%A0%87%E5%AE%9AD435i%E7%9A%84%E5%A4%96%E5%8F%82%E6%95%B0(%E4%B8%89)/">标定D435i(三) 外参数</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-06-29</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E7%9B%B8%E6%9C%BA/">相机</a></span><div class="content"><ul>
<li>标定板pattern尽量选择apriltag，尽量不要用纸质的</li>
<li>选择合适的相机模型</li>
<li>标定手法看看TUM的</li>
</ul>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/06/28/%E7%9B%B8%E6%9C%BA/realsense%20D435i%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE/">realsense D435i安装配置</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-06-28</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E7%9B%B8%E6%9C%BA/">相机</a></span><div class="content"><p><img src="https://s2.loli.net/2022/06/19/kFT4eULdGvqsDNO.png" alt=""><br>realsense D435i终于到手了，打开发现其实很小巧，先做一些配置看看。默认要使用USB3，如果RealSense使用USB2, Output Resolution自动降到<code>480*270 30fbs</code>，而非产品所宣称的1280 x 720 active stereo depth resolution和90fps，且只有Stereo Moudle在工作，无Image Sensor的RGB Moudle菜单项，无法进行3D建模。</p>
<p>D435i采用了即用型USB供电形式，不仅提供深度传感器模组，还配备了一个IMU单元（惯性测量单元，采用的博世BMI055）。凭借内置的IMU单元，结合视觉数据可实现6DoF追踪功能。其中，IMU将各种线性加速度计和陀螺仪数据结合，可检测X，Y，Z三轴的旋转和平移，以及俯仰、横摇等动作。D435i的2000万像素RGB摄像头和3D传感器可以30帧/秒的速度提供分辨率高达1280 × 720，或者以90帧/秒的速度提供848 × 480的较低分辨率。该摄像头具有全局快门，可以处理快速移动物体，室内室外皆可操作。深度距离在<code>0.1 m~10 m</code>之间，视场角度为85 × 58度</p>
<p>可以获得RGB图、左右红外摄像图、深度图、IMU数据，并且将深度图数据和RGB图进行对齐。左右红外相机进行测量深度，中间红外点阵投射器相当于补光灯，不打开也能测深度，只是效果不好；最右边的rgb相机用于采集彩色图片，最终可以将彩色视频流与深度流进行对齐.</p>
<p>两个驱动讲究搭配，否则安装编译都不报错，运行时会报错 <font size="4" color="red"> realsense  hwmon command 0x7d failed  </font> 我使用的是<code>realsense-ros-2.2.23</code>和<code>librealsense-2.43.0</code></p>
<h2 id="安装librealsense"><a href="#安装librealsense" class="headerlink" title="安装librealsense"></a>安装librealsense</h2><p>先装realsense的驱动，步骤参考网上的，其实不必完全相同，我的步骤如下：</p>
<ol>
<li>下载<a target="_blank" rel="noopener" href="https://github.com/IntelRealSense/librealsense">驱动</a>，然后解压到根目录</li>
<li>执行如下命令：<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> ~/librealsense</span><br><span class="line">sudo apt-get install libssl-dev libusb-1.0-0-dev pkg-config libgtk-3-dev libglfw3-dev</span><br><span class="line"><span class="comment"># 许可脚本</span></span><br><span class="line">sudo cp config/99-realsense-libusb.rules /etc/udev/rules.d/</span><br><span class="line">sudo udevadm control --reload-rules &amp;&amp; udevadm trigger</span><br></pre></td></tr></table></figure></li>
<li>开始编译<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> ~/librealsense</span><br><span class="line">mkdir build &amp;&amp; <span class="built_in">cd</span> build</span><br><span class="line">cmake ../ -DBUILD_EXAMPLES=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line">sudo make uninstall &amp;&amp; make clean &amp;&amp; make  -j7 &amp;&amp; sudo make install</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>运行<code>realsense-viewer</code>验证，看到如下画面<br><img src="https://i.loli.net/2020/06/28/TIEr7MGmfpWXisD.png" alt="RGB Depth Infrared"><br>配置可以修改为常见的黑白深度图以及分辨率等等<br><img src="https://i.loli.net/2020/06/28/3uPdGyh7TlFnS5w.png" alt="配置栏"></p>
<h2 id="ROS驱动"><a href="#ROS驱动" class="headerlink" title="ROS驱动"></a>ROS驱动</h2><p>从<a target="_blank" rel="noopener" href="https://github.com/IntelRealSense/realsense-ros">这里</a>下载，然后放到某工作空间，编译即可：<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">catkin_make -DCATKIN_ENABLE_TESTING=False -DCMAKE_BUILD_TYPE=Release</span><br><span class="line">catkin_make install</span><br></pre></td></tr></table></figure><br>现在运行<code>roslaunch realsense2_camera rs_camera.launch</code>，打开rqt就能看到realsense的三种图像<br>实际运行了<code>/camera/realsense2_camera</code>和<code>camera/realsense2_camera_manager</code>两个节点，涉及的话题有很多，以后慢慢分析。</p>
<p>tf关系如图：<br><img src="https://i.loli.net/2020/07/01/5DTI18Hnzdr7qJy.png" alt="frames.png"><br><br></p>
<p>在rqt中打开深度图时出现了报错，又是图像编码问题<br><img src="https://i.loli.net/2020/06/28/PV9LDck5atvEzMZ.png" alt="launch文件中报错.png"><br><img src="https://i.loli.net/2020/06/28/PYMuOQ7R6zDgvel.png" alt="rqt终端报错.png"><br>在rqt里查看<code>/camera/depth/image_rect_raw/theora</code>，同样没有深度图，但rqt不报警</p>
<p>在rqt查看RGB和红外的图像，只要选择theora，rqt终端都会报警:<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[ WARN][/rqt_gui_cpp_node_25764] [TheoraSubscriber::internalCallback] line_170  [theora] Packet was not a Theora header</span><br></pre></td></tr></table></figure><br><br></p>
<p>使用对齐的深度话题信息发布RGBD点云<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">roslaunch realsense2_camera rs_rgbd.launch</span><br></pre></td></tr></table></figure><br>这一步还没有成功,在rviz里没看到结果</p>
<h2 id="内参"><a href="#内参" class="headerlink" title="内参"></a>内参</h2><p><code>realsense</code>启动时可以发现信息 <code>[color stream is enabled - width: 640, height: 480, fps: 15, Format: RGB8]</code></p>
<p>realsense相机出厂的时候一般都标定好了，直接读取他们的内参即可。终端输入： <code>rs-sensor-control</code>，根据提示选择，出现所有视频流的列表时，根据上面的信息选择，最终显示内参:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Principal Point         : <span class="number">327.438</span>, <span class="number">239.997</span></span><br><span class="line">Focal Length            : <span class="number">611.354</span>, <span class="number">610.016</span></span><br><span class="line">Distortion Model        : Inverse Brown Conrady</span><br><span class="line">Distortion Coefficients : [<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>]</span><br></pre></td></tr></table></figure></p>
<p>参考：<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/sinat_23853639/article/details/88044019">realsense D435 驱动安装并嵌入ROS中使用</a></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/06/25/%E6%BF%80%E5%85%89SLAM/gmapping/(%E4%B9%9D)%20%E6%80%BB%E7%BB%93/">(九) 总结</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-06-25</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E6%BF%80%E5%85%89SLAM/">激光SLAM</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E6%BF%80%E5%85%89SLAM/gmapping/">gmapping</a></span><div class="content"><p>gmapping源码中不完善的部分：</p>
<ol>
<li>drawFromMotion函数是一个十分粗糙的运动模型，只是简单的矢量加减运算。相比于《概率机器人》中提到的速度模型和里程计模型，有很多方面都没有考虑，精度上可能有折扣。</li>
<li><code>m_angularOdometryReliability</code>和<code>m_linearOdometryReliability</code>用于控制激光评分的增益<code>odo_gain</code>, 实际都是0，所以没有用到，而且无法用参数赋值, 要使用就得修改源码.</li>
<li>紧接上面的代码，<code>localScore=odo_gain*score(map, localPose, readings);</code>，localScore在之后的<code>likelihoodAndScore</code>函数里实际赋值为0，根本没有用。所以这里有好几行可以删除</li>
<li>在论文中，粒子的权重不是用最优位姿的似然值来表示的，而是用所有的似然值的和来表示的</li>
<li>重采样的粒子索引选取用的是轮盘赌算法，有些论文提出了一些更好的算法</li>
</ol>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/06/19/%E6%BF%80%E5%85%89SLAM/gmapping/OpenMP%E5%8A%A0%E9%80%9Fgmapping/">OpenMP加速gmapping</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-06-19</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E6%BF%80%E5%85%89SLAM/">激光SLAM</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E6%BF%80%E5%85%89SLAM/gmapping/">gmapping</a></span><div class="content"><p>在CMakeLists里做如下配置：<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">FIND_PACKAGE( OpenMP REQUIRED)</span><br><span class="line"><span class="keyword">if</span>(OPENMP_FOUND)</span><br><span class="line">    message(<span class="string">&quot;OPENMP FOUND&quot;</span>)</span><br><span class="line">    <span class="built_in">set</span>(CMAKE_C_FLAGS <span class="string">&quot;<span class="variable">$&#123;CMAKE_C_FLAGS&#125;</span> <span class="variable">$&#123;OpenMP_C_FLAGS&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">set</span>(CMAKE_CXX_FLAGS <span class="string">&quot;<span class="variable">$&#123;CMAKE_CXX_FLAGS&#125;</span> <span class="variable">$&#123;OpenMP_CXX_FLAGS&#125;</span>&quot;</span>)</span><br><span class="line">endif()</span><br></pre></td></tr></table></figure></p>
<p>注意： OpenMP并不适合需要复杂的线程间同步和互斥的场合，这种情况下花的时间可能更长</p>
<p>gmapping使用OpenMP加速的语句: <code>#pragma omp parallel for</code></p>
<ol>
<li><p>for循环的drawFromMotion之前</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//#pragma omp parallel for</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">unsigned</span> <span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m_particles.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line"></span><br><span class="line">    m_particles[i].pose =  m_motionModel.<span class="built_in">drawFromMotion</span>(m_particles[i].pose, relPose,m_odoPose);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>invalidateActiveArea之前</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//#pragma omp parallel for</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">unsigned</span> <span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m_particles.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">    m_matcher.<span class="built_in">invalidateActiveArea</span>();</span><br></pre></td></tr></table></figure>
</li>
<li><p>scanMatch函数开头，实际就是对整个scanMatch并行化</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">scanMatch</span><span class="params">(<span class="keyword">double</span> * plainReading)</span> </span>&#123;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">pragma</span> omp parallel for</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">unsigned</span> <span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m_particles.<span class="built_in">size</span>(); i++) &#123;</span><br></pre></td></tr></table></figure>
</li>
<li><p>updateMap函数中</p>
</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> omp parallel for</span></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> x=<span class="number">0</span>; x &lt; smap.<span class="built_in">getMapSizeX</span>(); x++)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> y=<span class="number">0</span>; y &lt; smap.<span class="built_in">getMapSizeY</span>(); y++)</span><br><span class="line">    &#123;</span><br></pre></td></tr></table></figure>
<ol>
<li>重采样resample函数</li>
</ol>
<p>对于保留下来的粒子进行更新，在并行化操作里面<code>m_particles.push_back()</code>会报错，因此需要把push_back()提出来，在外面的的for循环进行<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> omp parallel for</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i&lt;tmp_size;i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//对保留下来的粒子数据进行更新</span></span><br><span class="line">        <span class="comment">//每个粒子的权重都设置为相同的值</span></span><br><span class="line">        temp[i].<span class="built_in">setWeight</span>(<span class="number">0</span>);</span><br><span class="line">        <span class="comment">//为每个粒子更新running_scans</span></span><br><span class="line">        <span class="comment">//增加了一帧激光数据 因此需要更新地图</span></span><br><span class="line">        m_matcher.<span class="built_in">registerScan</span>(temp[i].map,temp[i].pose,plainReading);</span><br><span class="line">        <span class="comment">//m_matcher.registerScan(temp[i].lowResolutionMap,temp[i].pose,plainReading);</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>为每个粒子更新地图时，同样可以并行化</p>
</div><hr></div><nav id="pagination"><div class="pagination"><a class="extend prev" rel="prev" href="/page/40/">&lt;&lt; Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/40/">40</a><span class="page-number current">41</span><a class="page-number" href="/page/42/">42</a><span class="space">&hellip;</span><a class="page-number" href="/page/65/">65</a><a class="extend next" rel="next" href="/page/42/">Next &gt;&gt;</a></div></nav></div></div><footer class="footer-bg" style="background-image: url(https://s2.loli.net/2022/11/17/QOR8cePIS5NdDrK.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2018 - 2024 By Charon Cheung</div><div class="framework-info"><span>Driven - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_site_uv"><i class="fa fa-user"></i><span id="busuanzi_value_site_uv"></span><span></span></span><span class="footer-separator">|</span><span id="busuanzi_container_site_pv"><i class="fa fa-eye"></i><span id="busuanzi_value_site_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.6.1"></script><script src="/js/fancybox.js?version=1.6.1"></script><script src="/js/sidebar.js?version=1.6.1"></script><script src="/js/copy.js?version=1.6.1"></script><script src="/js/fireworks.js?version=1.6.1"></script><script src="/js/transition.js?version=1.6.1"></script><script src="/js/scroll.js?version=1.6.1"></script><script src="/js/head.js?version=1.6.1"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
    processEscapes: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
  },
  CommonHTML: {
    linebreaks: { automatic: true, width: "90% container" }
  },
  "HTML-CSS": { 
    linebreaks: { automatic: true, width: "90% container" }
  },
  "SVG": { 
    linebreaks: { automatic: true, width: "90% container" }
  }
});
</script><script type="text/x-mathjax-config">MathJax.Hub.Queue(function() {
  var all = MathJax.Hub.getAllJax(), i;
  for (i=0; i < all.length; i += 1) {
    all[i].SourceElement().parentNode.className += ' has-jax';
  }
});
</script><script src="https://cdn.bootcss.com/mathjax/2.7.2/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script>if(/Android|webOS|iPhone|iPod|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
}</script></body></html>