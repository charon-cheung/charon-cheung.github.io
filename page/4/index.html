<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content=""><meta name="keywords" content=""><meta name="author" content="Charon Cheung"><meta name="copyright" content="Charon Cheung"><title>If you wish for peace, prepare for war | 沉默杀手</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.6.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.6.1"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  }
} </script><meta name="generator" content="Hexo 5.4.0"></head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="author-info"><div class="author-info__avatar text-center"><img src="https://s2.loli.net/2022/02/17/HQaCXUBn64zsMIL.png"></div><div class="author-info__name text-center">Charon Cheung</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">654</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">6</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">53</span></a></div></div></div><nav id="nav" style="background-image: url(https://s2.loli.net/2022/11/17/QOR8cePIS5NdDrK.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">沉默杀手</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span></div><div id="site-info"><div id="site-title">沉默杀手</div><div id="site-sub-title">If you wish for peace, prepare for war</div></div></nav><div id="content-outer"><div class="layout" id="content-inner"><div class="recent-post-item article-container"><a class="article-title" href="/2023/07/20/C++/C++%20%20%E6%A8%A1%E6%9D%BF%E4%B8%8ESTL/vector%E5%88%A0%E9%99%A4%E6%8C%87%E5%AE%9A%E7%B4%A2%E5%BC%95%E7%9A%84%E5%85%83%E7%B4%A0/">vector删除指定索引的元素</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2023-07-20</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/C/">C++</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/C/C-%E6%A8%A1%E6%9D%BF%E4%B8%8ESTL/">C++ 模板与STL</a></span><div class="content"><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">std::vector&lt;<span class="keyword">int</span>&gt; v;</span><br><span class="line">v.<span class="built_in">push_back</span>(<span class="number">0</span>);</span><br><span class="line">v.<span class="built_in">push_back</span>(<span class="number">1</span>);</span><br><span class="line">v.<span class="built_in">push_back</span>(<span class="number">2</span>);</span><br><span class="line">v.<span class="built_in">push_back</span>(<span class="number">3</span>);</span><br><span class="line">v.<span class="built_in">push_back</span>(<span class="number">4</span>);</span><br><span class="line">v.<span class="built_in">push_back</span>(<span class="number">5</span>);</span><br><span class="line">v.<span class="built_in">push_back</span>(<span class="number">6</span>);</span><br><span class="line">v.<span class="built_in">push_back</span>(<span class="number">7</span>);</span><br><span class="line">v.<span class="built_in">push_back</span>(<span class="number">8</span>);</span><br><span class="line">v.<span class="built_in">push_back</span>(<span class="number">9</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> j = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">int</span> size = v.<span class="built_in">size</span>();</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">unsigned</span> <span class="keyword">int</span> i=<span class="number">0</span>; i&lt; size; i++)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span>(i%<span class="number">2</span> == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        v.<span class="built_in">erase</span>(v.<span class="built_in">begin</span>() + i - j);</span><br><span class="line">        j++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">cout &lt;&lt; <span class="string">&quot;after remove&quot;</span>&lt;&lt; endl ;</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">unsigned</span> <span class="keyword">int</span> i=<span class="number">0</span>; i &lt; v.<span class="built_in">size</span>(); i++)</span><br><span class="line">    cout &lt;&lt; v[i] &lt;&lt;<span class="string">&quot;   &quot;</span>;</span><br></pre></td></tr></table></figure>
<p>结果是  <code>1   3   5   7   9</code></p>
<p><br></p>
<p>常见iterator自增，如果多增加，可能报错<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">std::vector&lt;<span class="keyword">int</span>&gt; v;</span><br><span class="line">v.<span class="built_in">push_back</span>(<span class="number">0</span>);</span><br><span class="line">v.<span class="built_in">push_back</span>(<span class="number">1</span>);</span><br><span class="line">v.<span class="built_in">push_back</span>(<span class="number">2</span>);</span><br><span class="line">v.<span class="built_in">push_back</span>(<span class="number">3</span>);</span><br><span class="line">v.<span class="built_in">push_back</span>(<span class="number">4</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(vector&lt;<span class="keyword">int</span>&gt;::iterator it=v.<span class="built_in">begin</span>(); it != v.<span class="built_in">end</span>(); it++)</span><br><span class="line">&#123;</span><br><span class="line">    it = it + <span class="number">5</span>;</span><br><span class="line">        cout &lt;&lt; *it &lt;&lt; endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>这样的程序是错的，会越界。 应该改成这样<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(vector&lt;<span class="keyword">int</span>&gt;::iterator it=v.<span class="built_in">begin</span>(); it != v.<span class="built_in">end</span>(); it++)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int</span> step = v.<span class="built_in">end</span>() - it;</span><br><span class="line">    it = it+step/<span class="number">5</span>;</span><br><span class="line">    cout &lt;&lt; *it &lt;&lt; endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2023/07/20/%E8%B7%AF%E5%BE%84%E8%A7%84%E5%88%92/move_base%20%E5%88%86%E6%9E%90/%E4%B8%AD%E6%96%AD%E5%BC%93%E5%AD%97%E8%B7%AF%E5%BE%84%E5%90%8E%E5%86%8D%E8%BF%94%E5%9B%9E%EF%BC%8C%E7%BB%A7%E7%BB%AD%E5%8E%9F%E6%9C%89%E8%B7%AF%E5%BE%84/">弓字 ---&gt; 离开弓字到某点 ---&gt; 回原位置继续弓字</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2023-07-20</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E8%B7%AF%E5%BE%84%E8%A7%84%E5%88%92/">路径规划</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E8%B7%AF%E5%BE%84%E8%A7%84%E5%88%92/%E7%BA%AF%E8%B7%9F%E8%B8%AA%E7%AE%97%E6%B3%95/">纯跟踪算法</a></span><div class="content">abstract Welcome to my blog, enter password to read.</div><a class="more" href="/2023/07/20/%E8%B7%AF%E5%BE%84%E8%A7%84%E5%88%92/move_base%20%E5%88%86%E6%9E%90/%E4%B8%AD%E6%96%AD%E5%BC%93%E5%AD%97%E8%B7%AF%E5%BE%84%E5%90%8E%E5%86%8D%E8%BF%94%E5%9B%9E%EF%BC%8C%E7%BB%A7%E7%BB%AD%E5%8E%9F%E6%9C%89%E8%B7%AF%E5%BE%84/#more">Read more</a><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2023/07/20/%E8%B7%AF%E5%BE%84%E8%A7%84%E5%88%92/move_base%20%E5%88%86%E6%9E%90/%E4%BA%8C%E6%AC%A1%E8%A7%84%E5%88%92%E5%BC%93%E5%AD%97%E5%AF%BC%E8%87%B4move_base%E9%80%80%E5%87%BA/">二次规划弓字导致move_base退出</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2023-07-20</time><div class="content">abstract Welcome to my blog, enter password to read.</div><a class="more" href="/2023/07/20/%E8%B7%AF%E5%BE%84%E8%A7%84%E5%88%92/move_base%20%E5%88%86%E6%9E%90/%E4%BA%8C%E6%AC%A1%E8%A7%84%E5%88%92%E5%BC%93%E5%AD%97%E5%AF%BC%E8%87%B4move_base%E9%80%80%E5%87%BA/#more">Read more</a><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2023/07/06/%E8%B7%AF%E5%BE%84%E8%A7%84%E5%88%92/%E4%BB%A3%E4%BB%B7%E5%9C%B0%E5%9B%BE/%E6%97%A0%E4%BC%A0%E6%84%9F%E5%99%A8%E6%97%B6%E7%9A%84%E4%BB%A3%E4%BB%B7%E5%9C%B0%E5%9B%BE%E5%92%8Cmove_base%E6%8A%A5%E8%AD%A6/">不使用传感器时的代价地图和move_base报警</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2023-07-06</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E8%B7%AF%E5%BE%84%E8%A7%84%E5%88%92/">路径规划</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E8%B7%AF%E5%BE%84%E8%A7%84%E5%88%92/%E4%BB%A3%E4%BB%B7%E5%9C%B0%E5%9B%BE/">代价地图</a></span><div class="content"><p>有一次机器人没有装雷达和相机，打算随便跑跑。于是在通用代价地图的障碍层，不设置传感器数据来源，运行<code>move_base</code>出现频繁报警<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">The /scan observation buffer has not been updated <span class="keyword">for</span> <span class="number">22.06</span> seconds, and it should be updated every <span class="number">5.00</span> seconds.</span><br></pre></td></tr></table></figure><br>来源在<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">ObservationBuffer::isCurrent</span><span class="params">()</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (expected_update_rate_ == ros::<span class="built_in">Duration</span>(<span class="number">0.0</span>))</span><br><span class="line">    	<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  <span class="comment">// last_updated_ 没有赋值</span></span><br><span class="line">  <span class="keyword">bool</span> current = (ros::Time::<span class="built_in">now</span>() - last_updated_).<span class="built_in">toSec</span>() &lt;= expected_update_rate_.<span class="built_in">toSec</span>();</span><br><span class="line">  <span class="keyword">if</span> (!current)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">ROS_WARN</span>(</span><br><span class="line">        <span class="string">&quot;The %s observation buffer has not been updated for %.2f seconds, and it should be updated every %.2f seconds.&quot;</span>,</span><br><span class="line">        topic_name_.<span class="built_in">c_str</span>(), (ros::Time::<span class="built_in">now</span>() - last_updated_).<span class="built_in">toSec</span>(), expected_update_rate_.<span class="built_in">toSec</span>());</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> current;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>此时发导航命令，又有报警<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[/move_base]:Sensor data is out of date, we<span class="string">&#x27;re not going to allow commanding of the base for safety</span></span><br></pre></td></tr></table></figure><br>因为没有可靠的传感器数据，<code>move_base</code>不允许车跑起来。来源在<code>MoveBase::executeCycle</code><br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(!controller_costmap_ros_-&gt;<span class="built_in">isCurrent</span>())</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">ROS_WARN</span>(<span class="string">&quot;[%s]:Sensor data is out of date, we&#x27;re not going to allow commanding of the base for safety&quot;</span>,ros::this_node::<span class="built_in">getName</span>().<span class="built_in">c_str</span>());</span><br><span class="line">  <span class="built_in">publishZeroVelocity</span>();</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>也就是函数<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">LayeredCostmap::isCurrent</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  current_ = <span class="literal">true</span>;</span><br><span class="line">  <span class="keyword">for</span> (vector&lt;boost::shared_ptr&lt;Layer&gt; &gt;::iterator plugin = plugins_.<span class="built_in">begin</span>(); plugin != plugins_.<span class="built_in">end</span>();</span><br><span class="line">      ++plugin)</span><br><span class="line">  &#123;</span><br><span class="line">    current_ = current_ &amp;&amp; (*plugin)-&gt;<span class="built_in">isCurrent</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>显然是因为障碍层不符合<code>isCurrent</code>，导致代价地图也不符合<code>isCurrent</code>。如果希望车照样跑，就把<code>MoveBase::executeCycle</code>那段注释掉，把<code>ObservationBuffer::isCurrent()</code>的报警也注释掉，否则没完没了。</p>
<p>从网上下载一个包含雷达数据的bag，又设置了通用代价地图和tf树后，发现报警依然，应该还是时间戳问题，懒得再对齐了。</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2023/06/29/ROS/ROS%E7%A8%8B%E5%BA%8F%E5%92%8C%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/ROS%E7%BC%96%E7%A8%8B%E8%A7%84%E8%8C%83/">ROS编程规范</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2023-06-29</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/ROS/">ROS</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/ROS/ROS%E7%A8%8B%E5%BA%8F%E5%92%8C%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">ROS程序和源码分析</a></span><div class="content"><ul>
<li><p><code>Packages</code>,  <code>Topics / Services</code>, 文件、库的命名都采用 <strong>under_scored</strong></p>
</li>
<li><p><code>Classes / Types</code>的命名采用 <strong>CamelCased</strong>，比如<code>class ExampleClass</code>, <code>class HokuyoURGLaser</code>。  函数命名采用 <strong>camelCased</strong>，比如<code>int exampleMethod(int example_arg)</code></p>
</li>
<li><p>普通变量和成员变量命名、命名空间都使用 <strong>under_scored</strong>，循环中的临时变量使用<code>i,j,k</code>，i on the outer loop, j on the next inner loop</p>
</li>
<li><p>常量命名采用 <strong>ALL_CAPITALS</strong></p>
</li>
<li><p>全局变量采用 <code>g_</code> 开头的 <strong>under_scored</strong></p>
</li>
<li><p>每行最多120个字符</p>
</li>
<li><p>所有头文件要包含<code>#ifndef</code>，比如:</p>
</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> PACKAGE_PATH_FILE_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PACKAGE_PATH_FILE_H</span></span><br><span class="line">	......</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p>这部分应该在license之后，<code>#endif</code>在头文件的最后</p>
<ul>
<li>不使用宏</li>
</ul>
<p>预处理所用的宏，比如<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">if</span> DEBUG</span></span><br><span class="line">        <span class="built_in">temporary_debugger_break</span>();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure></p>
<ul>
<li><p>函数的输出参数使用指针，而不是引用:  <code>int exampleMethod(FooThing input, BarThing* output);</code></p>
</li>
<li><p>头文件里不要用<code>using namespace</code>关键字，在源文件里可使用<code>using</code>，但不要<code>using namespace std;</code>，而是使用<code>using std::list;</code>, <code>using std::vector;</code>，否则引入了<code>std</code>所有内容。</p>
</li>
<li><p>建议使用Exceptions，而不是returning integer error codes。 析构函数不要抛出异常。 不直接触发的回调函数，不要抛出异常。 </p>
</li>
<li><p>保证代码是 <code>exception-safe</code>: When your code can be interrupted by exceptions, you must ensure that resources you hold will be deallocated when stack variables go out of scope. In particular, mutexes must be released, and heap-allocated memory must be freed. Accomplish this safety by using the following mutex guards and smart pointers</p>
</li>
</ul>
<h2 id="枚举"><a href="#枚举" class="headerlink" title="枚举"></a>枚举</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> Choices</span><br><span class="line">&#123;</span><br><span class="line">  <span class="class"><span class="keyword">enum</span> <span class="title">Choice</span></span></span><br><span class="line"><span class="class">  &#123;</span></span><br><span class="line">     Choice1,</span><br><span class="line">     Choice2,</span><br><span class="line">     Choice3</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">typedef</span> Choices::Choice Choice;</span><br></pre></td></tr></table></figure>
<p>This prevents enums from polluting the namespace they’re inside. Individual items within the enum are referenced by: Choices::Choice1, but the typedef still allows declaration of the Choice enum without the namespace.</p>
<ul>
<li>If you are using C++11 and above, you can use scoped enumeration</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="keyword">class</span> <span class="title">Choice</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    Choice1,</span><br><span class="line">    Choice2,</span><br><span class="line">    Choice3</span><br><span class="line">&#125;;</span><br><span class="line">Choice c = Choice::Choice1;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>不建议使用全局变量和函数，尤其前者。更不能在多线程中使用。大多数变量和函数都该在类的体内，其他应当在命名空间里。</p>
</li>
<li><p>类不要使用静态变量。</p>
</li>
<li><p>只在 well-defined exit point 调用<code>exit()</code>函数</p>
</li>
<li><p>使用assertions之类的比条件判断语句好，比如<code>ROS_ASSERT</code>, <code>ROS_ASSERT_MSG</code>, <code>ROS_ASSERT_CMD</code>, <code>ROS_BREADK</code></p>
</li>
</ul>
<p>Depending on compilation settings, the assertion may not be executed.</p>
<p>It is typical to develop software with assertion-checking enabled, in order to catch violations. When nearing software completion and when assertions are found to always be true in the face of extensive testing, you build with a flag that removes assertions from compilation, so they take up no space or time. </p>
<p>The following option to catkin_make will define the NDEBUG macro for all your ROS packages, and thereby remove assertion checks.<br><code>catkin_make -DCMAKE_CXX_FLAGS:STRING=&quot;-DNDEBUG&quot;</code></p>
<p>Note: cmake will rebuild all your software when you run it with this command, and will remember the setting through subsequent catkin_make runs until you delete your build and devel directories and rebuild.</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2023/06/28/ROS/ROS%E7%A8%8B%E5%BA%8F%E5%92%8C%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/TopicManager%20%E7%B1%BB/">TopicManager 类</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2023-06-28</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/ROS/">ROS</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/ROS/ROS%E7%A8%8B%E5%BA%8F%E5%92%8C%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">ROS程序和源码分析</a></span><div class="content"><p>这个类有时也有用，但是不熟悉就容易用错。它具备单例模式 <code>static const TopicManagerPtr&amp;  instance()</code>，使用方便。</p>
<ul>
<li><p><code>size_t  getNumPublishers (const std::string &amp;_topic)</code> &emsp;&emsp;  Return the number of publishers connected to <font size=3 color = blue> this node </font>  on a particular topic.</p>
</li>
<li><p><code>size_t  getNumSubscribers (const std::string &amp;_topic)</code> &emsp;&emsp; Return the number of subscribers a node has for a particular topic</p>
</li>
<li><p><code>void  getAdvertisedTopics (V_string &amp;topics)</code> &emsp;&emsp;  Get the list of topics advertised by <font size=3 color = blue> this node </font></p>
</li>
<li><p><code>void   getSubscribedTopics (V_string &amp;topics)</code> &emsp;&emsp; Get the list of topics subscribed to by <font size=3 color = blue> this node </font></p>
</li>
</ul>
<p>根据说明，对以上几个函数，不能直接传一个话题名做参数，以获知订阅者和发布者的数量，结果往往不是你想要的。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">std::vector&lt;string&gt; topics;</span><br><span class="line">ros::TopicManager::<span class="built_in">instance</span>()-&gt;<span class="built_in">getSubscribedTopics</span>(topics);</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt; topics.<span class="built_in">size</span>(); i++)</span><br><span class="line">    std::cout &lt;&lt; topics.<span class="built_in">at</span>(i) &lt;&lt; <span class="string">&quot;  &quot;</span>;</span><br></pre></td></tr></table></figure>
<p>这里获得的话题只有<code>clock</code>，而不是所有被订阅的节点。</p>
<ul>
<li><code>PublicationPtr  lookupPublication(const std::string &amp;topic)</code> &emsp;&emsp; Lookup an advertised topic.</li>
</ul>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2023/06/27/C++/C++%20%20%E5%9F%BA%E7%A1%80/%E5%A6%82%E4%BD%95%E5%88%A4%E6%96%ADCPU%20%E6%9E%B6%E6%9E%84%E5%92%8C%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E7%B1%BB%E5%9E%8B/">如何判断CPU 架构和操作系统类型</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2023-06-27</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/C/">C++</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/C/C-%E5%9F%BA%E7%A1%80/">C++ 基础</a></span><div class="content"><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="meta">#<span class="meta-keyword">if</span> defined __linux__</span></span><br><span class="line">      std::cout&lt;&lt;<span class="string">&quot;linux system&quot;</span>&lt;&lt;std::endl;</span><br><span class="line">  <span class="meta">#<span class="meta-keyword">elif</span> defined _WIN32</span></span><br><span class="line">      std::cout&lt;&lt;<span class="string">&quot;windows system&quot;</span>&lt;&lt;std::endl;</span><br><span class="line">  <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">   </span><br><span class="line">  <span class="meta">#<span class="meta-keyword">if</span> defined  __aarch64__</span></span><br><span class="line">      std::cout&lt;&lt;<span class="string">&quot;this is arm cpu&quot;</span>&lt;&lt;std::endl;</span><br><span class="line">  <span class="meta">#<span class="meta-keyword">elif</span> defined __x86_64__</span></span><br><span class="line">      std::cout&lt;&lt;<span class="string">&quot;this id x86 cpu&quot;</span>&lt;&lt;std::endl;</span><br><span class="line">  <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>cmake 中判断CPU 架构，操作系统类型<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">cmake_minimum_required(VERSION <span class="number">3.10</span><span class="number">.0</span>)</span><br><span class="line"> </span><br><span class="line">message($&#123;CMAKE_HOST_SYSTEM_NAME&#125;)</span><br><span class="line">message($&#123;CMAKE_HOST_SYSTEM_PROCESSOR&#125;)</span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span>(CMAKE_HOST_SYSTEM_NAME MATCHES <span class="string">&quot;Linux&quot;</span>)</span><br><span class="line">    message(<span class="string">&quot;this is Linux&quot;</span>)</span><br><span class="line">elseif(CMAKE_HOST_SYSTEM_NAME MATCHES <span class="string">&quot;Windows&quot;</span>)</span><br><span class="line">  message(<span class="string">&quot;this is Windows&quot;</span>)</span><br><span class="line">endif()</span><br><span class="line"><span class="keyword">if</span>(CMAKE_HOST_SYSTEM_PROCESSOR MATCHES <span class="string">&quot;aarch64&quot;</span>)</span><br><span class="line">    message(<span class="string">&quot;this is aarch64 cpu&quot;</span>)</span><br><span class="line">elseif(CMAKE_HOST_SYSTEM_PROCESSOR MATCHES <span class="string">&quot;x86_64&quot;</span>)</span><br><span class="line">  message(<span class="string">&quot;this is x86_64 cpu&quot;</span>)</span><br><span class="line">endif()</span><br></pre></td></tr></table></figure></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2023/06/25/%E8%B7%AF%E5%BE%84%E8%A7%84%E5%88%92/%E4%BB%A3%E4%BB%B7%E5%9C%B0%E5%9B%BE/Costmap2DROS%E7%9A%84%E5%87%BD%E6%95%B0getRobotPose/">Costmap2DROS的函数getRobotPose</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2023-06-25</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E8%B7%AF%E5%BE%84%E8%A7%84%E5%88%92/">路径规划</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E8%B7%AF%E5%BE%84%E8%A7%84%E5%88%92/%E4%BB%A3%E4%BB%B7%E5%9C%B0%E5%9B%BE/">代价地图</a></span><div class="content"><p>源码其实并不复杂<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">Costmap2DROS::getRobotPose</span><span class="params">(tf::Stamped&lt;tf::Pose&gt;&amp; global_pose)</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  global_pose.<span class="built_in">setIdentity</span>();</span><br><span class="line">  tf::Stamped &lt; tf::Pose &gt; robot_pose;</span><br><span class="line">  robot_pose.<span class="built_in">setIdentity</span>();</span><br><span class="line">  robot_pose.frame_id_ = robot_base_frame_;</span><br><span class="line">  robot_pose.stamp_ = ros::<span class="built_in">Time</span>();</span><br><span class="line">  ros::Time current_time = ros::Time::<span class="built_in">now</span>();  <span class="comment">// save time for checking tf delay later</span></span><br><span class="line">  <span class="keyword">try</span></span><br><span class="line">  &#123;</span><br><span class="line">    tf_.<span class="built_in">transformPose</span>(global_frame_, robot_pose, global_pose);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in"><span class="keyword">catch</span></span> (tf::LookupException&amp; ex)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">ROS_ERROR_THROTTLE</span>(<span class="number">1.0</span>, <span class="string">&quot;No Transform available Error looking up robot pose: %s\n&quot;</span>, ex.<span class="built_in">what</span>());</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in"><span class="keyword">catch</span></span> (tf::ConnectivityException&amp; ex)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">ROS_ERROR_THROTTLE</span>(<span class="number">1.0</span>, <span class="string">&quot;Connectivity Error looking up robot pose: %s\n&quot;</span>, ex.<span class="built_in">what</span>());</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in"><span class="keyword">catch</span></span> (tf::ExtrapolationException&amp; ex)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">ROS_ERROR_THROTTLE</span>(<span class="number">1.0</span>, <span class="string">&quot;Extrapolation Error looking up robot pose: %s\n&quot;</span>, ex.<span class="built_in">what</span>());</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// check global_pose timeout</span></span><br><span class="line">  <span class="keyword">if</span> (current_time.<span class="built_in">toSec</span>() - global_pose.stamp_.<span class="built_in">toSec</span>() &gt; transform_tolerance_)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">ROS_WARN_THROTTLE</span>(<span class="number">1.0</span>,</span><br><span class="line">                      <span class="string">&quot;Costmap2DROS transform timeout. Current time: %.4f, global_pose stamp: %.4f, tolerance: %.4f&quot;</span>,</span><br><span class="line">                      current_time.<span class="built_in">toSec</span>(), global_pose.stamp_.<span class="built_in">toSec</span>(), transform_tolerance_);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>核心是函数 <code>transformPose</code>，<code>tf_</code>在这里是<code>tf::TransformListener</code>，但函数实际是继承自基类<code>tf::Transformer</code>，有两个重载，常用的是第一个<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Transformer::transformPose</span><span class="params">(<span class="keyword">const</span> std::string&amp;   target_frame,</span></span></span><br><span class="line"><span class="params"><span class="function">                                <span class="keyword">const</span> Stamped&lt; tf::Pose &gt;&amp;   stamped_in,</span></span></span><br><span class="line"><span class="params"><span class="function">                                Stamped&lt; tf::Pose &gt;&amp;   stamped_out </span></span></span><br><span class="line"><span class="params"><span class="function">)</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Transformer::transformPose</span><span class="params">(<span class="keyword">const</span> std::string&amp;   target_frame,</span></span></span><br><span class="line"><span class="params"><span class="function">                                <span class="keyword">const</span> ros::Time&amp;   target_time,</span></span></span><br><span class="line"><span class="params"><span class="function">                                <span class="keyword">const</span> Stamped&lt; tf::Pose &gt;&amp;   stamped_in,</span></span></span><br><span class="line"><span class="params"><span class="function">                                <span class="keyword">const</span> std::string&amp;   fixed_frame,</span></span></span><br><span class="line"><span class="params"><span class="function">                                Stamped&lt; tf::Pose &gt;&amp;   stamped_out </span></span></span><br><span class="line"><span class="params"><span class="function">)</span> <span class="keyword">const</span></span></span><br></pre></td></tr></table></figure><br>第二个重载会调用函数<code>lookupTransform</code><br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Get the transform between two frames by frame ID assuming fixed frame.</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Transformer::lookupTransform</span> <span class="params">( <span class="keyword">const</span> std::string &amp;   target_frame,</span></span></span><br><span class="line"><span class="params"><span class="function">	<span class="keyword">const</span> ros::Time &amp;   target_time,</span></span></span><br><span class="line"><span class="params"><span class="function">	<span class="keyword">const</span> std::string &amp;   source_frame,</span></span></span><br><span class="line"><span class="params"><span class="function">	<span class="keyword">const</span> ros::Time &amp;   source_time,</span></span></span><br><span class="line"><span class="params"><span class="function">	<span class="keyword">const</span> std::string &amp;   fixed_frame,</span></span></span><br><span class="line"><span class="params"><span class="function">	StampedTransform &amp;  transform </span></span></span><br><span class="line"><span class="params"><span class="function">)</span>   <span class="keyword">const</span></span></span><br></pre></td></tr></table></figure></p>
<ul>
<li>target_frame  The frame to which data should be transformed</li>
<li>target_time The time to which the data should be transformed. (0 will get the latest)</li>
<li>source_frame  The frame where the data originated</li>
<li>source_time The time at which the source_frame should be evaluated. (0 will get the latest)</li>
<li>fixed_frame The frame in which to assume the transform is constant in time.</li>
<li>transform The transform reference to fill.</li>
</ul>
<p>可能抛出的异常<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> tf&#123;</span><br><span class="line">  <span class="comment">// Pass through exceptions from tf2</span></span><br><span class="line">  <span class="keyword">typedef</span> tf2::TransformException TransformException;</span><br><span class="line">  <span class="keyword">typedef</span> tf2::LookupException LookupException;</span><br><span class="line">  <span class="keyword">typedef</span> tf2::ConnectivityException ConnectivityException;</span><br><span class="line">  <span class="keyword">typedef</span> tf2::ExtrapolationException ExtrapolationException;</span><br><span class="line">  <span class="keyword">typedef</span> tf2::InvalidArgumentException InvalidArgument; </span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="报警-Costmap2DROS-transform-timeout"><a href="#报警-Costmap2DROS-transform-timeout" class="headerlink" title="报警 Costmap2DROS transform timeout"></a>报警 Costmap2DROS transform timeout</h2><font size="3" color="blue"> 每次出现这个报警，基本就是网络带宽不足了。  </font>

<p>报警对应的<code>transform_tolerance_</code>是在构造函数里写死的<code>0.3</code>，一开始我以为这个数太小了，于是改为2，结果没有改善。</p>
<p>以下报警的根源都是<code>Costmap2DROS::getRobotPose</code><br><img src="https://s2.loli.net/2023/06/27/zstZTuh8cO63VvG.png" alt=""><br><img src="https://s2.loli.net/2023/06/27/jnCAr6sdbgxJwBK.png" alt="获取不到开始位姿，无法生成全局路径"></p>
<p>尝试的改善措施(全都无效):</p>
<ul>
<li><p><code>Costmap2DROS</code>构造函数中设置: <code>transform_tolerance_(2)</code></p>
</li>
<li><p><code>timer_ = private_nh.createTimer(ros::Duration(.1), &amp;Costmap2DROS::movementCB, this);</code> 0.1秒间隔太短了。增大到1.5，稍有改善，但未解决根本问题，反而降低了代价地图的性能。</p>
</li>
<li><p>降低两个代价地图的<code>update_frequency</code></p>
</li>
</ul>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2023/06/25/%E8%B7%AF%E5%BE%84%E8%A7%84%E5%88%92/VFH%E7%AE%97%E6%B3%95/">VFH算法</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2023-06-25</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E8%B7%AF%E5%BE%84%E8%A7%84%E5%88%92/">路径规划</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E8%B7%AF%E5%BE%84%E8%A7%84%E5%88%92/%E5%85%B6%E4%BB%96/">其他</a></span><div class="content"><p>目前的VFH遇到障碍，会先向前走一段，这样就容易碰撞。</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2023/06/13/C++/%E5%A4%9A%E7%BA%BF%E7%A8%8B/unique_lock/">unique_lock</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2023-06-13</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/C/">C++</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/C/%E5%A4%9A%E7%BA%BF%E7%A8%8B/">多线程</a></span><div class="content"><p><code>unique_lock</code>是管理具有唯一所有权的互斥对象的对象。类似智能指针<code>unique_ptr</code>。在构造时（或通过移动分配给它），对象获得一个互斥对象，负责该对象的锁定和解锁操作。该对象支持两种状态：锁定和解锁。此类保证在销毁时将管理的互斥对象解锁（即使未显式调用解锁函数）。因此，它能够保证互斥对象在抛出异常的情况下正确解锁，克服了mutex使用中的缺点。但是，unique_lock对象不以任何方式管理互斥对象的生命周期：这要求互斥对象的持续时间应至少延长到管理它的unique_lock销毁。</p>
<p><code>unique_lock</code>是一个模板类，需要使用Mutex类型作为模板参数。</p>
<ul>
<li><p><code>try_lock</code>初始化: 新创建的<code>unique_lock</code>对象管理<code>Mutex</code>对象<code>m</code>，并尝试调用<code>m.lock()</code>对<code>Mutex</code>对象进行上锁，如果此时另外某个<code>unique_lock</code>对象已经管理了该<code>Mutex</code>对象<code>m</code>，则当前线程将会被阻塞。</p>
</li>
<li><p><code>try-locking</code>初始化: 新创建的<code>unique_lock</code>对象管理Mutex对象m，并尝试调用m.try_lock()对Mutex对象进行上锁，但如果上锁不成功，并不会阻塞当前线程</p>
</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">boost::mutex mut;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">bar</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   <span class="function">boost::unique_lock&lt;boost::mutex&gt; <span class="title">lock</span><span class="params">(mut)</span></span>;</span><br><span class="line">   std::cout &lt;&lt; <span class="string">&quot;This is bar!&quot;</span> &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span>( lock.<span class="built_in">owns_lock</span>() )</span><br><span class="line">       cout &lt;&lt; <span class="string">&quot;owns lock&quot;</span> &lt;&lt; endl;</span><br><span class="line">   <span class="keyword">else</span></span><br><span class="line">      lock.<span class="built_in">lock</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">foo</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">boost::unique_lock&lt;boost::mutex&gt; <span class="title">lock</span><span class="params">(mut)</span></span>;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;This is foo!&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</div><hr></div><nav id="pagination"><div class="pagination"><a class="extend prev" rel="prev" href="/page/3/">&lt;&lt; Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><span class="space">&hellip;</span><a class="page-number" href="/page/66/">66</a><a class="extend next" rel="next" href="/page/5/">Next &gt;&gt;</a></div></nav></div></div><footer class="footer-bg" style="background-image: url(https://s2.loli.net/2022/11/17/QOR8cePIS5NdDrK.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2018 - 2023 By Charon Cheung</div><div class="framework-info"><span>Driven - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_site_uv"><i class="fa fa-user"></i><span id="busuanzi_value_site_uv"></span><span></span></span><span class="footer-separator">|</span><span id="busuanzi_container_site_pv"><i class="fa fa-eye"></i><span id="busuanzi_value_site_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.6.1"></script><script src="/js/fancybox.js?version=1.6.1"></script><script src="/js/sidebar.js?version=1.6.1"></script><script src="/js/copy.js?version=1.6.1"></script><script src="/js/fireworks.js?version=1.6.1"></script><script src="/js/transition.js?version=1.6.1"></script><script src="/js/scroll.js?version=1.6.1"></script><script src="/js/head.js?version=1.6.1"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
    processEscapes: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
  },
  CommonHTML: {
    linebreaks: { automatic: true, width: "90% container" }
  },
  "HTML-CSS": { 
    linebreaks: { automatic: true, width: "90% container" }
  },
  "SVG": { 
    linebreaks: { automatic: true, width: "90% container" }
  }
});
</script><script type="text/x-mathjax-config">MathJax.Hub.Queue(function() {
  var all = MathJax.Hub.getAllJax(), i;
  for (i=0; i < all.length; i += 1) {
    all[i].SourceElement().parentNode.className += ' has-jax';
  }
});
</script><script src="https://cdn.bootcss.com/mathjax/2.7.2/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script>if(/Android|webOS|iPhone|iPod|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
}</script></body></html>