<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content=""><meta name="keywords" content=""><meta name="author" content="Charon Cheung"><meta name="copyright" content="Charon Cheung"><title>If you wish for peace, prepare for war | 沉默杀手</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.6.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.6.1"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  }
} </script><meta name="generator" content="Hexo 5.4.0"></head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="author-info"><div class="author-info__avatar text-center"><img src="https://s2.loli.net/2022/02/17/HQaCXUBn64zsMIL.png"></div><div class="author-info__name text-center">Charon Cheung</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">654</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">6</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">53</span></a></div></div></div><nav id="nav" style="background-image: url(https://s2.loli.net/2022/11/17/QOR8cePIS5NdDrK.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">沉默杀手</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span></div><div id="site-info"><div id="site-title">沉默杀手</div><div id="site-sub-title">If you wish for peace, prepare for war</div></div></nav><div id="content-outer"><div class="layout" id="content-inner"><div class="recent-post-item article-container"><a class="article-title" href="/2022/04/30/%E6%BF%80%E5%85%89SLAM/Cartographer/%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/metrics%E6%9C%BA%E5%88%B6/">metrics机制</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-04-30</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E6%BF%80%E5%85%89SLAM/">激光SLAM</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E6%BF%80%E5%85%89SLAM/Cartographer/">Cartographer</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E6%BF%80%E5%85%89SLAM/Cartographer/%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/">源码解读</a></span><div class="content"><p>若要启用metrics机制，必须在launch文件里添加参数<code>-collect_metrics true</code>，这个本质也是gflag</p>
<p>源码的顺序如下<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// node.cc中</span></span><br><span class="line"><span class="keyword">if</span> (collect_metrics)</span><br><span class="line">&#123;</span><br><span class="line">  metrics_registry_ = absl::make_unique&lt;metrics::FamilyFactory&gt;();</span><br><span class="line">  carto::metrics::<span class="built_in">RegisterAllMetrics</span>(metrics_registry_.<span class="built_in">get</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// register.cc 中定义</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">RegisterAllMetrics</span><span class="params">(FamilyFactory* registry)</span> </span>&#123;</span><br><span class="line">  mapping::constraints::ConstraintBuilder2D::<span class="built_in">RegisterMetrics</span>(registry);</span><br><span class="line">  mapping::<span class="built_in">GlobalTrajectoryBuilderRegisterMetrics</span>(registry);</span><br><span class="line">  mapping::LocalTrajectoryBuilder2D::<span class="built_in">RegisterMetrics</span>(registry);</span><br><span class="line">  mapping::PoseGraph2D::<span class="built_in">RegisterMetrics</span>(registry);</span><br><span class="line">  sensor::TrajectoryCollator::<span class="built_in">RegisterMetrics</span>(registry);</span><br><span class="line">  <span class="comment">// 不需要可以注释掉</span></span><br><span class="line">  mapping::constraints::ConstraintBuilder3D::<span class="built_in">RegisterMetrics</span>(registry);</span><br><span class="line">  mapping::LocalTrajectoryBuilder3D::<span class="built_in">RegisterMetrics</span>(registry);</span><br><span class="line">  mapping::PoseGraph3D::<span class="built_in">RegisterMetrics</span>(registry);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>以上所有<code>RegisterMetrics</code>在<code>local_trajectory_builder_2d.cc</code>,  <code>pose_graph_2d.cc</code>,  <code>constraint_builder_2d.cc</code>(排除3D情况)定义了所有metrics参数</p>
<p><br></p>
<p>以<code>kLocalSlamCpuRealTimeRatio</code>为例进行说明， 在<code>local_trajectory_builder_2d.cc</code>开始部分的声明：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">auto</span>* kLocalSlamCpuRealTimeRatio = metrics::Gauge::<span class="built_in">Null</span>();`</span><br></pre></td></tr></table></figure></p>
<p>然后在<code>LocalTrajectoryBuilder2D::RegisterMetrics</code>中<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">auto</span>* cpu_real_time_ratio = family_factory-&gt;<span class="built_in">NewGaugeFamily</span>(</span><br><span class="line">      <span class="string">&quot;mapping_2d_local_trajectory_builder_cpu_real_time_ratio&quot;</span>,</span><br><span class="line">      <span class="string">&quot;sensor duration / cpu duration.&quot;</span>);</span><br><span class="line"></span><br><span class="line">kLocalSlamCpuRealTimeRatio = cpu_real_time_ratio-&gt;<span class="built_in">Add</span>(&#123;&#125;);</span><br></pre></td></tr></table></figure></p>
<p>最后是赋值部分<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (last_thread_cpu_time_seconds_.<span class="built_in">has_value</span>()) &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">double</span> thread_cpu_duration_seconds =</span><br><span class="line">        thread_cpu_time_seconds - last_thread_cpu_time_seconds_.<span class="built_in">value</span>();</span><br><span class="line">    <span class="keyword">if</span> (sensor_duration.<span class="built_in">has_value</span>()) &#123;</span><br><span class="line">      kLocalSlamCpuRealTimeRatio-&gt;<span class="built_in">Set</span>(</span><br><span class="line">          common::<span class="built_in">ToSeconds</span>(sensor_duration.<span class="built_in">value</span>()) / thread_cpu_duration_seconds );</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<p>如果想查看metrics，只能<code>rosservice call /read_metrics &quot;&#123;&#125;&quot;</code>，一次调用的结果部分：<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">name: <span class="string">&quot;mapping_constraints_constraint_builder_2d_constraints&quot;</span></span><br><span class="line">description: <span class="string">&quot;Constraints computed&quot;</span></span><br><span class="line">metrics: </span><br><span class="line">    <span class="built_in">type</span>: 0</span><br><span class="line">    labels: </span><br><span class="line">      - </span><br><span class="line">        key: <span class="string">&quot;matcher&quot;</span></span><br><span class="line">        value: <span class="string">&quot;searched&quot;</span></span><br><span class="line">      - </span><br><span class="line">        key: <span class="string">&quot;search_region&quot;</span></span><br><span class="line">        value: <span class="string">&quot;global&quot;</span></span><br><span class="line">    value: 4206.0</span><br><span class="line">    counts_by_bucket: []</span><br><span class="line">  - </span><br><span class="line">    <span class="built_in">type</span>: 0</span><br><span class="line">    labels: </span><br><span class="line">      - </span><br><span class="line">        key: <span class="string">&quot;matcher&quot;</span></span><br><span class="line">        value: <span class="string">&quot;found&quot;</span></span><br><span class="line">      - </span><br><span class="line">        key: <span class="string">&quot;search_region&quot;</span></span><br><span class="line">        value: <span class="string">&quot;global&quot;</span></span><br><span class="line">    value: 0.0</span><br><span class="line">    counts_by_bucket: []</span><br><span class="line"></span><br><span class="line">- </span><br><span class="line">  name: <span class="string">&quot;mapping_2d_pose_graph_constraints&quot;</span></span><br><span class="line">  description: <span class="string">&quot;Current number of constraints in the pose graph&quot;</span></span><br><span class="line">  metrics: </span><br><span class="line">    - </span><br><span class="line">      <span class="built_in">type</span>: 1</span><br><span class="line">      labels: </span><br><span class="line">        - </span><br><span class="line">          key: <span class="string">&quot;tag&quot;</span></span><br><span class="line">          value: <span class="string">&quot;inter_submap&quot;</span></span><br><span class="line">        - </span><br><span class="line">          key: <span class="string">&quot;trajectory&quot;</span></span><br><span class="line">          value: <span class="string">&quot;different&quot;</span></span><br><span class="line">      value: 0.0</span><br><span class="line">      counts_by_bucket: []</span><br><span class="line"></span><br><span class="line">name: <span class="string">&quot;mapping_constraints_constraint_builder_2d_num_submap_scan_matchers&quot;</span></span><br><span class="line">description: <span class="string">&quot;Current number of constructed submap scan matchers&quot;</span></span><br><span class="line">metrics: </span><br><span class="line">- </span><br><span class="line">    <span class="built_in">type</span>: 1</span><br><span class="line">    labels: []</span><br><span class="line">    value: 18.0</span><br><span class="line">    counts_by_bucket: []</span><br><span class="line">- </span><br><span class="line">name: <span class="string">&quot;mapping_2d_pose_graph_constraints&quot;</span></span><br><span class="line">description: <span class="string">&quot;Current number of constraints in the pose graph&quot;</span></span><br><span class="line">metrics: </span><br><span class="line">  - </span><br><span class="line">    <span class="built_in">type</span>: 1</span><br><span class="line">    labels: </span><br><span class="line">      - </span><br><span class="line">        key: <span class="string">&quot;tag&quot;</span></span><br><span class="line">        value: <span class="string">&quot;inter_submap&quot;</span></span><br><span class="line">      - </span><br><span class="line">        key: <span class="string">&quot;trajectory&quot;</span></span><br><span class="line">        value: <span class="string">&quot;different&quot;</span></span><br><span class="line">    value: 27.0</span><br><span class="line">    counts_by_bucket: []</span><br><span class="line">  - </span><br><span class="line">    <span class="built_in">type</span>: 1</span><br><span class="line">    labels: </span><br><span class="line">      - </span><br><span class="line">        key: <span class="string">&quot;tag&quot;</span></span><br><span class="line">        value: <span class="string">&quot;inter_submap&quot;</span></span><br><span class="line">      - </span><br><span class="line">        key: <span class="string">&quot;trajectory&quot;</span></span><br><span class="line">        value: <span class="string">&quot;same&quot;</span></span><br><span class="line">    value: 10.0</span><br><span class="line">    counts_by_bucket: []</span><br><span class="line">- </span><br><span class="line">name: <span class="string">&quot;mapping_constraints_constraint_builder_2d_scores&quot;</span></span><br><span class="line">description: <span class="string">&quot;Constraint scores built&quot;</span></span><br><span class="line">metrics: </span><br><span class="line">  - </span><br><span class="line">    <span class="built_in">type</span>: 2</span><br><span class="line">    labels: </span><br><span class="line">      - </span><br><span class="line">        key: <span class="string">&quot;search_region&quot;</span></span><br><span class="line">        value: <span class="string">&quot;local&quot;</span></span><br></pre></td></tr></table></figure><br>获知不同轨迹之间的查找次数和找到的约束数目，源码在<code>ConstraintBuilder2D::ComputeConstraint</code>中的<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kGlobalConstraintsFoundMetric-&gt;<span class="built_in">Increment</span>();</span><br><span class="line">kGlobalConstraintScoresMetric-&gt;<span class="built_in">Observe</span>(score);</span><br></pre></td></tr></table></figure></p>
<font size="4" color="blue"> 模仿源码，可以根据自己的需要添加 metrics  </font>

<p>如果不需要3D的metrics，可以到<code>ConstraintBuilder3D::RegisterMetrics</code>,  <code>LocalTrajectoryBuilder3D::RegisterMetrics</code>,  <code>PoseGraph3D::RegisterMetrics</code>中return</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2022/04/28/%E8%8B%B1%E8%AF%AD/batman%20%E5%8D%95%E8%AF%8D/">batman 单词</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-04-28</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E8%8B%B1%E8%AF%AD/">英语</a></span><div class="content"><ul>
<li>deadbeat &emsp;&emsp;&emsp;   老赖，游手好闲者</li>
<li>Don’t take it too hard &emsp;&emsp;&emsp; (受到打击后)别太难过，别放在心上</li>
<li>way to go &emsp;&emsp;&emsp;  表示对他人的贊同、興奮</li>
<li>hatchet man  &emsp;&emsp;&emsp;  受雇的打手, 职业杀手</li>
<li>we are rolling  &emsp;&emsp;&emsp;  相机开拍了</li>
<li>dead wrong  &emsp;&emsp;&emsp; 大错特错</li>
<li>mouthy &emsp;&emsp;&emsp;  喜欢说很多话，而且是以粗鲁的方式</li>
<li>gun barrel  &emsp;&emsp;&emsp;  枪管</li>
<li>reek &emsp;&emsp;&emsp;  发出臭味， reeking of imported cologne</li>
<li>small-time  &emsp;&emsp;&emsp; 不起眼的，不很成功的</li>
<li>sneaky pete  &emsp;&emsp;&emsp; （美国俚语）劣质的或廉价的烈性酒</li>
<li>milk and honey   &emsp;&emsp;&emsp;  丰富的享受    land of milk and honey  富饶的地方</li>
<li>hilt  &emsp;&emsp;&emsp;  刀柄</li>
<li>hapless  &emsp;&emsp;&emsp;  不幸运的；不愉快的</li>
<li>adversary  &emsp;&emsp;&emsp; 对手</li>
<li>squabble  &emsp;&emsp;&emsp;  争吵</li>
<li>gimmick   &emsp;&emsp;&emsp;    花招，华而不实的东西</li>
<li>neat and tidy   &emsp;&emsp;&emsp; 干净整洁</li>
<li>point-blank &emsp;&emsp;&emsp; 近距离平射的, 直截了当的</li>
<li>incantation &emsp;&emsp;&emsp; 咒语</li>
<li>coin toss  &emsp;&emsp;&emsp;   抛硬币</li>
<li>goofy  &emsp;&emsp;&emsp;  愚蠢的，古怪的</li>
<li>light sb up   &emsp;&emsp;&emsp;  To cause someone to become noticeably excited or animated.</li>
</ul>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2022/04/21/SLAM%E5%B7%A5%E5%85%B7/ceres%202%20%E8%87%AA%E5%8A%A8%E6%B1%82%E5%AF%BC/">Ceres(二) 自动求导</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-04-21</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/SLAM%E5%B7%A5%E5%85%B7/">SLAM工具</a></span><div class="content"><p>头文件只有一个<code>&quot;ceres/ceres.h&quot;</code></p>
<p>调试几个经典例子的过程<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;ceres/ceres.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> ceres::AutoDiffCostFunction;</span><br><span class="line"><span class="keyword">using</span> ceres::CostFunction;</span><br><span class="line"><span class="keyword">using</span> ceres::Problem;</span><br><span class="line"><span class="keyword">using</span> ceres::Solver;</span><br><span class="line"><span class="keyword">using</span> ceres::Solve;</span><br></pre></td></tr></table></figure><br><br></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span>  <span class="title">Functor</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt; <span class="function"><span class="keyword">bool</span> <span class="title">operator</span><span class="params">()</span><span class="params">(<span class="keyword">const</span> T* <span class="keyword">const</span> x, T* residual)</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		residual[<span class="number">0</span>] = <span class="number">10.0</span> - x[<span class="number">0</span>];</span><br><span class="line">		residual[<span class="number">1</span>] = <span class="number">3.0</span> - x[<span class="number">1</span>];</span><br><span class="line">		<span class="comment">// 直接让第2维度为0，优化后的x[1]还是初值2</span></span><br><span class="line">		<span class="comment">// residual[1] = T(0.0);</span></span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>这里的变量为二维的<script type="math/tex">(x_0, x_1)</script>，目标函数为<code>10.0-x</code>和<code>3.0-x</code></p>
<p>如果这里不写10.0而是10，就会报错。 Ceres中没有int，只接受double</p>
<p>对于<code>residual[1] = T(0.0);</code>的情况，如果不加<code>T</code>，编译就会报错<font size="4" color="orange"> error: no match for ‘operator=’ (operand types are ‘ceres::Jet<double, 2>’ and ‘double’)  </font>. Jet类型是ceres内置类型，我们要把double转成Jet类型，也就是<code>T(0.0)</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span>  <span class="title">TestLocalParam</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt; <span class="keyword">bool</span> <span class="title">operator</span><span class="params">()</span><span class="params">(<span class="keyword">const</span> T* x, <span class="keyword">const</span> T* delta, T* x_plus_delta)</span> <span class="keyword">const</span></span>&#123;</span><br><span class="line">		x_plus_delta[<span class="number">0</span>] = x[<span class="number">0</span>] + <span class="number">0.4</span> * delta[<span class="number">0</span>];</span><br><span class="line">		x_plus_delta[<span class="number">1</span>] = x[<span class="number">1</span>] + <span class="number">0.4</span> * delta[<span class="number">1</span>];</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><code>CostFunctor</code>的<code>operator</code>就是计算残差，不带平方项，平方是ceres自动添加，相当于最小二乘的函数 f</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// double x = 0.5;</span></span><br><span class="line"><span class="keyword">double</span> x[] = &#123;<span class="number">0.5</span>, <span class="number">2.0</span>&#125;;</span><br><span class="line"></span><br><span class="line">Problem problem;</span><br><span class="line"></span><br><span class="line">problem.<span class="built_in">AddParameterBlock</span>(x, <span class="number">2</span>, </span><br><span class="line">  (<span class="keyword">new</span> ceres::AutoDiffLocalParameterization</span><br><span class="line">  	<span class="comment">// 真正的维度是2， 参与优化的维度是1</span></span><br><span class="line">  	&lt;TestLocalParam, <span class="number">2</span>, <span class="number">1</span>&gt; ())</span><br><span class="line">	);</span><br><span class="line"><span class="comment">// AddParameterBlock 修改之后，无论下面的AutoDiffCostFunction参数是多少，只优化第1维度</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 残差的维度，参数的维度</span></span><br><span class="line"><span class="comment">// 如果此时是 2,1. 报错</span></span><br><span class="line">CostFunction* cost_func = <span class="keyword">new</span> AutoDiffCostFunction&lt;Functor, <span class="number">2</span>, <span class="number">2</span>&gt;(<span class="keyword">new</span> Functor);</span><br><span class="line"><span class="comment">// 参数：CostFunction，可选的LossFunction，将CostFunction连接到一组参数块</span></span><br><span class="line">problem.<span class="built_in">AddResidualBlock</span>(cost_func, <span class="literal">nullptr</span>, x);</span><br></pre></td></tr></table></figure>
<p>创建最小二乘问题，可以使用<code>Problem::AddResidualBlock()</code>和<code>Problem::AddParameterBlock()</code>。 可以使用<code>Problem::AddParameterBlock()</code>显式添加参数块，这将导致额外的正确性检查; 然而，如果参数块不存在，<code>Problem::AddResidualBlock()</code>会隐式添加参数块。</p>
<p><code>AddParameterBlock()</code>显式地向Problem添加了一个参数块。它还允许用户将LocalParameterization对象与参数块关联起来。</p>
<p><code>AddResidualBlock</code>默认会先调用<code>AddParameterBlock</code>，一般不用后者。</p>
<p>损失函数<code>LossFunction</code>，给异常值做限定，如果是nullptr，该项的代价就是残差的平方范数</p>
<p>代价函数携带关于它所期望的参数块大小的信息。函数检查这些参数是否与parameter_blocks中列出的参数块的大小匹配。如果检测到不匹配，程序将中止。</p>
<h2 id="Solver"><a href="#Solver" class="headerlink" title="Solver"></a>Solver</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">  Solver::Options  option;</span><br><span class="line">  option.minimizer_progress_to_stdout = <span class="literal">true</span>;</span><br><span class="line">  option.linear_solver_type = ceres::SPARSE_NORMAL_CHOLESKY;</span><br><span class="line"></span><br><span class="line">  Solver::Summary summary;</span><br><span class="line">  <span class="built_in">Solve</span>(option, &amp;problem, &amp;summary);</span><br><span class="line">  </span><br><span class="line">  std::cout &lt;&lt; summary.<span class="built_in">BriefReport</span>() &lt;&lt; std::endl&lt;&lt;std::endl;</span><br><span class="line">  <span class="comment">// std::cout &lt;&lt; summary.FullReport() &lt;&lt; std::endl&lt;&lt;std::endl;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// std::cout &lt;&lt; &quot;initial x: &quot; &lt;&lt; initial_x &lt;&lt;&quot;   x: &quot;&lt;&lt; x &lt;&lt; std::endl;</span></span><br><span class="line">  std::cout &lt;&lt;<span class="string">&quot;x[0]: &quot;</span>&lt;&lt; x[<span class="number">0</span>] &lt;&lt;<span class="string">&quot;   x[1]: &quot;</span>&lt;&lt; x[<span class="number">1</span>]&lt;&lt; std::endl;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>优先选用自动微分算法，某些情况可能需要用到解析微分算法，尽量避免数值微分算法。</p>
<h2 id="曲线拟合"><a href="#曲线拟合" class="headerlink" title="曲线拟合"></a>曲线拟合</h2><p>使用十四讲第六章的曲线拟合的例子，已知 N 个数据 <script type="math/tex">(x_i, y_i)</script>，它们符合曲线 <script type="math/tex">e^{(ax^2 + bx + c)}</script>，通过曲线拟合求 a, b, c</p>
<p>跟上面的例子不同，这次目标函数为 <script type="math/tex">e(x) = y-e^{(ax^2 + bx + c)}</script>，<font size="4" color="blue">  残差维度为3(未知a,b,c) </font></p>
<p>CMake配置如下<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">find_package(OpenCV REQUIRED)</span><br><span class="line">INCLUDE_DIRECTORIES($&#123;OpenCV_DIRS&#125;)</span><br><span class="line"></span><br><span class="line">target_link_libraries(node_2</span><br><span class="line">   $&#123;catkin_LIBRARIES&#125;</span><br><span class="line">   $&#123;CERES_LIBRARIES&#125;</span><br><span class="line">   $&#123;OpenCV_LIBS&#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure></p>
<p>先生成带有高斯噪声的数据<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;opencv2/opencv.hpp&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 真实值</span></span><br><span class="line"><span class="keyword">double</span> a =<span class="number">1.0</span>, b=<span class="number">2.0</span>, c=<span class="number">1.0</span>;</span><br><span class="line"><span class="comment">// abc的初值</span></span><br><span class="line"><span class="keyword">double</span> abc[<span class="number">3</span>]  = &#123;<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 生成带有噪声的模拟数据</span></span><br><span class="line">vector&lt;<span class="keyword">double</span>&gt; x_data, y_data;</span><br><span class="line"><span class="keyword">int</span> N = <span class="number">240</span>;  <span class="comment">// 数据数量</span></span><br><span class="line"><span class="keyword">double</span> w_sigma = <span class="number">1.0</span>;  <span class="comment">// 高斯标准差</span></span><br><span class="line">cv::RNG  rng;</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">unsigned</span> <span class="keyword">int</span> i =<span class="number">0</span>; i&lt;N; i++)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">double</span> x = i/<span class="number">100.0</span>;</span><br><span class="line">    x_data.<span class="built_in">push_back</span>(x);</span><br><span class="line">    y_data.<span class="built_in">push_back</span>(<span class="built_in">exp</span>(a*x*x + b*x + c) + rng.<span class="built_in">gaussian</span>(w_sigma)  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>高斯噪声的产生： <code>cv::RNG  rng;  rng.gaussian(w_sigma)</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Functor</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="built_in">Functor</span>(<span class="keyword">double</span> x, <span class="keyword">double</span> y):</span><br><span class="line">    <span class="built_in">m_x</span>(x), <span class="built_in">m_y</span>(y) &#123;    &#125;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">if</span> 0</span></span><br><span class="line">    <span class="comment">// 开始我是这么写的，没弄清残差的维度</span></span><br><span class="line">    <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt; <span class="keyword">bool</span> <span class="title">operator</span><span class="params">()</span><span class="params">( <span class="keyword">const</span> T* <span class="keyword">const</span> a, </span></span></span><br><span class="line"><span class="params"><span class="function">                                          <span class="keyword">const</span> T* <span class="keyword">const</span> b, </span></span></span><br><span class="line"><span class="params"><span class="function">                                          <span class="keyword">const</span> T* <span class="keyword">const</span> c, </span></span></span><br><span class="line"><span class="params"><span class="function">                                          T* residual)</span>  <span class="keyword">const</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        residual[<span class="number">0</span>] = m_y - <span class="built_in">exp</span>(a[<span class="number">0</span>] * m_x * m_x + b[<span class="number">0</span>] * m_x + c[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 因为要传入数据(x,y)， 所以要定义两个成员变量</span></span><br><span class="line">    <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt; <span class="keyword">bool</span> <span class="title">operator</span><span class="params">()</span><span class="params">( <span class="keyword">const</span> T* <span class="keyword">const</span> abc, T* residual)</span>  <span class="keyword">const</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        residual[<span class="number">0</span>] = m_y - <span class="built_in">exp</span>(abc[<span class="number">0</span>] * m_x * m_x + abc[<span class="number">1</span>] * m_x + abc[<span class="number">2</span>]);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">double</span> m_x, m_y;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>因为自变量x是一维的，而不是向量，所以残差只计算一维 <code>residual[0]</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Problem problem;</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">unsigned</span> <span class="keyword">int</span> i=<span class="number">0</span>; i&lt;N; i++)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// 残差维度， 所估计变量的维度</span></span><br><span class="line">  CostFunction* cost_func = <span class="keyword">new</span> AutoDiffCostFunction&lt;Functor,<span class="number">1</span>,<span class="number">3</span>&gt;(<span class="keyword">new</span> <span class="built_in">Functor</span>(x_data[i], y_data[i]) );</span><br><span class="line">  problem.<span class="built_in">AddResidualBlock</span>(cost_func, <span class="literal">nullptr</span>, abc);</span><br><span class="line">&#125;</span><br><span class="line">Solver::Options option;</span><br><span class="line">option.minimizer_progress_to_stdout = <span class="literal">true</span>;</span><br><span class="line">option.linear_solver_type = ceres::SPARSE_NORMAL_CHOLESKY;</span><br><span class="line"></span><br><span class="line">Solver::Summary summary;</span><br><span class="line"><span class="built_in">Solve</span>(option, &amp;problem, &amp;summary);</span><br><span class="line"></span><br><span class="line">cout &lt;&lt; summary.<span class="built_in">BriefReport</span>() &lt;&lt; endl &lt;&lt;endl;</span><br><span class="line">cout &lt;&lt; <span class="string">&quot;a: &quot;</span>&lt;&lt; abc[<span class="number">0</span>] &lt;&lt;<span class="string">&quot;  b: &quot;</span>&lt;&lt; abc[<span class="number">1</span>]&lt;&lt; <span class="string">&quot;  c: &quot;</span>&lt;&lt; abc[<span class="number">2</span>] &lt;&lt;endl;</span><br></pre></td></tr></table></figure>
<p>参考：<br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/vivian187/p/15331181.html">Curve Fitting(曲线拟合)</a><br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/vivian187/p/15394000.html">Problem类</a><br><a target="_blank" rel="noopener" href="https://www.zybuluo.com/iStarLee/note/1639516#88-evaluate%E7%9B%B8%E5%85%B3">资料</a></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2022/04/18/%E6%BF%80%E5%85%89SLAM/Hector/">Hector</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-04-18</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E6%BF%80%E5%85%89SLAM/">激光SLAM</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E6%BF%80%E5%85%89SLAM/%E5%85%B6%E4%BB%96/">其他</a></span><div class="content"><p>hector相当于cartographer的前端，没有闭环检测，利用高斯牛顿方法来解决scan-matching的问题。它要求激光雷达的扫描频率比较高，建图时机器人速度需要很慢，但在机器人快速转弯时容易发生错误，原因在于优化算法容易陷入局部最小值。使用了多分辨率地图，也可以没有里程计。</p>
<p>论文的新颖点在于scanMatch使用<strong>高斯牛顿法</strong>以及<strong>多分辨率地图</strong>，后来被cartographer借鉴。</p>
<p><img src="https://s2.loli.net/2022/04/18/BJeNV18bKDCqHEn.png" alt="对向量求导.png"></p>
<h2 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h2><ol>
<li>hector的计算太慢了，只进行扫描匹配的操作就要花费大概0.1秒钟，这就导致即使雷达频率再高，hector也处理不过来</li>
<li>hector的地图不能自动更改大小，地图的大小在初始化之后始终是固定的</li>
<li>适用于非光滑线性逼近的地图梯度∇M(Si(ε))，这意味着不能保证局部二次收敛到最小，但该算法在实践中精度较高。</li>
</ol>
<p>参考：<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/tiancailx/article/details/113522899">李想对hector的分析</a><br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/dlutjwh/p/10962026.html">论文阅读：hector_slam</a></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2022/04/15/%E6%BF%80%E5%85%89SLAM/Cartographer/%E5%8E%9F%E7%90%86%E5%92%8C%E9%85%8D%E7%BD%AE/cartographer_grpc_server%E7%9A%84%E9%85%8D%E7%BD%AE/">cartographer_grpc_server的使用和配置</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-04-15</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E6%BF%80%E5%85%89SLAM/">激光SLAM</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E6%BF%80%E5%85%89SLAM/Cartographer/">Cartographer</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E6%BF%80%E5%85%89SLAM/Cartographer/%E5%8E%9F%E7%90%86%E5%92%8C%E9%85%8D%E7%BD%AE/">原理和配置</a></span><div class="content"><p>使用gRPC与云端结合：cartographer使用Protobuf数据传输协议，所以可以使用gRPC（也是谷歌的），可以通过云端运行cartographer算法，最典型的例子就是多机器人在一张已知地图上进行导航，在一个远程的强大centralized localization server运行 multi-trajectories Cartographer</p>
<p>方案：一台机器运行local optimization，另一台运行 global optimization</p>
<p>Cloud-based mapping ，using a gRPC streaming connection between local and global SLAM to propagate sensor data and local SLAM updates, which does not support ACKs and resending, hence this is not going to work over spotty WiFi.<br><img src="https://s2.loli.net/2022/04/15/luS9ofiMEh5c2mR.png" alt=""></p>
<p>先安装<code>protobuf</code>和<code>ceres</code></p>
<h2 id="安装-grpc"><a href="#安装-grpc" class="headerlink" title="安装 grpc"></a>安装 grpc</h2><p>一开始下载<code>grpc</code>后进行编译，结果报错：<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CMake Warning at cmake/abseil-cpp.cmake:30 (message):</span><br><span class="line">  gRPC_ABSL_PROVIDER is <span class="string">&quot;module&quot;</span> but ABSL_ROOT_DIR is wrong</span><br><span class="line">Call Stack (most recent call first):</span><br><span class="line">  CMakeLists.txt:188 (include)</span><br></pre></td></tr></table></figure><br>这说明第三方库没准备好，最好按如下步骤：</p>
<p>如果只想下载指定版本的，如以版本<code>1.27.3</code>为例，可改成如下语句：<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone -b v1<span class="number">.27</span><span class="number">.0</span> https:<span class="comment">//github.com/grpc/grpc.git</span></span><br></pre></td></tr></table></figure><br>上列操作成功完成后，gRPC 源码的第三方依赖目录 <code>third_party</code> 实际是空的，需通过下列步骤拉取依赖的第三方。切换到 grpc 目录，下载 grpc 第三方依赖到本地：<br><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git submodule update --init</span><br></pre></td></tr></table></figure><br>grpc依赖的第三方库有点多，如果不借助<code>git submodule</code>，手工一个个下载不太容易。其中的<code>bloaty</code>库很大。</p>
<p>注意，gRPC 要求 <code>CMake 3.5.1</code> 或以上版本的CMake，否则会报错 CMake 3.5.1 or higher is required </p>
<p>编译：<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cmake -DgRPC_SSL_PROVIDER=package ..</span><br><span class="line">make -j8</span><br><span class="line">sudo make install</span><br><span class="line"></span><br><span class="line">cmake  -DgRPC_INSTALL=ON -DgRPC_ZLIB_PROVIDER=package -DgRPC_CARES_PROVIDER=package -DgRPC_PROTOBUF_PROVIDER=package -DgRPC_SSL_PROVIDER=package -DgRPC_ABSL_PROVIDER=package ..</span><br><span class="line">make -j8</span><br><span class="line">sudo make install</span><br><span class="line"></span><br><span class="line">cmake  -DgRPC_INSTALL=ON -DBUILD_SHARED_LIBS=ON -DgRPC_ZLIB_PROVIDER=package -DgRPC_CARES_PROVIDER=package -DgRPC_PROTOBUF_PROVIDER=package -DgRPC_SSL_PROVIDER=package -DgRPC_ABSL_PROVIDER=package ..</span><br><span class="line">make -j8</span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure></p>
<h2 id="CMake配置"><a href="#CMake配置" class="headerlink" title="CMake配置"></a>CMake配置</h2><p>在包含<code>option(BUILD_GRPC &quot;build Cartographer gRPC support&quot; false)</code>的3个<code>CMakeLists</code>修改为true。 最好再添加 <code>set(BUILD_GRPC true)</code>，以及C++14的支持  <code>set(CMAKE_CXX_STANDARD 14)</code></p>
<h2 id="lua配置"><a href="#lua配置" class="headerlink" title="lua配置"></a>lua配置</h2><p><code>backpack_2d_server.lua</code>如下:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">include <span class="string">&quot;map_builder_server.lua&quot;</span></span><br><span class="line"></span><br><span class="line">MAP_BUILDER_SERVER.map_builder.use_trajectory_builder_2d = <span class="keyword">true</span></span><br><span class="line"><span class="keyword">return</span> MAP_BUILDER_SERVER</span><br></pre></td></tr></table></figure></p>
<p><code>map_builder_server.lua</code>如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">include <span class="string">&quot;map_builder.lua&quot;</span></span><br><span class="line"></span><br><span class="line">MAP_BUILDER_SERVER = &#123;</span><br><span class="line">  map_builder = MAP_BUILDER,</span><br><span class="line">  num_event_threads = <span class="number">4</span>,</span><br><span class="line">  num_grpc_threads = <span class="number">4</span>,</span><br><span class="line">  --- 我的修改</span><br><span class="line">  server_address = <span class="string">&quot;192.168.0.105:50051&quot;</span>,</span><br><span class="line">  uplink_server_address = <span class="string">&quot;&quot;</span>,</span><br><span class="line">  upload_batch_size = <span class="number">100</span>,</span><br><span class="line">  enable_ssl_encryption = <span class="keyword">false</span>,</span><br><span class="line">  enable_google_auth = <span class="keyword">false</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="运行数据集"><a href="#运行数据集" class="headerlink" title="运行数据集"></a>运行数据集</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">roslaunch cartographer_ros grpc_demo_backpack_2d.launch bag_filename:=/home/user/cartographer/dataset/cartographer_paper_deutsches_museum.bag</span><br></pre></td></tr></table></figure>
<p>这是在一台机上运行客户端和服务端<br><img src="https://s2.loli.net/2022/08/21/thAPe3QlsTKYyRc.png" alt=""><br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">launch</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">&quot;/use_sim_time&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">&quot;robot_description&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">textfile</span>=<span class="string">&quot;$(find cartographer_ros)/urdf/backpack_2d.urdf&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">node</span> <span class="attr">name</span>=<span class="string">&quot;robot_state_publisher&quot;</span> <span class="attr">pkg</span>=<span class="string">&quot;robot_state_publisher&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">type</span>=<span class="string">&quot;robot_state_publisher&quot;</span> /&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- 服务端 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">node</span> <span class="attr">name</span>=<span class="string">&quot;cartographer_grpc_server&quot;</span> <span class="attr">pkg</span>=<span class="string">&quot;cartographer_ros&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">type</span>=<span class="string">&quot;cartographer_grpc_server.sh&quot;</span> <span class="attr">args</span>=<span class="string">&quot;</span></span></span><br><span class="line"><span class="string"><span class="tag">          -configuration_directory $(find cartographer_ros)/configuration_files</span></span></span><br><span class="line"><span class="string"><span class="tag">          -configuration_basename backpack_2d_server.lua&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">node</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- 客户端 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">node</span> <span class="attr">name</span>=<span class="string">&quot;cartographer_grpc_node&quot;</span> <span class="attr">pkg</span>=<span class="string">&quot;cartographer_ros&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">type</span>=<span class="string">&quot;cartographer_grpc_node&quot;</span> <span class="attr">args</span>=<span class="string">&quot;</span></span></span><br><span class="line"><span class="string"><span class="tag">    -client_id CLIENT_ID</span></span></span><br><span class="line"><span class="string"><span class="tag">          -configuration_directory $(find cartographer_ros)/configuration_files</span></span></span><br><span class="line"><span class="string"><span class="tag">          -configuration_basename backpack_2d.lua&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">output</span>=<span class="string">&quot;screen&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">remap</span> <span class="attr">from</span>=<span class="string">&quot;echoes&quot;</span> <span class="attr">to</span>=<span class="string">&quot;horizontal_laser_2d&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">node</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">node</span> <span class="attr">name</span>=<span class="string">&quot;playbag&quot;</span> <span class="attr">pkg</span>=<span class="string">&quot;rosbag&quot;</span> <span class="attr">type</span>=<span class="string">&quot;play&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">args</span>=<span class="string">&quot;--clock $(arg bag_filename)&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">node</span> <span class="attr">name</span>=<span class="string">&quot;rviz&quot;</span> <span class="attr">pkg</span>=<span class="string">&quot;rviz&quot;</span> <span class="attr">type</span>=<span class="string">&quot;rviz&quot;</span> <span class="attr">required</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">args</span>=<span class="string">&quot;-d $(find cartographer_ros)/configuration_files/demo_2d.rviz&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">launch</span>&gt;</span></span><br></pre></td></tr></table></figure><br>就是<code>CLIENT_ID</code>，无需设置为数字。</p>
<h2 id="真实运行"><a href="#真实运行" class="headerlink" title="真实运行"></a>真实运行</h2><ul>
<li>把客户端上的<code>ROS_MASTER_URI</code>设置为服务端的IP</li>
<li>rviz放在服务端。</li>
<li>服务端的终端刷新日志，客户端不刷新</li>
<li>网络不能差，否则服务端刷新慢。</li>
<li>连接成功后，关服务端，客户端也会终止。连接成功后，关客户端，服务端停止刷新；再启动客户端，服务端继续更新。</li>
</ul>
<p>客户端<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">launch</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">node</span> <span class="attr">name</span>=<span class="string">&quot;cartographer_grpc_node&quot;</span> <span class="attr">pkg</span>=<span class="string">&quot;cartographer_ros&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">type</span>=<span class="string">&quot;cartographer_grpc_node&quot;</span> <span class="attr">args</span>=<span class="string">&quot;</span></span></span><br><span class="line"><span class="string"><span class="tag">      -client_id CLIENT_ID</span></span></span><br><span class="line"><span class="string"><span class="tag">      -server_address 192.168.1.213:50051</span></span></span><br><span class="line"><span class="string"><span class="tag">          -configuration_directory $(find cartographer_ros)/configuration_files</span></span></span><br><span class="line"><span class="string"><span class="tag">          -configuration_basename backpack_2d.lua&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">output</span>=<span class="string">&quot;screen&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">remap</span> <span class="attr">from</span>=<span class="string">&quot;/scan&quot;</span> <span class="attr">to</span>=<span class="string">&quot;/sick_tim551_scan&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">remap</span> <span class="attr">from</span>=<span class="string">&quot;/odom&quot;</span> <span class="attr">to</span>=<span class="string">&quot;/odometry/filtered&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">node</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">launch</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>服务端<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">launch</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">node</span> <span class="attr">name</span>=<span class="string">&quot;cartographer_grpc_server&quot;</span> <span class="attr">pkg</span>=<span class="string">&quot;cartographer_ros&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">type</span>=<span class="string">&quot;cartographer_grpc_server.sh&quot;</span> <span class="attr">args</span>=<span class="string">&quot;</span></span></span><br><span class="line"><span class="string"><span class="tag">          -configuration_directory $(find cartographer_ros)/configuration_files</span></span></span><br><span class="line"><span class="string"><span class="tag">          -configuration_basename backpack_2d_server.lua&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">node</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">node</span> <span class="attr">name</span>=<span class="string">&quot;rviz&quot;</span> <span class="attr">pkg</span>=<span class="string">&quot;rviz&quot;</span> <span class="attr">type</span>=<span class="string">&quot;rviz&quot;</span> <span class="attr">required</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">args</span>=<span class="string">&quot;-d $(find cartographer_ros)/configuration_files/demo_2d.rviz&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">launch</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<h2 id="纯定位"><a href="#纯定位" class="headerlink" title="纯定位"></a>纯定位</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">node</span> <span class="attr">name</span>=<span class="string">&quot;cartographer_grpc_node&quot;</span> <span class="attr">pkg</span>=<span class="string">&quot;cartographer_ros&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">type</span>=<span class="string">&quot;cartographer_grpc_node&quot;</span> <span class="attr">args</span>=<span class="string">&quot;</span></span></span><br><span class="line"><span class="string"><span class="tag">        -client_id CLIENT_ID</span></span></span><br><span class="line"><span class="string"><span class="tag">        -configuration_directory $(find cartographer_ros)/configuration_files</span></span></span><br><span class="line"><span class="string"><span class="tag">        -configuration_basename backpack_2d_localization.lua</span></span></span><br><span class="line"><span class="string"><span class="tag">        -load_state_filename $(arg load_state_filename)&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">output</span>=<span class="string">&quot;screen&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">remap</span> <span class="attr">from</span>=<span class="string">&quot;echoes&quot;</span> <span class="attr">to</span>=<span class="string">&quot;horizontal_laser_2d&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">node</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>参考：<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/windxf/article/details/108868236">运行cartographer的gRPC demo</a><br><a target="_blank" rel="noopener" href="http://txgcwm.github.io/blog/2014/03/26/ubuntuxia-an-zhuang-c-aresku/">Ubuntu下安装c-ares库</a></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2022/04/15/%E6%BF%80%E5%85%89SLAM/Cartographer/%E5%8E%9F%E7%90%86%E5%92%8C%E9%85%8D%E7%BD%AE/%E5%A6%82%E4%BD%95%E6%89%93%E5%8D%B0%E5%BD%93%E5%89%8D%E4%BD%BF%E7%94%A8%E7%9A%84lua%E5%8F%82%E6%95%B0/">如何打印当前使用的lua参数</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-04-15</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E6%BF%80%E5%85%89SLAM/">激光SLAM</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E6%BF%80%E5%85%89SLAM/Cartographer/">Cartographer</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E6%BF%80%E5%85%89SLAM/Cartographer/%E5%8E%9F%E7%90%86%E5%92%8C%E9%85%8D%E7%BD%AE/">原理和配置</a></span><div class="content"><p>这里就是使用<code>cartographer_print_configuration</code>，它输出了当前cartographer使用的所有lua参数，虽然不如rosparam强大，但也是一种方法，本质就是读取加载的lua文件。</p>
<p>代码比较简单，不用太过研究，直接写launch<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">launch</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">node</span> <span class="attr">name</span>=<span class="string">&quot;print_mit_config&quot;</span> <span class="attr">pkg</span>=<span class="string">&quot;cartographer_ros&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">type</span>=<span class="string">&quot;cartographer_print_configuration&quot;</span> <span class="attr">args</span>=<span class="string">&quot;</span></span></span><br><span class="line"><span class="string"><span class="tag">          -configuration_directories $(find cartographer_ros)/configuration_files</span></span></span><br><span class="line"><span class="string"><span class="tag">          -configuration_basename mit_stata_odom.lua</span></span></span><br><span class="line"><span class="string"><span class="tag">	  	  -subdictionary map_builder&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">output</span>=<span class="string">&quot;screen&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">node</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">launch</span>&gt;</span></span><br></pre></td></tr></table></figure><br>运行后会报错，找不到<code>cartographer_print_configuration</code>，这是因为可执行文件在bin路径: <code>/home/user/carto_ws/install_isolated/bin/cartographer_print_configuration</code>，roslaunch找的是<code>/home/user/carto_ws/install_isolated/lib/cartographer_ros</code>路径下的文件，复制到这里就好了。</p>
<p>运行launch就会输出所有lua参数，自己设置的参数也会覆盖默认的。 另外还有个<code>subdictionary</code>参数，输出的是子参数，这里用map_builder。但是只能输出第一级的子参数，如果自参数太底层就会报错，比如<code>submaps</code>做子参数就会运行错误。</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2022/04/13/%E6%BF%80%E5%85%89SLAM/LOAM%E7%B3%BB%E5%88%97/%E7%82%B9%E4%BA%91%E5%9C%B0%E5%9B%BE/">点云地图</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-04-13</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/LOAM%E7%B3%BB%E5%88%97/">LOAM系列</a></span><div class="content"><ul>
<li><p>去除噪点：激光雷达扫的点云有很多噪点，需要用PCL移除噪点。有的是孤立点，有的是激光打到边缘产生的衍射现象，衍射产生的点也要移除。</p>
</li>
<li><p>降采样：激光的数据量很大，需要用Voxel进行降采样</p>
</li>
<li><p>移除行人： 动态障碍，没必要采用</p>
</li>
<li><p>移除地面： 地面不是重要的参考，也要移除</p>
</li>
<li><p>点云变换和增量式注册： </p>
</li>
<li><p>mesh化： 点云地图建好后，把点云用边连起来，形成三维模型，再用Matlab进行处理</p>
</li>
</ul>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2022/04/13/%E6%BF%80%E5%85%89SLAM/Cartographer/%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/cartographer_occupancy_grid_node%E8%8E%B7%E5%8F%96%E5%9C%B0%E5%9B%BE/">cartographer_occupancy_grid_node获取地图</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-04-13</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E6%BF%80%E5%85%89SLAM/">激光SLAM</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E6%BF%80%E5%85%89SLAM/Cartographer/">Cartographer</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E6%BF%80%E5%85%89SLAM/Cartographer/%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/">源码解读</a></span><div class="content"><p>Rviz中的地图绘制使用了<code>cairo</code>库。注意gflag的参数<code>include_frozen_submaps</code> 和 <code>include_unfrozen_submaps</code>不能都为false，否则会报错</p>
<p>cartographer<em>rviz的绘制方式，就是`submap_node</em><code>控制一个子图的绘制，每个子图有一个子图原点，这个是</code>submap_query<code>中的</code>slice_pose<code>。而每个子图之间是有微弱旋转的，而控制旋转的中心也是这个</code>slice_pose<code>。而每个子图之间的旋转和平移可以通过</code>submap_list`的pose得到。</p>
<p><code>main</code>函数值得看的就一句<code>::cartographer_ros::Node node(FLAGS_resolution, FLAGS_publish_period_sec);</code>，构造函数如下<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">Node::<span class="built_in">Node</span>(<span class="keyword">const</span> <span class="keyword">double</span> resolution, <span class="keyword">const</span> <span class="keyword">double</span> publish_period_sec)</span><br><span class="line">: <span class="built_in">resolution_</span>(resolution),</span><br><span class="line">	<span class="comment">// submap_query 服务的客户端</span></span><br><span class="line">  <span class="built_in">client_</span>(node_handle_.serviceClient&lt;::cartographer_ros_msgs::SubmapQuery&gt;(</span><br><span class="line">      kSubmapQueryServiceName)),</span><br><span class="line">  <span class="comment">// submap_list话题的订阅者，回调函数 HandleSubmapList</span></span><br><span class="line">  <span class="built_in">submap_list_subscriber_</span>(node_handle_.<span class="built_in">subscribe</span>(</span><br><span class="line">      kSubmapListTopic, kLatestOnlyPublisherQueueSize,</span><br><span class="line">      boost::function&lt;<span class="built_in"><span class="keyword">void</span></span>(</span><br><span class="line">          <span class="keyword">const</span> cartographer_ros_msgs::SubmapList::ConstPtr&amp;)&gt;(</span><br><span class="line">          [<span class="keyword">this</span>](<span class="keyword">const</span> cartographer_ros_msgs::SubmapList::ConstPtr&amp; msg) &#123;</span><br><span class="line">            <span class="built_in">HandleSubmapList</span>(msg);</span><br><span class="line">          &#125;))),</span><br><span class="line">  <span class="comment">// 发布话题 map</span></span><br><span class="line">  <span class="built_in">occupancy_grid_publisher_</span>(</span><br><span class="line">      node_handle_.advertise&lt;::nav_msgs::OccupancyGrid&gt;(</span><br><span class="line">          kOccupancyGridTopic, kLatestOnlyPublisherQueueSize,</span><br><span class="line">          <span class="literal">true</span> <span class="comment">/* latched */</span>)),</span><br><span class="line">  <span class="comment">// timer执行DrawAndPublish函数</span></span><br><span class="line">  <span class="built_in">occupancy_grid_publisher_timer_</span>(</span><br><span class="line">      node_handle_.<span class="built_in">createWallTimer</span>(::ros::<span class="built_in">WallDuration</span>(publish_period_sec),</span><br><span class="line">                                   &amp;Node::DrawAndPublish, <span class="keyword">this</span>)) &#123;&#125;</span><br></pre></td></tr></table></figure><br><code>Node::DrawAndPublish</code>是画图和发布<code>map</code>，不是重点</p>
<p><br></p>
<p><code>HandleSubmapList</code>函数大部分都很简单，终点是下面这句：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">auto</span> fetched_textures =</span><br><span class="line">        ::cartographer_ros::<span class="built_in">FetchSubmapTextures</span>(id, &amp;client_);</span><br></pre></td></tr></table></figure><br>内部其实就是<code>submap_query</code>的客户端发起请求，服务端的注册在<code>Node</code>的构造函数里，回调是<code>Node::HandleSubmapQuery</code></p>
<p>代码调用顺序是： <code>Node::HandleSubmapQuery</code> —— <code>MapBuilderBridge::HandleSubmapQuery</code> —— <code>MapBuilder::SubmapToProto</code> —— <code>PoseGraph2D::GetSubmapData</code> 和 <code>Submap2D::ToResponseProto</code>  —— <code>ProbabilityGrid::DrawToSubmapTexture</code></p>
<p>重点：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这里比较简单，最终返回的是后端传来的 global坐标系下的位姿</span></span><br><span class="line"><span class="function">PoseGraphInterface::SubmapData <span class="title">PoseGraph2D::GetSubmapDataUnderLock</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">const</span> SubmapId&amp; submap_id)</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">auto</span> it = data_.submap_data.<span class="built_in">find</span>(submap_id);</span><br><span class="line">  <span class="keyword">if</span> (it == data_.submap_data.<span class="built_in">end</span>())</span><br><span class="line">      <span class="keyword">return</span> &#123;&#125;;</span><br><span class="line">  <span class="keyword">auto</span> submap = it-&gt;data.submap;</span><br><span class="line">  <span class="keyword">if</span> (data_.global_submap_poses_2d.<span class="built_in">Contains</span>(submap_id) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// We already have an optimized pose.</span></span><br><span class="line">    <span class="keyword">return</span> &#123;submap,</span><br><span class="line">            transform::<span class="built_in">Embed3D</span>(</span><br><span class="line">                data_.global_submap_poses_2d.<span class="built_in">at</span>(submap_id).global_pose) &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// We have to extrapolate.</span></span><br><span class="line">  <span class="keyword">return</span> &#123;submap, <span class="built_in">ComputeLocalToGlobalTransform</span>(data_.global_submap_poses_2d,</span><br><span class="line">                                                submap_id.trajectory_id) *</span><br><span class="line">                      submap-&gt;<span class="built_in">local_pose</span>() &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Submap2D::ToResponseProto</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">const</span> transform::Rigid3d&amp;,</span></span></span><br><span class="line"><span class="params"><span class="function">    proto::SubmapQuery::Response* <span class="keyword">const</span> response)</span> <span class="keyword">const</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!grid_)  	<span class="keyword">return</span>;</span><br><span class="line">  <span class="comment">// 这个 version 是子图插入了多少雷达数据，完成的子图是 2* num_range_data</span></span><br><span class="line">  response-&gt;<span class="built_in">set_submap_version</span>( <span class="built_in">num_range_data</span>()  );</span><br><span class="line">  proto::SubmapQuery::Response::SubmapTexture* <span class="keyword">const</span> texture =</span><br><span class="line">      response-&gt;<span class="built_in">add_textures</span>();</span><br><span class="line">  <span class="built_in">grid</span>()-&gt;<span class="built_in">DrawToSubmapTexture</span>(texture, <span class="built_in">local_pose</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>再看<code>DrawToSubmapTexture</code><br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">ProbabilityGrid::DrawToSubmapTexture</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    proto::SubmapQuery::Response::SubmapTexture* <span class="keyword">const</span> texture,</span></span></span><br><span class="line"><span class="params"><span class="function">    transform::Rigid3d local_pose)</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  Eigen::Array2i offset;</span><br><span class="line">  CellLimits cell_limits;</span><br><span class="line">  <span class="built_in">ComputeCroppedLimits</span>(&amp;offset, &amp;cell_limits);</span><br><span class="line"></span><br><span class="line">  std::string cells;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> Eigen::Array2i&amp; xy_index : <span class="built_in">XYIndexRangeIterator</span>(cell_limits))</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">IsKnown</span>(xy_index + offset)) &#123;</span><br><span class="line">      cells.<span class="built_in">push_back</span>(<span class="number">0</span> <span class="comment">/* unknown log odds value */</span>);</span><br><span class="line">      cells.<span class="built_in">push_back</span>(<span class="number">0</span> <span class="comment">/* alpha */</span>);</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// We would like to add &#x27;delta&#x27; but this is not possible using a value and</span></span><br><span class="line">    <span class="comment">// alpha. We use premultiplied alpha, so when &#x27;delta&#x27; is positive we can</span></span><br><span class="line">    <span class="comment">// add it by setting &#x27;alpha&#x27; to zero. If it is negative, we set &#x27;value&#x27; to</span></span><br><span class="line">    <span class="comment">// zero, and use &#x27;alpha&#x27; to subtract. This is only correct when the pixel</span></span><br><span class="line">    <span class="comment">// is currently white, so walls will look too gray. This should be hard to</span></span><br><span class="line">    <span class="comment">// detect visually for the user, though.</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// delta范围[-127, 127]</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> delta =</span><br><span class="line">        <span class="number">128</span> - <span class="built_in">ProbabilityToLogOddsInteger</span>(<span class="built_in">GetProbability</span>(xy_index + offset));</span><br><span class="line">    <span class="keyword">const</span> uint8 alpha = delta &gt; <span class="number">0</span> ? <span class="number">0</span> : -delta;</span><br><span class="line">    <span class="keyword">const</span> uint8 value = delta &gt; <span class="number">0</span> ? delta : <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 存数据有2个值，栅格值value和alpha透明度</span></span><br><span class="line">    cells.<span class="built_in">push_back</span>(value);</span><br><span class="line">    cells.<span class="built_in">push_back</span>((value || alpha) ? alpha : <span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 保存地图栅格数据时进行压缩</span></span><br><span class="line">  common::<span class="built_in">FastGzipString</span>(cells, texture-&gt;<span class="built_in">mutable_cells</span>());</span><br><span class="line">  <span class="comment">// 地图描述信息赋值，省略</span></span><br><span class="line">  	......</span><br><span class="line">  *texture-&gt;<span class="built_in">mutable_slice_pose</span>() = transform::<span class="built_in">ToProto</span>(</span><br><span class="line">      local_pose.<span class="built_in">inverse</span>() *</span><br><span class="line">      transform::Rigid3d::<span class="built_in">Translation</span>(Eigen::<span class="built_in">Vector3d</span>(max_x, max_y, <span class="number">0.</span>))  );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 解压后的栅格数据</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">SubmapTexture</span> &#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">Pixels</span> &#123;</span></span><br><span class="line">    std::vector&lt;<span class="keyword">char</span>&gt; intensity;   <span class="comment">// 栅格值</span></span><br><span class="line">    std::vector&lt;<span class="keyword">char</span>&gt; alpha;      <span class="comment">// 透明度</span></span><br><span class="line">  &#125;;</span><br><span class="line">  Pixels pixels;</span><br><span class="line">  <span class="keyword">int</span> width;</span><br><span class="line">  <span class="keyword">int</span> height;</span><br><span class="line">  <span class="keyword">double</span> resolution;</span><br><span class="line">  ::cartographer::transform::Rigid3d slice_pose;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 压缩后的栅格数据</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">SubmapTextures</span> &#123;</span></span><br><span class="line">  <span class="keyword">int</span> version;</span><br><span class="line">  std::vector&lt;SubmapTexture&gt; textures;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2022/04/10/%E8%8B%B1%E8%AF%AD/Bad%20%20Blood%E5%8D%95%E8%AF%8D/">Bad  Blood单词</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-04-10</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E8%8B%B1%E8%AF%AD/">英语</a></span><div class="content"><ul>
<li>stick up for  &emsp;&emsp;&emsp;  为辩护, 维护</li>
<li>rat sb out &emsp;&emsp;&emsp; 告密，出卖</li>
<li>chill out &emsp;&emsp;&emsp; 冷静下来</li>
<li>keep sb out of loop &emsp;&emsp;&emsp; 把某人排除在核心圈</li>
<li>check on sb &emsp;&emsp;&emsp; 确认某人安全或在正常状态；确认某人在做该做的事</li>
<li>going south &emsp;&emsp;&emsp; 下降，恶化，失败</li>
<li>save the day &emsp;&emsp;&emsp; 解决困难的情况；解除危机</li>
<li>sit something out &emsp;&emsp;&emsp; 不参与活动或事件</li>
<li><p>on the board &emsp;&emsp;&emsp;  在董事会里</p>
</li>
<li><p>flip flops &emsp;&emsp;&emsp;   人字拖</p>
</li>
<li>fix-it man &emsp;&emsp;&emsp;   擅长修东西的人</li>
<li>vible &emsp;&emsp;&emsp; </li>
<li>sign on  &emsp;&emsp;&emsp;  加入工作或其他团体</li>
<li>mock-up  &emsp;&emsp;&emsp;   模型机</li>
<li>employee turnover   &emsp;&emsp;&emsp; 员工离职率</li>
<li>embezzle fund   &emsp;&emsp;&emsp; 挪用资金</li>
<li>brush sb off    &emsp;&emsp;&emsp;  漠视，不理睬</li>
<li>relationship cools   &emsp;&emsp;&emsp;  关系恶化   Ed and Holmes relationship cooled</li>
<li>silos  &emsp;&emsp;&emsp;  (公司、机构或系统内部与其他单位不联系、不了解、不合作的) 孤立单位</li>
<li>snoop &emsp;&emsp;&emsp;   窥探</li>
<li>convene   &emsp;&emsp;&emsp; 召集</li>
<li>pull down the shade  &emsp;&emsp;&emsp;  拉下窗帘</li>
<li>come on board &emsp;&emsp;&emsp;   成为团队的一员</li>
<li>guinea pig   &emsp;&emsp;&emsp;   豚鼠</li>
<li>fine-tune  &emsp;&emsp;&emsp;     微调</li>
<li>ominous &emsp;&emsp;&emsp;   不祥的</li>
<li>flatly &emsp;&emsp;&emsp;   断然地</li>
<li>waive &emsp;&emsp;&emsp;  放弃</li>
<li>hard copy  纸质的    &emsp;&emsp;&emsp; &emsp;&emsp;&emsp; &emsp;&emsp;&emsp;         soft copy  扫描件</li>
<li>broad daylight  &emsp;&emsp;&emsp; 大白天</li>
<li>premises &emsp;&emsp;&emsp; （尤指公司或机构的）房屋连地基，生产场所，经营厂址</li>
<li>talk sense into someone. &emsp;&emsp;&emsp; 帮某人理性思考to help someone to think about a situation in a reasonable way</li>
<li>sell ice to Eskimos &emsp;&emsp;&emsp; 劝人接受不必要的东西</li>
<li>stumbled across  &emsp;&emsp;&emsp;  意外获知某事</li>
<li>stock option &emsp;&emsp;&emsp;  股票期权</li>
<li>in the doghouse &emsp;&emsp;&emsp;  因为惹怒某人而有了麻烦</li>
<li>mortify       &emsp;&emsp;&emsp;    尴尬</li>
<li>technical glitch  &emsp;&emsp;&emsp; 技术上突然的小问题</li>
<li>general counsel  &emsp;&emsp;&emsp;  法律顾问</li>
<li>dying to do   &emsp;&emsp;&emsp;    急切做某事</li>
<li>stormed off &emsp;&emsp;&emsp;  愤怒地离开</li>
<li>relationship begin to fray &emsp;&emsp;&emsp; 关系开始恶化</li>
<li>on the outs  &emsp;&emsp;&emsp;  不再说话或保持友好</li>
<li>steale a glance at   &emsp;&emsp;&emsp;  偷瞄了某人一眼</li>
<li>come out of left field   &emsp;&emsp;&emsp; 完全地令人意外</li>
<li>job blues  &emsp;&emsp;&emsp;  工作中的现实和期望的脱节</li>
<li>red flag  &emsp;&emsp;&emsp;   红旗, 危险信号, 惹人生气的事</li>
<li>tax shelter   &emsp;&emsp;&emsp;  合法的避税手段</li>
<li>point-blank  &emsp;&emsp;&emsp;  直截了当的</li>
<li>cubicle &emsp;&emsp;&emsp;  工作的隔间</li>
<li>brainy &emsp;&emsp;&emsp; 有才能的；十分聰明的</li>
<li>wreak havoc  &emsp;&emsp;&emsp;  严重破坏</li>
<li>RV   房车</li>
<li>bed of pickup   车后面的装卸位置</li>
<li>dude  一般是年轻人说</li>
<li>word around office  &emsp;&emsp;&emsp;  办公室留言</li>
<li>keep afloat with &emsp;&emsp;&emsp;   have sufficient funds to be able to pay your debts and continue as a business</li>
<li><p>shady  &emsp;&emsp;&emsp; 昏暗，阴凉的，不正当的</p>
</li>
<li><p>yelling match  &emsp;&emsp;&emsp;  </p>
</li>
<li>snorting lines of cocaine  &emsp;&emsp;&emsp;  吸食一条条的可卡因</li>
<li>lose steam  &emsp;&emsp;&emsp; 失去動力；頓時洩氣</li>
<li>My Commute Is Killing Me  &emsp;&emsp;&emsp;  通勤累死我了</li>
<li>NDA &emsp;&emsp;&emsp;保密协议</li>
<li>onsite interview  &emsp;&emsp;&emsp; 面对面的面试</li>
<li>wear thin &emsp;&emsp;&emsp;  逐渐失去耐心，不再有效</li>
<li>to top it all off  &emsp;&emsp;&emsp; （后面接的事物会比前面的事物程度更加強烈）更棒的是 或 更糟的是</li>
<li>miss out &emsp;&emsp;&emsp;  错失机会</li>
<li>disclaimer &emsp;&emsp;&emsp;  否认声明，放弃书</li>
<li>lift weight  &emsp;&emsp;&emsp;   举杠铃，举重</li>
<li>drug regimen  &emsp;&emsp;&emsp;  配药方案</li>
<li>bagger &emsp;&emsp;&emsp;  装袋工</li>
<li>be over the moon &emsp;&emsp;&emsp;  十分高兴</li>
<li>black eye on &emsp;&emsp;&emsp;  丢人的事，耻辱</li>
<li>DUI &emsp;&emsp;&emsp;  driving under influence， 酒后驾车，吸毒后驾车</li>
<li>selling point   卖点</li>
<li>rebuff &emsp;&emsp;&emsp;  断然拒绝</li>
<li>Start from scratch  &emsp;&emsp;&emsp;  从零开始</li>
<li>pull cart before horse  &emsp;&emsp;&emsp;   本末倒置，前后顺序颠倒</li>
<li>budge  &emsp;&emsp;&emsp;  轻微移动， 改变主意</li>
<li>lapse into  &emsp;&emsp;&emsp;  陷入（消极的状态）, 显得异常。  例如会议陷入一片沉默</li>
<li>doze off  &emsp;&emsp;&emsp;  （尤指在白天）睡着了</li>
<li>forthright &emsp;&emsp;&emsp;   坦誠的，直率的；直截了當的</li>
<li>nepotism  &emsp;&emsp;&emsp;   任人唯亲，裙带关系</li>
<li>take on a new dimension &emsp;&emsp;&emsp;   达到新高度</li>
<li>from afar &emsp;&emsp;&emsp;  从远处看</li>
<li>hush-hush  &emsp;&emsp;&emsp;   神秘的</li>
<li>slack off    &emsp;&emsp;&emsp;     松懈，懒散</li>
<li>half-mast flag  &emsp;&emsp;&emsp;  降半旗</li>
<li>do bidding</li>
<li>all seeing and all knowing &emsp;&emsp;&emsp;  全知全能的</li>
<li>crowdfunding &emsp;&emsp;&emsp;  众筹的</li>
<li>cynicism &emsp;&emsp;&emsp;  愤世嫉俗</li>
<li>job fair  &emsp;&emsp;&emsp; 招聘会</li>
<li>work sb’s ass off   &emsp;&emsp;&emsp;  拼命地干</li>
<li>roll-up door   &emsp;&emsp;&emsp;      卷帘门</li>
<li>loading dock    &emsp;&emsp;&emsp;    装卸平台</li>
<li>revolving door  &emsp;&emsp;&emsp;    大楼入口的旋转门，短促而快速持续的，走马灯似的</li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
</ul>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2022/04/03/%E6%BF%80%E5%85%89SLAM/Cartographer/%E5%8E%9F%E7%90%86%E5%92%8C%E9%85%8D%E7%BD%AE/MIT%E5%92%8C%E8%BD%AF%E4%BB%B6%E6%89%80%E7%9A%84%E6%95%B0%E6%8D%AE%E9%9B%86/">MIT和软件所的数据集</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-04-03</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E6%BF%80%E5%85%89SLAM/">激光SLAM</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E6%BF%80%E5%85%89SLAM/Cartographer/">Cartographer</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E6%BF%80%E5%85%89SLAM/Cartographer/%E5%8E%9F%E7%90%86%E5%92%8C%E9%85%8D%E7%BD%AE/">原理和配置</a></span><div class="content"><p>根据我的经验，先启动cartographer后，等待出现下面的日志，然后再播放bag。如果这个日志没出现，播放bag通常不会成功开始建图<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[/cartographer_node   node.cc:<span class="number">886</span>] Expected topic <span class="string">&quot;scan&quot;</span> (trajectory <span class="number">0</span>) (resolved topic <span class="string">&quot;/base_scan&quot;</span>) but no publisher is currently active.</span><br><span class="line">[/cartographer_node   node.cc:<span class="number">895</span>] Currently available topics are: /constraint_list,/submap_list,/scan_matched_points2,/rosout,/tf,/rosout_agg,/map,/trajectory_node_list,/landmark_poses_list,</span><br></pre></td></tr></table></figure></p>
<p><strong>MIT数据集老出问题，德意志博物馆数据集却从不出问题</strong>， <font size="4" color="blue"> 最好数据集里不要有tf信息  </font><br><img src="https://s2.loli.net/2022/11/17/yG1RzQxHUSkYjcV.png" alt="博物馆的tf"><br><img src="https://s2.loli.net/2022/11/17/BnvgP4eVhTL9JG6.png" alt="MIT数据集的 tf"></p>
<p>博物馆的地图大小 3066平方米</p>
<h2 id="MIT的数据集运行"><a href="#MIT的数据集运行" class="headerlink" title="MIT的数据集运行"></a>MIT的数据集运行</h2><p>这个数据集使用雷达北洋UTM-30LX，也就是LOAM论文所用的雷达，有一个问题是它的机器人是会坐电梯在楼层之间跑的，因此需要选择一个只在一个平面上跑的数据集<code>2011-03-28-08-38-59.bag</code></p>
<p>从TF变换树可以看到，这里的里程计信息是采用经过EKF滤波之后的里程计坐标系<code>/robot_pose_ekf/odom_combined</code>，而不是直接的<code>base_odometry/odom</code>。<strong>第2个问题</strong>来了：cartographer需要的里程计消息是<code>nav_msgs/Odometry</code>，但是<code>/robot_pose_ekf/odom_combined</code>的类型是<code>geometry_msgs/PoseWithCovarianceStamped</code>，在播放rosbag时会报错，无法建图。于是想用原来的里程计<code>/base_odometry/odom</code>，结果发现缺少<code>child_frame_id</code>，一般为<code>base_link</code>。无法给bag消息加坐标系，只能写一个程序<code>mit_to_odom</code>做转换</p>
<p>我们要使用数据集的IMU和odom，否则建图不能进行，日志如下<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[/cartographer_node] [local_trajectory_builder_2d.cc:<span class="number">136</span>] time_first_point: <span class="number">634369235390529797</span></span><br><span class="line">[/cartographer_node] [local_trajectory_builder_2d.cc:<span class="number">137</span>] GetLastPoseTime: <span class="number">634369235390647384</span></span><br><span class="line">[/cartographer_node] [local_trajectory_builder_2d.cc:<span class="number">138</span>] Extrapolator is still initializing</span><br><span class="line">[/cartographer_node] [pose_graph_2d.cc:<span class="number">148</span>] <span class="function">Inserted <span class="title">submap</span> <span class="params">(<span class="number">0</span>, <span class="number">0</span>)</span>.</span></span><br></pre></td></tr></table></figure><br>阻塞在<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (time_first_point &lt; extrapolator_-&gt;<span class="built_in">GetLastPoseTime</span>() )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">LOG</span>(INFO) &lt;&lt; <span class="string">&quot;Extrapolator is still initializing.&quot;</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>launch如下，不能加<code>&lt;param name=&quot;/use_sim_time&quot; value=&quot;true&quot; /&gt;</code>，否则cartographer一直阻塞。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">launch</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">node</span> <span class="attr">name</span>=<span class="string">&quot;cartographer_node&quot;</span> <span class="attr">pkg</span>=<span class="string">&quot;cartographer_ros&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">type</span>=<span class="string">&quot;cartographer_node&quot;</span> <span class="attr">args</span>=<span class="string">&quot;</span></span></span><br><span class="line"><span class="string"><span class="tag">          -configuration_directory $(find cartographer_ros)/configuration_files</span></span></span><br><span class="line"><span class="string"><span class="tag">          -configuration_basename mit_stata_odom.lua&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">output</span>=<span class="string">&quot;screen&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">remap</span> <span class="attr">from</span>=<span class="string">&quot;scan&quot;</span> <span class="attr">to</span>=<span class="string">&quot;base_scan&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">remap</span> <span class="attr">from</span>=<span class="string">&quot;imu&quot;</span> <span class="attr">to</span>=<span class="string">&quot;torso_lift_imu/data&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">node</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">node</span> <span class="attr">name</span>=<span class="string">&quot;cartographer_occupancy_grid_node&quot;</span> <span class="attr">pkg</span>=<span class="string">&quot;cartographer_ros&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">type</span>=<span class="string">&quot;cartographer_occupancy_grid_node&quot;</span> <span class="attr">args</span>=<span class="string">&quot;-resolution 0.05&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">launch</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<h3 id="TF-REPEATED-DATA-问题"><a href="#TF-REPEATED-DATA-问题" class="headerlink" title="TF_REPEATED_DATA 问题"></a>TF_REPEATED_DATA 问题</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Warning: TF_REPEATED_DATA ignoring data with redundant timestamp <span class="keyword">for</span> frame odom at time <span class="number">1301326803.532597</span> according to authority unknown_publisher</span><br><span class="line">         at line <span class="number">278</span> in /tmp/binarydeb/ros-noetic-tf2-<span class="number">0.7</span><span class="number">.5</span>/src/buffer_core.cpp</span><br></pre></td></tr></table></figure>
<p>这个问题困扰了我好长时间，后来发现是数据集发布了坐标转换<code>odom_combined</code> —— <code>base_footprint</code>，而cartographer也容易发布这个变换，此时仍然可以建图，但这个报警无穷无尽，没法看其他日志了。</p>
<p>如此解决：首先在播放bag的终端，先运行<code>rosparam set use_sim_time true</code>，lua设置如下<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">map_frame = <span class="string">&quot;map&quot;</span>,</span><br><span class="line">tracking_frame = <span class="string">&quot;imu_link&quot;</span>,</span><br><span class="line">published_frame = <span class="string">&quot;odom_combined&quot;</span>,</span><br><span class="line">odom_frame = <span class="string">&quot;odom_combined&quot;</span>,</span><br><span class="line"></span><br><span class="line">provide_odom_frame = <span class="literal">false</span>,  </span><br><span class="line">use_odometry = <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">TRAJECTORY_BUILDER_2D.use_imu_data = <span class="literal">true</span></span><br></pre></td></tr></table></figure></p>
<p>但是Rviz终端也出现了报警，按说把Rviz里的<code>Submaps</code>的Tracking Frame改为lua 文件中的 <code>tracking_frame</code> 即可，但是我改了后无效，把<code>base_footprint</code>和<code>base_link</code>都试了一遍也没有解决<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[ WARN] Could not compute submap fading: Could not find a connection between <span class="string">&#x27;map&#x27;</span> and <span class="string">&#x27;base_link&#x27;</span> because they are not part of the same tree.Tf has two or more unconnected trees</span><br></pre></td></tr></table></figure></p>
<font size="4" color="blue">  这样导致无法获得`base_link`在`map`中的坐标 </font> 


<h3 id="map-和-base-link的关系问题"><a href="#map-和-base-link的关系问题" class="headerlink" title="map 和 base_link的关系问题"></a><code>map</code> 和 <code>base_link</code>的关系问题</h3><p>数据集中已经包含了<code>odom_combined</code>和<code>base_link</code>之间的tf关系，运行carto之后会获得<code>odom_combined</code>和<code>map</code>之间的关系，但是无法获得<code>map</code>和<code>base_link</code>之间的tf，运行<code>rosrun tf tf_echo map base_link</code>报警如下<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Exception thrown:Lookup would require extrapolation <span class="number">367325588.</span>004024029s into the past.  Requested time <span class="number">1301326755.953867912</span> but the earliest data is at time <span class="number">1668652343.957891941</span>, when looking up transform from frame [base_link] to frame [map]</span><br></pre></td></tr></table></figure><br><code>1668652343</code>是当前时间的，<code>1301326755</code>是数据集中的时间。<font size="4" color="orange"> 目前未解决  </font></p>
<h2 id="软件所的数据集运行"><a href="#软件所的数据集运行" class="headerlink" title="软件所的数据集运行"></a>软件所的数据集运行</h2><p><img src="https://s2.loli.net/2022/11/17/SageUnGRjQ3fNDF.png" alt=""><br>不需要在任何地方设置<code>use_sim_time</code>，如果出现时间戳问题，关掉一切节点，重新开始roscore。launch里不能加<code>&lt;param name=&quot;/use_sim_time&quot; value=&quot;true&quot; /&gt;</code>，否则cartographer一直阻塞。</p>
<p>问题:</p>
<ol>
<li><p><code>scan</code>话题里的坐标系是<code>laser</code>，这是驱动程序决定的。但是<code>tf</code>里的坐标系变成了<code>laser_mount_link</code>，到了<code>tf_bridge_.LookupToTracking</code>那里卡住了，即使手动改了源码也不行。</p>
</li>
<li><p>坐标系名称带了<code>/</code>，这个其实在cartographer里会被解决，但是习惯上不要加上。</p>
</li>
<li><p>也无法获得<code>map</code>到<code>base_link</code>的转换。</p>
</li>
<li><p><code>tfecho map odom</code>会发现位姿跳变极大，<font size="4" color="orange">  还没搞清楚， </font>不是是否和时间戳有关<br><img src="https://s2.loli.net/2022/12/21/bXUdoimK3OVIZTw.png" alt=""></p>
</li>
</ol>
<p>参考：<br><a target="_blank" rel="noopener" href="http://wiki.ros.org/tf/Errors%20explained">TF_OLD_DATA 问题</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_55937915/article/details/126875442">TF_OLD_DATA的另一种原因</a></p>
</div><hr></div><nav id="pagination"><div class="pagination"><a class="extend prev" rel="prev" href="/page/17/">&lt;&lt; Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/17/">17</a><span class="page-number current">18</span><a class="page-number" href="/page/19/">19</a><span class="space">&hellip;</span><a class="page-number" href="/page/66/">66</a><a class="extend next" rel="next" href="/page/19/">Next &gt;&gt;</a></div></nav></div></div><footer class="footer-bg" style="background-image: url(https://s2.loli.net/2022/11/17/QOR8cePIS5NdDrK.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2018 - 2023 By Charon Cheung</div><div class="framework-info"><span>Driven - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_site_uv"><i class="fa fa-user"></i><span id="busuanzi_value_site_uv"></span><span></span></span><span class="footer-separator">|</span><span id="busuanzi_container_site_pv"><i class="fa fa-eye"></i><span id="busuanzi_value_site_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.6.1"></script><script src="/js/fancybox.js?version=1.6.1"></script><script src="/js/sidebar.js?version=1.6.1"></script><script src="/js/copy.js?version=1.6.1"></script><script src="/js/fireworks.js?version=1.6.1"></script><script src="/js/transition.js?version=1.6.1"></script><script src="/js/scroll.js?version=1.6.1"></script><script src="/js/head.js?version=1.6.1"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
    processEscapes: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
  },
  CommonHTML: {
    linebreaks: { automatic: true, width: "90% container" }
  },
  "HTML-CSS": { 
    linebreaks: { automatic: true, width: "90% container" }
  },
  "SVG": { 
    linebreaks: { automatic: true, width: "90% container" }
  }
});
</script><script type="text/x-mathjax-config">MathJax.Hub.Queue(function() {
  var all = MathJax.Hub.getAllJax(), i;
  for (i=0; i < all.length; i += 1) {
    all[i].SourceElement().parentNode.className += ' has-jax';
  }
});
</script><script src="https://cdn.bootcss.com/mathjax/2.7.2/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script>if(/Android|webOS|iPhone|iPod|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
}</script></body></html>