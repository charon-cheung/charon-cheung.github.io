<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content=""><meta name="keywords" content=""><meta name="author" content="Charon Cheung"><meta name="copyright" content="Charon Cheung"><title>If you wish for peace, prepare for war | 沉默杀手</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.6.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.6.1"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  }
} </script><meta name="generator" content="Hexo 5.4.0"></head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="author-info"><div class="author-info__avatar text-center"><img src="https://s2.loli.net/2022/02/17/HQaCXUBn64zsMIL.png"></div><div class="author-info__name text-center">Charon Cheung</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">655</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">6</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">52</span></a></div></div></div><nav id="nav" style="background-image: url(https://s2.loli.net/2022/11/17/QOR8cePIS5NdDrK.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">沉默杀手</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span></div><div id="site-info"><div id="site-title">沉默杀手</div><div id="site-sub-title">If you wish for peace, prepare for war</div></div></nav><div id="content-outer"><div class="layout" id="content-inner"><div class="recent-post-item article-container"><a class="article-title" href="/2022/05/10/%E6%BF%80%E5%85%89SLAM/Cartographer/%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/cartographer_offline_node/">cartographer_offline_node</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-05-10</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E6%BF%80%E5%85%89SLAM/">激光SLAM</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E6%BF%80%E5%85%89SLAM/Cartographer/">Cartographer</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E6%BF%80%E5%85%89SLAM/Cartographer/%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/">源码解读</a></span><div class="content"><p><code>cartographer_offline_node</code>对应<code>offline_node_main.cc</code>，它和<code>cartographer_grpc_offline_node</code>对应的<code>offline_node_grpc_main.cc</code>极为相似</p>
<p>在线和离线的建图效果无区别。离线节点直接从bag读取传感器数据，使用了CPU能实现的最大速度处理bag，而且不会丢失消息，不过无法设置速度和看不清建图过程的细节。 如果想控制处理速度，就使用在线节点和<code>rosbag play -r 2</code>，但是如果设置速度太快，可能会丢失消息，这是很常见的。</p>
<p>简单看了源码，离线节点之所以运行快，是因为使用了ROS多线程<code>ros::AsyncSpinner</code>，而在线节点还是普通的ROS程序</p>
<h2 id="运行示例"><a href="#运行示例" class="headerlink" title="运行示例"></a>运行示例</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget -P ~/Downloads https://storage.googleapis.com/cartographer-public-data/bags/backpack_2d/b2-2016-04-05-14-44-52.bag</span><br><span class="line">roslaunch cartographer_ros offline_backpack_2d.launch bag_filenames:=<span class="variable">$&#123;HOME&#125;</span>/Downloads/b2-2016-04-05-14-44-52.bag</span><br></pre></td></tr></table></figure>
<p>此时的CPU占用果然要爆了，所以说只适合运行数据集，不适合需要优化cartographer的场合<br><img src="https://s2.loli.net/2022/05/10/DPjh8Xe9YVdcNIx.png" alt="CPU占用.png"></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;cartographer/mapping/map_builder.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;cartographer_ros/offline_node.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;cartographer_ros/ros_log_sink.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;gflags/gflags.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;ros/ros.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>** argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  google::<span class="built_in">InitGoogleLogging</span>(argv[<span class="number">0</span>]);</span><br><span class="line">  google::<span class="built_in">ParseCommandLineFlags</span>(&amp;argc, &amp;argv, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">  ::ros::<span class="built_in">init</span>(argc, argv, <span class="string">&quot;cartographer_offline_node&quot;</span>);</span><br><span class="line">  ::ros::<span class="built_in">start</span>();</span><br><span class="line">  cartographer_ros::ScopedRosLogSink ros_log_sink;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> cartographer_ros::MapBuilderFactory   map_builder_factory =</span><br><span class="line">      [](<span class="keyword">const</span> ::cartographer::mapping::proto::MapBuilderOptions&amp; </span><br><span class="line">             map_builder_options) &#123;</span><br><span class="line">        <span class="keyword">return</span> absl::make_unique&lt; ::cartographer::mapping::MapBuilder&gt;(</span><br><span class="line">            <span class="keyword">const_cast</span>&lt;::cartographer::mapping::proto::MapBuilderOptions&amp;&gt;(map_builder_options));</span><br><span class="line">      &#125;;</span><br><span class="line">  cartographer_ros::<span class="built_in">RunOfflineNode</span>(map_builder_factory);</span><br><span class="line">  ::ros::<span class="built_in">shutdown</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="参数"><a href="#参数" class="headerlink" title="参数"></a>参数</h2><p><code>RunOfflineNode</code>函数转到了<code>offline_node.cc</code>，这个文件主要就是这个函数。这个文件开头是一堆宏定义，根据字符串解释每个可用的参数</p>
<ul>
<li>configuration_directory</li>
<li>configuration_basenames</li>
<li><p>load_state_filename</p>
</li>
<li><p>bag_filenames: Comma-separated list of bags to process. One bag per trajectory. Any combination of simultaneous and sequential bags is supported.</p>
</li>
<li><p>urdf_filenames: Comma-separated list of one or more URDF files that contain. static links for the sensor configurations</p>
</li>
<li><p>use_bag_transforms: 默认true，Whether to read, use and republish transforms from bags</p>
</li>
<li><p>keep_running: 默认false，最好改为true。Keep running the offline node after all messages from the bag have been processed</p>
</li>
<li><p>load_frozen_state: 默认true，Load the saved state as frozen (non-optimized) trajectories</p>
</li>
<li><p>skip_seconds: 默认0，Optional amount of seconds to skip from the beginning (i.e. when the earliest bag starts)</p>
</li>
</ul>
<p>一个配置了两个机器人的的launch的关键部分是这样的:<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">node</span> <span class="attr">name</span>=<span class="string">&quot;cartographer_offline_node&quot;</span> <span class="attr">pkg</span>=<span class="string">&quot;cartographer_ros&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">required</span>=<span class="string">&quot;$(arg no_rviz)&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">type</span>=<span class="string">&quot;cartographer_offline_node&quot;</span> <span class="attr">args</span>=<span class="string">&quot;</span></span></span><br><span class="line"><span class="string"><span class="tag">      -configuration_directory $(arg abspath)</span></span></span><br><span class="line"><span class="string"><span class="tag">      -configuration_basenames alpha-cartographer.lua,delta-cartographer.lua</span></span></span><br><span class="line"><span class="string"><span class="tag">      -urdf_filenames $(arg abspath)/pioneer-alpha.urdf,$(arg abspath)/pioneer-delta.urdf</span></span></span><br><span class="line"><span class="string"><span class="tag">      -bag_filenames $(arg abspath)/alpha.bag,$(arg abspath)/delta.bag</span></span></span><br><span class="line"><span class="string"><span class="tag">      -keep_running=true -use_bag_transforms=false&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">output</span>=<span class="string">&quot;screen&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">remap</span> <span class="attr">from</span>=<span class="string">&quot;bag_1_scan&quot;</span> <span class="attr">to</span>=<span class="string">&quot;alpha/scan&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">remap</span> <span class="attr">from</span>=<span class="string">&quot;bag_1_odom&quot;</span> <span class="attr">to</span>=<span class="string">&quot;alpha/pose&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">remap</span> <span class="attr">from</span>=<span class="string">&quot;bag_2_scan&quot;</span> <span class="attr">to</span>=<span class="string">&quot;delta/scan&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">remap</span> <span class="attr">from</span>=<span class="string">&quot;bag_2_odom&quot;</span> <span class="attr">to</span>=<span class="string">&quot;delta/pose&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">node</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<h2 id="话题和service"><a href="#话题和service" class="headerlink" title="话题和service"></a>话题和service</h2><p>Publications:</p>
<ul>
<li>cartographer_offline_node/bagfile_progress [cartographer_ros_msgs/BagfileProgress]</li>
<li>clock [rosgraph_msgs/Clock]</li>
<li>constraint_list [visualization_msgs/MarkerArray]</li>
<li>landmark_poses_list [visualization_msgs/MarkerArray]</li>
<li>rosout [rosgraph_msgs/Log]</li>
<li>scan_matched_points2 [sensor_msgs/PointCloud2]</li>
<li>submap_list [cartographer_ros_msgs/SubmapList]</li>
<li>tf [tf2_msgs/TFMessage]</li>
<li>tf_static [tf2_msgs/TFMessage]</li>
<li>tracked_pose [geometry_msgs/PoseStamped]</li>
<li>trajectory_node_list [visualization_msgs/MarkerArray]</li>
</ul>
<p>Subscriptions:</p>
<ul>
<li>clock [rosgraph_msgs/Clock]</li>
</ul>
<p>Services:</p>
<ul>
<li>finish_trajectory</li>
<li>get_trajectory_states</li>
<li>read_metrics</li>
<li>start_trajectory</li>
<li>submap_query</li>
<li>trajectory_query</li>
<li>write_state</li>
</ul>
<p>离线节点是直接在程序里读取消息，所以它没有像<code>rosbag play</code>那样把bag里的话题发布出来，我运行bag时，因为还需要运行一个节点对bag里的话题进行类型转换，而话题又没发布出来，所以离线节点实际无法使用了。</p>
<h2 id="源码的重要部分"><a href="#源码的重要部分" class="headerlink" title="源码的重要部分"></a>源码的重要部分</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">constexpr</span> <span class="keyword">char</span> kClockTopic[] = <span class="string">&quot;clock&quot;</span>;</span><br><span class="line"><span class="keyword">constexpr</span> <span class="keyword">char</span> kTfStaticTopic[] = <span class="string">&quot;/tf_static&quot;</span>;</span><br><span class="line"><span class="keyword">constexpr</span> <span class="keyword">char</span> kTfTopic[] = <span class="string">&quot;tf&quot;</span>;</span><br><span class="line"><span class="keyword">constexpr</span> <span class="keyword">double</span> kClockPublishFrequencySec = <span class="number">1.</span> / <span class="number">30.</span>;</span><br><span class="line"><span class="keyword">constexpr</span> <span class="keyword">int</span> kSingleThreaded = <span class="number">1</span>;</span><br><span class="line"><span class="comment">// We publish tf messages one second earlier than other messages. Under</span></span><br><span class="line"><span class="comment">// the assumption of higher frequency tf this should ensure that tf can</span></span><br><span class="line"><span class="comment">// always interpolate.</span></span><br><span class="line"><span class="keyword">const</span> ::ros::Duration kDelay = ::ros::<span class="built_in">Duration</span>(<span class="number">1.0</span>);</span><br></pre></td></tr></table></figure></div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2022/05/09/C++/C++%20%20%E6%A8%A1%E6%9D%BF%E4%B8%8ESTL/sort%E5%92%8Creverse%E5%87%BD%E6%95%B0/">sort函数</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-05-09</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/C/">C++</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/C/C-%E6%A8%A1%E6%9D%BF%E4%B8%8ESTL/">C++ 模板与STL</a></span><div class="content"><p><code>sort</code>使用快速排序的递归形式，时间复杂度是<code>O(nlog(n) )</code></p>
<p>Sort函数有三个参数：（第三个参数可不写）</p>
<ol>
<li>第一个是要排序的数组的起始地址。</li>
<li>第二个是结束的地址（最后一位要排序的地址）</li>
<li>第三个参数是排序的方法，可以是从大到小也可是从小到大，还可以不写第三个参数，此时默认的排序方法是从小到大排序。</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> b = <span class="number">3</span>, c = <span class="number">12</span>;</span><br><span class="line"><span class="built_in">qDebug</span>() &lt;&lt; std::greater&lt;<span class="keyword">int</span>&gt;()(b, c);</span><br><span class="line"><span class="built_in">qDebug</span>() &lt;&lt; std::less&lt;<span class="keyword">int</span>&gt;()(b, c);</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> a[]=&#123;<span class="number">3</span>,<span class="number">4</span>,<span class="number">1</span>,<span class="number">12</span>,<span class="number">0</span>,<span class="number">8</span>,<span class="number">4</span>&#125;;</span><br><span class="line"><span class="comment">// 默认从小到大排列</span></span><br><span class="line">std::<span class="built_in">sort</span>(a, a+<span class="number">7</span>);</span><br><span class="line"><span class="comment">// 从大到小</span></span><br><span class="line">std::<span class="built_in">sort</span>(a, a+<span class="number">7</span>, std::greater&lt;<span class="keyword">int</span>&gt;());</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i &lt; <span class="number">7</span>; i++)</span><br><span class="line">    cout &lt;&lt; a[i] &lt;&lt;<span class="string">&quot;  &quot;</span>;</span><br><span class="line"><span class="comment">// 0  1  3  4  4  8  12</span></span><br></pre></td></tr></table></figure>
<p>针对自定义的数据类型，需要自定义排序的方式<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Frontier</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="built_in">Frontier</span>(<span class="keyword">double</span> c):</span><br><span class="line">        <span class="built_in">cost</span>(c)&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">double</span> cost;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">compareFrontier</span><span class="params">(Frontier f1, Frontier f2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (f1.cost &lt; f2.cost);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">showFrontiers</span><span class="params">(<span class="keyword">const</span> vector&lt;Frontier&gt;&amp; v)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">auto</span> f: v)</span><br><span class="line">        cout &lt;&lt; f.cost &lt;&lt; <span class="string">&quot;  &quot;</span>;</span><br><span class="line">    cout &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vector&lt;Frontier&gt; frontiers;</span><br><span class="line">frontiers.<span class="built_in">push_back</span>(<span class="built_in">Frontier</span>(<span class="number">1.2</span>) );</span><br><span class="line">frontiers.<span class="built_in">push_back</span>(<span class="built_in">Frontier</span>(<span class="number">4.9</span>) );</span><br><span class="line">frontiers.<span class="built_in">push_back</span>(<span class="built_in">Frontier</span>(<span class="number">12.7</span>) );</span><br><span class="line">frontiers.<span class="built_in">push_back</span>(<span class="built_in">Frontier</span>(<span class="number">0.3</span>) );</span><br><span class="line">frontiers.<span class="built_in">push_back</span>(<span class="built_in">Frontier</span>(<span class="number">3.6</span>) );</span><br><span class="line"><span class="built_in">showFrontiers</span>(frontiers);</span><br><span class="line"></span><br><span class="line">std::<span class="built_in">sort</span>(frontiers.<span class="built_in">begin</span>(), frontiers.<span class="built_in">end</span>(),</span><br><span class="line">      [](<span class="keyword">const</span> Frontier&amp; f1, <span class="keyword">const</span> Frontier&amp; f2) &#123; <span class="keyword">return</span> f1.cost &lt; f2.cost; &#125;);</span><br><span class="line"><span class="comment">// std::sort(frontiers.begin(), frontiers.end(), compareFrontier);</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">showFrontiers</span>(frontiers);</span><br></pre></td></tr></table></figure><br><code>frontiers</code>一般用vector或数组，不能是list, dequeue, queue</p>
<p>运行结果：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.2</span>  <span class="number">4.9</span>  <span class="number">12.7</span>  <span class="number">0.3</span>  <span class="number">3.6</span>  </span><br><span class="line"><span class="number">0.3</span>  <span class="number">1.2</span>  <span class="number">3.6</span>  <span class="number">4.9</span>  <span class="number">12.7</span>  </span><br></pre></td></tr></table></figure></p>
<h2 id="reverse"><a href="#reverse" class="headerlink" title="reverse"></a>reverse</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iterator&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;algorithm&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">std::vector&lt;<span class="keyword">int</span>&gt; <span class="title">v</span><span class="params">(&#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>&#125;)</span></span>;</span><br><span class="line">    std::<span class="built_in">reverse</span>(std::<span class="built_in">begin</span>(v), std::<span class="built_in">end</span>(v));</span><br><span class="line">    std::cout &lt;&lt; v[<span class="number">0</span>] &lt;&lt; v[<span class="number">1</span>] &lt;&lt; v[<span class="number">2</span>] &lt;&lt; <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">int</span> a[] = &#123;<span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>&#125;;</span><br><span class="line">    std::<span class="built_in">reverse</span>(std::<span class="built_in">begin</span>(a), std::<span class="built_in">end</span>(a));</span><br><span class="line">    std::cout &lt;&lt; a[<span class="number">0</span>] &lt;&lt; a[<span class="number">1</span>] &lt;&lt; a[<span class="number">2</span>] &lt;&lt; a[<span class="number">3</span>] &lt;&lt; <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2022/05/08/%E7%AE%97%E6%B3%95%E6%8E%A8%E5%AF%BC/%E6%9C%9F%E5%88%8A%E4%BC%9A%E8%AE%AE%E7%9A%84%E6%83%85%E5%86%B5/">期刊会议的情况</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-05-08</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E7%AE%97%E6%B3%95%E6%8E%A8%E5%AF%BC/">算法推导</a></span><div class="content"><h2 id="机器人顶级期刊"><a href="#机器人顶级期刊" class="headerlink" title="机器人顶级期刊"></a>机器人顶级期刊</h2><p>IEEE Transactions on Robotics (TRO)</p>
<p>International Journal of Robotics Research (IJRR)</p>
<p>Journal of Field Robotics (JFR)</p>
<p>IEEE Robotics &amp; Automation Magazine (RAM)</p>
<h2 id="机器人次顶级期刊"><a href="#机器人次顶级期刊" class="headerlink" title="机器人次顶级期刊"></a>机器人次顶级期刊</h2><p>Robotics and Autonomous Systems (RAS)</p>
<p>Autonomous Robots (AURO)</p>
<p>Robotics and Computer-Integrated Manufacturing (RCIM)</p>
<p>期刊影响因子应该至少为2</p>
<h2 id="机器人顶级会议"><a href="#机器人顶级会议" class="headerlink" title="机器人顶级会议"></a>机器人顶级会议</h2><p>Robotics: Science and Systems (RSS)</p>
<p><strong>IEEE The International Conference on Robotics and Automation (ICRA)</strong></p>
<p><strong>IEEE/RSJ International Conference on Intelligent Robots and Systems (IROS)</strong></p>
<h2 id="机器人次顶级会议"><a href="#机器人次顶级会议" class="headerlink" title="机器人次顶级会议"></a>机器人次顶级会议</h2><p>IEEE International Conference on Robotics and Biomimetics (ROBIO)</p>
<p>IEEE International Conference on Real-time Computing and Robotics (RCAR)</p>
<p>International Conference on Advanced Robotics (ICAR)</p>
<p>IEEE International Conference on CYBER Technology in Automation, Control, and Intelligent Systems (IEEE-CYBER)</p>
<p>IEEE International Conference on Multisensor Fusion and Integration for Intelligent Systems (MFI)</p>
<h2 id="机器人一般会议"><a href="#机器人一般会议" class="headerlink" title="机器人一般会议"></a>机器人一般会议</h2><p>IEEE International Conference on Advanced Intelligent Mechatronics (AIM)</p>
<p>IEEE International Conference on Humanoid Robots (Humanoids)</p>
<p>International Conference on Climbing and Walking Robots (CLAWAR)</p>
<p>IEEE International Conference on Information and Automation (ICIA)</p>
<p>论文的<code>相关工作</code>一项也是有意义的。比如论文A，作者说他的方法很好，我看了之后找不出问题，后来又看到了论文B，B在介绍论文A时会提出A存在的问题，而它又如何避免了这种问题。 写的差的论文往往<code>相关工作</code>只是简单介绍，它和以往的论文没多大关系，或者介绍的论文价值不高。</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2022/05/07/%E6%BF%80%E5%85%89SLAM/Cartographer/%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/%E8%BD%A8%E8%BF%B9%E7%9A%84%E5%8F%AF%E8%A7%86%E5%8C%96/">轨迹的可视化</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-05-07</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E6%BF%80%E5%85%89SLAM/">激光SLAM</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E6%BF%80%E5%85%89SLAM/Cartographer/">Cartographer</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E6%BF%80%E5%85%89SLAM/Cartographer/%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/">源码解读</a></span><div class="content"><p><code>Node::PublishSubmapList</code>: 这里的子图只有节点id和子图的节点数，没有地图数据</p>
<h2 id="scan-matched-points2-话题"><a href="#scan-matched-points2-话题" class="headerlink" title="scan_matched_points2 话题"></a><code>scan_matched_points2</code> 话题</h2><h2 id="trajectory-node-list话题"><a href="#trajectory-node-list话题" class="headerlink" title="trajectory_node_list话题"></a><code>trajectory_node_list</code>话题</h2></div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2022/05/07/%E6%BF%80%E5%85%89SLAM/Cartographer/%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/%E7%BB%93%E6%9D%9F%E8%BD%A8%E8%BF%B9%20FinishTrajectoryUnderLock/">结束轨迹</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-05-07</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E6%BF%80%E5%85%89SLAM/">激光SLAM</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E6%BF%80%E5%85%89SLAM/Cartographer/">Cartographer</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E6%BF%80%E5%85%89SLAM/Cartographer/%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/">源码解读</a></span><div class="content"><p><code>node_main.cc</code>中的<code>Run</code>函数最后：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">::ros::<span class="built_in">spin</span>();</span><br><span class="line"><span class="comment">// 终止所有轨迹</span></span><br><span class="line">node.<span class="built_in">FinishAllTrajectories</span>();</span><br><span class="line">node.<span class="built_in">RunFinalOptimization</span>();</span><br></pre></td></tr></table></figure></p>
<p>主要看<code>FinishAllTrajectories</code><br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Node::FinishAllTrajectories</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  carto::<span class="function">common::MutexLocker <span class="title">lock</span><span class="params">(&amp;mutex_)</span></span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">auto</span>&amp; entry : is_active_trajectory_) &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> trajectory_id = entry.first;</span><br><span class="line">    <span class="comment">// 已经lock了，所以叫做 FinishTrajectoryUnderLock</span></span><br><span class="line">    <span class="keyword">if</span> (entry.second) &#123;</span><br><span class="line">      <span class="built_in">CHECK_EQ</span>(<span class="built_in">FinishTrajectoryUnderLock</span>(trajectory_id).code,</span><br><span class="line">               cartographer_ros_msgs::StatusCode::OK);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><code>offline_node.cc</code> 中还调用了一个<code>Node::FinishTrajectory</code>(是这个函数唯一被调用的地方)，还有就是<code>finish_trajectory</code>服务的回调函数，以上3个函数实际都调用<code>FinishTrajectoryUnderLock</code></p>
<p><br></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">cartographer_ros_msgs::StatusResponse <span class="title">Node::FinishTrajectoryUnderLock</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">const</span> <span class="keyword">int</span> trajectory_id)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  cartographer_ros_msgs::StatusResponse status_response;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// First, check if we can actually finish the trajectory</span></span><br><span class="line">  <span class="comment">// trajectory_id 是否属于正在结束的轨迹集合，如果是 FROZEN 则返回</span></span><br><span class="line">  <span class="keyword">if</span> (map_builder_bridge_.<span class="built_in">GetFrozenTrajectoryIds</span>().<span class="built_in">count</span>(trajectory_id))</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">const</span> std::string error =</span><br><span class="line">        <span class="string">&quot;Trajectory &quot;</span> + std::<span class="built_in">to_string</span>(trajectory_id) + <span class="string">&quot; is frozen.&quot;</span>;</span><br><span class="line">    <span class="built_in">LOG</span>(ERROR) &lt;&lt; error;</span><br><span class="line">    status_response.code = cartographer_ros_msgs::StatusCode::INVALID_ARGUMENT;</span><br><span class="line">    status_response.message = error;</span><br><span class="line">    <span class="keyword">return</span> status_response;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// trajectory_id 是否是 ACTIVE状态</span></span><br><span class="line">  <span class="keyword">if</span> (is_active_trajectory_.<span class="built_in">count</span>(trajectory_id) == <span class="number">0</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">const</span> std::string error =</span><br><span class="line">        <span class="string">&quot;Trajectory &quot;</span> + std::<span class="built_in">to_string</span>(trajectory_id) + <span class="string">&quot; is not created yet.&quot;</span>;</span><br><span class="line">    <span class="built_in">LOG</span>(ERROR) &lt;&lt; error;</span><br><span class="line">    status_response.code = cartographer_ros_msgs::StatusCode::NOT_FOUND;</span><br><span class="line">    status_response.message = error;</span><br><span class="line">    <span class="keyword">return</span> status_response;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// trajectory_id 是否已经 finish</span></span><br><span class="line">  <span class="keyword">if</span> (!is_active_trajectory_[trajectory_id])</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">const</span> std::string error = <span class="string">&quot;Trajectory &quot;</span> + std::<span class="built_in">to_string</span>(trajectory_id) +</span><br><span class="line">                              <span class="string">&quot; has already been finished.&quot;</span>;</span><br><span class="line">    <span class="built_in">LOG</span>(ERROR) &lt;&lt; error;</span><br><span class="line">    status_response.code =</span><br><span class="line">        cartographer_ros_msgs::StatusCode::RESOURCE_EXHAUSTED;</span><br><span class="line">    status_response.message = error;</span><br><span class="line">    <span class="keyword">return</span> status_response;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// Shutdown the subscribers of this trajectory.</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">auto</span>&amp; entry : subscribers_[trajectory_id])</span><br><span class="line">  &#123;</span><br><span class="line">    entry.subscriber.<span class="built_in">shutdown</span>();</span><br><span class="line">    subscribed_topics_.<span class="built_in">erase</span>(entry.topic);</span><br><span class="line">    <span class="built_in">LOG</span>(INFO) &lt;&lt; <span class="string">&quot;Shutdown the subscriber of [&quot;</span> &lt;&lt; entry.topic &lt;&lt; <span class="string">&quot;]&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">CHECK_EQ</span>(subscribers_.<span class="built_in">erase</span>(trajectory_id), <span class="number">1</span>);</span><br><span class="line">  <span class="built_in">CHECK</span>(is_active_trajectory_.<span class="built_in">at</span>(trajectory_id));</span><br><span class="line">  <span class="comment">// 主要是这里</span></span><br><span class="line">  map_builder_bridge_.<span class="built_in">FinishTrajectory</span>(trajectory_id);</span><br><span class="line"></span><br><span class="line">  is_active_trajectory_[trajectory_id] = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">const</span> std::string message =</span><br><span class="line">      <span class="string">&quot;Finished trajectory &quot;</span> + std::<span class="built_in">to_string</span>(trajectory_id) + <span class="string">&quot;.&quot;</span>;</span><br><span class="line">  status_response.code = cartographer_ros_msgs::StatusCode::OK;</span><br><span class="line">  status_response.message = message;</span><br><span class="line">  <span class="keyword">return</span> status_response;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>StatusResponse</code>不正常的<code>code</code>是<code>INVALID_ARGUMENT</code>,  <code>NOT_FOUND</code>,  <code>RESOURCE_EXHAUSTED</code>, 只有<code>OK</code>是正常的</p>
<p>其中的关键函数就是：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MapBuilderBridge::FinishTrajectory</span><span class="params">(<span class="keyword">const</span> <span class="keyword">int</span> trajectory_id)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">LOG</span>(INFO) &lt;&lt; <span class="string">&quot;Finishing trajectory with ID &#x27;&quot;</span> &lt;&lt; trajectory_id &lt;&lt; <span class="string">&quot;&#x27;...&quot;</span>;</span><br><span class="line">  <span class="comment">// Make sure there is a trajectory with &#x27;trajectory_id&#x27;.</span></span><br><span class="line">  <span class="built_in">CHECK_EQ</span>(sensor_bridges_.<span class="built_in">count</span>(trajectory_id), <span class="number">1</span>);</span><br><span class="line">  map_builder_-&gt;<span class="built_in">FinishTrajectory</span>(trajectory_id);</span><br><span class="line">  sensor_bridges_.<span class="built_in">erase</span>(trajectory_id);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 再看这个函数</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MapBuilder::FinishTrajectory</span><span class="params">(<span class="keyword">const</span> <span class="keyword">int</span> trajectory_id)</span> </span>&#123;</span><br><span class="line">  sensor_collator_-&gt;<span class="built_in">FinishTrajectory</span>(trajectory_id);</span><br><span class="line">  pose_graph_-&gt;<span class="built_in">FinishTrajectory</span>(trajectory_id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><code>sensor_collator_</code>就是<code>Collator::FinishTrajectory</code> 或者 <code>TrajectoryCollator::FinishTrajectory</code>，不用关注。</p>
<p>重要的是后端的同名函数：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">PoseGraph2D::FinishTrajectory</span><span class="params">(<span class="keyword">const</span> <span class="keyword">int</span> trajectory_id)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">AddWorkItem</span>([<span class="keyword">this</span>, trajectory_id]() <span class="built_in">LOCKS_EXCLUDED</span>(mutex_)</span><br><span class="line">  &#123;</span><br><span class="line">    absl::MutexLock  <span class="built_in">locker</span>(&amp;mutex_);</span><br><span class="line">    <span class="built_in">CHECK</span>(!<span class="built_in">IsTrajectoryFinished</span>(trajectory_id));   <span class="comment">// 不能是已结束</span></span><br><span class="line">    data_.trajectories_state[trajectory_id].state = TrajectoryState::FINISHED;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; submap : data_.submap_data.<span class="built_in">trajectory</span>(trajectory_id)) &#123;</span><br><span class="line">      data_.submap_data.<span class="built_in">at</span>(submap.id).state = SubmapState::kFinished;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> WorkItem::Result::kRunOptimization;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>这里又是全局优化的标志<code>kRunOptimization</code>，然后又去<code>PoseGraph2D::HandleWorkQueue</code>，也是一次优化过程了</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2022/05/07/%E6%BF%80%E5%85%89SLAM/Cartographer/%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/map_builder_server.cc/">map_builder_server.cc</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-05-07</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E6%BF%80%E5%85%89SLAM/">激光SLAM</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E6%BF%80%E5%85%89SLAM/Cartographer/">Cartographer</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E6%BF%80%E5%85%89SLAM/Cartographer/%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/">源码解读</a></span><div class="content"><p><code>map_builder_server.cc</code>中注册了一大堆回调函数，例如：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">server_builder.RegisterHandler&lt;handlers::GetLocalToGlobalTransformHandler&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">// get_local_to_global_transform_handler.cc 文件</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">GetLocalToGlobalTransformHandler::OnRequest</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">const</span> proto::GetLocalToGlobalTransformRequest&amp; request)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">auto</span> response = absl::make_unique&lt;proto::GetLocalToGlobalTransformResponse&gt;();</span><br><span class="line">  <span class="keyword">auto</span> local_to_global =</span><br><span class="line">      GetContext&lt;MapBuilderContextInterface&gt;()</span><br><span class="line">          -&gt;<span class="built_in">map_builder</span>()</span><br><span class="line">          .<span class="built_in">pose_graph</span>()</span><br><span class="line">          -&gt;<span class="built_in">GetLocalToGlobalTransform</span>(request.<span class="built_in">trajectory_id</span>());</span><br><span class="line">  *response-&gt;<span class="built_in">mutable_local_to_global</span>() = transform::<span class="built_in">ToProto</span>(local_to_global);</span><br><span class="line">  <span class="built_in">Send</span>(std::<span class="built_in">move</span>(response));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>GetLocalToGlobalTransform</code>可用于获取local坐标系的原点<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">transform::Rigid3d <span class="title">PoseGraph2D::GetLocalToGlobalTransform</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">const</span> <span class="keyword">int</span> trajectory_id)</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="function">absl::MutexLock <span class="title">locker</span><span class="params">(&amp;mutex_)</span></span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">ComputeLocalToGlobalTransform</span>(data_.global_submap_poses_2d,</span><br><span class="line">                                       trajectory_id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>同样的还有 <code>PoseGraph2D::GetAllSubmapPoses</code>,  <code>PoseGraph2D::GetTrajectoryStates</code>,  <code>PoseGraph2D::GetTrajectoryNodePoses</code>,  <code>PoseGraph2D::GetLandmarkPoses()</code>,  <code>PoseGraph2D::constraints()</code>等等</p>
<p><code>cartographer\cartographer\cloud\internal\handlers</code>目录有一堆文件，每个文件只定义了一个对应的回调函数，这个回调函数只在<code>map_builder_server.cc</code>中调用，最终是运行<code>cartographer_grpc_server</code></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2022/04/30/%E6%BF%80%E5%85%89SLAM/Cartographer/%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/metrics%E6%9C%BA%E5%88%B6/">metrics机制</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-04-30</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E6%BF%80%E5%85%89SLAM/">激光SLAM</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E6%BF%80%E5%85%89SLAM/Cartographer/">Cartographer</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E6%BF%80%E5%85%89SLAM/Cartographer/%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/">源码解读</a></span><div class="content"><p>若要启用metrics机制，必须在launch文件里添加参数<code>-collect_metrics true</code>，这个本质也是gflag</p>
<p>源码的顺序如下<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// node.cc中</span></span><br><span class="line"><span class="keyword">if</span> (collect_metrics)</span><br><span class="line">&#123;</span><br><span class="line">  metrics_registry_ = absl::make_unique&lt;metrics::FamilyFactory&gt;();</span><br><span class="line">  carto::metrics::<span class="built_in">RegisterAllMetrics</span>(metrics_registry_.<span class="built_in">get</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// register.cc 中定义</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">RegisterAllMetrics</span><span class="params">(FamilyFactory* registry)</span> </span>&#123;</span><br><span class="line">  mapping::constraints::ConstraintBuilder2D::<span class="built_in">RegisterMetrics</span>(registry);</span><br><span class="line">  mapping::<span class="built_in">GlobalTrajectoryBuilderRegisterMetrics</span>(registry);</span><br><span class="line">  mapping::LocalTrajectoryBuilder2D::<span class="built_in">RegisterMetrics</span>(registry);</span><br><span class="line">  mapping::PoseGraph2D::<span class="built_in">RegisterMetrics</span>(registry);</span><br><span class="line">  sensor::TrajectoryCollator::<span class="built_in">RegisterMetrics</span>(registry);</span><br><span class="line">  <span class="comment">// 不需要可以注释掉</span></span><br><span class="line">  mapping::constraints::ConstraintBuilder3D::<span class="built_in">RegisterMetrics</span>(registry);</span><br><span class="line">  mapping::LocalTrajectoryBuilder3D::<span class="built_in">RegisterMetrics</span>(registry);</span><br><span class="line">  mapping::PoseGraph3D::<span class="built_in">RegisterMetrics</span>(registry);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>以上所有<code>RegisterMetrics</code>在<code>local_trajectory_builder_2d.cc</code>,  <code>pose_graph_2d.cc</code>,  <code>constraint_builder_2d.cc</code>(排除3D情况)定义了所有metrics参数</p>
<p><br></p>
<p>以<code>kLocalSlamCpuRealTimeRatio</code>为例进行说明， 在<code>local_trajectory_builder_2d.cc</code>开始部分的声明：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">auto</span>* kLocalSlamCpuRealTimeRatio = metrics::Gauge::<span class="built_in">Null</span>();`</span><br></pre></td></tr></table></figure></p>
<p>然后在<code>LocalTrajectoryBuilder2D::RegisterMetrics</code>中<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">auto</span>* cpu_real_time_ratio = family_factory-&gt;<span class="built_in">NewGaugeFamily</span>(</span><br><span class="line">      <span class="string">&quot;mapping_2d_local_trajectory_builder_cpu_real_time_ratio&quot;</span>,</span><br><span class="line">      <span class="string">&quot;sensor duration / cpu duration.&quot;</span>);</span><br><span class="line"></span><br><span class="line">kLocalSlamCpuRealTimeRatio = cpu_real_time_ratio-&gt;<span class="built_in">Add</span>(&#123;&#125;);</span><br></pre></td></tr></table></figure></p>
<p>最后是赋值部分<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (last_thread_cpu_time_seconds_.<span class="built_in">has_value</span>()) &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">double</span> thread_cpu_duration_seconds =</span><br><span class="line">        thread_cpu_time_seconds - last_thread_cpu_time_seconds_.<span class="built_in">value</span>();</span><br><span class="line">    <span class="keyword">if</span> (sensor_duration.<span class="built_in">has_value</span>()) &#123;</span><br><span class="line">      kLocalSlamCpuRealTimeRatio-&gt;<span class="built_in">Set</span>(</span><br><span class="line">          common::<span class="built_in">ToSeconds</span>(sensor_duration.<span class="built_in">value</span>()) / thread_cpu_duration_seconds );</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<p>如果想查看metrics，只能<code>rosservice call /read_metrics &quot;&#123;&#125;&quot;</code>，一次调用的结果部分：<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">name: <span class="string">&quot;mapping_constraints_constraint_builder_2d_constraints&quot;</span></span><br><span class="line">description: <span class="string">&quot;Constraints computed&quot;</span></span><br><span class="line">metrics: </span><br><span class="line">    <span class="built_in">type</span>: 0</span><br><span class="line">    labels: </span><br><span class="line">      - </span><br><span class="line">        key: <span class="string">&quot;matcher&quot;</span></span><br><span class="line">        value: <span class="string">&quot;searched&quot;</span></span><br><span class="line">      - </span><br><span class="line">        key: <span class="string">&quot;search_region&quot;</span></span><br><span class="line">        value: <span class="string">&quot;global&quot;</span></span><br><span class="line">    value: 4206.0</span><br><span class="line">    counts_by_bucket: []</span><br><span class="line">  - </span><br><span class="line">    <span class="built_in">type</span>: 0</span><br><span class="line">    labels: </span><br><span class="line">      - </span><br><span class="line">        key: <span class="string">&quot;matcher&quot;</span></span><br><span class="line">        value: <span class="string">&quot;found&quot;</span></span><br><span class="line">      - </span><br><span class="line">        key: <span class="string">&quot;search_region&quot;</span></span><br><span class="line">        value: <span class="string">&quot;global&quot;</span></span><br><span class="line">    value: 0.0</span><br><span class="line">    counts_by_bucket: []</span><br><span class="line"></span><br><span class="line">- </span><br><span class="line">  name: <span class="string">&quot;mapping_2d_pose_graph_constraints&quot;</span></span><br><span class="line">  description: <span class="string">&quot;Current number of constraints in the pose graph&quot;</span></span><br><span class="line">  metrics: </span><br><span class="line">    - </span><br><span class="line">      <span class="built_in">type</span>: 1</span><br><span class="line">      labels: </span><br><span class="line">        - </span><br><span class="line">          key: <span class="string">&quot;tag&quot;</span></span><br><span class="line">          value: <span class="string">&quot;inter_submap&quot;</span></span><br><span class="line">        - </span><br><span class="line">          key: <span class="string">&quot;trajectory&quot;</span></span><br><span class="line">          value: <span class="string">&quot;different&quot;</span></span><br><span class="line">      value: 0.0</span><br><span class="line">      counts_by_bucket: []</span><br><span class="line"></span><br><span class="line">name: <span class="string">&quot;mapping_constraints_constraint_builder_2d_num_submap_scan_matchers&quot;</span></span><br><span class="line">description: <span class="string">&quot;Current number of constructed submap scan matchers&quot;</span></span><br><span class="line">metrics: </span><br><span class="line">- </span><br><span class="line">    <span class="built_in">type</span>: 1</span><br><span class="line">    labels: []</span><br><span class="line">    value: 18.0</span><br><span class="line">    counts_by_bucket: []</span><br><span class="line">- </span><br><span class="line">name: <span class="string">&quot;mapping_2d_pose_graph_constraints&quot;</span></span><br><span class="line">description: <span class="string">&quot;Current number of constraints in the pose graph&quot;</span></span><br><span class="line">metrics: </span><br><span class="line">  - </span><br><span class="line">    <span class="built_in">type</span>: 1</span><br><span class="line">    labels: </span><br><span class="line">      - </span><br><span class="line">        key: <span class="string">&quot;tag&quot;</span></span><br><span class="line">        value: <span class="string">&quot;inter_submap&quot;</span></span><br><span class="line">      - </span><br><span class="line">        key: <span class="string">&quot;trajectory&quot;</span></span><br><span class="line">        value: <span class="string">&quot;different&quot;</span></span><br><span class="line">    value: 27.0</span><br><span class="line">    counts_by_bucket: []</span><br><span class="line">  - </span><br><span class="line">    <span class="built_in">type</span>: 1</span><br><span class="line">    labels: </span><br><span class="line">      - </span><br><span class="line">        key: <span class="string">&quot;tag&quot;</span></span><br><span class="line">        value: <span class="string">&quot;inter_submap&quot;</span></span><br><span class="line">      - </span><br><span class="line">        key: <span class="string">&quot;trajectory&quot;</span></span><br><span class="line">        value: <span class="string">&quot;same&quot;</span></span><br><span class="line">    value: 10.0</span><br><span class="line">    counts_by_bucket: []</span><br><span class="line">- </span><br><span class="line">name: <span class="string">&quot;mapping_constraints_constraint_builder_2d_scores&quot;</span></span><br><span class="line">description: <span class="string">&quot;Constraint scores built&quot;</span></span><br><span class="line">metrics: </span><br><span class="line">  - </span><br><span class="line">    <span class="built_in">type</span>: 2</span><br><span class="line">    labels: </span><br><span class="line">      - </span><br><span class="line">        key: <span class="string">&quot;search_region&quot;</span></span><br><span class="line">        value: <span class="string">&quot;local&quot;</span></span><br></pre></td></tr></table></figure><br>获知不同轨迹之间的查找次数和找到的约束数目，源码在<code>ConstraintBuilder2D::ComputeConstraint</code>中的<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kGlobalConstraintsFoundMetric-&gt;<span class="built_in">Increment</span>();</span><br><span class="line">kGlobalConstraintScoresMetric-&gt;<span class="built_in">Observe</span>(score);</span><br></pre></td></tr></table></figure></p>
<font size="4" color="blue"> 模仿源码，可以根据自己的需要添加 metrics  </font>

<p>如果不需要3D的metrics，可以到<code>ConstraintBuilder3D::RegisterMetrics</code>,  <code>LocalTrajectoryBuilder3D::RegisterMetrics</code>,  <code>PoseGraph3D::RegisterMetrics</code>中return</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2022/04/21/SLAM%E5%B7%A5%E5%85%B7/ceres%202%20%E8%87%AA%E5%8A%A8%E6%B1%82%E5%AF%BC/">Ceres(二) 自动求导</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-04-21</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/SLAM%E5%B7%A5%E5%85%B7/">SLAM工具</a></span><div class="content"><p>头文件只有一个<code>&quot;ceres/ceres.h&quot;</code></p>
<p>调试几个经典例子的过程<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;ceres/ceres.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> ceres::AutoDiffCostFunction;</span><br><span class="line"><span class="keyword">using</span> ceres::CostFunction;</span><br><span class="line"><span class="keyword">using</span> ceres::Problem;</span><br><span class="line"><span class="keyword">using</span> ceres::Solver;</span><br><span class="line"><span class="keyword">using</span> ceres::Solve;</span><br></pre></td></tr></table></figure><br><br></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span>  <span class="title">Functor</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt; <span class="function"><span class="keyword">bool</span> <span class="title">operator</span><span class="params">()</span><span class="params">(<span class="keyword">const</span> T* <span class="keyword">const</span> x, T* residual)</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		residual[<span class="number">0</span>] = <span class="number">10.0</span> - x[<span class="number">0</span>];</span><br><span class="line">		residual[<span class="number">1</span>] = <span class="number">3.0</span> - x[<span class="number">1</span>];</span><br><span class="line">		<span class="comment">// 直接让第2维度为0，优化后的x[1]还是初值2</span></span><br><span class="line">		<span class="comment">// residual[1] = T(0.0);</span></span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>这里的变量为二维的<script type="math/tex">(x_0, x_1)</script>，目标函数为<code>10.0-x</code>和<code>3.0-x</code></p>
<p>如果这里不写10.0而是10，就会报错。 Ceres中没有int，只接受double</p>
<p>对于<code>residual[1] = T(0.0);</code>的情况，如果不加<code>T</code>，编译就会报错<font size="4" color="orange"> error: no match for ‘operator=’ (operand types are ‘ceres::Jet<double, 2>’ and ‘double’)  </font>. Jet类型是ceres内置类型，我们要把double转成Jet类型，也就是<code>T(0.0)</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span>  <span class="title">TestLocalParam</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt; <span class="keyword">bool</span> <span class="title">operator</span><span class="params">()</span><span class="params">(<span class="keyword">const</span> T* x, <span class="keyword">const</span> T* delta, T* x_plus_delta)</span> <span class="keyword">const</span></span>&#123;</span><br><span class="line">		x_plus_delta[<span class="number">0</span>] = x[<span class="number">0</span>] + <span class="number">0.4</span> * delta[<span class="number">0</span>];</span><br><span class="line">		x_plus_delta[<span class="number">1</span>] = x[<span class="number">1</span>] + <span class="number">0.4</span> * delta[<span class="number">1</span>];</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><code>CostFunctor</code>的<code>operator</code>就是计算残差，不带平方项，平方是ceres自动添加，相当于最小二乘的函数 f</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// double x = 0.5;</span></span><br><span class="line"><span class="keyword">double</span> x[] = &#123;<span class="number">0.5</span>, <span class="number">2.0</span>&#125;;</span><br><span class="line"></span><br><span class="line">Problem problem;</span><br><span class="line"></span><br><span class="line">problem.<span class="built_in">AddParameterBlock</span>(x, <span class="number">2</span>, </span><br><span class="line">  (<span class="keyword">new</span> ceres::AutoDiffLocalParameterization</span><br><span class="line">  	<span class="comment">// 真正的维度是2， 参与优化的维度是1</span></span><br><span class="line">  	&lt;TestLocalParam, <span class="number">2</span>, <span class="number">1</span>&gt; ())</span><br><span class="line">	);</span><br><span class="line"><span class="comment">// AddParameterBlock 修改之后，无论下面的AutoDiffCostFunction参数是多少，只优化第1维度</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 残差的维度，参数的维度</span></span><br><span class="line"><span class="comment">// 如果此时是 2,1. 报错</span></span><br><span class="line">CostFunction* cost_func = <span class="keyword">new</span> AutoDiffCostFunction&lt;Functor, <span class="number">2</span>, <span class="number">2</span>&gt;(<span class="keyword">new</span> Functor);</span><br><span class="line"><span class="comment">// 参数：CostFunction，可选的LossFunction，将CostFunction连接到一组参数块</span></span><br><span class="line">problem.<span class="built_in">AddResidualBlock</span>(cost_func, <span class="literal">nullptr</span>, x);</span><br></pre></td></tr></table></figure>
<p>创建最小二乘问题，可以使用<code>Problem::AddResidualBlock()</code>和<code>Problem::AddParameterBlock()</code>。 可以使用<code>Problem::AddParameterBlock()</code>显式添加参数块，这将导致额外的正确性检查; 然而，如果参数块不存在，<code>Problem::AddResidualBlock()</code>会隐式添加参数块。</p>
<p><code>AddParameterBlock()</code>显式地向Problem添加了一个参数块。它还允许用户将LocalParameterization对象与参数块关联起来。</p>
<p><code>AddResidualBlock</code>默认会先调用<code>AddParameterBlock</code>，一般不用后者。</p>
<p>损失函数<code>LossFunction</code>，给异常值做限定，如果是nullptr，该项的代价就是残差的平方范数</p>
<p>代价函数携带关于它所期望的参数块大小的信息。函数检查这些参数是否与parameter_blocks中列出的参数块的大小匹配。如果检测到不匹配，程序将中止。</p>
<h2 id="Solver"><a href="#Solver" class="headerlink" title="Solver"></a>Solver</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">  Solver::Options  option;</span><br><span class="line">  option.minimizer_progress_to_stdout = <span class="literal">true</span>;</span><br><span class="line">  option.linear_solver_type = ceres::SPARSE_NORMAL_CHOLESKY;</span><br><span class="line"></span><br><span class="line">  Solver::Summary summary;</span><br><span class="line">  <span class="built_in">Solve</span>(option, &amp;problem, &amp;summary);</span><br><span class="line">  </span><br><span class="line">  std::cout &lt;&lt; summary.<span class="built_in">BriefReport</span>() &lt;&lt; std::endl&lt;&lt;std::endl;</span><br><span class="line">  <span class="comment">// std::cout &lt;&lt; summary.FullReport() &lt;&lt; std::endl&lt;&lt;std::endl;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// std::cout &lt;&lt; &quot;initial x: &quot; &lt;&lt; initial_x &lt;&lt;&quot;   x: &quot;&lt;&lt; x &lt;&lt; std::endl;</span></span><br><span class="line">  std::cout &lt;&lt;<span class="string">&quot;x[0]: &quot;</span>&lt;&lt; x[<span class="number">0</span>] &lt;&lt;<span class="string">&quot;   x[1]: &quot;</span>&lt;&lt; x[<span class="number">1</span>]&lt;&lt; std::endl;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>优先选用自动微分算法，某些情况可能需要用到解析微分算法，尽量避免数值微分算法。</p>
<h2 id="曲线拟合"><a href="#曲线拟合" class="headerlink" title="曲线拟合"></a>曲线拟合</h2><p>使用十四讲第六章的曲线拟合的例子，已知 N 个数据 <script type="math/tex">(x_i, y_i)</script>，它们符合曲线 <script type="math/tex">e^{(ax^2 + bx + c)}</script>，通过曲线拟合求 a, b, c</p>
<p>跟上面的例子不同，这次目标函数为 <script type="math/tex">e(x) = y-e^{(ax^2 + bx + c)}</script>，<font size="4" color="blue">  残差维度为3(未知a,b,c) </font></p>
<p>CMake配置如下<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">find_package(OpenCV REQUIRED)</span><br><span class="line">INCLUDE_DIRECTORIES($&#123;OpenCV_DIRS&#125;)</span><br><span class="line"></span><br><span class="line">target_link_libraries(node_2</span><br><span class="line">   $&#123;catkin_LIBRARIES&#125;</span><br><span class="line">   $&#123;CERES_LIBRARIES&#125;</span><br><span class="line">   $&#123;OpenCV_LIBS&#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure></p>
<p>先生成带有高斯噪声的数据<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;opencv2/opencv.hpp&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 真实值</span></span><br><span class="line"><span class="keyword">double</span> a =<span class="number">1.0</span>, b=<span class="number">2.0</span>, c=<span class="number">1.0</span>;</span><br><span class="line"><span class="comment">// abc的初值</span></span><br><span class="line"><span class="keyword">double</span> abc[<span class="number">3</span>]  = &#123;<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 生成带有噪声的模拟数据</span></span><br><span class="line">vector&lt;<span class="keyword">double</span>&gt; x_data, y_data;</span><br><span class="line"><span class="keyword">int</span> N = <span class="number">240</span>;  <span class="comment">// 数据数量</span></span><br><span class="line"><span class="keyword">double</span> w_sigma = <span class="number">1.0</span>;  <span class="comment">// 高斯标准差</span></span><br><span class="line">cv::RNG  rng;</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">unsigned</span> <span class="keyword">int</span> i =<span class="number">0</span>; i&lt;N; i++)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">double</span> x = i/<span class="number">100.0</span>;</span><br><span class="line">    x_data.<span class="built_in">push_back</span>(x);</span><br><span class="line">    y_data.<span class="built_in">push_back</span>(<span class="built_in">exp</span>(a*x*x + b*x + c) + rng.<span class="built_in">gaussian</span>(w_sigma)  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>高斯噪声的产生： <code>cv::RNG  rng;  rng.gaussian(w_sigma)</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Functor</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="built_in">Functor</span>(<span class="keyword">double</span> x, <span class="keyword">double</span> y):</span><br><span class="line">    <span class="built_in">m_x</span>(x), <span class="built_in">m_y</span>(y) &#123;    &#125;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">if</span> 0</span></span><br><span class="line">    <span class="comment">// 开始我是这么写的，没弄清残差的维度</span></span><br><span class="line">    <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt; <span class="keyword">bool</span> <span class="title">operator</span><span class="params">()</span><span class="params">( <span class="keyword">const</span> T* <span class="keyword">const</span> a, </span></span></span><br><span class="line"><span class="params"><span class="function">                                          <span class="keyword">const</span> T* <span class="keyword">const</span> b, </span></span></span><br><span class="line"><span class="params"><span class="function">                                          <span class="keyword">const</span> T* <span class="keyword">const</span> c, </span></span></span><br><span class="line"><span class="params"><span class="function">                                          T* residual)</span>  <span class="keyword">const</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        residual[<span class="number">0</span>] = m_y - <span class="built_in">exp</span>(a[<span class="number">0</span>] * m_x * m_x + b[<span class="number">0</span>] * m_x + c[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 因为要传入数据(x,y)， 所以要定义两个成员变量</span></span><br><span class="line">    <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt; <span class="keyword">bool</span> <span class="title">operator</span><span class="params">()</span><span class="params">( <span class="keyword">const</span> T* <span class="keyword">const</span> abc, T* residual)</span>  <span class="keyword">const</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        residual[<span class="number">0</span>] = m_y - <span class="built_in">exp</span>(abc[<span class="number">0</span>] * m_x * m_x + abc[<span class="number">1</span>] * m_x + abc[<span class="number">2</span>]);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">double</span> m_x, m_y;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>因为自变量x是一维的，而不是向量，所以残差只计算一维 <code>residual[0]</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Problem problem;</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">unsigned</span> <span class="keyword">int</span> i=<span class="number">0</span>; i&lt;N; i++)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// 残差维度， 所估计变量的维度</span></span><br><span class="line">  CostFunction* cost_func = <span class="keyword">new</span> AutoDiffCostFunction&lt;Functor,<span class="number">1</span>,<span class="number">3</span>&gt;(<span class="keyword">new</span> <span class="built_in">Functor</span>(x_data[i], y_data[i]) );</span><br><span class="line">  problem.<span class="built_in">AddResidualBlock</span>(cost_func, <span class="literal">nullptr</span>, abc);</span><br><span class="line">&#125;</span><br><span class="line">Solver::Options option;</span><br><span class="line">option.minimizer_progress_to_stdout = <span class="literal">true</span>;</span><br><span class="line">option.linear_solver_type = ceres::SPARSE_NORMAL_CHOLESKY;</span><br><span class="line"></span><br><span class="line">Solver::Summary summary;</span><br><span class="line"><span class="built_in">Solve</span>(option, &amp;problem, &amp;summary);</span><br><span class="line"></span><br><span class="line">cout &lt;&lt; summary.<span class="built_in">BriefReport</span>() &lt;&lt; endl &lt;&lt;endl;</span><br><span class="line">cout &lt;&lt; <span class="string">&quot;a: &quot;</span>&lt;&lt; abc[<span class="number">0</span>] &lt;&lt;<span class="string">&quot;  b: &quot;</span>&lt;&lt; abc[<span class="number">1</span>]&lt;&lt; <span class="string">&quot;  c: &quot;</span>&lt;&lt; abc[<span class="number">2</span>] &lt;&lt;endl;</span><br></pre></td></tr></table></figure>
<p>参考：<br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/vivian187/p/15331181.html">Curve Fitting(曲线拟合)</a><br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/vivian187/p/15394000.html">Problem类</a><br><a target="_blank" rel="noopener" href="https://www.zybuluo.com/iStarLee/note/1639516#88-evaluate%E7%9B%B8%E5%85%B3">资料</a></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2022/04/18/%E6%BF%80%E5%85%89SLAM/Hector/">Hector</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-04-18</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E6%BF%80%E5%85%89SLAM/">激光SLAM</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E6%BF%80%E5%85%89SLAM/%E5%85%B6%E4%BB%96/">其他</a></span><div class="content"><p>hector相当于cartographer的前端，没有闭环检测，利用高斯牛顿方法来解决scan-matching的问题。它要求激光雷达的扫描频率比较高，建图时机器人速度需要很慢，但在机器人快速转弯时容易发生错误，原因在于优化算法容易陷入局部最小值。使用了多分辨率地图，也可以没有里程计。</p>
<p>论文的新颖点在于scanMatch使用<strong>高斯牛顿法</strong>以及<strong>多分辨率地图</strong>，后来被cartographer借鉴。</p>
<p><img src="https://s2.loli.net/2022/04/18/BJeNV18bKDCqHEn.png" alt="对向量求导.png"></p>
<h2 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h2><ol>
<li>hector的计算太慢了，只进行扫描匹配的操作就要花费大概0.1秒钟，这就导致即使雷达频率再高，hector也处理不过来</li>
<li>hector的地图不能自动更改大小，地图的大小在初始化之后始终是固定的</li>
<li>适用于非光滑线性逼近的地图梯度∇M(Si(ε))，这意味着不能保证局部二次收敛到最小，但该算法在实践中精度较高。</li>
</ol>
<p>参考：<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/tiancailx/article/details/113522899">李想对hector的分析</a><br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/dlutjwh/p/10962026.html">论文阅读：hector_slam</a></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2022/04/15/%E6%BF%80%E5%85%89SLAM/Cartographer/%E5%8E%9F%E7%90%86%E5%92%8C%E9%85%8D%E7%BD%AE/cartographer_grpc_server%E7%9A%84%E9%85%8D%E7%BD%AE/">cartographer_grpc_server的使用和配置</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-04-15</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E6%BF%80%E5%85%89SLAM/">激光SLAM</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E6%BF%80%E5%85%89SLAM/Cartographer/">Cartographer</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E6%BF%80%E5%85%89SLAM/Cartographer/%E5%8E%9F%E7%90%86%E5%92%8C%E9%85%8D%E7%BD%AE/">原理和配置</a></span><div class="content"><p>使用gRPC与云端结合：cartographer使用Protobuf数据传输协议，所以可以使用gRPC（也是谷歌的），可以通过云端运行cartographer算法，最典型的例子就是多机器人在一张已知地图上进行导航，在一个远程的强大centralized localization server运行 multi-trajectories Cartographer</p>
<p>方案：一台机器运行local optimization，另一台运行 global optimization</p>
<p>Cloud-based mapping ，using a gRPC streaming connection between local and global SLAM to propagate sensor data and local SLAM updates, which does not support ACKs and resending, hence this is not going to work over spotty WiFi.<br><img src="https://s2.loli.net/2022/04/15/luS9ofiMEh5c2mR.png" alt=""></p>
<p>先安装<code>protobuf</code>和<code>ceres</code></p>
<h2 id="安装-grpc"><a href="#安装-grpc" class="headerlink" title="安装 grpc"></a>安装 grpc</h2><p>一开始下载<code>grpc</code>后进行编译，结果报错：<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CMake Warning at cmake/abseil-cpp.cmake:30 (message):</span><br><span class="line">  gRPC_ABSL_PROVIDER is <span class="string">&quot;module&quot;</span> but ABSL_ROOT_DIR is wrong</span><br><span class="line">Call Stack (most recent call first):</span><br><span class="line">  CMakeLists.txt:188 (include)</span><br></pre></td></tr></table></figure><br>这说明第三方库没准备好，最好按如下步骤：</p>
<p>如果只想下载指定版本的，如以版本<code>1.27.3</code>为例，可改成如下语句：<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone -b v1<span class="number">.27</span><span class="number">.0</span> https:<span class="comment">//github.com/grpc/grpc.git</span></span><br></pre></td></tr></table></figure><br>上列操作成功完成后，gRPC 源码的第三方依赖目录 <code>third_party</code> 实际是空的，需通过下列步骤拉取依赖的第三方。切换到 grpc 目录，下载 grpc 第三方依赖到本地：<br><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git submodule update --init</span><br></pre></td></tr></table></figure><br>grpc依赖的第三方库有点多，如果不借助<code>git submodule</code>，手工一个个下载不太容易。其中的<code>bloaty</code>库很大。</p>
<p>注意，gRPC 要求 <code>CMake 3.5.1</code> 或以上版本的CMake，否则会报错 CMake 3.5.1 or higher is required </p>
<p>编译：<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cmake -DgRPC_SSL_PROVIDER=package ..</span><br><span class="line">make -j8</span><br><span class="line">sudo make install</span><br><span class="line"></span><br><span class="line">cmake  -DgRPC_INSTALL=ON -DgRPC_ZLIB_PROVIDER=package -DgRPC_CARES_PROVIDER=package -DgRPC_PROTOBUF_PROVIDER=package -DgRPC_SSL_PROVIDER=package -DgRPC_ABSL_PROVIDER=package ..</span><br><span class="line">make -j8</span><br><span class="line">sudo make install</span><br><span class="line"></span><br><span class="line">cmake  -DgRPC_INSTALL=ON -DBUILD_SHARED_LIBS=ON -DgRPC_ZLIB_PROVIDER=package -DgRPC_CARES_PROVIDER=package -DgRPC_PROTOBUF_PROVIDER=package -DgRPC_SSL_PROVIDER=package -DgRPC_ABSL_PROVIDER=package ..</span><br><span class="line">make -j8</span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure></p>
<h2 id="CMake配置"><a href="#CMake配置" class="headerlink" title="CMake配置"></a>CMake配置</h2><p>在包含<code>option(BUILD_GRPC &quot;build Cartographer gRPC support&quot; false)</code>的3个<code>CMakeLists</code>修改为true。 最好再添加 <code>set(BUILD_GRPC true)</code>，以及C++14的支持  <code>set(CMAKE_CXX_STANDARD 14)</code></p>
<h2 id="lua配置"><a href="#lua配置" class="headerlink" title="lua配置"></a>lua配置</h2><p><code>backpack_2d_server.lua</code>如下:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">include <span class="string">&quot;map_builder_server.lua&quot;</span></span><br><span class="line"></span><br><span class="line">MAP_BUILDER_SERVER.map_builder.use_trajectory_builder_2d = <span class="keyword">true</span></span><br><span class="line"><span class="keyword">return</span> MAP_BUILDER_SERVER</span><br></pre></td></tr></table></figure></p>
<p><code>map_builder_server.lua</code>如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">include <span class="string">&quot;map_builder.lua&quot;</span></span><br><span class="line"></span><br><span class="line">MAP_BUILDER_SERVER = &#123;</span><br><span class="line">  map_builder = MAP_BUILDER,</span><br><span class="line">  num_event_threads = <span class="number">4</span>,</span><br><span class="line">  num_grpc_threads = <span class="number">4</span>,</span><br><span class="line">  --- 我的修改</span><br><span class="line">  server_address = <span class="string">&quot;192.168.0.105:50051&quot;</span>,</span><br><span class="line">  uplink_server_address = <span class="string">&quot;&quot;</span>,</span><br><span class="line">  upload_batch_size = <span class="number">100</span>,</span><br><span class="line">  enable_ssl_encryption = <span class="keyword">false</span>,</span><br><span class="line">  enable_google_auth = <span class="keyword">false</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="运行数据集"><a href="#运行数据集" class="headerlink" title="运行数据集"></a>运行数据集</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">roslaunch cartographer_ros grpc_demo_backpack_2d.launch bag_filename:=/home/user/cartographer/dataset/cartographer_paper_deutsches_museum.bag</span><br></pre></td></tr></table></figure>
<p>这是在一台机上运行客户端和服务端<br><img src="https://s2.loli.net/2022/08/21/thAPe3QlsTKYyRc.png" alt=""><br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">launch</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">&quot;/use_sim_time&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">&quot;robot_description&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">textfile</span>=<span class="string">&quot;$(find cartographer_ros)/urdf/backpack_2d.urdf&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">node</span> <span class="attr">name</span>=<span class="string">&quot;robot_state_publisher&quot;</span> <span class="attr">pkg</span>=<span class="string">&quot;robot_state_publisher&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">type</span>=<span class="string">&quot;robot_state_publisher&quot;</span> /&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- 服务端 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">node</span> <span class="attr">name</span>=<span class="string">&quot;cartographer_grpc_server&quot;</span> <span class="attr">pkg</span>=<span class="string">&quot;cartographer_ros&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">type</span>=<span class="string">&quot;cartographer_grpc_server.sh&quot;</span> <span class="attr">args</span>=<span class="string">&quot;</span></span></span><br><span class="line"><span class="string"><span class="tag">          -configuration_directory $(find cartographer_ros)/configuration_files</span></span></span><br><span class="line"><span class="string"><span class="tag">          -configuration_basename backpack_2d_server.lua&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">node</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- 客户端 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">node</span> <span class="attr">name</span>=<span class="string">&quot;cartographer_grpc_node&quot;</span> <span class="attr">pkg</span>=<span class="string">&quot;cartographer_ros&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">type</span>=<span class="string">&quot;cartographer_grpc_node&quot;</span> <span class="attr">args</span>=<span class="string">&quot;</span></span></span><br><span class="line"><span class="string"><span class="tag">    -client_id CLIENT_ID</span></span></span><br><span class="line"><span class="string"><span class="tag">          -configuration_directory $(find cartographer_ros)/configuration_files</span></span></span><br><span class="line"><span class="string"><span class="tag">          -configuration_basename backpack_2d.lua&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">output</span>=<span class="string">&quot;screen&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">remap</span> <span class="attr">from</span>=<span class="string">&quot;echoes&quot;</span> <span class="attr">to</span>=<span class="string">&quot;horizontal_laser_2d&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">node</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">node</span> <span class="attr">name</span>=<span class="string">&quot;playbag&quot;</span> <span class="attr">pkg</span>=<span class="string">&quot;rosbag&quot;</span> <span class="attr">type</span>=<span class="string">&quot;play&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">args</span>=<span class="string">&quot;--clock $(arg bag_filename)&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">node</span> <span class="attr">name</span>=<span class="string">&quot;rviz&quot;</span> <span class="attr">pkg</span>=<span class="string">&quot;rviz&quot;</span> <span class="attr">type</span>=<span class="string">&quot;rviz&quot;</span> <span class="attr">required</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">args</span>=<span class="string">&quot;-d $(find cartographer_ros)/configuration_files/demo_2d.rviz&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">launch</span>&gt;</span></span><br></pre></td></tr></table></figure><br>就是<code>CLIENT_ID</code>，无需设置为数字。</p>
<h2 id="真实运行"><a href="#真实运行" class="headerlink" title="真实运行"></a>真实运行</h2><ul>
<li>把客户端上的<code>ROS_MASTER_URI</code>设置为服务端的IP</li>
<li>rviz放在服务端。</li>
<li>服务端的终端刷新日志，客户端不刷新</li>
<li>网络不能差，否则服务端刷新慢。</li>
<li>连接成功后，关服务端，客户端也会终止。连接成功后，关客户端，服务端停止刷新；再启动客户端，服务端继续更新。</li>
</ul>
<p>客户端<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">launch</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">node</span> <span class="attr">name</span>=<span class="string">&quot;cartographer_grpc_node&quot;</span> <span class="attr">pkg</span>=<span class="string">&quot;cartographer_ros&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">type</span>=<span class="string">&quot;cartographer_grpc_node&quot;</span> <span class="attr">args</span>=<span class="string">&quot;</span></span></span><br><span class="line"><span class="string"><span class="tag">      -client_id CLIENT_ID</span></span></span><br><span class="line"><span class="string"><span class="tag">      -server_address 192.168.1.213:50051</span></span></span><br><span class="line"><span class="string"><span class="tag">          -configuration_directory $(find cartographer_ros)/configuration_files</span></span></span><br><span class="line"><span class="string"><span class="tag">          -configuration_basename backpack_2d.lua&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">output</span>=<span class="string">&quot;screen&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">remap</span> <span class="attr">from</span>=<span class="string">&quot;/scan&quot;</span> <span class="attr">to</span>=<span class="string">&quot;/sick_tim551_scan&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">remap</span> <span class="attr">from</span>=<span class="string">&quot;/odom&quot;</span> <span class="attr">to</span>=<span class="string">&quot;/odometry/filtered&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">node</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">launch</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>服务端<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">launch</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">node</span> <span class="attr">name</span>=<span class="string">&quot;cartographer_grpc_server&quot;</span> <span class="attr">pkg</span>=<span class="string">&quot;cartographer_ros&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">type</span>=<span class="string">&quot;cartographer_grpc_server.sh&quot;</span> <span class="attr">args</span>=<span class="string">&quot;</span></span></span><br><span class="line"><span class="string"><span class="tag">          -configuration_directory $(find cartographer_ros)/configuration_files</span></span></span><br><span class="line"><span class="string"><span class="tag">          -configuration_basename backpack_2d_server.lua&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">node</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">node</span> <span class="attr">name</span>=<span class="string">&quot;rviz&quot;</span> <span class="attr">pkg</span>=<span class="string">&quot;rviz&quot;</span> <span class="attr">type</span>=<span class="string">&quot;rviz&quot;</span> <span class="attr">required</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">args</span>=<span class="string">&quot;-d $(find cartographer_ros)/configuration_files/demo_2d.rviz&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">launch</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<h2 id="纯定位"><a href="#纯定位" class="headerlink" title="纯定位"></a>纯定位</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">node</span> <span class="attr">name</span>=<span class="string">&quot;cartographer_grpc_node&quot;</span> <span class="attr">pkg</span>=<span class="string">&quot;cartographer_ros&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">type</span>=<span class="string">&quot;cartographer_grpc_node&quot;</span> <span class="attr">args</span>=<span class="string">&quot;</span></span></span><br><span class="line"><span class="string"><span class="tag">        -client_id CLIENT_ID</span></span></span><br><span class="line"><span class="string"><span class="tag">        -configuration_directory $(find cartographer_ros)/configuration_files</span></span></span><br><span class="line"><span class="string"><span class="tag">        -configuration_basename backpack_2d_localization.lua</span></span></span><br><span class="line"><span class="string"><span class="tag">        -load_state_filename $(arg load_state_filename)&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">output</span>=<span class="string">&quot;screen&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">remap</span> <span class="attr">from</span>=<span class="string">&quot;echoes&quot;</span> <span class="attr">to</span>=<span class="string">&quot;horizontal_laser_2d&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">node</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>参考：<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/windxf/article/details/108868236">运行cartographer的gRPC demo</a><br><a target="_blank" rel="noopener" href="http://txgcwm.github.io/blog/2014/03/26/ubuntuxia-an-zhuang-c-aresku/">Ubuntu下安装c-ares库</a></p>
</div><hr></div><nav id="pagination"><div class="pagination"><a class="extend prev" rel="prev" href="/page/17/">&lt;&lt; Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/17/">17</a><span class="page-number current">18</span><a class="page-number" href="/page/19/">19</a><span class="space">&hellip;</span><a class="page-number" href="/page/66/">66</a><a class="extend next" rel="next" href="/page/19/">Next &gt;&gt;</a></div></nav></div></div><footer class="footer-bg" style="background-image: url(https://s2.loli.net/2022/11/17/QOR8cePIS5NdDrK.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2018 - 2024 By Charon Cheung</div><div class="framework-info"><span>Driven - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_site_uv"><i class="fa fa-user"></i><span id="busuanzi_value_site_uv"></span><span></span></span><span class="footer-separator">|</span><span id="busuanzi_container_site_pv"><i class="fa fa-eye"></i><span id="busuanzi_value_site_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.6.1"></script><script src="/js/fancybox.js?version=1.6.1"></script><script src="/js/sidebar.js?version=1.6.1"></script><script src="/js/copy.js?version=1.6.1"></script><script src="/js/fireworks.js?version=1.6.1"></script><script src="/js/transition.js?version=1.6.1"></script><script src="/js/scroll.js?version=1.6.1"></script><script src="/js/head.js?version=1.6.1"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
    processEscapes: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
  },
  CommonHTML: {
    linebreaks: { automatic: true, width: "90% container" }
  },
  "HTML-CSS": { 
    linebreaks: { automatic: true, width: "90% container" }
  },
  "SVG": { 
    linebreaks: { automatic: true, width: "90% container" }
  }
});
</script><script type="text/x-mathjax-config">MathJax.Hub.Queue(function() {
  var all = MathJax.Hub.getAllJax(), i;
  for (i=0; i < all.length; i += 1) {
    all[i].SourceElement().parentNode.className += ' has-jax';
  }
});
</script><script src="https://cdn.bootcss.com/mathjax/2.7.2/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script>if(/Android|webOS|iPhone|iPod|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
}</script></body></html>