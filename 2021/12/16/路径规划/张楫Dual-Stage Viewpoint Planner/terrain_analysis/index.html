<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="terrain_analysis"><meta name="keywords" content=""><meta name="author" content="Charon Cheung"><meta name="copyright" content="Charon Cheung"><title>terrain_analysis | 沉默杀手</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.6.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.6.1"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  }
} </script><meta name="generator" content="Hexo 5.4.0"></head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0"><span class="toc-number">1.</span> <span class="toc-text">概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BC%98%E5%8C%96%E4%B8%80%EF%BC%9A-%E8%B0%83%E6%95%B4%E5%8F%82%E6%95%B0"><span class="toc-number">2.</span> <span class="toc-text">优化一： 调整参数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BC%98%E5%8C%96%E4%BA%8C%EF%BC%9A-%E4%BF%AE%E6%94%B9%E6%A1%86%E6%9E%B6%E5%92%8C%E4%BB%A3%E7%A0%81"><span class="toc-number">3.</span> <span class="toc-text">优化二： 修改框架和代码</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">Charon Cheung</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">483</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">5</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">44</span></a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://i.loli.net/2021/07/13/RCLw5Bx8aFPN74b.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">沉默杀手</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span></div><div id="post-info"><div id="post-title">terrain_analysis</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-12-16</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/%E8%B7%AF%E5%BE%84%E8%A7%84%E5%88%92/">路径规划</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/%E8%B7%AF%E5%BE%84%E8%A7%84%E5%88%92/Dual-Stage-Viewpoint-Planner/">Dual-Stage Viewpoint Planner</a><span class="post-meta__separator">|</span><i class="fa fa-comment-o post-meta__icon" aria-hidden="true"></i><a href="/2021/12/16/%E8%B7%AF%E5%BE%84%E8%A7%84%E5%88%92/%E5%BC%A0%E6%A5%ABDual-Stage%20Viewpoint%20Planner/terrain_analysis/#disqus_thread"><span class="disqus-comment-count" data-disqus-identifier="2021/12/16/路径规划/张楫Dual-Stage Viewpoint Planner/terrain_analysis/"></span></a><div class="post-meta-wordcount"><span>Word count: </span><span class="word-count">1.6k</span><span class="post-meta__separator">|</span><span>Reading time: 5 min</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>其实是有两个包: <code>terrain_analysis</code> 和 <code>terrain_analysis_ext</code>。后者是扩展的terrain_map，还是<code>map</code>坐标系的点云。 这里先只讨论前者。</p>
<p><code>terrain_analysis</code>分析了地形的 local smoothness，对地形地图(terrain map)的每一个点都附加了代价值。 <code>terrainAnalysis</code>发布了话题<code>terrain_map</code>，订阅者<code>localPlanner</code>，显然是用于后者的避障。如果运行了<code>terrain_analysis_ext</code>，就还有<code>terrainAnalysisExt</code>。 <code>terrain_map</code>的消息类型是<code>sensor_msgs::PointCloud2</code>，实际是从<code>pcl::PointXYZI</code>转换而来。x, y, z部分就是点的坐标， <code>intensity</code>部分是代价值而不是强度。地形地图默认覆盖了 10m x 10m 的区域，车在中心。 </p>
<p><code>terrain_analysis_ext</code>就是把区域扩展为 40m x 40m，这里面又增加了一个滑动窗口机制，keeps lidar points over a sliding window of 10 seconds with a non-decay region within 4m from the vehicle. 另外用于高层的规划模块，比如FARE. </p>
<p>在Rviz选择’<code>terrainMap</code> 或者 <code>terrainMapExt</code>。绿色点是可经过的，红色是不可经过的。</p>
<p>如果只要求避障而且机器人速度慢，只用<code>terrain_analysis</code>即可。 <code>terrain_map_ext</code>的发布频率会比<code>terrain_map</code>低</p>
<h2 id="优化一：-调整参数"><a href="#优化一：-调整参数" class="headerlink" title="优化一： 调整参数"></a>优化一： 调整参数</h2><p><code>real_robot.launch</code>中的部分(去掉<code>terrain_analysis_ext.launch</code>)：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">arg</span> <span class="attr">name</span>=<span class="string">&quot;cameraOffsetZ&quot;</span> <span class="attr">default</span>=<span class="string">&quot;0&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">arg</span> <span class="attr">name</span>=<span class="string">&quot;vehicleX&quot;</span> <span class="attr">default</span>=<span class="string">&quot;0&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">arg</span> <span class="attr">name</span>=<span class="string">&quot;vehicleY&quot;</span> <span class="attr">default</span>=<span class="string">&quot;0&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">arg</span> <span class="attr">name</span>=<span class="string">&quot;checkTerrainConn&quot;</span> <span class="attr">default</span>=<span class="string">&quot;false&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">include</span> <span class="attr">file</span>=<span class="string">&quot;$(find terrain_analysis)/launch/terrain_analysis.launch&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure><br>现在运行<code>real_robot.launch</code>，进行导航后发现了明显的问题(视频懒得上传了)，没有动态障碍时，车行走基本都正常。在车开始行走后，人到前面遮挡，车可以避开，但不能避开静态的障碍了，也就是<code>free_paths</code>未更新，对应变量<code>freePaths</code>。再追本溯源，原因可能是在<code>terrain_map</code>。 所以先分析<code>terrain_map</code>是否符合实际，经过反复测试发现<code>terrain_map</code>存在下列：</p>
<ol>
<li>某些动态障碍的清除不及时。车静止时，清除动态障碍也会失败</li>
<li>对某些障碍没有生成 terrain_map</li>
<li>无新障碍时正常导航，加入新障碍则长时间无法导航成功，路径混乱不稳定</li>
<li>把地面也生成了 terrain_map</li>
</ol>
<p><img src="https://s2.loli.net/2022/01/12/S2LWeQrwlCqA3ak.png" alt=""><br>根据代码，<code>terrain_map</code>对应变量<code>terrainCloudElev</code>，怀疑是参数<code>vehicleHeight</code>太大(默认1.5)，改为雷达到地面的高度(参考CMU团队的机器人，雷达高于机器人)</p>
<p>现在问题2和3基本没有了，问题1偶尔还会出现，问题4有明显改善。<br><br></p>
<p>机器人清除动态障碍的效果很差，反复测试，相关源码应该是在这里<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">float</span> dis = <span class="built_in">sqrt</span>((point.x - vehicleX) * (point.x - vehicleX) +</span><br><span class="line">                 (point.y - vehicleY) * (point.y - vehicleY) );</span><br><span class="line"><span class="comment">// 这里的条件十分重要，影响到了动态障碍能否清除</span></span><br><span class="line"><span class="keyword">if</span> (point.z - vehicleZ &gt; minRelZ - disRatioZ * dis &amp;&amp;</span><br><span class="line">    point.z - vehicleZ &lt; maxRelZ + disRatioZ * dis &amp;&amp;</span><br><span class="line">    (laserCloudTime - systemInitTime - point.intensity &lt; decayTime || dis &lt; noDecayDis) &amp;&amp;</span><br><span class="line">    !(dis &lt; clearingDis &amp;&amp; clearingCloud) )</span><br><span class="line">&#123;</span><br><span class="line">  terrainVoxelCloudPtr-&gt;<span class="built_in">push_back</span>(point);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>变量<code>clearingCloud</code>为true的情况只有<code>joystickHandler</code> 和 <code>clearingHandler</code>，所以先不看</p>
<p>终于确定需要调整参数<code>decayTime</code> 和 <code>noDecayDis</code>，前者改为 0.2，后者改为 0.3</p>
<p>现在的避障效果明显好了很多，还剩下的问题就是</p>
<ol>
<li>对于动态障碍，生成 terrain_map 明显滞后</li>
<li>个别障碍的残留时间长</li>
<li>不能保证清除所有的动态障碍物</li>
</ol>
<h2 id="优化二：-修改框架和代码"><a href="#优化二：-修改框架和代码" class="headerlink" title="优化二： 修改框架和代码"></a>优化二： 修改框架和代码</h2><p><code>real_robot.launch</code>里包含了<code>loam_interface.launch</code>，它其实就是LOAM的接口，转换数据类型用的。 <code>current_scan</code>的发布频率为10Hz，但是<code>terrain_map</code>的发布频率只有4.2Hz左右。另外通过<code>nethogs</code>可以发现它消耗了不少网络流量，所以考虑将其去掉。</p>
<ol>
<li>去掉<code>loam_interface</code>，<code>lego_loam</code>发布的<code>current_scan</code>直接进<code>terrain_map</code>，也就是修改<code>terrainAnalysis.cpp</code>，将订阅话题<code>registered_scan</code>改为<code>current_scan</code>。 这样将<code>terrain_map</code>的发布频率提高到5.2Hz左右<br><br></li>
</ol>
<p>机器人路径规划一般用<strong>直通滤波</strong>分割点云的范围，删除指定场景外的点。深度相机或多线雷达获取的点云数据量过大，需要经过降采样处理以减少点的数量，提高处理效率，路径规划算法常用<strong>体素滤波</strong>进行数据压缩，节省存储空间；再常用<strong>统计滤波</strong>去除离群点噪声，保留物体表面上的点。 <code>laserCloudHandler</code>处理之后的点云到main函数里又进行了体素滤波， 但是没有针对xy的直通滤波，这样就有了第二个优化之处</p>
<ol>
<li>在<code>terrain_map</code>中的<code>laserCloudHandler</code>进行x y的直通滤波，只保留机器人为中心的<code>±5m</code>以内的点云，并将滤波后的点云发布为新话题<code>crop_pcl</code>。<br><br></li>
</ol>
<p><code>terrain_map</code>还有个明显问题就是把地面也包含进了，虽然经过上面参数<code>vehicleHeight</code>的设置已经有所改善，但还是能看到。</p>
<ol>
<li>把原有的参数<code>minRelZ</code>和<code>maxRelZ</code>分解，增加参数<code>minTestZ</code>和<code>maxTestZ</code>。  后两个只用于获得 <code>filtered_scan</code>和 <code>terrainVoxelCloudPtr</code>，详见代码。 <code>minRelZ &gt; 0.4</code>才把地面的点云过滤掉一部分，如果再大，人腿下部将不生成障碍，就是说 <code>terrain_map</code> 把地面障碍生成到一定高度了.   将代码中的<code>disZ &gt;= 0</code> 改为 <code>disZ &gt;= 0.05</code>，或者0.04; <code>minBlockPointNum</code>从10降为5，现在效果好了很多</li>
</ol>
<p>如下图，实际的障碍是A，生成的理想<code>terrain_map</code>是B，但目前即使增加了两个参数，无论怎么调整，要么是C，要么是D。 其实C只要不太夸张，也可以接受。<br><img src="https://s2.loli.net/2022/01/22/78Moml3PdcSXr5U.png" alt=""></p>
<p>经过以上优化，在我自己的电脑上将<code>terrain_map</code>的发布频率提高到6Hz左右，在工控机上提高到10Hz左右，也就是和<code>current_scan</code>的频率几乎一样了。此时Rviz中和<code>crop_pcl</code>的滞后现象已经大为改善，路径规划的效果好多了。<br><img src="https://s2.loli.net/2022/01/22/6kilZRebg2HIDTB.gif" alt="2倍速播放"><br><a target="_blank" rel="noopener" href="https://youtu.be/q9uIZ-X3TsM">完整视频</a><br><br></p>
<p>现存主要问题：</p>
<ol>
<li>部分动态障碍清除不及时，作者也未解决</li>
<li>要么把地面生成terrain_map，要么实际障碍的下部没有生成terrain_map，即上面图中的C D情况</li>
<li><p>车行走时，近处的障碍偶尔没有生成terrain_map</p>
</li>
<li><p>距离雷达稍远的障碍生成terrain_map少</p>
</li>
<li>到达目标没有发布状态，<code>path</code>和<code>free_paths</code>话题仍然在发布。至少<code>path</code>应设法禁止</li>
<li>目标点没有朝向</li>
<li>上下坡</li>
</ol>
</div></article><div class="post-meta__tag-list"></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2021/12/19/%E8%B7%AF%E5%BE%84%E8%A7%84%E5%88%92/%E5%BC%A0%E6%A5%ABDual-Stage%20Viewpoint%20Planner/local%20planner%E6%89%80%E7%94%A8%E5%8F%82%E6%95%B0/"><i class="fa fa-chevron-left">  </i><span>local planner所用参数</span></a></div><div class="next-post pull-right"><a href="/2021/12/16/%E8%B7%AF%E5%BE%84%E8%A7%84%E5%88%92/%E5%BC%A0%E6%A5%ABDual-Stage%20Viewpoint%20Planner/%E8%B7%AF%E5%BE%84%E8%A7%84%E5%88%92%E6%A8%A1%E5%9D%97(%E4%B8%80)%20localPlanner/"><span>路径规划模块(一) localPlanner</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="disqus_thread"></div><script>var unused = null;
var disqus_config = function () {
  this.page.url = 'https://charon-cheung.github.io/2021/12/16/%E8%B7%AF%E5%BE%84%E8%A7%84%E5%88%92/%E5%BC%A0%E6%A5%ABDual-Stage%20Viewpoint%20Planner/terrain_analysis/';
  this.page.identifier = '2021/12/16/路径规划/张楫Dual-Stage Viewpoint Planner/terrain_analysis/';
  this.page.title = 'terrain_analysis';
}
var d = document, s = d.createElement('script');
s.src = "https://" + '沉默杀手' +".disqus.com/embed.js";
s.setAttribute('data-timestamp', '' + +new Date());
(d.head || d.body).appendChild(s);</script><script id="dsq-count-scr" src="https://沉默杀手.disqus.com/count.js" async></script></div></div><footer class="footer-bg" style="background-image: url(https://i.loli.net/2021/07/13/RCLw5Bx8aFPN74b.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2018 - 2022 By Charon Cheung</div><div class="framework-info"><span>Driven - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.6.1"></script><script src="/js/fancybox.js?version=1.6.1"></script><script src="/js/sidebar.js?version=1.6.1"></script><script src="/js/copy.js?version=1.6.1"></script><script src="/js/fireworks.js?version=1.6.1"></script><script src="/js/transition.js?version=1.6.1"></script><script src="/js/scroll.js?version=1.6.1"></script><script src="/js/head.js?version=1.6.1"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
    processEscapes: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
  },
  CommonHTML: {
    linebreaks: { automatic: true, width: "90% container" }
  },
  "HTML-CSS": { 
    linebreaks: { automatic: true, width: "90% container" }
  },
  "SVG": { 
    linebreaks: { automatic: true, width: "90% container" }
  }
});
</script><script type="text/x-mathjax-config">MathJax.Hub.Queue(function() {
  var all = MathJax.Hub.getAllJax(), i;
  for (i=0; i < all.length; i += 1) {
    all[i].SourceElement().parentNode.className += ' has-jax';
  }
});
</script><script src="https://cdn.bootcss.com/mathjax/2.7.2/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script>if(/Android|webOS|iPhone|iPod|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
}</script></body></html>