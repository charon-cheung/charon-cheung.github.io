<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="障碍层5  raytraceFreespace从代价地图清除障碍"><meta name="keywords" content=""><meta name="author" content="Charon Cheung"><meta name="copyright" content="Charon Cheung"><title>障碍层5  raytraceFreespace从代价地图清除障碍 | 沉默杀手</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.6.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.6.1"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  }
} </script><meta name="generator" content="Hexo 5.4.0"></head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#updateCosts"><span class="toc-number">1.</span> <span class="toc-text">updateCosts</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://s2.loli.net/2022/02/17/HQaCXUBn64zsMIL.png"></div><div class="author-info__name text-center">Charon Cheung</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">659</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">6</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">53</span></a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://s2.loli.net/2022/11/17/QOR8cePIS5NdDrK.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">沉默杀手</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span></div><div id="post-info"><div id="post-title">障碍层5  raytraceFreespace从代价地图清除障碍</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-11-04</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/%E8%B7%AF%E5%BE%84%E8%A7%84%E5%88%92/">路径规划</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/%E8%B7%AF%E5%BE%84%E8%A7%84%E5%88%92/%E4%BB%A3%E4%BB%B7%E5%9C%B0%E5%9B%BE/">代价地图</a><span class="post-meta__separator">|</span><i class="fa fa-comment-o post-meta__icon" aria-hidden="true"></i><a href="/2021/11/04/%E8%B7%AF%E5%BE%84%E8%A7%84%E5%88%92/%E4%BB%A3%E4%BB%B7%E5%9C%B0%E5%9B%BE/%E9%9A%9C%E7%A2%8D%E5%B1%825%20%20%E4%BB%8E%E4%BB%A3%E4%BB%B7%E5%9C%B0%E5%9B%BE%E6%B8%85%E9%99%A4%E9%9A%9C%E7%A2%8D/#disqus_thread"><span class="disqus-comment-count" data-disqus-identifier="2021/11/04/路径规划/代价地图/障碍层5  从代价地图清除障碍/"></span></a><div class="post-meta-wordcount"><span>Word count: </span><span class="word-count">178</span><span class="post-meta__separator">|</span><span>Reading time: 1 min</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>先提一下栅格地图的占用值更新的方式。当雷达扫到一个障碍时，会对击中点的栅格更新一次占用，这时在ROS地图下这个点将被表示为障碍物．</p>
<p>如果ROS中设置障碍物的<code>occupied_thresh</code>是0.65，<code>free_thresh</code>是0.25。第一次更新地图时，这个格子的占用值为 <script type="math/tex">1/1 = 1 > 0.65</script>，就会将ROS地图中这个格子设置为100，表示障碍物．如果这个障碍离开了这个位置，在之后的过程中，如果有4次雷达扫描这个栅格都是空闲状态，也就是没有障碍物，则这个格子的占用值将变为 <script type="math/tex">1/5 = 0.2 <0.25</script> ，所以就会将ROS地图中对应的栅格设置为0，变成可通过区域了．</p>
<p>这就导致了不能通过一次两次的更新之后的值，来代表这个栅格是占用还是空闲的，因为这个状态十分有可能是错的．只有通过长时间的累计之后，最后通过这个值是否大于零，来近似地将这个栅格设置为是否是障碍物，这时候依然不能百分百地确定这个栅格是否就是障碍物．</p>
<p>在上一篇的<code>UpdateBounds</code>函数最后到了<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">unsigned</span> <span class="keyword">int</span> i = <span class="number">0</span>; i &lt; clearing_observations.<span class="built_in">size</span>(); ++i)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">raytraceFreespace</span>(clearing_observations[i], min_x, min_y, max_x, max_y);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><img src="https://i.loli.net/2021/11/15/i79yefxSj3lzVgY.png" alt="流程"></p>
<p>清理传感器到障碍物间的cell，会首先处理测量值越界的问题，然后调用<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">MarkCell <span class="title">marker</span><span class="params">(costmap_, FREE_SPACE)</span></span>;</span><br><span class="line"><span class="comment">// and finally... we can execute our trace to clear obstacles along that line</span></span><br><span class="line"><span class="built_in">raytraceLine</span>(marker, x0, y0, x1, y1, cell_raytrace_range);</span><br><span class="line"><span class="built_in">updateRaytraceBounds</span>(ox, oy, wx, wy, clearing_observation.raytrace_range_, min_x, min_y, max_x, max_y);</span><br></pre></td></tr></table></figure><br>最终<code>raytraceLine(marker, x0, y0, x1, y1, cell_raytrace_range);</code> 会将所有在<code>(x0,y0)&gt;&gt;(x1,y1)</code>之间的所有cell标记为<code>FREE_SPACE</code>。而<code>updateRaytraceBounds</code> 会根据测量的距离，更新扩张<code>（min_x, min_y, max_x, max_y）</code><br><code>updateBounds</code>在根据测量数据完成 clear 操作之后，就开始了mark 操作，对每个测量到的点，标记为obstacle ：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">double</span> px = cloud.points[i].x, py = cloud.points[i].y, pz = cloud.points[i].z;</span><br><span class="line"></span><br><span class="line">......省略</span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> index = <span class="built_in">getIndex</span>(mx, my);</span><br><span class="line">costmap_[index] = LETHAL_OBSTACLE;</span><br><span class="line"><span class="built_in">touch</span>(px, py, min_x, min_y, max_x, max_y);</span><br></pre></td></tr></table></figure></p>
<p><img src="https://i.loli.net/2021/07/14/s2UD3i8wOE4zPCo.png" alt=""></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * @brief  Given distance in the world, convert it to cells</span></span><br><span class="line"><span class="comment"> * @param  world_dist: The world distance</span></span><br><span class="line"><span class="comment"> * @return The equivalent cell distance</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">Costmap2D::cellDistance</span><span class="params">(<span class="keyword">double</span> world_dist)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">double</span> cells_dist = <span class="built_in">max</span>(<span class="number">0.0</span>, <span class="built_in">ceil</span>(world_dist / resolution_));</span><br><span class="line">  <span class="keyword">return</span> (<span class="keyword">unsigned</span> <span class="keyword">int</span>)cells_dist;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MarkCell</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="built_in">MarkCell</span>(<span class="keyword">unsigned</span> <span class="keyword">char</span>* costmap, <span class="keyword">unsigned</span> <span class="keyword">char</span> value) :</span><br><span class="line">      <span class="built_in">costmap_</span>(costmap), <span class="built_in">value_</span>(value)</span><br><span class="line">  &#123;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">operator</span><span class="params">()</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> offset)</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    costmap_[offset] = value_;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">char</span>* costmap_;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">char</span> value_;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="updateCosts"><a href="#updateCosts" class="headerlink" title="updateCosts"></a>updateCosts</h2><p>代价地图中每个cell可用255个不同值中任何一个值，可是下层数据结构仅需要3个值。具体来说，每个cell仅需要3个值来表示cell的3种状态：free，occupied，unknown。 当投影到代价地图时候，每种状态被赋一个特定的代价值，也就是说<font size="4" color="blue"> 每个cell的cost值是由这个cell对应的各层中对应的cell的状态进行加权得到的。 </font> 如果列有一定量的占用就被赋代价值。 如果存储的障碍物信息是3D的，需要将每一列的障碍物信息投影成2D后才能放入到代价地图。</p>
<p>更新障碍地图代价，将机器人足迹范围内设置为 <code>FREE_SPACE</code>，并且在 bound 范围内将本层障碍地图的内容合并到主地图上。</p>
<p>障碍物层是将传感器检测到的点云投影到地图中，不同的传感器来源会分别存到Observation类中。只要遍历存储Observation的容器，将检测到的点云的每个点分别投影到地图中，将对应的网格的代价值设为<code>LETHAL_OBSTACLE</code>，实现函数在<code>ObstacleLayer::updateBounds</code>中：</p>
<p>清除代价地图的方式也很好理解，以单线激光雷达的激光线为例子，当激光线发射出去之后，在某处检测到一个障碍物，那说明：从发射的地方至某处之间是free的，那么这之间的旧的障碍物应当被删除，这之间网格的代价值应当被修改为free</p>
<p>可能是Bresenham2D的round off error(舍入误差)造成的. It marks a particular cell as obstacle but the next time when the sensor reading changes instantaneously, it no longer traces it through the same path and hence, the blob seem remains in the costmap.</p>
<p>added 2 lines of code to the Bresenham2D algorithm. This basically clears the cell to the left and right of the grid through which the Line segment constructed by the algorithm passes. This results in loosing some resolution of the map, but the solution works pretty well in real life application</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// A 2D implementation of Bresenham&#x27;s raytracing algorithm, applies an action </span></span><br><span class="line"><span class="comment">// at each step template&lt;class ActionType&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">bresenham2D</span><span class="params">( ActionType at, <span class="keyword">unsigned</span> <span class="keyword">int</span> abs_da, <span class="keyword">unsigned</span> <span class="keyword">int</span> abs_db, </span></span></span><br><span class="line"><span class="params"><span class="function">                        <span class="keyword">int</span> error_b, <span class="keyword">int</span> offset_a, <span class="keyword">int</span> offset_b, <span class="keyword">unsigned</span> <span class="keyword">int</span> offset, </span></span></span><br><span class="line"><span class="params"><span class="function">                        <span class="keyword">unsigned</span> <span class="keyword">int</span> max_length)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> end = std::<span class="built_in">min</span>(max_length, abs_da);</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">unsigned</span> <span class="keyword">int</span> i = <span class="number">0</span>; i &lt; end; ++i)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">at</span>(offset);</span><br><span class="line">    <span class="built_in">at</span>(offset+<span class="number">1</span>); <span class="comment">// **ADDED THIS LINE**</span></span><br><span class="line">    <span class="built_in">at</span>(offset<span class="number">-1</span>); <span class="comment">// **ADDED THIS LINE**</span></span><br><span class="line">    offset += offset_a;</span><br><span class="line">    error_b += abs_db;</span><br><span class="line">    <span class="keyword">if</span> ((<span class="keyword">unsigned</span> <span class="keyword">int</span>)error_b &gt;= abs_da)</span><br><span class="line">    &#123;</span><br><span class="line">      offset += offset_b;</span><br><span class="line">      error_b -= abs_da;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">at</span>(offset);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></article><div class="post-meta__tag-list"></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2021/11/13/%E8%B7%AF%E5%BE%84%E8%A7%84%E5%88%92/%E4%BB%A3%E4%BB%B7%E5%9C%B0%E5%9B%BE/%E9%9A%9C%E7%A2%8D%E5%B1%826%20%20%E5%8A%A0%E9%80%9F%E6%B8%85%E9%99%A4%E4%BB%A3%E4%BB%B7%E5%9C%B0%E5%9B%BE%E4%B8%AD%E7%9A%84%E9%9A%9C%E7%A2%8D/"><i class="fa fa-chevron-left">  </i><span>障碍层6 加速清除代价地图中的障碍</span></a></div><div class="next-post pull-right"><a href="/2021/11/04/%E8%B7%AF%E5%BE%84%E8%A7%84%E5%88%92/%E4%BB%A3%E4%BB%B7%E5%9C%B0%E5%9B%BE/map_server%E5%8A%A0%E8%BD%BD%E4%B8%8D%E5%90%8C%E5%A4%A7%E5%B0%8F%E5%9C%B0%E5%9B%BE%E7%9A%84%E5%BD%B1%E5%93%8D/"><span>map_server加载不同大小地图的影响</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="disqus_thread"></div><script>var unused = null;
var disqus_config = function () {
  this.page.url = 'https://charon-cheung.github.io/2021/11/04/%E8%B7%AF%E5%BE%84%E8%A7%84%E5%88%92/%E4%BB%A3%E4%BB%B7%E5%9C%B0%E5%9B%BE/%E9%9A%9C%E7%A2%8D%E5%B1%825%20%20%E4%BB%8E%E4%BB%A3%E4%BB%B7%E5%9C%B0%E5%9B%BE%E6%B8%85%E9%99%A4%E9%9A%9C%E7%A2%8D/';
  this.page.identifier = '2021/11/04/路径规划/代价地图/障碍层5  从代价地图清除障碍/';
  this.page.title = '障碍层5  raytraceFreespace从代价地图清除障碍';
}
var d = document, s = d.createElement('script');
s.src = "https://" + '沉默杀手' +".disqus.com/embed.js";
s.setAttribute('data-timestamp', '' + +new Date());
(d.head || d.body).appendChild(s);</script><script id="dsq-count-scr" src="https://沉默杀手.disqus.com/count.js" async></script></div></div><footer class="footer-bg" style="background-image: url(https://s2.loli.net/2022/11/17/QOR8cePIS5NdDrK.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2018 - 2023 By Charon Cheung</div><div class="framework-info"><span>Driven - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.6.1"></script><script src="/js/fancybox.js?version=1.6.1"></script><script src="/js/sidebar.js?version=1.6.1"></script><script src="/js/copy.js?version=1.6.1"></script><script src="/js/fireworks.js?version=1.6.1"></script><script src="/js/transition.js?version=1.6.1"></script><script src="/js/scroll.js?version=1.6.1"></script><script src="/js/head.js?version=1.6.1"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
    processEscapes: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
  },
  CommonHTML: {
    linebreaks: { automatic: true, width: "90% container" }
  },
  "HTML-CSS": { 
    linebreaks: { automatic: true, width: "90% container" }
  },
  "SVG": { 
    linebreaks: { automatic: true, width: "90% container" }
  }
});
</script><script type="text/x-mathjax-config">MathJax.Hub.Queue(function() {
  var all = MathJax.Hub.getAllJax(), i;
  for (i=0; i < all.length; i += 1) {
    all[i].SourceElement().parentNode.className += ' has-jax';
  }
});
</script><script src="https://cdn.bootcss.com/mathjax/2.7.2/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script>if(/Android|webOS|iPhone|iPod|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
}</script></body></html>